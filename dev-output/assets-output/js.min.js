"use strict";var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var i=[],n=!0,a=!1,s=void 0;try{for(var o,r=e[Symbol.iterator]();!(n=(o=r.next()).done)&&(i.push(o.value),!t||i.length!==t);n=!0);}catch(e){a=!0,s=e}finally{try{!n&&r.return&&r.return()}finally{if(a)throw s}}return i}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_createClass=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var $window=$(window),$document=$(document),$html=$("html"),$body=$("body"),$body_preventMouseover=!1,$body_isTouch=!1,_g={isinit:!1,isload:!1,isfocus:!document.hasFocus||document.hasFocus(),everfocus:!document.hasFocus||document.hasFocus(),posttime:[],time_format:"m月d日",time_format2:"Y年m月d日",time_diff_range:3456e5,time_diff_range2:31536e6,last:{width:0,height:0},interval:{},initSize:20,baseSize:10,baseMultiper:1,lastBaseSize:10,pixelRatio:window.devicePixelRatio?window.devicePixelRatio:screen.deviceXDPI?screen.deviceXDPI/72:1,maxMultiper:Math.max(1,Math.ceil((screen.availHeight||screen.height||$window.height())/800*10)/10),strings:{},inputIndex:0,lang:"zh_cn",_:!1},_p={comp:{},el:{}},_frame={dom:{},init_all:function(){for(var e in _frame)_frame[e].init&&_frame[e].init()}},_module={},_page={},_data={};if(void 0===_huScrolled)var _huScrolled={};if(!_huScrolled.ver||_huScrolled.ver<1.2){_huScrolled.ver=1.2,_huScrolled.timeout=!1,_huScrolled.throttle=_huScrolled.throttle||100;var bIEnew=/\(Windows NT [0-9\.]+.+Trident\/[0-9\.]+.+rv.{1}[0-9\.]+\)/.test(navigator.userAgent),el=(bIE=!(!window.attachEvent||window.opera)||bIEnew)&&parseFloat(navigator.appVersion.split("MSIE")[1])<9?$window:$document;el.on({"scroll.huScrolled":function(){if(_huScrolled.timeout)return!0;_huScrolled.timeout=setTimeout(function(){$document.trigger("huScrolled"),_huScrolled.timeout=null},_huScrolled.throttle)}})}if(void 0===_huResized)var _huResized={};if((!_huResized.ver||_huResized.ver<2.1)&&(_huResized.ver=2.1,_huResized.throttle=_huResized.throttle||300,_huResized.startSize={},_huResized.viewport=function(){var e=window,t="inner";return"innerWidth"in window||(t="client",e=document.documentElement||document.body),{width:e[t+"Width"],height:e[t+"Height"]}},$window.on({"resize.huResized":function(e,t){t=t||{};var i=_huResized.viewport(),n=_huResized.startSize.width||i.width,a=_huResized.startSize.height||i.height,s=50<Math.abs(i.width-n)||50<Math.abs(i.height-a);_huResized.timeout&&(clearTimeout(_huResized.timeout),_huResized.timeout=null),_huResized.topmask||(_huResized.topmask=$("<div/>").css({"z-index":"16777269",display:"none",position:"fixed",width:"100%",height:"100%",top:0,left:0,"background-color":"rgba(0,0,0,.5)"}).appendTo($body)),!s||t.isInitial||_huResized.maskShowing||(_huResized.topmask.css("display","block"),_huResized.maskShowing=!0),s||_huResized.isChanging||(_huResized.startSize={width:i.width,height:i.height}),_huResized.isChanging=!0,_huResized.timeout=setTimeout(function(){$window.trigger("huResized"),_huResized.timeout=null,_huResized.maskShowing=!1,_huResized.isChanging=!1,_huResized.topmask.css("display","none"),i=_huResized.viewport(),_huResized.startSize={width:i.width,height:i.height}},t.isInitial?0:_huResized.throttle)}})),void 0===_huCss)var _huCss={};(!_huCss.ver||_huCss.ver<1.2)&&(_huCss.ver=1.2,_huCss.cssprefix_result={},_huCss.csscheck=function(e){if(_huCss.csscheck_div||(_huCss.csscheck_div=document.documentElement),e in _huCss.csscheck_div.style)return!0;var t=e.split("-");e=t[0];for(var i=1;i<t.length;i++)e+=t[1].substr(0,1).toUpperCase()+t[1].substr(1);return e in _huCss.csscheck_div.style},_huCss.csscheck_full=function(e){return _huCss.cssprefix(e,null,!0)},_huCss.cssprefix=function(e,t,i){if(_huCss.cssprefix_result[e])var n=_huCss.cssprefix_result[e];else if(!1===_huCss.cssprefix_result[e]){if(i)return!1;n=""}else{n="";var a=["-webkit-","-moz-","-ms-","-o-"];if(!_huCss.csscheck(e)){n=!1;for(var s=0;s<a.length;s++)if(_huCss.csscheck(a[s]+e)){n=a[s];break}}if(_huCss.cssprefix_result[e]=n,i)return n=!1!==n}return n=!1===n?"":n,t?n:n+e},_huCss.csscheck_3d=function(){return _huCss.csscheck_full("perspective")},_huCss.createSheet=function(e){var t=document.createElement("style");if(e&&(t.title=e),document.getElementsByTagName("head")[0].appendChild(t),window.createPopup||t.appendChild(document.createTextNode("")),e)for(var i=0;i<document.styleSheets.length;i++)if(document.styleSheets[i].title==e)return document.styleSheets[i];return document.styleSheets[document.styleSheets.length-1]},_huCss.getSheet=function(e){return(e=e||_huCss.sheet)||(_huCss.sheet=_huCss.createSheet("__huCss_sheet"),e=_huCss.sheet),e},_huCss.getCssRulesNum=function(e){return(e=_huCss.getSheet(e)).cssRules?e.cssRules.length:0},_huCss.addRule=function(e,t,i,n){var a="";for(var s in n=_huCss.getSheet(n),t)_huCss.csscheck_full(s)?a+=_huCss.cssprefix(s)+":"+t[s]+";":"opacity"==s&&_huCss.csscheck_full("filter")&&(a+="filter:alpha(opacity="+100*t[s]+")");if(i||0===i||(i=n.cssRules?n.cssRules.length:_huCss.getCssRulesNum()),n.insertRule)n.insertRule(e+"{"+a+"}",i);else for(e=e.split(","),s=0;s<e.length;s++)n.addRule(e[s],a,i)},_huCss.removeRule=function(t,i){if(!t&&0!==t)return!1;i=_huCss.getSheet(i);try{i.deleteRule(t)}catch(e){i.removeRule(t)}});var bIE,_UA=navigator.userAgent,bChrome=/Chrome/.test(_UA),bChromeVer=!!bChrome&&/Chrome\/([0-9\.]+)/.exec(navigator.appVersion),bSafari=/Safari/.test(_UA)&&!bChrome,bFirefox=/Firefox/.test(_UA),bOpera=/Opera/.test(_UA),bWebkit=/WebKit/.test(_UA),bWebkitVer=!!bWebkit&&/(AppleWebKit|Safari)\/([0-9\.]+)/.exec(navigator.appVersion),bIEnewVer=!!(bIEnew=/\(Windows NT [0-9\.]+.+Trident\/[0-9\.]+.+rv.{1}[0-9\.]+\)/.test(_UA))&&parseFloat(_UA.split("rv:")[1]),bIE6=(bIE=!(!window.attachEvent||window.opera)||bIEnew)&&parseFloat(navigator.appVersion.split("MSIE")[1])<7,bIE7=bIE&&parseFloat(navigator.appVersion.split("MSIE")[1])<8,bIE8=bIE&&parseFloat(navigator.appVersion.split("MSIE")[1])<9,bIE9=bIE&&parseFloat(navigator.appVersion.split("MSIE")[1])<10,bIE10=bIE&&parseFloat(navigator.appVersion.split("MSIE")[1])<11,bIE11=bIEnewVer&&bIEnewVer<12,bGecko=!bIE&&!bIEnew&&!bWebkit&&-1!=_UA.indexOf("Gecko"),bIphone=/iPhone/i.test(_UA),bIpad=/iPad/i.test(_UA),bAndroid=/Android/i.test(_UA),bIOS=!1,bIOSver=!(!bIphone&&!bIpad)&&/CPU.*OS\s*([0-9_]+)/i.exec(navigator.appVersion),bMobile=bIphone||bIpad||bAndroid,bCSSrem=!bIE8,bCSS3=_huCss.csscheck_full("border-radius"),bCSS3A=_huCss.csscheck_full("animation"),bCSS3flex=_huCss.csscheck_full("flex"),b3D=_huCss.csscheck_full("perspective"),bCSS3calc=bCSSrem,bTouch=/Touch/.test(_UA),bUnsupport=bIE7,bHTML5m3u8=bMobile,bAccessYoutube=!1,bAccessTwitter=!1,bAccessFacebook=!1;if(bWebkitVer&&bWebkitVer.length&&(bWebkitVer=bWebkitVer[2]),bChromeVer&&bChromeVer.length&&(bChromeVer=parseFloat(bChromeVer[1])),bIOSver&&bIOSver.length&&(bIOSver=parseFloat(bIOSver[1].replace(/_/,".")),bIOS=!0),(bChromeVer&&bChromeVer<29||bIOSver&&bIOSver<7)&&(bCSS3flex=!1),bIOSver&&bIOSver<6&&(bCSS3calc=!1),bGecko?$html.addClass("is-gecko"):bIE11&&!bIE10?$html.removeClass("ie9").addClass("ie11"+(bTouch?" ie-touch":"")):bIE10&&!bIE9?$html.removeClass("ie9").addClass("ie10"+(bTouch?" ie-touch":"")):bMobile?($html.addClass("mobile"),bIOS&&$html.addClass("ios"),bIphone&&$html.addClass("iphone"),bIpad&&$html.addClass("ipad"),bAndroid&&$html.addClass("android")):bWebkitVer<537&&$html.addClass("oldwebkit"),bTouch&&$html.addClass("touch"),navigator.userAgent.match(/IEMobile\/10\.0/)){var msViewportStyle=document.createElement("style");msViewportStyle.appendChild(document.createTextNode("@-ms-viewport{width:auto!important}")),document.getElementsByTagName("head")[0].appendChild(msViewportStyle)}_g.getUrl=function(){return location.href.split("#")[0]},_g.uriSearchArr={},_g.uriHashArr={},_g.timeHash=function(){var e=new Date;return e=e.getTime()},_g.uriSearch=function(e){if(!_g.uriSearchArr.length){var t=location.search?location.search.split("?")[1]:"";t=t.split("&");for(var i=0;i<t.length;i++){var n=t[i].split("=");_g.uriSearchArr[n[0]]=n[1]||""}}return e?_g.uriSearchArr[e]:location.search.substr(location.search.indexOf("?")+1)},_g.uriHash=function(e,t,i){var n=location.hash,a=n?n.split("#")[1]:"";if(a=a.split("&"),!_g.uriHashInited){for(var s in _g.uriHashArr={},a){var o=a[s].split("=");""!==o[0]&&(_g.uriHashArr[o[0]]=o[1]||!1)}_g.uriHashInited=!0}if("object"==(void 0===e?"undefined":_typeof(e))){for(var r in e)n=_g.uriHash(r,e[r],n);location.hash=n}else if(!1===t||""===t)"#"!=(n=n.replace("&"+e+"="+_g.uriHashArr[e],"").replace(e+"="+_g.uriHashArr[e],""))&&""!=n&&n||(n="_"),location.hash=n;else if(void 0!==t){if(t==_g.uriHashArr[e])return t;var l=_g.uriHashArr[e]?n.replace(e+"="+_g.uriHashArr[e],e+"="+t):n+(""==n?"#":"&")+e+"="+t;return _g.uriHashArr[e]=t,i?l:(location.hash=l,t)}return e?_g.uriHashArr[e]||!1:location.hash.substr(location.hash.indexOf("#")+1)},_g.randNumber=function(e){var t=new Date;return t=(9301*(t=t.getTime())+49297)%233280,e||(e=1e3),Math.ceil(t/233280*e)},_g.randInt=function(e,t){return Math.floor(Math.random()*parseInt(e)+(t?parseInt(t):0))},_g.scrollTo=function(e,t){if(isNaN(e))var i=(e=$(e)).scrollTop();else{t=e,e=$("html,body");i=$window.scrollTop()}var n=Math.abs(i-t),a=$window.height(),s=n<=a?200:n/a*200*(2/3);e.stop().animate({scrollTop:t},s)},_g.get_em=function(e,t,i){var n=parseFloat(e);return t=t||$body,i=i||0,isNaN(n)?e:n/parseFloat(t.css("font-size"))+i+"em"},_g.get_fontsize=function(e){return e=e||$body,parseInt(e.css("font-size"))},_g.get_basesize=function(){return parseInt($body.css("font-size"))/_g.initSize*10},_g.get_basesize_true=function(){return parseInt($body.css("font-size"))},_g.get_basemultiper=function(){return parseFloat(_g.get_basesize()/10)},_g.get_rem=function(e){var t=parseFloat(e);return isNaN(t)?e:bCSSrem?t/_g.initSize+"rem":e},_g.rem=function(e,t){var i=parseFloat(e);return isNaN(i)?e:bCSSrem?(i=i/(_g.get_basesize()/10)/_g.initSize,t?i+"rem":Math.round(10*i)/10+"rem"):e},_g.px=function(e,t){var i=parseFloat(e);return isNaN(i)?e:bIE8?e:i*_g.initSize+(t?0:"px")},_g.get_animate_duration=function(e){return _g.isfocus?e:0},_g.goto_hash=function(e,t){if("!"==(e=(e=e||location.hash).replace(/^([\#]{0,1})(.+)/,"$2"))[0])return!1;var i=$("#"+e);if(!i.length)return!1;var n=i.offset().top,a=$window.scrollTop(),s=Math.abs(a-n),o=$window.height();return(t=null==t?s<=o?200:s/o*200*(2/3):t)?$("html,body").stop().animate({scrollTop:n},t,function(){location.hash=e}):($("html,body").scrollTop(n),location.hash=e),e},_g.time=function(e){if(!e)return _g.timeNow();for(var t,i=[{exp:/(\d{4}).(\d{1,2}).(\d{1,2})[^0-9]*(\d{0,2})[:]{0,1}(\d{0,2})[:]{0,1}(\d{0,2})([\+\-])(\d{2})\:(\d{2})/i,p:{year:1,month:2,day:3,hour:4,min:5,sec:6,zoneD:7,zoneH:8,zoneM:9}},{exp:/(\d{1,2}).(\d{1,2}).(\d{4})[^0-9]*(\d{0,2})[:]{0,1}(\d{0,2})[:]{0,1}(\d{0,2})/i,p:{year:3,month:1,day:2,hour:4,min:5,sec:6}},{exp:/(\d{4}).(\d{1,2}).(\d{1,2})[^0-9]*(\d{0,2})[:]{0,1}(\d{0,2})[:]{0,1}(\d{0,2})/i,p:{year:1,month:2,day:3,hour:4,min:5,sec:6}}],n=0;n<i.length;n++){var a=i[n].exp,s=e.match(a);if(!t&&s&&s.length){var o=parseInt(s[i[n].p.year]),r=parseInt(s[i[n].p.month])||0,l=parseInt(s[i[n].p.day])||1,d=parseInt(s[i[n].p.hour])||0,u=parseInt(s[i[n].p.min])||0,c=parseInt(s[i[n].p.sec])||0;if(t=new Date(o,r-1,l,d,u,c,0),i[n].p.zoneD&&s[i[n].p.zoneD]){var h="+"==s[i[n].p.zoneD]?-1:1,m=(d=parseInt(s[i[n].p.zoneH])||0,h*((u=parseInt(s[i[n].p.zoneM])||0)+60*d+t.getTimezoneOffset())*60*1e3);t=new Date(t.valueOf()+m)}}}return t},_g.timeCal=function(e,t){return e<6e4?Math.floor(e/1e3)+"秒"+(t?"前":""):e<36e5?Math.floor(e/6e4)+"分钟"+(t?"前":""):e<864e5?Math.floor(e/36e5)+"小时"+(t?"前":""):e<1728e5?"昨天":e<2592e6?Math.floor(e/864e5)+"天"+(t?"前":""):e<31536e6?Math.floor(e/2592e6)+"月"+(t?"前":""):Math.floor(e/31536e6)+"年"+(t?"前":"")},_g.timeNow=function(){return(new Date).getTime()},_g.timeDiff=function(e){var t={time:_g.timeNow(),obj:null,format:_g.time_format,format2:_g.time_format2,range:_g.time_diff_range,range2:_g.time_diff_range2,is_init:!0};return $.extend(t,e),!!t.obj&&(e=t)},_g.timeDiffInterval=function(){function e(){if(!_g.isfocus)return!1;for(var e=0;e<_g.posttime.length;e++){var t=_g.posttime[e].is_init?_g.posttime[e]:_g.timeDiff(_g.posttime[e]),i=(new Date).getTime()-t.time,n=t.range,a=t.range2;if(i<n)t.obj.html(i<6e4?"刚刚":_g.timeCal(i,!0));else{var s=a<i?t.format2:t.format,o=t.time;s=(s=(s=(s=(s=s.replace(/Y/g,o.getFullYear())).replace(/M/g,o.getMonth()+1<10?"0"+(o.getMonth()+1):o.getMonth()+1)).replace(/m/g,o.getMonth()+1)).replace(/D/g,o.getDate()<10?"0"+o.getDate():o.getDate())).replace(/d/g,o.getDate()),t.obj.html(s)}}}clearInterval(_g.interval.posttime),e(),_g.interval.posttime=setInterval(function(){e()},6e4)};var _support={cache:{},check:function(e){return e=e.toLowerCase().replace(/[ :-_]/g,""),void 0===_support.cache[e]&&_support["_"+e]&&(_support.cache[e]=_support["_"+e]()),_support.cache[e]}};function _b(e){return _support.check(e)}function addHandler(e,t,i){if(void 0!==e.addEventListener)e.addEventListener(t,i,!1);else{if(void 0===e.attachEvent)throw"Incompatible browser";e.attachEvent("on"+t,i)}}_support._css3=function(){return _huCss.csscheck_full("border-radius")},_support._css3animation=function(){return _huCss.csscheck_full("animation")},_support._css3transition=function(){return _huCss.csscheck_full("transition")},_support._css3flex=function(){return _huCss.csscheck_full("flex")},_support._css33d=function(){return _huCss.csscheck_full("perspective")},_support._css3d=_support._css33d,_support._css3mediaquery=function(){return!(!window.matchMedia&&!window.msMatchMedia)},_support._mediaquery=_support._css3mediaquery,_support._css3imageset=function(){var i=$("<div/>",{style:"background-image:url("+_g.pathImg+"_g-p.gif)"});function e(e){i.css("background-image","image-set(url("+_g.pathImg+"_g-p.gif) 1x)");var t=i.css("background-image");return!(!t||"none"==t)||!(!e||(i.css("background-image",e+"image-set(url("+_g.pathImg+"_g-p.gif) 1x)"),!(t=i.css("background-image"))||"none"==t))&&e}return bWebkit?e("-webkit-"):bGecko?e("-moz-"):bIE?e("-ms-"):e()},_support._pluginflash=function(){var e=!1;try{e=void 0!==navigator.plugins&&"object"==_typeof(navigator.plugins["Shockwave Flash"])||window.ActiveXObject&&0!=new ActiveXObject("ShockwaveFlash.ShockwaveFlash")}catch(e){}return e},_support._flash=_support._pluginflash,_support._html5attrdownload=function(){return"download"in document.createElement("a")},_support._html5download=_support._html5attrdownload,_support._html5attributedownload=_support._html5attrdownload,_support._html5videomp4=function(){var e=document.createElement("video"),t=!1;return e.canPlayType&&e.canPlayType("video/mp4").replace(/no/,"")&&(t=!0),t},_support._html5mp4=_support._html5videomp4,_g.init=function(){if(_g.baseSize=_g.get_basesize(),_g.baseMultiper=parseFloat(_g.baseSize/10),_g.lastBaseSize=_g.get_basesize(),_g.isfocus="visible"==Visibility.state(),_g.everfocus=_g.isfocus,Visibility.change(function(e,t){"visible"==t?(_g.isfocus=!0,_g.everfocus||(_g.everfocus=!0,_g.last.width=-1,_g.last.height=-1,_frame.main.last.width=-1,_frame.main.last.height=-1),$window.trigger("resized_check._g"),_g.timeDiffInterval()):_g.isfocus=!1}),$window.on({orientationchange:function(){$window.trigger("resize")},huResized:function(){$window.trigger("resized_check._g")},"resized_check._g":function(){if(!_g.isfocus)return!1;var e=$window,t=e.width(),i=e.height();if(_g.baseSize=_g.get_basesize(),_g.orientation=i<=t?"landscape":"portrait",_g.baseSize!=_g.lastBaseSize&&(_g.baseMultiper=parseFloat(_g.baseSize/10),_g.lastBaseSize=_g.baseSize,_g.isBaseChange=!0,e.trigger("basechange")),t!=_g.last.width||i!=_g.last.height){var n={is_widthchange:t!=_g.last.width,is_heightchange:i!=_g.last.height};e.trigger("resized_before",[n]).trigger("resized",[n]),_g.isEverResized=!0}_g.last.width=t,_g.last.height=i},basechange:function(){_g.isBaseChange&&(_g.isBaseChange=!1,setTimeout(function(){$window.trigger("resized_before").trigger("resized",[{is_basechange:!0}])},_g.animate_duration_delay))},"load.trigger_resized":function(){if(!_g.isfocus)return!1;setTimeout(function(){$window.trigger("resized_before",[{is_load:!0}]).trigger("resized",[{is_load:!0}])},_g.readyLock?4*_g.animate_duration+10:0),_g.isload=!0},"hashchange._global":function(e){_g.uriHashArr={};var t=(location.hash?location.hash.split("#")[1]:"").split("&");for(var i in t){var n=t[i].split("=");""!==n[0]&&(_g.uriHashArr[n[0]]=n[1]||!1)}_g.uriHashInited=!0,_g.uriHash()&&""!=_g.uriHash()||(e.preventDefault(),e.stopPropagation())},"unload.focuswindow":function(){$(this).focus()}}),setTimeout(function(){$window.trigger("hashchange")},_g.animate_duration_delay+10),$document.on({huScrolled:function(){$window.trigger("scrolled")}}),$body.on({"touchstart.preventMouseover":function(){$body.removeClass("hover"),$body_isTouch=$body_preventMouseover=!0},pointerenter:function(e){"touch"==e.originalEvent.pointerType?$body.trigger("touchstart.preventMouseover"):$body_isTouch=$body_preventMouseover=!1},mouseover:function(){$body_isTouch?$body_preventMouseover=!($body_isTouch=!1):($body.addClass("hover"),$body_preventMouseover=!1)},mouseleave:function(){$body.removeClass("hover")}}),top!=self)try{self.location.host!=top.location.host&&top.location.replace(self.location.href),self.location.host==top.location.host&&($body.addClass("only-content"),_g.changeTheme(top._g.getTheme())),$html.css("font-size",top.$html.css("font-size")),$window.on({"resized.iframe_resize":function(){$html.css("font-size",top.$html.css("font-size"))}})}catch(e){}_hotkey.init(),_frame.init_all(),_p.init_document_ready(),$html.addClass("ready"),$window.trigger("resize",[{isInitial:!0}]),_g.readyLock=!0,setTimeout(function(){_g.readyLock=null},4*_g.animate_duration+10);try{window.external.msSiteModeClearBadge()}catch(e){}return!(_g.isinit=!0)},jQuery.cookie=function(e,t,i){if(void 0===t){var n=null;if(document.cookie&&""!=document.cookie)for(var a=document.cookie.split(";"),s=0;s<a.length;s++){var o=jQuery.trim(a[s]);if(o.substring(0,e.length+1)==e+"="){n=decodeURIComponent(o.substring(e.length+1));break}}return n}i=i||{},null===t&&(t="",i.expires=-1);var r,l="";i.expires&&("number"==typeof i.expires||i.expires.toUTCString)&&("number"==typeof i.expires?(r=new Date).setTime(r.getTime()+24*i.expires*60*60*1e3):r=i.expires,l="; expires="+r.toUTCString());var d="; path="+(i.path?i.path:"/"),u=i.domain?"; domain="+i.domain:/(.*)([\.]*)acgdb\.com/.test(location.host)?"; domain=.acgdb.com":"",c=i.secure?"; secure":"";document.cookie=[e,"=",encodeURIComponent(t),l,d,u,c].join("")},function(e){e.fn.innerWidth=function(){return parseFloat(this.css("width"))},e.fn.innerHeight=function(){return parseFloat(this.css("height"))}}(jQuery),$.fn.serializeObject=function(){var t={},e=this.serializeArray();function s(e){return"number"==typeof e&&0===e?e:e||""}return $.each(e,function(){if(!/^_tabview\-/.test(this.name))if(this.value=isNaN(this.value)||!this.value?this.value:parseFloat(this.value),-1<this.name.indexOf(".")){var e=this.name.split(".");!function e(t,i,n){if(!i.length)return t;var a=i[0];void 0===t[a]?t[a]=1<i.length?{}:n:1==i.length&&(t[a].push||(t[a]=[t[a]]),t[a].push(s(n))),i.shift(),e(t[a],i,n)}(t,e,this.value)}else t[this.name]||0===t[this.name]?(t[this.name].push||(t[this.name]=[t[this.name]]),t[this.name].push(s(this.value))):t[this.name]=s(this.value)}),t},_p.initDOM=function(e){return(e=e||_frame.dom.layout||_frame.dom.layout||$body).initAll()},_p.initAll=_p.initDOM,$.fn.initDOM=function(){for(var e in _p.el)_p.el[e].init&&_p.el[e].init(this);return this},$.fn.initAll=$.fn.initDOM,_p.init_document_ready=function(){_p.is_init_document_ready||(_p.initDOM($body),_p.is_init_document_ready=!0)},_p.getSummary=function(){var e=$("#summary").text()||!1;return!e&&$("head").find("meta[name=keywords]").length&&(e=(e=$("head").find("meta[name=Description]").attr("content")).substr(0,e.indexOf(" - ACGDB"))),e},_p.get_tar=function(e,t,i){return e=e||_frame.dom.layout||$("#layout")||$body,"."==t.substr(0,1)&&(t=t.substr(1)),e.hasClass(t)?e:i?e.find('[class^="'+t+'"]'):e.find("."+t)},_p.hashlinks=function(e){(e=e||$body).find("a[href^=#]").each(function(){$(this).off("click.hashlink").on({"click.hashlink":function(){return _g.goto_hash($(this).attr("href")),!1}})})},_p.get_lines=function(e,t){return t=t||e,Math.max(1,Math.floor(Math.min(e.innerHeight(),e.height())/parseFloat(t.css("line-height"))))},_p.el.time={init:function(e){_p.get_tar(e,".time").each(function(){var e=$(this),t=e.text();time=t?_g.time(t):null,time&&_g.posttime.push({time:time,obj:e})}),_g.timeDiffInterval()}},_p.el.timeSec={init:function(e){_p.get_tar(e,".time-sec").each(function(){var e=$(this);if(e.data("acgdb-time-sec"))return e.data("acgdb-time-sec");var t=e.text(),i=/\s*([0-9]+)/.exec(t);if(i&&1<i.length){i=parseInt(i[1]);var n=Math.floor(i/60),a=i%60,s=(n<10?"0":"")+n+":"+(a<10?"0":"")+a+"'";e.text(s)}e.data("acgdb-time-sec",i)})}},_p.removeEmptyTextNode=function(e){if(!(e=$(e)).length)return!1;e.contents().filter(function(){return 3===this.nodeType}).remove()},Object.defineProperty(Array.prototype,"mergeFrom",{enumerable:!1,value:function(e){return Array.prototype.push.apply(this,e instanceof Array||e.push?e:[e]),this}}),Date.prototype.format=function(e,t){return _g.formatTime(this,e,t)},_g.formatTime_string={zh_CN:{Midnight:"深夜",Sunday:"周日",Monday:"周一",Tuesday:"周二",Wednesday:"周三",Thursday:"周四",Friday:"周五",Saturday:"周六"}},_g.formatTime_weekdaymappding=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],_g.formatTime=function(e,t,i){if(!e)return!1;i=i||{},t=t||"%Y年%m月%d日","date"!=typeof e&&(e=new Date(e));var n=e.valueOf();function a(e){return e<10?"0"+e:e}void 0!==i.output_timezone&&(n+=60*(i.output_timezone+e.getTimezoneOffset()/60)*60*1e3,e=new Date(n));var s=e.getHours(),o=a(s);return i.midnight_astoday&&(s<6||24==s)?(o=s+=24,n-=864e5,e=new Date(n),t=t.replace(/\%midnight/g,"Midnight"._(_g.formatTime_string))):t=t.replace(/\%midnight/g,""),t.replace(/\%Y/g,e.getFullYear()).replace(/\%m/g,a(e.getMonth()+1)).replace(/\%n/g,e.getMonth()+1).replace(/\%d/g,a(e.getDate())).replace(/\%j/g,e.getDate()).replace(/\%G/g,s).replace(/\%H/g,o).replace(/\%i/g,a(e.getMinutes())).replace(/\%s/g,a(e.getSeconds())).replace(/\%l/g,_g.formatTime_weekdaymappding[e.getDay()]._(_g.formatTime_string))},Object.defineProperty(Object.prototype,"_size",{enumerable:!1,get:function(){var e=0;for(var t in this)e++;return e}}),String.prototype.getText=function(e,t){return _g.getText(this,e,t,!0)},String.prototype._=String.prototype.getText,_g.getText=function(e,t,n,a){if(!e||!t)return e;function s(e){return"object"==(void 0===e?"undefined":_typeof(e))&&e.length?e[0]:e}n=n||_g.lang;if(t[e]){if("string"==typeof t[e])return s(t[e]);if(t[e][n])return s(t[e][n])}if(t[n]&&t[n][e])return s(t[n][e]);if("string"!=typeof e&&a){for(_t="",i=0;i<e.length;i++)_t+=e[i];e=_t}return s(e)},_g.hashCode=function(t){t=encodeURIComponent(t);try{return t.split("").reduce(function(e,t){return(e=(e<<5)-e+t.charCodeAt(0))&e},0).toString(16)}catch(e){var i,n=0;if(0==t.length)return n;for(i=0,l=t.length;i<l;i++)n=(n<<5)-n+t.charCodeAt(i),n|=0;return n.toString(16)}},String.prototype.hashCode=function(){return _g.hashCode(this)},String.prototype.filter=function(){return _g.stringFilter(this)},String.prototype.filterCensored=function(){return _g.stringFilterCensored(this)},String.prototype.escape=function(){return $("<div />").text(this).html()};var _tmpl={export:function(e,t){return e.attr&&t?e.prop("outerHTML"):e.attr&&!t?e:!e.attr&&t?e:e.attr||t?void 0:$(e)}},_hotkey={allowed:!0,keyCodeBindings:{},bind:function(e,t,i,n){if("function"==typeof t)return _hotkey.bind(e,null,t,i);if(!e||!i)return!1;e=parseInt(e),t="text"==typeof t?[t]:t||[],n=n||{},void 0===_hotkey.keyCodeBindings[e]&&(_hotkey.keyCodeBindings[e]={default:[],meta:[],alt:[],shift:[],"meta+alt":[],"meta+shift":[],"alt+shift":[],"meta+alt+shift":[]});var a=!1,s=!1,o=!1;for(var r in t)t[r]=t[r].toLowerCase(),"ctrl"!=t[r]&&"meta"!=t[r]||(a=!0),"alt"==t[r]&&(s=!0),"shift"==t[r]&&(o=!0);return a&&s&&o?_hotkey.keyCodeBindings[e]["meta+alt+shift"].push(i):a&&s?_hotkey.keyCodeBindings[e]["meta+alt"].push(i):a&&o?_hotkey.keyCodeBindings[e]["meta+shift"].push(i):s&&o?_hotkey.keyCodeBindings[e]["alt+shift"].push(i):a?_hotkey.keyCodeBindings[e].meta.push(i):s?_hotkey.keyCodeBindings[e].alt.push(i):o?_hotkey.keyCodeBindings[e].shift.push(i):_hotkey.keyCodeBindings[e].default.push(i),!0},_run:function(e){for(var t in e)e[t]()},init:function(){if(_hotkey.is_init)return _hotkey;$window.on("keydown._hotkey",function(e){if("INPUT"!=document.activeElement.tagName&&"TEXTAREA"!=document.activeElement.tagName&&"SELECT"!=document.activeElement.tagName&&!document.activeElement.hasAttribute("contenteditable")&&_hotkey.allowed){var t=parseInt(e.keyCode||e.which);_hotkey.keyCodeBindings[t]&&((e.ctrlKey||e.metaKey)&&e.altKey&&e.shiftKey?_hotkey._run(_hotkey.keyCodeBindings[t]["meta+alt+shift"]):(e.ctrlKey||e.metaKey)&&e.altKey?_hotkey._run(_hotkey.keyCodeBindings[t]["meta+alt"]):(e.ctrlKey||e.metaKey)&&e.shiftKey?_hotkey._run(_hotkey.keyCodeBindings[t]["meta+shift"]):e.altKey&&e.shiftKey?_hotkey._run(_hotkey.keyCodeBindings[t]["alt+shift"]):e.ctrlKey||e.metaKey?_hotkey._run(_hotkey.keyCodeBindings[t].meta):e.altKey?_hotkey._run(_hotkey.keyCodeBindings[t].alt):e.shiftKey?_hotkey._run(_hotkey.keyCodeBindings[t].shift):e.altKey||e.ctrlKey||e.metaKey||e.shiftKey||_hotkey._run(_hotkey.keyCodeBindings[t].default))}}),_hotkey.is_init=!0}},_form={section:function(e,t,i,n,a,s){if(!e)return!1;if("object"==(void 0===e?"undefined":_typeof(e)))return _form.section(e.type,e.name||null,e.label||null,e.value||null,e.suffix||null,e);if("object"==(void 0===t?"undefined":_typeof(t)))return _form.section(e,t,t.label||null,t.value||null,t.suffix||null,t);if("object"==(void 0===i?"undefined":_typeof(i)))return _form.section(e,t,i.label||null,i.value||null,i.suffix||null,i);if("object"==(void 0===n?"undefined":_typeof(n)))return _form.section(e,t,d,n.value||null,n.suffix||null,n);if("object"==(void 0===a?"undefined":_typeof(a)))return _form.section(e,t,d,n||null,a.suffix||null,a);s=s||{};var o=$("<dl/>").addClass(e,s.className),r=$("<dt/>").appendTo(o),l=$("<dd/>").appendTo(o),d="_input_g"+_g.inputIndex;switch(_g.inputIndex++,e){case"directory":$("<label/>").html(i).appendTo(r);break;default:a?$("<label/>").html(i).appendTo(r):$('<label for="'+d+'"/>').html(i).appendTo(r)}return _form.element(e,t,d,n,s).appendTo(l),a&&$('<label for="'+d+'"/>').html(a).appendTo(l),s.add&&l.append(s.add),l}};_form.line=_form.section,_form.element=function(e,t,i,n,a){if(!e)return!1;if("object"==(void 0===e?"undefined":_typeof(e)))return _form.element(e.type,e.name||null,e.id||null,e.value||null,e);if("object"==(void 0===t?"undefined":_typeof(t)))return _form.element(e,t,t.id||null,t.value||null,t);if("object"==(void 0===i?"undefined":_typeof(i)))return _form.element(e,t,i.id||null,i.value||null,i);if("object"==(void 0===n?"undefined":_typeof(n)))return _form.element(e,t,i,n.value||null,n);a=a||{},null===(i=i||null)&&(i="_input_g"+_g.inputIndex,_g.inputIndex++);var s=$(),o=a.default||a.defaultValue;switch(e){default:s=$("<input/>",{type:e,name:t,id:i}).val(n);break;case"select":s=$("<select/>",{name:t,id:i}).val(n);var r=$('<option value=""/>').appendTo(s);for(var l in n){if("object"==_typeof(n[l]))var d=n[l].value||n[l].val,u=$('<option value="'+d+'"/>').html(n[l].title||n[l].name).appendTo(s);else d=n[l],u=$('<option value="'+d+'"/>').html(d).appendTo(s);void 0!==o&&d==o&&u.prop("selected",!0),u.val()||u.attr("disabled",!0)}n&&n.length||r.html("..."),a.new&&($('<option value="" disabled/>').html("==========").insertAfter(r),$('<option value="___new___"/>').html("+ 新建").insertAfter(r),s.on("change.___new___",function(){"___new___"==s.val()&&(s.val(""),a.new(s))}));break;case"select_group":case"selectGroup":s=$("<select/>",{name:t,id:i}).val(n);r=$('<option value=""/>').appendTo(s);for(var l in n){var c=$('<optgroup label="'+n[l][0]+'"/>').appendTo(s);for(var h in n[l][1]){var m=n[l][1][h];if("object"==(void 0===m?"undefined":_typeof(m)))u=$('<option value="'+(void 0===m.val?m.value:m.val)+'"/>').html(m.title||m.name).appendTo(c);else u=$('<option value="'+m+'"/>').html(m).appendTo(c);void 0!==o&&u.val()==o&&u.prop("selected",!0),u.val()||u.attr("disabled",!0)}}n&&n.length||r.html("..."),a.new&&($('<option value="" disabled/>').html("==========").insertAfter(r),$('<option value="___new___"/>').html("+ 新建").insertAfter(r),s.on("change.___new___",function(){"___new___"==s.val()&&(s.val(""),a.new(s))}));break;case"checkbox":s=$("<input/>",{type:e,name:t,id:i}),"string"==typeof n&&"true"!==n.toLowerCase()?s.val(n).prop("checked",a.checked):s.prop("checked",void 0===a.checked?n:a.checked);break;case"checkboxes":for(var l in n){"object"!=(void 0===(d=n[l])?"undefined":_typeof(d))&&(d=[d,!1]),parseInt(l)&&(_g.inputIndex++,i="_input_g"+_g.inputIndex),s=s.add($('<input type="checkbox" name="'+t+'" id="'+i+'" value="'+d[0]+'" />').prop("checked",d[1])).add($('<label for="'+i+'"/>').html(d[2]||d[0]))}break;case"directory":case"file":s=$('<input type="text" name="'+t+'" id="'+i+'" />').on({input:function(){s.trigger("change")},click:function(){s.val()||f.trigger("click")}}).val(n);var p=$('<input type="file" class="none"'+("directory"==e?" nwdirectory":"")+" />").on("change",function(){s.val($(this).val()).trigger("change")}),f=$('<button type="button" value="Browse..."/>').html("Browse...").on("click",function(){p.trigger("click")}),_=s.add(p).add(f);a.accept&&p.attr("accept",a.accept)}return a.required&&s.prop("required",!0),a.onchange&&(s.on("change.___onchange___",a.onchange),a.default&&s.trigger("change")),_||s},_frame.dom={},_frame.main={last:{}},_frame.global={key_registerd:[],esc_funcs:[],allowKeyNav:!0,esc_register:function(e){_frame.global.esc_funcs.push(e)},disableBodyScroll:function(){$(document.body).on("touchmove.disableBodyScroll mousewheel.disableBodyScroll",function(e){e.preventDefault(),e.stopPropagation()})},enableBodyScroll:function(){$(document.body).off("touchmove.disableBodyScroll mousewheel.disableBodyScroll")}},_frame.global.init=function(){return!!_frame.global.is_init||(_frame.dom={layout:$("#layout")},$body.on({"keydown.esckey":function(e){if("INPUT"!=document.activeElement.tagName&&"TEXTAREA"!=document.activeElement.tagName&&"SELECT"!=document.activeElement.tagName&&!$(document.activeElement).attr("contenteditable")&&_frame.global.allowKeyNav)e.altKey||e.ctrlKey||e.metaKey||e.shiftKey||(window.event?e.keyCode:e.which).toString();else if(!_frame.global.allowKeyNav){if(!(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey))switch((window.event?e.keyCode:e.which).toString()){case"27":for(var t=0;t<_frame.global.esc_funcs.length;t++)_frame.global.esc_funcs[t]()}}}}),_frame.dom.hidden=$("<div/>",{class:"none"}).appendTo($body),_frame.dom.hiddenVisible=$("<div/>",{class:"none-visible"}).appendTo($body),_frame.dom.hiddenIframe=$("<iframe/>",{class:"none",name:"hiddeniframe"}).appendTo($body),$body.on("submit.check_submitting_status","form",function(e){var t=$(this);(t.hasClass("submitting")||t.hasClass("loading")||t.hasClass("disabled"))&&e.preventDefault()}),_frame.global.is_init=!0)};var _menu=function(e){this.settings||(this.settings=$.extend(!0,{},this.defaults,e||{}),this.init())};_menu.prototype.defaults={items:[],target:null,className:null},_menu.prototype.init=function(){var t=this;this.dom={},this.dom.menu=$('<div class="menu"/>').addClass(this.settings.className).on("click",function(){t.timeout_hideself||(t.timeout_hideself=setTimeout(function(){t.timeout_hideself=null,t.hide()},10))}),this.dom.body=$('<div class="body"/>').appendTo(this.dom.menu),this.dom.menu.on({"transitionend.menu_hide webkitTransitionEnd.menu_hide mozTransitionEnd.menu_hide":function(e){e.currentTarget==e.target&&"opacity"==e.originalEvent.propertyName&&0===parseFloat(t.dom.menu.css("opacity"))&&t.hideTrue()}});for(var e,i=0;e=this.settings.items[i];i++)if(e){switch(e){case"separator":e=$("<hr/>")}e.hasClass("donot_hide")&&e.on("click",function(){setTimeout(function(){clearTimeout(t.timeout_hideself),t.timeout_hideself=null},1)}),t.appendItem(e)}this.dom.body.find('input[type="checkbox"]+label').addClass("checkbox"),"undefined"!=typeof node&&this.dom.menu.addClass("mod-blur-shot"),_frame.menu.menus.push(this)},_menu.prototype.show=function(e,t,i){return this.showing?this:"number"==typeof e?this.show("mouse",e,t):(e=e||this.settings.target,clearTimeout(_frame.menu.timeout_hideall),_frame.menu.timeout_hideall=null,this.dom.menu.appendTo(_frame.menu.dom.container).addClass("show"),_frame.menu.dom.container.addClass("on"),this.showing=!0,this.dom.body.children().trigger("show"),this.position(e,t,i),void("undefined"!=typeof node?node.win.capturePage(this.capturePage_callback.bind(this),{format:"jpg",datatype:"datauri"}):this.dom.menu.addClass("on")))},_menu.prototype.hide=function(e){if(!this.showing)return!1;e&&(this.callback_hide=e),this.dom.menu.hasClass("on")||this.hideTrue(),this.dom.menu.removeClass("on")},_menu.prototype.hideTrue=function(){this.dom.menu.removeClass("show").css({top:"",left:""}).detach(),this.dom.blured instanceof jQuery&&(this.dom.blured.remove(),delete this.dom.blured),this.showing=!1,_frame.menu.dom.container.removeClass("on"),this.callback_hide&&this.callback_hide(),delete this.callback_hide},_menu.prototype.position=function(e,t,i){var n,a,s,o,r,l;if(e=e||this.settings.target,this.dom.menu.css({top:"",left:""}),e&&e instanceof jQuery){var d=e.offset();n=d.top+e.height()-$body.scrollTop()+(i||0),a=d.left-$body.scrollLeft()+(t||0)}else("mouse"==e||!e&&"number"==typeof t)&&(a=t||0,n=i+5||0);s=$window.height()-10,o=$window.width()-10,r=this.dom.menu.outerHeight(),l=this.dom.menu.outerWidth(),this.dom.menu.css({top:s<n+r?s-r:n,left:o<a+l?o-l:a})},_menu.prototype.appendItem=function(e){if(e instanceof jQuery)return e.appendTo(this.dom.body)},_menu.prototype.capturePage_callback=function(e){this.showing&&(this.dom.blured=$('<s class="blured"/>').css("background-image","url("+e+")").appendTo(this.dom.menu.addClass("on")))},_menu.hideAll=function(e){_frame.menu.timeout_hideall=setTimeout(function(){for(var e in _frame.menu.menus)_frame.menu.menus[e].hide&&_frame.menu.menus[e].hide();_frame.menu.timeout_hideall=null},e||1)},_frame.menu={dom:{},menus:[],init:function(){if(this.is_init)return this;this.dom.container=$('<div class="menus"/>').on({click:function(e,t){_menu.hideAll(t)},contextmenu:function(e){_frame.menu.dom.container.trigger("click"),e.preventDefault()}}).appendTo($body),$body.on("click.cancel_hideall",".menus>.menu",function(e){clearTimeout(_frame.menu.timeout_hideall),_frame.menu.timeout_hideall=null}),this.is_init=!0}},_frame.modal={dom:{},defaults:{classname:"",showBlured:!0},show:function(e,t,i,n){clearTimeout(this.hide_timeout),this.hide_timeout=null,this.dom.container.addClass("show"),this.showing=!0;var a=$.extend({},this.defaults,i);a.detach&&(this.content=e),e.appendTo(this.dom.content),a.onClose&&_frame.modal.dom.container.on("close",a.onClose),t?(this.dom.titlebar.html(t),this.dom.container.addClass("hastitle")):(this.dom.titlebar.html(""),this.dom.container.removeClass("hastitle")),this.dom.box.css({width:a.width||null,height:a.height||null}),a.showBlured&&(this.dom.blured||"undefined"==typeof node||(node.win.capturePage(function(e){_frame.modal.dom.blured=$("<img/>").attr("src",e).appendTo(_frame.modal.dom.bg)},{format:"jpg",datatype:"datauri"}),this.dom.container.addClass("mod-blur-shot"))),setTimeout(function(){_frame.modal.dom.container.addClass("on "+a.classname).data("customclass",a.classname)},0),_p.initDOM(this.dom.content),this.dom.bg.off("click.blank_to_close").on("click.blank_to_close",function(){a.blank_to_close&&_frame.modal.dom.btn_close.trigger("click")}),n&&n(this.dom.content),this.dom.content.scrollTop(0)},hide:function(){if(!this.showing)return!1;clearTimeout(this.hide_timeout),this.hide_timeout=null,this.dom.container.removeClass("on")},reset:function(){this.resetContent(),this.dom.blured&&(parseInt(this.dom.container.css("opacity"))||(this.dom.blured.remove(),this.dom.blured=null),this.dom.container.removeClass("mod-blur-shot"))},resetContent:function(){this.content&&(this.content.detach(),this.content=null),this.dom.content.empty(),this.dom.container.removeClass(this.dom.container.data("customclass")),this.dom.container.data("customclass",""),this.dom.titlebar.html(""),this.dom.container.removeClass("hastitle")}},_frame.modal.init=function(){return!!this.is_init||(this.dom.container=$('<div class="modal" />').on({"transitionend.modal_hide webkitTransitionEnd.modal_hide mozTransitionEnd.modal_hide":function(e){_frame.modal.showing&&e.currentTarget==e.target&&"opacity"==e.originalEvent.propertyName&&0==_frame.modal.dom.container.css("opacity")&&(_frame.modal.hide_timeout=setTimeout(function(){_frame.modal.reset(),_frame.modal.dom.container.removeClass("show"),_frame.modal.showing=!1,_frame.modal.dom.container.trigger("close").off("close")},10))}}).prependTo($body),this.dom.box=$("<div/>").appendTo(this.dom.container),this.dom.titlebar=$("<header/>").appendTo(this.dom.box),this.dom.content=$("<section/>").appendTo(this.dom.box),this.dom.btn_close=$('<button class="close" />').html("&times;").on("click",function(){_frame.modal.hide()}).appendTo(this.dom.box),this.dom.bg=$("<s/>").appendTo(this.dom.container),_hotkey.bind("27",function(){_frame.modal.hide()}),this.is_init=!0)},_p.tip={pos:"bottom",size_indicator:8,filters:[],countdown_fade:250,init_global:function(){if(this.is_init)return!1;this.dom=$('<div id="tip"/>').on("transitionend webkitTransitionEnd mozTransitionEnd",function(e){e.currentTarget==e.target&&"opacity"==e.originalEvent.propertyName&&0==_p.tip.dom.css("opacity")&&(_p.tip.dom.removeClass("show").css({top:"",left:""}).attr({"data-tip-indicator-pos":"","data-tip-indicator-offset-x":"","data-tip-indicator-offset-y":""}),_p.tip.dom_bluredbg&&_p.tip.dom_bluredbg.css("background-image",""))}).appendTo($body),this.dom_body=$('<div class="body"/>').appendTo(this.dom),"undefined"!=typeof node&&(this.dom.addClass("mod-blur-shot"),this.dom_bluredbg=$("<div/>").appendTo($('<div class="bluredbg"/>').appendTo(this.dom))),this.is_init=!0},show:function(e,t,i){if(!e)return!1;clearTimeout(this.timeout_fade),this.timeout_fade=null,t=t||"body",this.el=$(t),i=i||this.pos,e=this.content(e),this.init_global(),this.dom.hasClass("show")||(this.dom_bluredbg&&"undefined"!=typeof node&&node.win.capturePage(function(e){_p.tip.dom_bluredbg.css("background-image","url("+e+")")},{format:"jpg",datatype:"datauri"}),this.dom.addClass("show")),this.position(e,i),this.is_showing=!0},position:function(e,t){var i=e.hashCode();this.curContent!=i&&(this.dom.css({top:"-1000px",left:"-1000px"}),this.dom_body.html(e),_p.initDOM(this.dom_body),this.curContent=i);var n=this["pos_"+t](this.dom.outerWidth(),this.dom.outerHeight());n&&this.move(n.x,n.y)},hide:function(e){if(!this.is_init||!this.is_showing)return!1;this.timeout_fade=setTimeout(function(){_p.tip.el=null,_p.tip.dom.removeClass("on"),_p.tip.is_showing=!1,_p.tip.curContent=null,_p.tip.timeout_fade=null},e?0:this.countdown_fade)},content:function(e,t){return t=t||this.el,e},move:function(e,t){this.dom.css({top:t,left:e}).addClass("on")},get_indicator_size:function(){return this.size_indicator*_g.baseMultiper},pos_mouse:function(o,r){this.el.unbind("mousemove.tooltip").bind("mousemove.tooltip",function(e){var t=e.pageX+25,i=e.pageY+20,n=jQuery(window).innerWidth(),a=jQuery(window).innerHeight(),s=jQuery(window).scrollTop();n+jQuery(window).scrollLeft()<t+o+25&&(t=t-o-25-20),a+s<i+10+r&&(i=a+s-r-10),_p.tip.move(t,i)})},pos_bottom:function(e,t){var i=this.el,n=this.dom,a=i.offset(),s=a.left+(i.outerWidth()-n.outerWidth())/2,o=a.top+i.outerHeight()+this.get_indicator_size();return this.dom.attr("data-tip-indicator-pos","top"),this.checkpos(s,o,e,t)},pos_top:function(e,t){var i=this.el,n=this.dom,a=i.offset(),s=a.left+(i.outerWidth()-n.outerWidth())/2,o=a.top-t-this.get_indicator_size();return this.dom.attr("data-tip-indicator-pos","bottom"),this.checkpos(s,o,e,t)},pos_left:function(e,t){var i=this.el,n=this.dom,a=i.offset(),s=a.left-e-this.get_indicator_size(),o=a.top+(i.outerHeight()-n.outerHeight())/2;return this.dom.attr("data-tip-indicator-pos","right"),this.checkpos(s,o,e,t)},pos_right:function(e,t){var i=this.el,n=this.dom,a=i.offset(),s=a.left+i.outerWidth()+this.get_indicator_size(),o=a.top+(i.outerHeight()-n.outerHeight())/2;return this.dom.attr("data-tip-indicator-pos","left"),this.checkpos(s,o,e,t)},checkpos:function(e,t,i,n){var a=this.el,s=this.dom,o=a.offset(),r=e,l=t,d={x:r,y:l},u=$document.width()||$window.width();return u<e+i?d=i>o.left?{x:u-i-2,y:t}:this.pos_left(i,n):e<0&&(d=this.pos_right(i,n)),t+n>$(window).scrollTop()+$(window).height()?d=this.pos_top(i,n):t<$(window).scrollTop()&&(d=this.pos_bottom(i,n)),s.attr({"data-tip-indicator-offset-x":e-r+"px","data-tip-indicator-offset-y":t-l+"px"}),d},trigger_by_el:function(e){var t=e.data("tip");e.data("tip-filtered")||(this.filters.forEach(function(e){t=e(t)||t}),e.data({tip:t,"tip-filtered":!0})),this.show(t,e,e.data("tip-position"))}},_p.el.tip={init:function(){if(_p.el.tip.isInit)return!1;$body.on("mouseenter._tip","[data-tip]",function(){$body_preventMouseover||_p.tip.trigger_by_el($(this))}).on("mouseleave._tip","[data-tip]",function(){_p.tip.hide()}).on("click._tip","[data-tip]",function(){_p.tip.hide(!0)}).on("tipshow._tip","[data-tip]",function(){_p.tip.trigger_by_el($(this))}).on("tiphide._tip","[data-tip]",function(){_p.tip.hide()}),_p.el.tip.isInit=!0}},_p.el.links={is_init:!1,click:function(e,t){e.attr("href");if(e.hasClass("disabled"))return t&&(t.preventDefault(),t.stopImmediatePropagation(),t.stopPropagation()),!1},init:function(e){_p.el.links.is_init||($body.on("click.link_delegate","a",function(e){var t=$(this),i=t.attr("target");if("undefined"!=typeof node&&(this.hostname!=window.location.hostname&&(i="_external"),"_external"==i||"_blank"==i))return node.gui.Shell.openExternal(t.attr("href")),e.preventDefault(),!0;_p.el.links.click(t,e)}),_p.el.links.is_init=!0)}},_p.el.form={init_el:function(i){if(i.data("is_init_form_el"))return!0;i.find("textarea").on({"keyup.ctrl_enter_submit":function(e){var t=window.event?e.keyCode:e.which;switch(t=t.toString()){case"13":(e.metaKey||e.ctrlKey)&&i.submit()}}}),i.data("is_init_form_el",!0)},init:function(e,t){e=e||$body,(t=t||e.find("form")).each(function(){_p.el.form.init_el($(this))})}},_p.el.flexgrid={create:function(){var e=$('<div class="flexgrid"/>');return _p.el.flexgrid.init_el(e),e},init_el:function(e){if(e.data("is_init_flexgrid"))return!0;if(!e.data("append_before_this")){e.data("append_before_this",$('<div class="unit"/>').appendTo(e));for(var t=0;t<9;)$('<div class="unit"/>').appendTo(e),t++}e.data("is_init_flexgrid",!0)},init:function(e,t){e=e||$body,(t=t||e.find(".flexgrid")).each(function(){_p.el.flexgrid.init_el($(this))})}},jQuery.fn.extend({appendDOM:function(e){return"function"==typeof e&&(e=e()),e&&e.insertBefore(this.data("append_before_this")),this}}),$document.ready(function(){for(var e in $body=$("body"),_g.func_first)_g.func_first[e]();for(var e in _g.init(),_g.func_last)_g.func_last[e]()});var Ship=KC.Ship,Equipment=KC.Equipment,Entity=KC.Entity,Consumable=KC.Consumable,Formula=KC.formula;if(!root)var root=self;function eventName(e,t){return t=t?"."+t:"",_g.event[e]?_g.event[e].split(" ").map(function(e){return e+t}).join(" "):e+t}_g.animate_duration_delay=320,_g.inputIndex=0,_g.lang=KC.lang,_g.joint=KC.joint,_g.defaultHqLv=90,_g.shipMaxLv=Ship.lvlMax,_g.hqMaxLv=KC.maxHqLv,_g.resourcesTable=["fuel","ammo","steel","bauxite"],_g.isNWjs="undefined"!=typeof node||"undefined"!=typeof nw,_g.isWebApp=navigator.standalone||"web_app_manifest"==_g.uriSearch("utm_source"),_g.isUWP="undefined"!=typeof Windows&&void 0!==Windows.UI&&void 0!==Windows.UI.Notifications,_g.isClient=_g.isNWjs||_g.isWebApp||_g.isUWP,_g.updateDefaultHqLv=function(e){(e=parseInt(e)||_g.defaultHqLv)<=0&&(e=_g.defaultHqLv),e!=Lockr.get("hqLvDefault",_g.defaultHqLv)&&(Lockr.set("hqLvDefault",e),clearTimeout(_g.delay_updateDefaultHqLv),_g.delay_updateDefaultHqLv=setTimeout(function(){$body.trigger("update_defaultHqLv",[e]),clearTimeout(_g.delay_updateDefaultHqLv),_g.delay_updateDefaultHqLv=null},200))},_g.stats=[["fire","火力"],["torpedo","雷装"],["aa","对空"],["asw","对潜"],["bomb","爆装"],["hit","命中"],["armor","装甲"],["evasion","回避"],["los","索敌"],["range","射程"]],_g.statSpeed=KC.statSpeed,_g.statRange=KC.statRange,_g.textRank=KC.textRank,_g.getStatSpeed=KC.getStatSpeed,_g.getStatRange=KC.getStatRange,_g.getStatSpeedNumber=function(e){for(var t in _g.statSpeed)if(_g.statSpeed[t]==e)return t;return-1},_g.getSize=function(e,t){function i(e){return Math.floor(100*e)/100}return"B"==(t=t.toUpperCase())[t.length-1]&&(t=t.substr(0,t.length-1)),e/=1024,"K"==t?i(e)+"KB":(e/=1024,"M"==t?i(e)+"MB":(e/=1024,"G"==t?i(e)+"GB":(e/=1024,"T"==t?i(e)+"TB":void 0)))};var _l={},Support={_webp:function(){var e=document.createElement("canvas");return!(!e.getContext||!e.getContext("2d"))&&0==e.toDataURL("image/webp").indexOf("data:image/webp")}};Support.webp=!!_g.isClient||Support._webp(),_g.imgExt=Support.webp?"webp":"png",String.prototype.printf=function(){return"undefined"!=typeof vsprintf?vsprintf(this,Array.prototype.slice.call(arguments)):this},_g.badge=function(e,t){switch("string"==typeof t&&(t=t.toLowerCase()),t){case"error":return _g.badgeError(e);default:return _g.badgeMsg(e)}},_g.badgeMsg=function(e){_frame.dom.layout.attr("data-msgbadge",e),clearTimeout(this.timeout_badgeMsg_hiding),this.timeout_badgeMsg_hiding=setTimeout(function(){_frame.dom.layout.removeAttr("data-msgbadge"),delete _g.timeout_badgeMsg_hiding},3e3)},_g.badgeError=function(e,t){_frame.dom.layout.attr("data-errorbadge",e),clearTimeout(this.timeout_badgeError_hiding),t||(this.timeout_badgeError_hiding=setTimeout(function(){_frame.dom.layout.removeAttr("data-errorbadge"),delete _g.timeout_badgeError_hiding},3e3))},_g.pageChangeBefore=function(){_frame.dom.mobilemenu.prop("checked",!1),_frame.modal.hide()},_g.title=function(e){if(!e){var t=document.title.split(" - ");return 1==t.length?t[0]:(t.pop(),t.join(" - "))}return _frame.dom.title&&_frame.dom.title.text(!0===e?"是谁呼叫舰队":e),e},setTimeout(function(){$body.on("mousewheel",'input[type="number"]',function(e){e.target})},0),_g.index={ships:{},equipments:{}},_g.buildIndex=function(){var o={};function e(i,n){for(var e in i){var t="ships"==n?i[e].getSeriesData().map(function(e){return e.id}):[i[e].id];for(var a in t.push&&0==t.length&&(t=[i[e].id]),i[e].name)if(i[e].name[a]){var s=i[e].name[a];"suffix"!=a?function(){var e=s.toLowerCase();_g.index[n][e]||(_g.index[n][e]=[]),t.forEach(function(t){_g.index[n][e].some(function(e){return e.id==t})||_g.index[n][e].push(i[t])})}():"ships"==n&&(o[s]||(o[s]=[]),o[s].push(i[e]))}}}e(_g.data.ships,"ships"),e(_g.data.items,"equipments");var t=function(e){var t=_g.data.ship_namesuffix[e];["ja_jp","ja_romaji","zh_cn"].forEach(function(e){_g.index.ships[t[e]]=o[t.id]})};for(var i in _g.data.ship_namesuffix)t(i)},_g.search=function(e,t){t=_g.index[t];var i=[],n=[];if(!t||!e)return i;function a(e){i=i.concat(e.filter(function(e){return!(-1<n.indexOf(t+e.id))&&(n.push(t+e.id),!0)}))}for(var s in e=e.trim().toLowerCase(),t[e]&&a(t[e]),t)e!==s&&-1<s.indexOf(e)&&a(t[s]);return i},_g.searchTest=function(e,t){var i=[];for(var n in e=_g.search(e,t))i.push(e[n]._name||e[n].name[_g.lang]);return i},setTimeout(function(){document.body.addEventListener("scroll",function(e){e.target.hasAttribute("scrollbody")&&e.target.setAttribute("scrollbody",e.target.scrollTop)},!0)});var _ga={counter:function(e,t,i){if(debugmode)return!0;this.init_count?"undefined"!=typeof ga&&ga("send","pageview",{location:location.href,page:location.pathname}):this.init_count=!0}};_g.kancolle_calc={version:4,max_fleets:4,max_ships_per_fleet:6,max_equipments_per_ship:4,decode:function(e,t){if(e&&("string"==typeof e&&(e=JSON.parse(e)),"object"==(void 0===e?"undefined":_typeof(e)))){var i=void 0,n=0,a=0,s=0,o=void 0,r=void 0,l=void 0;switch(parseInt(e.version)||this.version){case 3:for(i=[],n=0;n<4;){if(o=e["f"+(n+1)],i[n]=[],o)for(a=0;a<Math.max(6,o._size);){if((r=o["s"+(a+1)])&&r.id){if(i[n][a]=[r.id,[r.lv||null,r.luck||-1],[],[],[]],r.items)for(s=0;s<_g.kancolle_calc.max_equipments_per_ship;)(l=r.items["i"+(s+1)])&&l.id?(i[n][a][2][s]=l.id,i[n][a][3][s]=l.rf||null,i[n][a][4][s]=l.rp||null):(i[n][a][2][s]=null,i[n][a][3][s]=null,i[n][a][4][s]=null),s++}else i[n][a]=null;a++}n++}if(v=e.fField)for(i[4]=[],a=0;a<3;){i[4][a]=[];var d=v["f"+(a+1)]||{};for(s=0;s<4;){i[4][a][s]=[],(b=d["i"+(s+1)])&&(i[4][a][s][0]=b.id,i[4][a][s][1]=b.rp,i[4][a][s][2]=b.rf),s++}a++}break;case 4:for(i=[],n=0;n<4;){o=e["f"+(n+1)];var u=i[n]=[];if(o)for(a=0;a<Math.max(6,o._size);){if((r=o["s"+(a+1)])&&r.id){var c=_g.data.ships[r.id],h=u[a]=[r.id,[r.lv||null,r.luck||-1],[],[],[]];if(r.items){var m=void(s=0);for(var p in r.items)if("ix"!==p){if("i"===p.substr(0,1)&&r.items[p].id){var f=r.items[p],_=parseInt(p.substr(1)),g=_<5?_-1:_;_>c.slot.length?m=f:(h[2][g]=f.id,h[3][g]=f.rf||null,h[4][g]=f.mas||null)}}else m=r.items[p];m&&m.id&&(h[2][4]=m.id,h[3][4]=m.rf||null,h[4][4]=m.mas||null)}h.forEach(function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++)e[t]||(e[t]=null)})}else u[a]=null;a++}n++}var v;if(v=e.fField)for(i[4]=[],a=0;a<3;){i[4][a]=[];d=v["f"+(a+1)]||{};for(s=0;s<4;){var b;i[4][a][s]=[],(b=d["i"+(s+1)])&&(i[4][a][s][0]=b.id,i[4][a][s][1]=b.mas,i[4][a][s][2]=b.rf),s++}a++}}return i}},encode:function(e,t){if(e&&(e.length&&e.push||(e=JSON.parse(e)),e.length&&e.push)){t=parseInt(t)||this.version;var o=void 0,n=this.max_fleets;switch(t){case 3:o={version:3},e.forEach(function(e,s){e&&(s<n?(o["f"+(s+1)]={},e.forEach(function(n,a){n&&n[0]&&(o["f"+(s+1)]["s"+(a+1)]={id:parseInt(n[0]),lv:parseInt(n[1][0])||null,luck:parseInt(n[1][1])||-1,items:{ix:{}}},n[2].forEach(function(e,t){if(e){var i=4<t?t:t+1;o["f"+(s+1)]["s"+(a+1)].items["i"+i]={id:parseInt(e)},n[3]&&(o["f"+(s+1)]["s"+(a+1)].items["i"+i].rf=parseInt(n[3][t])||0),n[4]&&(o["f"+(s+1)]["s"+(a+1)].items["i"+i].rp=parseInt(n[4][t])||0)}}))})):4==s&&(o.fField={},e.forEach(function(e,i){e&&(o.fField["f"+(i+1)]={},e.forEach(function(e,t){e&&e[0]&&(o.fField["f"+(i+1)]["i"+(t+1)]={id:e[0],rp:e[1],rf:e[2]})}))})))});break;case 4:o={version:4},e.forEach(function(e,t){if(e)if(t<n){var i=o["f"+(t+1)]={};e.forEach(function(a,e){if(a&&a[0]){var s=_g.data.ships[parseInt(a[0])],o=i["s"+(e+1)]={id:parseInt(a[0]),lv:parseInt(a[1][0])||void 0,luck:parseInt(a[1][1])||-1,items:{}};a[2].forEach(function(e,t){if(e){var i=4==t?s.slot.length<4?["i"+(s.slot.length+1)]:"ix":["i"+(4<t?t:t+1)];o.items[i]={id:parseInt(e)};var n=o.items[i];a[3]&&(n.rf=parseInt(a[3][t])||0),a[4]&&(n.mas=parseInt(a[4][t])||0)}})}})}else 4==t&&(o.fField={},e.forEach(function(e,i){e&&(o.fField["f"+(i+1)]={},e.forEach(function(e,t){e&&e[0]&&(o.fField["f"+(i+1)]["i"+(t+1)]={id:e[0],mas:e[1],rf:e[2]})}))}))})}return o}}},_g.events=[{code:"leyteB",title:{ja_jp:"捷号決戦！邀撃、レイテ沖海戦(後篇)",zh_cn:"捷号决战！迎击莱特湾海战（后篇）"},start:15108444e5,end:15217704e5}],_g.getCurrentEvent=function(t){return t instanceof Date?t=t.valueOf:"string"==typeof t?t=parseInt(t):t||(t=(new Date).valueOf()),_g.events.filter(function(e){return t>=e.start&&t<e.end})};var _config={getFullKeyname:function(e){return"config_"+e},get:function(e){if(!localStorage)return!1;e=_config.getFullKeyname(e);var t=Lockr.get(e);return"true"===t||("undefined"===t?(Lockr.rm(e),null):t)},set:function(e,t){if(!localStorage)return!1;e=_config.getFullKeyname(e),null===t&&Lockr.get(e)?Lockr.rm(e):Lockr.set(e,t)}};_frame.app_config={init:function(){if(_frame.app_config.is_init)return!0;_frame.app_config.is_init=!0}},"localhost"===location.hostname||"127.0.0.1"===location.hostname||"192"===location.hostname.split(".")[0]||-1<location.hostname.indexOf("fleet.moe")||-1<location.hostname.indexOf("fleet.test")||-1<location.hostname.indexOf("diablohu.com")||-1<location.hostname.indexOf("diablohu.test")||location.replace("http://fleet.moe"+location.pathname),_g.db_version="20190106",_g.bgimg_count=0,_g.event={animationend:"animationend webkitAnimationEnd",animationiteration:"animationiteration webkitAnimationIteration",transitionend:"transitionend webkitTransitionEnd mozTransitionEnd"},_g.path={db:"/!/db/",bgimg_dir:"/!/assets/images/homebg/",pics:{ships:"/!/pics-ships/",shipsExtra:"/!/pics-ships-extra/",items:"/!/pics/items/"}},KC.path.pics=_g.path.pics,_g.dbs=["ships","ship_types","ship_classes","ship_series","ship_namesuffix","items","item_types"],_g.data={ships:{},items:{}},KC.db=_g.data;var _db={fleets:new Nedb({filename:"fleets"})};Nedb.prototype.updateById=function(e,t,i){this._updateByIdQueue||(this._updateByIdQueue={},Object.defineProperty(this._updateByIdQueue,"running",{enumerable:!1,value:!1,writable:!0})),(t=t||{})._id=e,this._updateByIdQueue[e]={docReplace:t,callback:i||function(){}},this._updateById()},Nedb.prototype._updateById=function(){if(!this._updateByIdQueue||this._updateByIdQueue.running)return!1;var e=void 0;for(var t in this._updateByIdQueue)if(this._updateByIdQueue[t]){e=t;break}if(!e)return!1;var i=this._updateByIdQueue[e];this._updateByIdQueue[e]=null,delete this._updateByIdQueue[e],this._updateByIdQueue.running=!0,this.update({_id:e},i.docReplace,{},function(e,t){i.callback.call(this,e,t),this._updateByIdQueue.running=!1,this._updateById()}.bind(this))},_g.log=function(){console.log.apply(console,arguments)},_g.parseURI=function(e){var t=(e=e||location.pathname).split("/").filter(function(e){return e});if(!t.length)return{page:"home"};if(1==t.length)return{page:t[0]};if(2==t.length){var i=t[0];switch(i){case"ships":i="ship";break;case"equipments":i="equipment";break;case"entities":i="entity";break;case"fleets":i="fleet",t[1]=_g.uriSearch("i")||"__NEW__"}return{infos:i,id:t[1]}}},_g.state2URI=function(e){if(!e||"home"==e.page)return"/";if(e.page)return"/"+e.page+"/";if(e.infos){var t=e.infos,i="";switch(t){case"ship":t="ships";break;case"equipment":t="equipments";break;case"entity":t="entities";break;case"fleet":t="fleets",i="?i="+e.id,e.id="build"}return"/"+t+"/"+e.id+"/"+i}},_g.save=function(e,t){_g.save_||(_g.save_=document.createElement("a")),_g.save_.href=e,void 0!==_g.save_.download?_g.save_.download=t:_g.save_.target="_blank",_g.save_.click()},_g.getScriptCanvas=function(){var e=Q.defer();return $.getScript("/!/assets/lib.canvas.min.js",function(){e.resolve()}),e.promise},_g.getLink=function(e,t){return _g.state2URI({infos:e,id:t})},_g.getImg=function(e,t,i){return _g.path.pics[e]+"/"+t+"/"+i+".png"},_frame.app_main={page:{},page_dom:{},page_html:{},page_title:{},loading:["dbs","bgimgs"],functions_on_ready:[],loaded:function(e,t){_g.log(e+" loaded."),e&&-1<this.loading.indexOf(e)&&(this.loading.splice(this.loading.indexOf(e),1),this.is_loaded=!1),this.loading.length||this.is_loaded||(setTimeout(function(){!_frame.app_main.is_loaded||_frame.app_main.loading.length||$html.hasClass("app-ready")||(_frame.dom.layout.addClass("ready"),$html.addClass("app-ready"),setTimeout(function(){for(var e=0;_frame.app_main.functions_on_ready[e];)_frame.app_main.functions_on_ready[e++]()},1500))},t?300:1e3),this.window_event_bound||($window.on("popstate._global",function(e){e.originalEvent&&e.originalEvent.state?_frame.app_main.state(e.originalEvent.state):_frame.app_main.state(_g.parseURI())}).trigger("popstate._global"),this.window_event_bound=!0),this.is_loaded=!0)},pushState:function(e,t,i){history.pushState(e,t,i)},state:function(e){e.infos?_frame.infos.show_func(e.infos,e.id,null,e.infosHistoryIndex):_frame.infos.hide(),e.page&&this.load_page_func(e.page)},loading_queue:[],loading_state:{},loading_start:function(n,a,s,o,i,r){n=n||location.pathname;var e=!0;"object"==(void 0===a?"undefined":_typeof(a))?(e=void 0===a.isUrl||a.isUrl,s=a.error,o=a.successAfter,i=a.beforeSend,r=a.complete,a=a.success):!1===a&&(e=!1),i=i||function(){},a=a||function(){},o=o||function(){},s=s||function(){},r=r||function(){},this.loading_cur=n,void 0===this.loading_state[n]||"fail"==this.loading_state[n]?("fail"!=this.loading_state[n]&&(this.loading_state[n]="loading"),this.loading_queue.push(n),_frame.dom.layout.addClass("is-loading"),e&&$.ajax({url:n,type:"get",dataType:"html",beforeSend:function(e,t){i(n,e,t)},success:function(e){var t=/\<main\>(.+)\<\/main\>/.exec(e),i=/\<title\>([^\<]+)\<\/title\>/.exec(e);i&&1<i.length&&(_frame.app_main.page_title[n]=i[1]),a(t&&1<t.length?t[1]:""),n==_frame.app_main.loading_cur&&o(t&&1<t.length?t[1]:""),_frame.app_main.loading_state[n]="complete"},error:function(e,t,i){if(i=i||"",_g.log("Loading Fail: "+n+" ["+t+"] ("+i+")"),"fail"==_frame.app_main.loading_state[n]||-1<["Bad Request","Not Found","Forbidden"].indexOf(i))return _frame.app_main.loading_fail(n,t,i,s);_frame.app_main.loading_state[n]="fail"},complete:function(e,t){_frame.app_main.loading_complete(n),r(n,e,t),"fail"==_frame.app_main.loading_state[n]&&(console.log("retry"),n+=("/"==n.substr(n.length-1)?"":"/")+"index.html",_frame.app_main.loading_start(n,a,s,o,i,r))}})):"complete"==this.loading_state[n]&&(a(),o())},loading_complete:function(e){if(e){e==this.loading_cur&&(this.loading_cur=null);var t=this.loading_queue.indexOf(e);0<=t&&this.loading_queue.splice(t,1),this.loading_queue.length||_frame.dom.layout.removeClass("is-loading")}},loading_fail:function(e,t,i,n){if(e)return this.loading_state&&delete this.loading_state[e],_frame.dom.layout.attr("data-errorbadge",e+" 载入失败 ("+i+")"),clearTimeout(this.loading_fail_timeout_errorbadge),this.loading_fail_timeout_errorbadge=setTimeout(function(){_frame.dom.layout.removeAttr("data-errorbadge"),delete _frame.app_main.loading_fail_timeout_errorbadge},3e3),console.log(n),n(e,t,i)},load_page:function(e,t){if(this.cur_page==e||!e)return e;t=t||{},this.pushState({page:e},null,_g.state2URI({page:e})),this.load_page_func(e,t)},load_page_func:function(t,e){if(_g.pageChangeBefore(),_g.log("PREPARE LOADING: "+t),e=e||{},!t)return t;var i=!1;if("donate"==t&&(i=!0),this.cur_page?i=!0:this.nav.forEach(function(e){t==e.page&&(i=!0)}),!i)return t=this.nav[0].page,this.load_page(t,e),t;var n=_g.state2URI({page:t});function a(){if(_frame.infos.hide(),e.callback_modeSelection_select||(document.title=_frame.app_main.page_title[n],_g.title(_frame.app_main.navtitle[t]||!0),_ga.counter(location.search)),_frame.app_main.cur_page==t)return t;Page.show(t),e.callback_modeSelection_select||"about"!=t&&Lockr.set("last_page",t),_g.log("LOADED: "+t),e.callback_modeSelection_select?_frame.app_main.page_dom[t].trigger("modeSelectionEnter",[e.callback_modeSelection_select||function(){},e.callback_modeSelection_enter||function(){}]):_frame.app_main.mode_selection_off()}this.page_dom[t]?a():(this.page_dom[t]=_frame.dom.main.find('.page-container[page="'+t+'"]'),this.page_dom[t].length?(Page.init(t),this.page_title[n]=document.title,a()):this.loading_start(n,{success:function(e){e&&(_frame.app_main.page_dom[t]=$(e).appendTo(_frame.dom.main),n!=location.pathname&&_frame.app_main.page_dom[t].addClass("off"),Page.init(t))},successAfter:a,error:function(){delete _frame.app_main.page_dom[t],history.back()}}))},init:function(){if(this.is_init)return!0;_frame.dom.mobilemenu=_frame.dom.layout.children("#view-mobile-menu"),_frame.dom.logo=$('<div class="logo"/>').on(_g.event.animationend,function(){_frame.dom.logo.addClass("ready-animated")}).appendTo(_frame.dom.layout),_frame.dom.nav=_frame.dom.layout.children("nav"),_frame.dom.navlinks=_frame.dom.nav.children(".pages"),_frame.dom.globaloptions=_frame.dom.nav.children("section.options").append($('<button class="show_only_bg" icon="images"/>').on("click",function(){BgImg.controlsToggle()})),_g.isClient&&(_frame.dom.btnsHistory=$('<div class="history"/>').insertBefore(_frame.dom.navlinks),_frame.dom.btnHistoryBack=$('<button class="button back" icon="arrow-set2-left"/>').on({click:function(){_frame.dom.btnHistoryForward.removeClass("disabled"),history.back()}}).appendTo(_frame.dom.btnsHistory),_frame.dom.btnHistoryForward=$('<button class="button forward disabled" icon="arrow-set2-right"/>').on("click",function(){history.forward()}).appendTo(_frame.dom.btnsHistory)),_frame.dom.main=_frame.dom.layout.children("main"),_frame.dom.title=_frame.dom.nav.children(".title").children("span"),$('<div class="nav-mask"/>').appendTo(_frame.dom.layout).on("click",function(){_frame.dom.mobilemenu.prop("checked",!1)});var e=Q.fcall(function(){});this.nav=[],this.navtitle={},e.then(function(){return _frame.dom.navs={},_frame.dom.navlinks.find("a").each(function(e,t){t=$(t);var i=_g.parseURI(t.attr("href")).page,n=t.text();_frame.app_main.nav.push({title:n,state:t.attr("mod-state"),page:i}),_frame.app_main.navtitle[i]=n,t.hasClass("button")||(t=t.parent()),_frame.dom.navs[i]=t.on("click",function(){Page.resetScroll(i)})}),_frame.app_main.nav}).then(BgImg.init).then(function(){_g.log("Preload All DBs (JSON ver.): START");var e=Q(),t=Q.defer();return _g.dbs.forEach(function(n){e=e.then(function(){var i=Q.defer();return $.ajax({url:"/!/db/"+n+".nedb?v="+_g.db_version,dataType:"text",success:function(e){var t=(e=LZString.decompressFromBase64(e)).split("\n");void 0===_g.data[n]&&(_g.data[n]={}),t.forEach(function(e){if(e){var t=JSON.parse(e);switch(n){case"ships":_g.data[n][t.id]=new Ship(t);break;case"items":_g.data[n][t.id]=new Equipment(t);break;case"entities":_g.data[n][t.id]=new Entity(t);break;default:_g.data[n][t.id]=t}}})},complete:function(e,t){i.resolve()}}),i.promise})}),e=e.catch(function(e){console.log(e)}).done(function(){_g.log("Preload All DBs (JSON ver.): DONE"),t.resolve()}),t.promise}).then(function(){_g.log("Preload All DBs: START");var e=[],s=[],o=0;for(var t in _db)s.push(t);return s.forEach(function(n){var a=Q.defer();_db[n].loadDatabase(function(e){e?a.reject(new Error(e)):_db[n].find({},function(e,t){var i;e?a.reject(new Error(e)):(void 0===_g.data[n]&&(_g.data[n]={}),t.forEach(function(e){_g.data[n][e.id]=e}),i=n,_g.log("DB "+i+" DONE"),a.resolve(),++o>=s.length&&(_g.log("Preload All DBs: DONE"),setTimeout(function(){_frame.app_main.loaded("dbs")},100)))})}),e.push(a.promise)}),Q.all(e)}).then(function(){return $body.on("click.global_delegate_page",'a[href^="?page="]',function(e){e.preventDefault(),_frame.app_main.load_page($(this).attr("href").substr("?page=".length))}).on("click.global_delegate_infos",'a[href^="?infos="]',function(e){e.preventDefault();var t=$(this);if(!t.attr("data-infos")){var i=/^[\?]{0,1}infos\=([^\&]+)\&id\=([^\&]+)/gi.exec(t.attr("href"));t.attr("data-infos","[["+i[1].toUpperCase()+"::"+i[2]+"]]"),_frame.infos.click(t)}}).on("click.global_delegate_default",'a[href^="/"]',function(e){e.preventDefault();var t=$(this),i=_g.parseURI(t.attr("href"));i.page?_frame.app_main.load_page(i.page):i.infos&&_frame.infos.click(t.attr("data-infos","[["+i.infos.toUpperCase()+"::"+i.id+"]]"))}).on("click.global_external_links pointerdown.global_external_links",'a:not([target]):not([href^="/"]):not([href^="javascript:"])',function(e){if(e.currentTarget.getAttribute("href").indexOf("//"+location.host)<0)return e.currentTarget.setAttribute("target","_blank")}),!0}).then(function(){_frame.gg(_frame.dom.layout)}).catch(function(e){_g.error(e)}).done(function(){_g.buildIndex(),_g.log("Global initialization DONE")}),this.is_init=!0}};var debugmode=!(_g.error=function(e){e instanceof Error||(e=new Error(e)),_g.badgeError(e instanceof Error?e.message:e),_g.log(e)});_g.ship_type_order_full=[6,7,18,20,8,10,11,9,4,23,5,2,28,3,1,19,13,14,17,12,24,15,21,16,29,25,26,27];var ShareBar=function(){function i(e){return _classCallCheck(this,i),e=e||{},this.settings=$.extend(!0,{},i.defaults,e),this.el=this.create(),this}return _createClass(i,[{key:"create",value:function(){return this.el=$('<div class="sharebar"/>'),this.settings.sites.forEach(function(e){var t=$("<a/>",{class:"sharebar-share sharebar-site-"+e,"data-share-site":e,href:"javascript:;",target:"_self",icon:i.iconmap[e]||e}).appendTo(this.el);this.settings.modifyItem&&this.settings.modifyItem(t)}.bind(this)),this.el.on("click.sharebar-share","a[data-share-site]",function(e,t){var i=$(e.target),n=i.attr("data-share-site");i.attr({href:"http://s.jiathis.com/?webid="+n+"&url="+encodeURIComponent(this.getContent("url",location.href))+"&title="+encodeURIComponent(this.getContent("title",document.title))+"&summary="+encodeURIComponent(this.getContent("summary",$('meta[name="description"]').attr("content")))+(this.settings.uid?"&uid="+this.settings.uid:"")+(this.settings.appkey[n]?"&appkey="+this.settings.appkey[n]:"")+"&shortUrl=true",target:"_blank"})}.bind(this)),this.el}},{key:"getContent",value:function(e,t){return"function"==typeof this.settings[e]?this.settings[e](this):this.settings[e]?this.settings[e]:t}}]),i}();ShareBar.defaults={sites:["tsina","tqq","cqq","twitter","tieba"],appkey:{}},ShareBar.iconmap={tsina:"weibo",tqq:"tencent-weibo",cqq:"qq"},_tmpl.improvement=function(e,t,i,n){if(void 0===e)return!1;if("object"!=(void 0===e?"undefined":_typeof(e))&&!(e=_g.data.items[e]))return!1;t=t||0,i=i||[0],n=n||!1;var a=e.improvement[t],s=!!a.upgrade&&_g.data.items[a.upgrade[0]],o=[],r="";if(i.forEach(function(e){var t=a.req[e];t[1]&&o.mergeFrom(t[1])}),o.length){var l=[];o.forEach(function(e){l.push('<a href="?infos=ship&id='+e+'" data-infos="[[SHIP::'+e+']]" data-tip="[[SHIP::'+e+']]">'+_g.data.ships[e].getName()+"</a>")}),r="<font>"+l.join(" / ")+"</font>"}else r='<font class="no">'+(0<=a.resource[0][0]?"无秘书舰":"未知")+"要求</font>";return _tmpl.export('<span class="improvement">'+_tmpl.improvement__title(e,s,a.upgrade[1])+r+_tmpl.improvement__resource(a,!!s)+"</span>",n)},_tmpl.improvement_detail=function(n,e){if(void 0===n)return!1;if("object"!=(void 0===n?"undefined":_typeof(n))&&!(n=_g.data.items[n]))return!1;var a="";return(n.improvement||[]).forEach(function(e){var t=!!e.upgrade&&_g.data.items[e.upgrade[0]],i=this.improvement__reqdetails(e.req,0<=e.resource[0][0]);a+='<span class="improvement improvement-details">'+_tmpl.improvement__resource(e,!!t)+_tmpl.improvement__title(n,t,e.upgrade[1])+i+"</span>"},this),_tmpl.export(a,e)},_tmpl.improvement_inEquipmentInfos=function(e,t){if(void 0===e)return!1;if("object"!=(void 0===e?"undefined":_typeof(e))&&!(e=_g.data.items[e]))return!1;var n="";return(e.improvement||[]).forEach(function(e){var t=!!e.upgrade&&_g.data.items[e.upgrade[0]],i=this.improvement__reqdetails(e.req,0<=e.resource[0][0]);n+='<span class="unit improvement improvement-details"><b>'+(t?'<span class="indicator true">可升级为</span><a class="equiptypeicon mod-left mod-'+t.getIconId()+'" href="?infos=equipment&id='+t.id+'" data-infos="[[EQUIPMENT::'+t.id+']]" data-tip="[[EQUIPMENT::'+t.id+']]">'+t.getName(!0)+"</a>"+(e.upgrade[1]?"<i>+"+e.upgrade[1]+"</i>":""):'<span class="indicator false">不可升级</span>')+"</b>"+i+_tmpl.improvement__resource(e,!!t)+"</span>"},this),_tmpl.export(n,t)},_tmpl.improvement__title=function(e,t,i){var n=function(e){return e.replace(/舰本/g,"")};return'<strong><a class="equiptypeicon mod-left mod-'+e.getIconId()+'" href="?infos=equipment&id='+e.id+'" data-infos="[[EQUIPMENT::'+e.id+']]" data-tip="[[EQUIPMENT::'+e.id+']]">'+n(e.getName(!0))+"</a>"+(t?'<b></b><a class="equiptypeicon mod-left mod-'+t.getIconId()+'" href="?infos=equipment&id='+t.id+'" data-infos="[[EQUIPMENT::'+t.id+']]" data-tip="[[EQUIPMENT::'+t.id+']]">'+n(t.getName(!0))+"</a>"+(i?"<i>+"+i+"</i>":""):"")+"</strong>"},_tmpl.improvement__resource=function(e,t){function s(e){return(e=parseInt(e))<0?"?":e}var i={};i.all='<span><em>必要资源</em><i class="fuel">'+s(e.resource[0][0])+'</i><i class="ammo">'+s(e.resource[0][1])+'</i><i class="steel">'+s(e.resource[0][2])+'</i><i class="bauxite">'+s(e.resource[0][3])+"</i></span>";for(var n=1;n<4;n++){var a="";switch(n){case 1:a="★+0 ~ +6";break;case 2:a="★+6 ~ MAX";break;case 3:a="升级"}var o=e.resource[n][4]||[];Array.isArray(e.resource[n][4])||(o=[[e.resource[n][4],e.resource[n][5]||0]]),o=(o=o.filter(function(e){return e[1]})).length?'<span class="items">'+o.map(function(e){var t=e[0],i=e[1],n="";if(isNaN(t)){var a=/^consumable_([0-9]+)/.exec(t);if(a&&1<a.length)n='<i class="consumable">'+_g.data.consumables[a[1]]._name+"<i>x"+s(i)+"</i></i>"}else n='<a class="equiptypeicon mod-left mod-'+_g.data.items[t].getIconId()+'" href="?infos=equipment&id='+t+'" data-infos="[[EQUIPMENT::'+t+']]" data-tip="[[EQUIPMENT::'+t+']]">'+_g.data.items[t].getName(!0)+"<i>x"+s(i)+"</i></a>";return'<span class="item">'+n+"</span>"}).join("")+"</span>":"",i[n]="<span><em>"+a+"</em>"+(3!=n||t?'<i class="dev_mat">'+s(e.resource[n][0])+"<i>("+s(e.resource[n][1])+')</i></i><i class="imp_mat">'+s(e.resource[n][2])+"<i>("+s(e.resource[n][3])+")</i></i>"+o:'<i class="no">-</i>')+"</span>"}return"<span>"+i.all+i[1]+i[2]+i[3]+"</span>"},_tmpl.improvement__reqdetails=function(e,a){if(!e||!e.push||!e.length)return"";var s="<font>";return e.forEach(function(e){var t,i=[];s+="<b>";for(var n=0;n<7;n++){switch(n){case 0:t="日";break;case 1:t="一";break;case 2:t="二";break;case 3:t="三";break;case 4:t="四";break;case 5:t="五";break;case 6:t="六"}s+="<i"+(e[0][n]?' class="on"':"")+">"+t+"</i>"}e[1]?(e[1].forEach(function(e){i.push('<a href="?infos=ship&id='+e+'" data-infos="[[SHIP::'+e+']]" data-tip="[[SHIP::'+e+']]">'+_g.data.ships[e].getName()+"</a>")}),s+=i.join(" / ")):s+="<b>"+(a?"无秘书舰":"未知")+"要求</b>",s+="</b>"}),s+="</font>"},_tmpl.link_entity=function(e,t,i,n){if(!e)return!1;if(t&&"object"==(void 0===t?"undefined":_typeof(t)))return _tmpl.link_entity(e,t.tagName||null,t.returnHTML||null,t.count||null);if(t=t||"a",i=i||!1,n=void 0!==n&&n,"object"!=(void 0===e?"undefined":_typeof(e))){var a=parseInt(e);e=_g.data.entities[a]}else a=e.id;return _tmpl.export("<"+t+("a"==t?' href="?infos=entity&id='+a+'"':"")+' class="link_entity" data-entityid="'+a+'" data-infos="[[ENTITY::'+a+']]">'+(e.picture&&e.picture.avatar?'<i style="background-image:url('+e.picture.avatar+')"></i>':"<i></i>")+"<span>"+e._name+(void 0===n?"":" <small>("+n+")</small>")+"</span></"+t+">",i)},_tmpl.link_equipment=function(e,t,i,n){if(!e)return!1;if(t&&"object"==(void 0===t?"undefined":_typeof(t)))return _tmpl.link_equipment(e,t.tagName||null,t.returnHTML||null,void 0===t.improvementStar?null:t.improvementStar);if(t=t||"a",i=i||!1,n=void 0===n?null:n,"object"!=(void 0===e?"undefined":_typeof(e))){var a=parseInt(e);e=_g.data.items[a]}else a=e.id;return _tmpl.export("<"+t+("a"==t?' href="?infos=equipment&id='+a+'"':"")+' class="link_equipment" data-equipmentid="'+a+'" data-tip-position="right" data-infos="[[EQUIPMENT::'+a+']]" data-tip="[[EQUIPMENT::'+a+']]"><i style="background-image:url(assets/images/itemicon/'+e.getIconId()+'.png)"></i><span>'+e.getName(!0)+"</span>"+(null==n?"":10<=n?'<em class="max"></em>':n<=0?'<em class="zero">+0</em>':"<em>+"+n+"</em>")+"</"+t+">",i)},_tmpl.link_ship=function(e,t,i,n,a){if(!e)return!1;if(t&&"object"==(void 0===t?"undefined":_typeof(t)))return _tmpl.link_ship(e,t.tagName||null,t.returnHTML||null,t.mode||null,t.extraIllust||null);if(t=t||"a",i=i||!1,n=n||"default","object"!=(void 0===e?"undefined":_typeof(e))){var s=parseInt(e);e=_g.data.ships[s]}else s=e.id;var o="",r=e.getType(),l=!1;switch(n){case"names":var d=[];e.getSeriesData().forEach(function(e){var t=_g.data.ships[e.id].getNameNoSuffix();$.inArray(t,d)<0&&d.push(t)}),o=d.join(" / ");break;default:o=(r?"<small>"+r+"</small>":"")+e.getName(_g.joint)}if(a){var u=e.getSeriesData();u.forEach(function(e,t){if(!(l=!!(e.illust_extra&&e.illust_extra.length&&e.illust_extra[0]))&&e.illust_delete){var i=t?u[t-1]:null;i&&(l=!!(i.illust_extra&&i.illust_extra.length&&i.illust_extra[0]))}})}return _tmpl.export("<"+t+("a"==t?' href="'+_g.getLink("ships",s)+'"':"")+' class="link_ship" data-shipid="'+s+'" data-infos="[[SHIP::'+s+']]"'+(l?' icon="hanger"':"")+'><img src="'+_g.getImg("ships",s,0)+'"/><span>'+o+"</span></"+t+">",i)},_tmpl.textlink_entity=function(e,t,i){if(!e)return!1;if(t&&"object"==(void 0===t?"undefined":_typeof(t)))return _tmpl.textlink_entity(e,t.tagName||null,t.returnHTML||null);if(t=t||"a",i=i||!1,"object"!=(void 0===e?"undefined":_typeof(e))){var n=parseInt(e);e=_g.data.entities[n]}else n=e.id;return _tmpl.export("<"+t+("a"==t?' href="?infos=entity&id='+n+'"':"")+' data-entityid="'+n+'" data-infos="[[ENTITY::'+n+']]">'+e._name+"</"+t+">",i)},_tmpl.textlink_ship=function(e,t,i){if(!e)return!1;if(t&&"object"==(void 0===t?"undefined":_typeof(t)))return _tmpl.textlink_ship(e,t.tagName||null,t.returnHTML||null);if(t=t||"a",i=i||!1,"object"!=(void 0===e?"undefined":_typeof(e))){var n=parseInt(e);e=_g.data.ships[n]}else n=e.id;var a=e.getType();return _tmpl.export("<"+t+("a"==t?' href="?infos=ship&id='+n+'"':"")+' data-shipid="'+n+'" data-infos="[[SHIP::'+n+']]">'+(a?"["+a+"] ":"")+e.getName(_g.joint)+"</"+t+">",i)};var Page=function(){function t(e){_classCallCheck(this,t),e.on({pageHide:function(){this.modeSelectionExit()}.bind(this)})}return _createClass(t,[{key:"modeSelectionEnter",value:function(e,t){var i;return e=e||function(){},i=function(){e(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7],arguments[8],arguments[9],arguments[10]),setTimeout(function(){this.modeSelectionExit()}.bind(this),10)}.bind(this),_frame.app_main.mode_selection_callback=i,_frame.app_main.mode_selection_on(t),i}},{key:"modeSelectionExit",value:function(){if(!_frame.dom.layout.hasClass("mode-selection"))return!1;_frame.app_main.mode_selection_off()}}]),t}();Page.hide=function(e){if("string"==typeof(e=e||_frame.app_main.cur_page))_frame.app_main.page_dom[e]&&_frame.app_main.page_dom[e].addClass("off").trigger("pageHide").detach(),_frame.dom.navs[e]&&_frame.dom.navs[e].removeClass("on");else{e.addClass("off").trigger("pageHide").detach();var t=e.attr("page");t&&_frame.dom.navs[t]&&_frame.dom.navs[t].removeClass("on")}_frame.app_main.cur_page=null},Page.show=function(e){var t=void 0;"string"==typeof(e=e||_frame.app_main.cur_page)?(_frame.app_main.page_dom[e]&&_frame.app_main.page_dom[e].appendTo(_frame.dom.main).removeClass("off").trigger("pageShow"),_frame.dom.navs[e]&&_frame.dom.navs[e].addClass("on"),t=e):(e.appendTo(_frame.dom.main).removeClass("off").trigger("pageShow"),t=e.attr("page")),_frame.app_main.cur_page&&Page.hide(_frame.app_main.cur_page),t&&(_frame.dom.navs[t]&&_frame.dom.navs[t].addClass("on"),_frame.dom.layout.attr("data-theme",t),_frame.app_main.cur_page=t)},Page.resetScroll=function(e){"string"==typeof(e=e||_frame.app_main.cur_page)&&(e=_frame.app_main.page_dom[e]),e&&e.length&&(e.attr("scrollbody",0),e.find("[scrollbody]").each(function(e,t){t.setAttribute("scrollbody",0)}))},Page.init=function(e){var t=void 0;"string"==typeof(e=e||_frame.app_main.cur_page)?(t=e,e=_frame.app_main.page_dom[e]):(e.appendTo(_frame.dom.main).removeClass("off").trigger("pageShow"),t=e.attr("page")),e&&e.length&&(t&&_frame.app_main.page[t]&&_frame.app_main.page[t].init&&_frame.app_main.page[t].init(e),_p.initDOM(e),e.on({"pageShow.scrollbody":function(){e.scrollTop(e.attr("scrollbody")||0),e.find("[scrollbody]").each(function(e,t){t.scrollTop=t.getAttribute("scrollbody")||0})}}))},_frame.app_main.page.fleets={init:function(e){this.object=new(function(e){function i(e){_classCallCheck(this,i);var t=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return e.on({pageShow:function(){this.inited&&e.children(".tablelist").data("tablelist").refresh(),this.inited=!0}}),t}return _inherits(i,Page),i}())(e)}},_frame.app_main.page.ships={init:function(e){this.object=new(function(e){function i(e){_classCallCheck(this,i);var t=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return t.tablelist=e.find(".tablelist"),t.tablelistObj=t.tablelist.data("tablelist"),e.on({modeSelectionEnter:function(e,t){this.modeSelectionEnter(t)}.bind(t),pageShow:function(){this.tablelistObj||(this.tablelistObj=this.tablelist.data("tablelist")),this.tablelistObj.onEnter()}.bind(t),pageHide:function(){this.tablelistObj&&(this.tablelistObj.search(),this.tablelistObj.dom.searchInput.val(""),this.tablelistObj.onExit())}.bind(t)}),t}return _inherits(i,Page),i}())(e)}},_frame.app_main.page.equipments={init:function(e){this.object=new(function(e){function i(e){_classCallCheck(this,i);var t=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return t.tablelist=e.find(".tablelist"),t.tablelistObj=t.tablelist.data("tablelist"),e.on({modeSelectionEnter:function(e,t,i){this.modeSelectionEnter(t,i)}.bind(t),pageShow:function(){this.tablelistObj||(this.tablelistObj=this.tablelist.data("tablelist")),this.tablelistObj&&(this.tablelistObj.thead_redraw(),this.tablelistObj.apply_types())}.bind(t),pageHide:function(){TablelistEquipments.types=[],TablelistEquipments.shipId=null,this.tablelistObj&&this.tablelistObj.apply_types()}.bind(t)}),t}return _inherits(i,Page),i}())(e)}},_frame.app_main.page.arsenal={},_frame.app_main.page.arsenal.init=function(e){e.find(".akashi").attr({animation:Math.floor(3*Math.random()+1)}).on(_g.event.animationiteration,function(e){e.target.setAttribute("animation",Math.floor(3*Math.random()+1))}),this.elMain=e.children(".main"),this.parse_weekday(this.elMain.children(".body-weekday")),this.parse_all(this.elMain.children(".body-all")),e.find('input[type="radio"]').on("change",function(){_frame.app_main.page.arsenal.elMain.scrollTop(0)})},_frame.app_main.page.arsenal.parse_weekday=function(e){var t=e.find("#arsenal_weekday-showmeterials");t.prop("checked",!!Lockr.get("arsenal_weekday-showmeterials",!0)).on("change",function(){Lockr.set("arsenal_weekday-showmeterials",t.prop("checked")?1:0)});var i=new Date;return i.setTime(i.getTime()+60*i.getTimezoneOffset()*1e3),i.setTime(i.getTime()+324e5),e.find("#arsenal_weekday-"+i.getDay()).prop("checked",!0),e},_frame.app_main.page.arsenal.parse_all=function(e){},_frame.app_main.page.about={},_frame.app_main.page.about.journal_parse=function(e){for(var t,i=/\[\[([^\:]+)\:([0-9]+)\]\]/gi,n=markdown.toHTML(e);null!==(t=i.exec(e));)try{n=n.replace(t[0],_tmpl["link_"+t[1].toLowerCase()](t[2],null,!0))}catch(e){}for(t=null,i=/\[\[([^\:]+)\:([0-9]+)\:TEXT\]\]/gi;null!==(t=i.exec(e));)try{n=n.replace(t[0],_tmpl["textlink_"+t[1].toLowerCase()](t[2],null,!0))}catch(e){}return n},_frame.app_main.page.about.journaltitle=function(e,t){return t=t||"h3","<h3>"+((e=e||{}).hotfix?"HOTFIX - ":"")+("app"==e.type?"":("app-db"==e.type?"DB":e.type).toUpperCase()+" / ")+e.version+"<small>"+(e.date?e.date:"WIP")+"</small></h3>"},_frame.app_main.page.about.init=function(t){var i=0;function n(e){new Journal(e).genSection(i<3).appendTo(t),i++}Q.fcall(function(){}).then(function(){var i=Q.defer();return _db.updates.find({date:""}).sort({date:-1,version:-1}).exec(function(e,t){t.forEach(function(e){n(e)}),i.resolve(e)}),i.promise}).then(function(){var i=Q.defer();return _db.updates.find({$not:{date:""}}).sort({date:-1,version:-1}).exec(function(e,t){t.forEach(function(e){n(e)}),i.resolve(e)}),i.promise})};var Journal=function(){function t(e){_classCallCheck(this,t),this.data=e}return _createClass(t,[{key:"genTitle",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"h3";return $("<"+e+">"+(this.data.hotfix?"[hotfix] ":"")+("app"==this.data.type?"":("app-db"==this.data.type?"DB":this.data.type).toUpperCase())+("app"==this.data.type?this.data.version:"")+"<small>"+(this.data.date?this.data.date:"WIP")+"</small></"+e+">")}},{key:"genContent",value:function(){for(var e=this.data.journal,t=void 0,i=/\[\[([^\:]+)\:([0-9]+)\]\]/gi,n=markdown.toHTML(e);null!==(t=i.exec(e));)try{n=n.replace(t[0],_tmpl["link_"+t[1].toLowerCase()](t[2],null,!0))}catch(e){}for(t=null,i=/\[\[([^\:]+)\:([0-9]+)\:TEXT\]\]/gi;null!==(t=i.exec(e));)try{n=n.replace(t[0],_tmpl["textlink_"+t[1].toLowerCase()](t[2],null,!0))}catch(e){}return this.content=$(n),this.content}},{key:"genSection",value:function(e){var t=this,i="update_journal_"+this.data._id,n=$('<input type="checkbox" id="'+i+'"/>').prop("checked",!!e).on("change",function(e){e.target.checked&&t.show()});return this.section=$('<section class="update_journal" data-version-'+this.data.type+'="'+this.data.version+'"/>').append($('<label for="'+i+'"/>').append(this.genTitle())),e&&this.show(),this.section.add(n.insertBefore(this.section))}},{key:"show",value:function(){this.content||this.genContent().appendTo(this.section)}}]),t}();_frame.app_main.page.calctp={init:function(e){e.find("form.tpcalculator").each(function(e,r){var l=(r=$(r)).find(".result_a"),d=r.find(".result_s");r.on("input","input",function(){r.trigger("submit")}).on("submit",function(e){e.preventDefault();var t,i,n=r.serializeObject(),a={ship:{},equipment:{}};for(var s in n){var o=parseInt(n[s])||0;switch(s){case"e75":a.equipment[75]=o;break;case"e68":a.equipment[68]=o;break;case"e145":a.equipment[145]=o;break;case"e150":a.equipment[150]=o;break;case"e166":a.equipment[166]=o;break;case"e167":a.equipment[167]=o;break;case"e26":a.equipment[26]=o;break;case"e62":a.equipment[62]=o;break;default:a.ship[s]=o}}t=.7*(i=Math.floor(Formula.calc.TP(a))),d.html(i),l.html(Math.floor(t))})})}},_frame.gg=function(){$.ajax({url:"http://fleet.moe/!/g/",method:"get",dataType:"html",success:function(e){_g.isOnline=!0,e&&_frame.dom.layout.append($('<div class="g"/>').html(e).append($('<button type="button" class="close"/>').on("click",function(){_frame.dom.layout.css("padding-bottom","").removeClass("mod-g")}))).addClass("mod-g")}})};var BgImg=function(){function n(e){_classCallCheck(this,n),e=e||{},$.extend(!0,this,n.defaults,e)}return _createClass(n,[{key:"show",value:function(){return n.change(this)}},{key:"save",value:function(){return n.save(this)}},{key:"append",value:function(){this.isDefault?n.controlsEls.listDefault&&this.elThumbnail.appendTo(n.controlsEls.listDefault):n.controlsEls.listCustomAdd&&this.elThumbnail.insertBefore(n.controlsEls.listCustomAdd),n.cur&&n.cur.name===this.name&&this.elThumbnail.addClass("on")}},{key:"delete",value:function(){n.delete(this)}},{key:"filename",get:function(){return this.isDefault?this.name.substr(1):this.name}},{key:"index",get:function(){var i=-1;return n.list.some(function(e,t){return e.name===this.name&&(i=t),e.name===this.name}.bind(this)),i}},{key:"els",get:function(){return this._els||(this._els=$('<s class="bgimg"/>').css("background-image","url("+this.path+")").add($('<s class="bgimg"/>').css("background-image","url("+this.blur+")")).add($('<s class="bgimg"/>').css("background-image","url("+this.blur+")")).add($('<s class="bgimg"/>').css("background-image","url("+this.blur+")"))),this._els}},{key:"elThumbnail",get:function(){return this._elThumbnail||(this._elThumbnail=$("<dd/>").on("click",function(){n.change(this)}.bind(this)).append($("<s/>").css("background-image","url("+this.thumbnail+")")).append($("<i/>").on("click",function(e){e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),this.visible=!this.visible}.bind(this))),this.isDefault||this._elThumbnail.append($("<del/>").on("click",function(e){e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),this.delete()}.bind(this)))),this._elThumbnail}},{key:"path",get:function(){return this._path||(this._path=n.getPath(this)),this._path}},{key:"blur",get:function(){return this._blured||(this._blured=n.getPath(this,"blured")),this._blured}},{key:"thumbnail",get:function(){return this._thumbnail||(this._thumbnail=n.getPath(this,"thumbnail")),this._thumbnail}},{key:"visible",get:function(){return this.elThumbnail.hasClass("is-visible")},set:function(e){e?this.visible||(this.elThumbnail.addClass("is-visible"),n.listVisible.push(this),n.namesHidden.forEach(function(e,t){e===this.name&&n.namesHidden.splice(t,1)}.bind(this))):this.visible&&(this.elThumbnail.removeClass("is-visible"),n.listVisible.forEach(function(e,t){e===this&&n.listVisible.splice(t,1)}.bind(this)),n.namesHidden.push(this.name)),Lockr.set("BgImgHidden",n.namesHidden)}}]),n}();BgImg.default={isEnable:!0},BgImg.list=[],BgImg.listVisible=[],BgImg.countCustom=0,BgImg.init=function(){if(BgImg.isInit)return BgImg.list;_g.log("背景图: START"),BgImg.controlsInit(),_frame.dom.bgimg=$('<div class="bgimgs"/>').appendTo(_frame.dom.layout).on(_g.event.animationend,"s",function(){BgImg.changeAfter()});var e=Q.defer(),t=void 0;return BgImg.namesHidden=Lockr.get("BgImgHidden",[]),Q.fcall(BgImg.getDefaultImgs).then(function(){BgImg.list.forEach(function(e){-1<BgImg.namesHidden.indexOf(e.name)?e.visible=!1:e.visible=!0}),BgImg.ensureVisible(),BgImg.listVisible.some(function(e){return t||e.name==Lockr.get("BgImgLast","")||(t=e),e.name==Lockr.get("BgImgLast","")}),Lockr.set("BgImgLast",BgImg.listVisible[0].name),BgImg.change(t),_frame.app_main.loaded("bgimgs"),BgImg.isInit=!0,_g.log("背景图: DONE"),e.resolve()}),e.promise},BgImg.getObj=function(t){if("string"==typeof t){var i=void 0;return BgImg.list.some(function(e){return e.name===t&&(i=e),e.name===t}),i}return"number"==typeof t?BgImg.list[t]:void 0===t?BgImg.cur:t},BgImg.change=function(e){if(BgImg.list.length){if(void 0===e){if(BgImg.ensureVisible(),e=BgImg.listVisible[_g.randInt(BgImg.listVisible.length)],BgImg.cur&&e.name===BgImg.cur.name)return 1==BgImg.listVisible.length?e:BgImg.change()}else if(e=BgImg.getObj(e),BgImg.cur&&e.name===BgImg.cur.name)return e;return BgImg.cur&&(BgImg.lastToHide=BgImg.cur,BgImg.cur.elThumbnail.removeClass("on")),e.els.addClass(BgImg.cur?"fadein":""),e.els.eq(0).appendTo(_frame.dom.bgimg),e.els.eq(1).appendTo(_frame.dom.nav),e.els.eq(2).appendTo(_frame.dom.main),e.els.eq(3).appendTo(BgImg.controlsEls.bgimgs),e.elThumbnail.addClass("on"),BgImg.cur=e}},BgImg.changeAfter=function(){BgImg.lastToHide&&(BgImg.lastToHide.els.detach(),delete BgImg.lastToHide)},BgImg.upload=function(){BgImg.fileSelector||(BgImg.fileSelector=$('<input type="file" class="none"/>').on("change",function(e){if(BgImg.fileSelector.val()){var t=function(){BgImg.controlsEls.body.removeClass("is-loading"),BgImg.fileSelector.prop("disabled",!1),BgImg.fileSelector.val(""),_g.log("BgImg.add() complete")},i=void 0,n=e.target.files[0].type;if(!n)return _g.badgeError("文件格式未知"),void t();if("image"!=(n=n.split("/"))[0].toLowerCase())return _g.badgeError("请选择图片文件"),void t();if(["bmp","jpg","jpeg","png","gif","tif","tiff","webp"].indexOf(n[1].toLowerCase())<0)return _g.badgeError("当前仅支持以下格式: BMP、JPG、PNG、GIF、TIFF"),void t();Q.fcall(function(){return BgImg.controlsEls.body.addClass("is-loading"),BgImg.fileSelector.prop("disabled",!0),BgImg.readFile(e)}).then(function(e){return i=e,BgImg.list.push(i),BgImg.generate(i,"thumbnail")}).then(function(e){return BgImg.set(i,"thumbnail",e)}).then(function(){return BgImg.generate(i,"blured")}).then(function(e){return BgImg.set(i,"blured",e)}).then(function(){BgImg.countCustom||BgImg.list.forEach(function(e){e.visible&&(e.visible=!1)}),i.append(),i.show(),i.visible=!0,BgImg.countCustom++}).catch(function(e){_g.error(e,"自定义背景图"),i&&i.delete()}).done(t)}})),BgImg.fileSelector.trigger("click")},BgImg.generate=function(e,t){e=BgImg.getObj(e);var i=Q.defer(),n=void 0;function a(e){i.reject("读取图片文件发生错误")}switch(t){case"thumbnail":n=$("<img/>",{src:e.path}).on({load:function(){var e=canvas.downScale(n[0],150/Math.min(n[0].width,n[0].height));n.remove(),i.resolve(e)},error:a}).appendTo($body);break;case"blured":n=$("<img/>",{src:e.path}).on({load:function(){var e=$("<canvas/>");canvas.blur.image(n[0],e[0],20*Math.min(n[0].width,n[0].height)/1080),n.remove(),i.resolve(e[0])},error:a}).appendTo($body)}return i.promise},BgImg.getUniqueName=function(e){var t=1,i=e;for("number"==typeof e&&(e=""+e);BgImg.getObj(i);){var n=(i=e.split(".")).pop();i=i.join(".")+"-"+t+++"."+n}return i},BgImg.ensureVisible=function(){BgImg.listVisible.length||BgImg.list.forEach(function(e){(BgImg.countCustom&&!e.isDefault||!BgImg.countCustom&&e.isDefault)&&(e.visible=!0)})},BgImg.controlsInit=function(){return BgImg.controlsEls||(BgImg.controlsEls={},BgImg.controlsEls.body=$('<div class="bgcontrols"/>').appendTo(_frame.dom.layout).on(_g.event.animationend,function(e){e.currentTarget==e.target&&(BgImg.controlsShowing?BgImg.controlsHideAfter():BgImg.controlsShowAfter())}).append(BgImg.controlsEls.container=$('<div class="wrapper"/>').append(BgImg.controlsEls.bgimgs=$('<div class="bgimgs"/>')))),BgImg.controlsEls.container},BgImg.controlsShow=function(){BgImg.controlsEls&&!BgImg.controlsShowing&&(BgImg.controlsEls.listDefault||($('<div class="controls"/>').appendTo(BgImg.controlsEls.container).append(BgImg.controlsEls.btnViewingToggle=$('<button icon="eye"/>').on("click",BgImg.controlsViewingToggle)).append($('<button icon="floppy-disk"/>').on("click",function(){BgImg.save()})).append($('<button icon="arrow-set2-right"/>').on("click",BgImg.controlsHide)),$('<div class="list"/>').appendTo(BgImg.controlsEls.container).append($("<dl/>",{class:"notes",html:"勾选的图片将会出现在背景图随机队列中"})).append(BgImg.controlsEls.listCustom=$("<dl/>",{html:"<dt>自定义</dt>"}).prepend(function(){if(BgImg.quota)return $("<small/>").append(BgImg.controlsEls.listCustomQuotaUsed=$("<span>"+_g.getSize(BgImg.quotaUsed,"m")+"</span>")).append(" / <span>"+_g.getSize(BgImg.quota,"m")+"</span>")}).append(BgImg.controlsEls.listCustomAdd=$("<dd/>",{class:"add",html:"<s></s>"}).on("click",function(){BgImg.upload()}))).append(BgImg.controlsEls.listDefault=$("<dl/>",{html:"<dt></dt>"})),BgImg.list.forEach(function(e){e.append()})),_frame.dom.layout.addClass("mod-bgcontrols"))},BgImg.controlsShowAfter=function(){BgImg.controlsEls&&!BgImg.controlsShowing&&(BgImg.controlsEls.body.addClass("is-on"),BgImg.controlsShowing=!0)},BgImg.controlsHide=function(){BgImg.controlsEls&&BgImg.controlsShowing&&BgImg.controlsEls.body.addClass("is-hiding")},BgImg.controlsHideAfter=function(){BgImg.controlsEls&&BgImg.controlsShowing&&(_frame.dom.layout.removeClass("mod-bgcontrols"),BgImg.controlsEls.body.removeClass("is-on is-hiding"),BgImg.controlsShowing=!1)},BgImg.controlsToggle=function(){return BgImg.controlsShowing?BgImg.controlsHide():BgImg.controlsShow()},BgImg.controlsViewingToggle=function(){BgImg.controlsEls.body.toggleClass("mod-viewing"),BgImg.controlsEls.btnViewingToggle.toggleClass("on")},BgImg.quota=10485760,BgImg.quotaUsed=0,BgImg.getDefaultImgs=function(){for(var a=Q.defer(),e=_g.bgimg_count-1;0<=e;e--)BgImg.list.push(new BgImg({name:"*"+e+".jpg",isDefault:!0}));return BgImg.dataCustom={},localforage.getItem("bgcustomlist",function(e,t){for(var i in BgImg.dataCustom=t||{},BgImg.dataCustom){var n=BgImg.dataCustom[i];n.name=i,BgImg.list.push(new BgImg(n)),BgImg.countCustom++,BgImg.quotaUsed+=n.size}BgImg.updateQuotaUsed(),a.resolve(BgImg.list)}),a.promise},BgImg.updateQuotaUsed=function(){BgImg.controlsEls.listCustomQuotaUsed&&BgImg.controlsEls.listCustomQuotaUsed.html(_g.getSize(BgImg.quotaUsed,"m"))},BgImg.getPath=function(e,t){return(e=BgImg.getObj(e)).isDefault?_g.path.bgimg_dir+(t?t+"/":"")+e.filename:t?e["_"+t]:e._path},BgImg.save=function(e){e=BgImg.getObj(e),_g.save(e.path,"fleet.moe - "+e.filename)},BgImg.readFile=function(n){var s=Q.defer();return Q.fcall(_g.getScriptCanvas).then(function(){for(var e,t=0;e=n.target.files[t];t++){if(BgImg.quotaUsed+e.size>BgImg.quota){s.reject("已超过 "+_g.getSize(BgImg.quota,"m")+" 上限");break}var i=new FileReader;i.onload=function(a){return function(i){var n=BgImg.getUniqueName(a.name);BgImg.quotaUsed+=a.size,BgImg.updateQuotaUsed(),BgImg.dataCustom[n]={_path:i.target.result,size:a.size},localforage.setItem("bgcustomlist",BgImg.dataCustom,function(e,t){s.resolve(new BgImg({name:n,_path:i.target.result,size:a.size}))})}}(e),i.readAsDataURL(e)}}),s.promise},BgImg.set=function(e,t,i){e=BgImg.getObj(e);var n=i.toDataURL("image/jpeg","blured"==t?.4:.6),a=Q.defer();return e["_"+t]=n,BgImg.dataCustom[e.name]["_"+t]=n,localforage.setItem("bgcustomlist",BgImg.dataCustom,function(e,t){a.resolve()}),a.promise},BgImg.delete=function(i){i=BgImg.getObj(i);var n=Q.defer();return i.elThumbnail.remove(),i.els.remove(),BgImg.listVisible.forEach(function(e,t){e===i&&BgImg.listVisible.splice(t,1)}),BgImg.namesHidden.forEach(function(e,t){e===i.name&&BgImg.namesHidden.splice(t,1)}),Lockr.set("BgImgHidden",BgImg.namesHidden),delete BgImg.dataCustom[i.name],localforage.setItem("bgcustomlist",BgImg.dataCustom,function(e,t){BgImg.countCustom--,BgImg.quotaUsed-=i.size,BgImg.updateQuotaUsed(),BgImg.list.forEach(function(e,t){e===i&&BgImg.list.splice(t,1)}),BgImg.cur===i&&BgImg.change(),n.resolve()}),n.promise},_frame.infos={historyLength:-1,historyCurrent:-1,contentCache:{},getContent:function(i,n,t){function e(e){return t&&t(e),e}if(this.contentCache[i]||(this.contentCache[i]={}),!this.firstrun){var a=this.dom.container.children(".infosbody").eq(0);if(this.firstrun=!0,a.attr("data-infos-type")==i&&a.attr("data-infos-id")==n)return this.contentCache[i][n]=_p.initDOM(a),_frame.app_main.page_title[_g.state2URI({infos:i,id:n})]=document.title,e(this.contentCache[i][n]);a.attr("data-infos-type")==i&&a.remove()}function s(e){return"fleet"==i&&(e=_frame.infos["__"+i](n,e)),_p.initDOM(e.addClass("infosbody").attr({"data-infos-type":i,"data-infos-id":n}))}return"__NEW__"==n?e(s(this["__"+i](n))):this.contentCache[i][n]?e(this.contentCache[i][n]):void _frame.app_main.loading_start(_g.state2URI({infos:i,id:n}),{success:function(e){if(e){var t=/\<div class\=\"wrapper\"\>(.+)\<\/div\>/.exec(e);_frame.infos.contentCache[i][n]=s($(1<t.length?t[1]:""))}},successAfter:function(){return e(_frame.infos.contentCache[i][n])},error:function(){void 0!==_frame.infos.contentCache[i][n]&&delete _frame.infos.contentCache[i][n],history.back()}})},show:function(e,t,i){var n=/^\[\[([^\:]+)\:\:(.+)\]\]$/.exec(e),a=null,s=null;if(!(n&&2<n.length))return!1;switch(a=n[1].toLowerCase(),s=isNaN(n[2])?n[2]:parseInt(n[2]),a){case"item":case"equip":case"equipments":a="equipment"}if(this.curContent==a+"::"+s)return this.dom.container.children("div:first-child");i||(this.historyCurrent++,this.historyLength=this.historyCurrent,_frame.app_main.pushState({infos:a,id:s,infosHistoryIndex:this.historyCurrent},null,_g.state2URI({infos:a,id:s}))),this.show_func(a,s,i)},show_func:function(n,a,e,t){return!(!n||!a)&&(_g.pageChangeBefore(),this.curContent==n+"::"+a?this.dom.container.children("div:first-child"):(n=n.toLowerCase(),isNaN(a)||(a=parseInt(a)),this.dom||(this.dom={main:_frame.dom.main.children(".page-container.infos")},this.dom.main.length?this.dom.container=this.dom.main.children(".wrapper"):(this.dom.main=$('<div class="page-container infos"/>').appendTo(_frame.dom.main),this.dom.container=$('<div class="wrapper"/>').appendTo(this.dom.main)),this.dom.main.on(eventName("transitionend","infos_hide"),function(e){e.currentTarget==e.target&&"opacity"==e.originalEvent.propertyName&&0==_frame.infos.dom.main.css("opacity")&&_frame.infos.hide_finish()}),_frame.dom.btnHistoryBack&&_frame.dom.btnHistoryBack.on(eventName("transitionend","infos_hide"),function(e){e.currentTarget==e.target&&"opacity"==e.originalEvent.propertyName&&0==_frame.dom.btnHistoryBack.css("opacity")&&_frame.infos.hide_finish()})),_frame.dom.layout.addClass("is-infos-show"),this.curContent=n+"::"+a,void this.getContent(n,a,function(t){switch(this.dom.container.children().not(t).each(function(e,t){var i=$(t);0==i.css("opacity")&&i.trigger("hidden")}),n){case"ship":case"equipment":case"entity":this.dom.main.attr("data-infostype",n);break;case"fleet":this.dom.main.attr("data-infostype","fleet"),TablelistEquipments.types=[]}switch(n){case"ship":_g.title(_frame.app_main.navtitle.ships);break;case"equipment":_g.title(_frame.app_main.navtitle.equipments);break;case"entity":_g.title(_frame.app_main.navtitle.entities);break;case"fleet":_g.title(_frame.app_main.navtitle.fleets)}var e=!t.data("is_infosinit");if(!t.data("is_infosinit")){if("ship"==n){var i=parseInt(_config.get("ship_infos_lvl")||99);t.find('input[type="radio"][name^="ship_infos_lvl_"]').each(function(){var e=$(this),t=e.val();e.prop("checked",i==t).on("change",function(){_config.set("ship_infos_lvl",t)})})}_frame.infos["__"+n+"_init"]&&_frame.infos["__"+n+"_init"](t),t.data("is_infosinit",!0).on("hidden",function(){t.detach().data("is_show",!1)}).on(eventName("transitionend","hide"),function(e){e.currentTarget==e.target&&"opacity"==e.originalEvent.propertyName&&0==t.css("opacity")&&t.data("is_show")&&(_frame.infos.curContent==n+"::"+a?t.prependTo(_frame.infos.dom.container):t.trigger("hidden"))})}this.curContent==n+"::"+a&&(t.prependTo(this.dom.container).trigger("show",[e]).data("is_show",!0),this.dom.main.scrollTop(0),_frame.app_main.cur_page&&Page.hide(_frame.app_main.cur_page),_frame.dom.main.attr("data-theme",t.attr("data-theme")||n),_frame.dom.layout.attr("data-theme",t.attr("data-theme")||n),setTimeout(function(){_frame.dom.layout.addClass("is-infos-on"),document.title=_frame.app_main.page_title[_g.state2URI({infos:n,id:a})],_ga.counter(location.search)},1))}.bind(this))))},hide:function(){if(!this.dom||!this.curContent)return!1;_frame.dom.layout.removeClass("is-infos-on"),this.curContent=null},hide_finish:function(){if(this.curContent)return!1;this.dom.container.children().trigger("hidden"),_frame.dom.layout.removeClass("is-infos-show"),this.dom.main.attr({"data-infostype":"","data-theme":""}),this.historyLength=-1,this.historyCurrent=-1},click:function(e){this.show(e.attr("data-infos"),e,e.attr("data-infos-nohistory"))},init:function(){return!!this.is_init||($body.on("click._infos","[data-infos]",function(e){"input"==e.target.tagName.toLowerCase()&&"compare"==e.target.className||(_frame.infos.click($(this)),"a"==e.target.tagName.toLowerCase()&&e.preventDefault())}),this.is_init=!0)}},_frame.infos.__equipment_init=function(e){e.on("click.equipable","button[data-equipment-type]",function(e){return modal.equipable.show(e.currentTarget.getAttribute("data-equipment-type"))}),e.on("click.viewbonuses",".button-viewbonuses",function(e){e.preventDefault(),e.target.disabled||modal.bonuses.show("equipment",e.target.getAttribute("data-equipment-id"))})},_frame.infos.__ship_init=function(i){i.on("click.viewbonuses",".button-viewbonuses",function(e){e.preventDefault(),e.target.disabled||modal.bonuses.show("ship",e.target.getAttribute("data-ship-id"))});var n=void 0,a=-1,s=void 0,o=void 0,r=void 0,l=void 0,d=void 0,u=!1,c=_huCss.csscheck_full("scroll-snap-type")&&!bFirefox,h=!1,m=!1,e=i.find(".illustrations"),p=e.find(".body"),f=p.children("span"),t="e"+_g.timeNow(),_=e.children("label"),g=e.children('input[type="radio"]').on("change",function(e,t){var i=parseInt(e.target.getAttribute("value"))-1;_.eq(i).is(":visible")||(i--,g.eq(i).prop("checked",!0)),c&&!h&&(h=!0,p.off("scroll").animate({scrollLeft:f.eq(i)[0].offsetLeft},void 0===t?200:t,function(){setTimeout(function(){h=!1,p.on("scroll",x)},50)}))}),v=0,b=0,y=1,k=0;function I(){b=parseInt(g.filter(":checked").val())-1,y=Math.ceil(g.length/_.filter(":visible").length),k=e.hasClass("is-singlelast")&&2==y?1:0}function w(){k=y=b=0}function C(){a=p.scrollLeft(),v=p.width(),I()}function x(){0<=a&&(n=p.scrollLeft(),u||requestAnimationFrame(T),u=!0)}function T(){var e=n-a,t=(Math.floor(Math.abs(e)/v)+(Math.abs(e%v)>v/2?1:0))*(n<a?-1:1);if(u=!1,0!==e){var i=b+t*y;i<0&&(i=0),i+y>g.length+k&&(i=g.length-y),g.eq(i).prop("checked",!0)}}function S(){a=-1,g.filter(":checked").trigger("change",0),c&&C()}if(i.on({show:function(e){$window.on("resized."+t,S),S()},hidden:function(){$window.off("resized."+t)}}),c)e.addClass("mod-scroll-snap"),p.on({scroll:x,pointerdown:function(e){a<0&&"touch"==e.originalEvent.pointerType&&C()},touchstart:function(){a<0&&C()}});else{var E=function(){p.css("transform","").removeClass("is-panning"),d=l=o=s=a=0,w(),j=!1,$(document).off("touchmove.infosShipIllust touchend.infosShipIllust touchcancel.infosShipIllust")},q=function(){u=!1;var e=b<=0&&0<l||b>=g.length-y&&l<0;p.css("transform","translateX("+(l*(e?.3333:1)+a)+"px)")},F=function(){u||requestAnimationFrame(q),u=!0},B=function(e){if(!u&&(s||o)&&1==e.originalEvent.targetTouches.length)if(l=e.originalEvent.targetTouches[0].clientX-s,j)F();else{d=e.originalEvent.targetTouches[0].clientY-o;var t=Math.abs(l),i=Math.abs(d);t<20&&i<20||i<t?(e.preventDefault(),i<t&&(j=!0,p.addClass("is-panning"),F())):E()}},A=function(e){requestAnimationFrame(function(){if(l&&(Math.abs(l)>v/3||_g.timeNow()-r<300)){var e=void 0;l<0&&b<g.length-1?e=b+y:0<l&&0<b&&(e=b-1),e<0&&(e=0),e+y>g.length+k&&(e=g.length-y),g.eq(e).prop("checked",!0).trigger("change")}E()})},j=!1;e.on({touchstart:function(e){if(e.originalEvent.targetTouches&&1==e.originalEvent.targetTouches.length){var t=p.css("transform").replace(/[^0-9\-.,]/g,"").split(",");a=parseInt(t[12]||t[4]||0),s=e.originalEvent.targetTouches[0].clientX,o=e.originalEvent.targetTouches[0].clientY,r=_g.timeNow(),I(),v=p.width(),$(document).on({"touchmove.infosShipIllust":B,"touchend.infosShipIllust":A,"touchcancel.infosShipIllust":A})}},touchmove:function(e){j&&e.preventDefault()}})}function O(e,t){if(e&&!h){var i=-10;I(),1==e?i=b+y:-1==e&&(i=b-1),i<0&&-10<i?i=t?g.length-y:0:i+y>g.length+k&&(i=t?0:g.length-y),w(),0<=i&&(c&&C(),g.eq(i).prop("checked",!0).trigger("change"))}}e.on("mousewheel",function(e){if(!(m||h||i.get(0).scrollHeight>i.get(0).clientHeight)){var t=void 0;c&&e.originalEvent.deltaY?t=e.originalEvent.deltaY<0?-1:1:e.originalEvent.wheelDelta?t=0<e.originalEvent.wheelDelta?-1:1:e.originalEvent.deltaX?t=e.originalEvent.deltaX<0?-1:1:e.originalEvent.deltaY&&(t=e.originalEvent.deltaY<0?-1:1),t&&(m=!0,O(t),setTimeout(function(){m=!1},100))}}),$('<button class="arrow prev" icon="arrow-left"/>').on("click",function(){O(-1,!0)}).insertBefore(g.eq(0)),$('<button class="arrow next" icon="arrow-right"/>').on("click",function(){O(1,!0)}).insertAfter(_.eq(_.length-1))},_frame.infos.__fleet=function(e,t,i){var n=new InfosFleet(e,t,i);return n.el.on({show:function(){InfosFleet.cur=n},hide:function(){InfosFleet.cur=null}})};var InfosFleetEditableTitle=function e(t){_classCallCheck(this,e);var i=$.extend(!0,{},e.defaults,t),n=$("<"+i.tagName+"/>",{contenteditable:!0,class:"title-editable "+i.className,html:i.placeholder}).on({input:function(){n.trigger("namechange")},focus:function(){n.text()==i.placeholder&&n.html("")},blur:function(){n.text()||n.html(i.placeholder)},namechange:function(e,t){return void 0===t&&(t=n.text()),t!=n.text()&&n.text(t),i.onUpdate(t),t?n.attr("data-content",t):n.removeAttr("data-content"),n},keydown:function(e){13==e.keyCode&&(n.blur(),setTimeout(function(){n.blur()},1)),setTimeout(function(){!n.text()&&i.targetObj&&(i.onUpdate(content),n.removeAttr("data-content"))},100)}});this.options=i,this.$el=n,this.el=n[0]};InfosFleetEditableTitle.defaults={tagName:"span",className:"",placeholder:"点击编辑",onUpdate:function(e){}};var InfosFleet=function(){function a(i,n,e){_classCallCheck(this,a),this.el=n||$("<div/>"),this.el.addClass("infos-fleet infosbody loading").attr({"data-infos-type":"fleet","data-infos-title":"舰队 ("+i+")"}),this.doms={},this.fleets=[],this.tip_hqlv_input="输入 0 表示采用默认等级 (Lv.%1$d)",e?this.init(e):"__NEW__"==i?_db.fleets.insert(_tablelist.prototype._fleets_new_data(),function(e,t){e?_g.error(e):"fleet::__NEW__"==_frame.infos.curContent&&_frame.infos.show("[[FLEET::"+t._id+"]]")}.bind(this)):_db.fleets.find({_id:i},function(e,t){if(e||!t)_g.error(e);else if(_frame.infos.curContent=="fleet::"+i)if(t.length)this.init(t[0]);else try{this._infos_state_id=i,this.init(TablelistFleets.prototype.new_data(JSON.parse(LZString.decompressFromEncodedURIComponent(_g.uriSearch("d")))))}catch(e){_g.error(e)}else n.remove(),delete _frame.infos.contentCache.fleet[i]}.bind(this)),a.cur=this}return _createClass(a,[{key:"init",value:function(e){var i=this;if(!e)return!1;this.el.on({show:function(e,t){if(this.is_showing=!0,InfosFleetShipEquipment.cur&&InfosFleetShipEquipment.cur.trigger("blur"),!t){var i=Lockr.get("hqLvDefault",_g.defaultHqLv);this.fleets.forEach(function(e){e.summaryCalc(!0);var t=e.el.attr("scrollbody");isNaN(t)||e.el.scrollTop(t)}),this._hqlv||this.doms.hqlvOption.val(i),this.doms.hqlvOptionLabel.data("tip",this.tip_hqlv_input.printf(i)),this.doms.hqlvOption.attr("placeholder",i)}this.is_init&&this.updateURI()}.bind(this),hidden:function(){this.is_showing=!1,InfosFleetShipEquipment.cur&&InfosFleetShipEquipment.cur.trigger("blur")}}).on("focus.number_input_select",'input[type="number"]:not([readonly])',function(e){e.currentTarget.select()}),this.data=e;var t=0,n=Lockr.get("hqLvDefault",_g.defaultHqLv);for(this.el.attr({"data-fleetid":e._id,"data-infos-id":e._id}).removeClass("loading"),this.el.find(".loading-msg").remove(),$("<header/>").append(this.doms.name=new InfosFleetEditableTitle({tagName:"h3",placeholder:"点击编辑标题",onUpdate:function(e){i._name=e}}).$el).append(this.doms.preview=$('<div class="preview"/>')).appendTo(this.el),$('<div class="fleets"/>').append(this.doms.tabs=$('<div class="tabs"/>')).append(this.doms.options=$('<div class="options"/>').append(this.doms.hqlvOptionLabel=$("<label/>",{class:"option option-hqlv",html:"司令部等级","data-tip":this.tip_hqlv_input.printf(n)}).on({"mouseenter mouseleave":function(e){_p.tip.is_showing&&!_p.tip.timeout_fade&&this.doms.hqlvOption.is(":focus")&&(e.stopImmediatePropagation(),e.stopPropagation())}.bind(this)}).append(this.doms.hqlvOption=$("<input/>",{type:"number",min:0,max:_g.hqMaxLv,placeholder:n}).val(this._hqlv||n).on({input:function(){this._hqlv=this.doms.hqlvOption.val()}.bind(this),"focus.tipshow":function(){this.doms.hqlvOption.trigger("tipshow")}.bind(this),"blur.tiphide":function(){this.doms.hqlvOption.trigger("tiphide"),this.doms.hqlvOption.val()>_g.hqMaxLv&&(this.doms.hqlvOption.val(_g.hqMaxLv),this.doms.hqlvOption.trigger("input"))}.bind(this),click:function(e){e.stopImmediatePropagation(),e.stopPropagation()}}))).append(this.doms.theme=$('<select class="option option-theme-value"/>').on("change",function(){this._theme=this.doms.theme.val()}.bind(this)).append(function(){for(var e=$(),t=1;t<11;t++)e=e.add($("<option/>",{value:t,html:"主题-"+t}));return e})).append(this.doms.themeOption=$('<button class="option option-theme mod-dropdown"/>').html("主题").on("click",function(){var t=this;if(!a.menuTheme){a.menuThemeItems=$("<div/>");for(var e=function(e){$('<button class="theme-'+e+'"/>').html(e).on("click",function(){a.menuCur._theme=e,this.el.attr("data-theme",this._theme)}.bind(t)).appendTo(a.menuThemeItems)},i=1;i<11;i++)e(i);a.menuTheme=new _menu({className:"contextmenu-infos_fleet_themes",items:[a.menuThemeItems]})}a.menuCur=this,a.menuTheme.show(this.doms.themeOption)}.bind(this))).append(this.doms.exportOption=$('<button class="option mod-dropdown"/>').html("分享").on("click",function(){if(!a.menuExport){var e=[];_g.isClient&&!_g.isOnline||e.push($('<div class="item"/>').html("分享当前配置"+(_g.isClient?"":"<small>可直接分享网址</small>")).add(new ShareBar({title:function(){return a.menuCur.data.name},summary:"分享自 是谁呼叫舰队（ http://fleet.moe ）",sites:["tsina","tqq","cqq","twitter","tieba"],uid:1552359,modifyItem:function(e){e.addClass("menuitem")},url:function(){return a.menuCur.url}}).el.addClass("item")).add($("<hr/>"))),_g.isClient&&e.push($("<menuitem/>",{html:"在浏览器中打开当前配置"}).on("click",function(){node.gui.Shell.openExternal(a.menuCur.url)})),e=e.concat([$("<menuitem/>",{html:"导出配置代码"}).on("click",function(){a.menuCur.modalExport_show()}),$("<menuitem/>",{html:"导出配置文本"}).on("click",function(){a.menuCur.modalExportText_show()})]),_g.isNWjs&&e.push($("<menuitem/>",{html:"生成图片"}).on("click",function(){a.menuCur.exportPic()})),a.menuExport=new _menu({className:"contextmenu-infos_fleet_themes",items:e})}a.menuCur=this,a.menuExport.show(this.doms.exportOption)}.bind(this))).append(this.doms.optionOptions=$('<button class="icon" icon="cog"/>').on("click",function(){TablelistFleets.menuOptions_show(this.doms.optionOptions)}.bind(this)))).appendTo(this.el),this.doms.ships=$('<div class="ships"/>').appendTo(this.el),this.subfleetinputs=[];t<4;)this.subfleetinputs[t]=$("<input/>",{type:"radio",name:"fleet_"+e._id+"_tab",id:"fleet_"+e._id+"_tab_"+t,value:t}).prop("checked",0==t).prependTo(this.el),this.fleets[t]=new InfosFleetSubFleet(this,[],t,$("<label/>",{for:"fleet_"+e._id+"_tab_"+t,"data-fleet":t,html:"#"+(t+1)}).appendTo(this.doms.tabs)),this.fleets[t].el.attr("data-fleet",t).appendTo(this.doms.ships),t++;$("<input/>",{type:"radio",name:"fleet_"+e._id+"_tab",id:"fleet_"+e._id+"_tab_airfileds",value:4}).prop("checked",!1).prependTo(this.el),this.fleet_airfileds=new InfosFleetSubAirfield(this,[],$("<label/>",{for:"fleet_"+e._id+"_tab_airfileds","data-fleet":4,html:"基地"}).appendTo(this.doms.tabs)),this.fleet_airfileds.el.attr("data-fleet",4).appendTo(this.doms.ships),this.data._id||(this.el.addClass("mod-preview"),this.doms.preview.html("若要编辑配置或保存以备日后查看，请").append($("<button/>",{html:"保存配置"}).on("click",function(){this.previewSave()}.bind(this))),this.doms.name.removeAttr("contenteditable"),this.doms.hqlvOptionLabel.data("tip","若要编辑配置或保存以备日后查看，<br/>请点击上方的“保存配置”按钮"),this.doms.hqlvOption.prop("readonly",!0)),this.update(e),this._theme=this._theme,Array.isArray(e.data)&&e.data.some(function(e,t){return!(!Array.isArray(e)||!e.some(function(e){return Array.isArray(e)&&e[0]}))&&(i.subfleetinputs[t]&&i.subfleetinputs[t].prop("checked",!0).trigger("change"),!0)}),$body.on("update_defaultHqLv.fleet"+this.data._id,function(e,t){this.is_showing&&(this._hqlv||this.doms.hqlvOption.val(t),this.doms.hqlvOptionLabel.data("tip",this.tip_hqlv_input.printf(t)),this.doms.hqlvOption.attr("placeholder",t))}.bind(this))}},{key:"update",value:function(e){this._updating=!0,(e=e||{}).data=a.decompress(e.data),void 0!==e.theme&&(_frame.infos.dom.main.attr("data-theme",e.theme),this.doms.theme.val(e.theme).attr("value",e.theme)),void 0!==e.name&&this.doms.name.html(e.name).trigger("namechange",[e.name]).trigger("blur"),e.data&&e.data.push&&e.data.forEach(function(e,t){4==t?this.fleet_airfileds.updateEl(e):this.fleets[t].updateEl(e)},this),this._updating=!1}},{key:"update_data",value:function(e){e=e||{},this.update(e)}},{key:"previewSave",value:function(){_db.fleets.insert(TablelistFleets.prototype.new_data(this.data),function(e,t){if(e)_g.error(e);else{this.el.attr({"data-infos-id":t._id}),_frame.infos.curContent="fleet::"+t._id;var i=_frame.infos.__fleet(t._id,null,t);_frame.infos.contentCache.fleet[t._id]=i,(_frame.infos.contentCache.fleet[this._infos_state_id]=i).insertBefore(this.el),this.el.remove(),_g.badgeMsg("舰队配置已保存")}}.bind(this))}},{key:"updateURI",value:function(){if(!_g.isNWjs&&this.data._id&&_g.uriSearch()){var e=$.extend(!0,{},this.data),t=e._id;delete e._id,delete e.time_create,delete e.time_modify,delete e.rating,delete e.user,history.replaceState(history.state,document.title,location.pathname+"?i="+t+"&d="+LZString.compressToEncodedURIComponent(JSON.stringify(e)))}}},{key:"save",value:function(e){return this._updating||(this.is_init?(this.data.data=[],this.fleets.forEach(function(e,t){if(Array.isArray(e.data)&&e.data.length>a.minSubFleetShipsCount){for(var i=[].concat(_toConsumableArray(e.data)),n=a.minSubFleetShipsCount;n<i.length;)Array.isArray(i[n])&&i[n][0]?n++:i.splice(n,1);e.data=i}this.data.data[t]=e.data},this),this.data.data[4]=this.fleet_airfileds.data,a.clean(this.data.data),this.data.time_modify=_g.timeNow(),this.updateURI(),e||(clearTimeout(this.delay_updateDb),this.delay_updateDb=setTimeout(function(){_db.fleets.updateById(this.data._id,a.compressMetaData(this.data),function(){_g.log("saved"),a.decompressMetaData(this.data)}.bind(this)),clearTimeout(this.delay_updateDb),this.delay_updateDb=null}.bind(this),200))):(a.clean(this.data.data),this.updateURI()),this.is_init=!0),this}},{key:"modalExport_show",value:function(){a.modalExport_show(this.data)}},{key:"modalExportText_show",value:function(){a.modalExportText_show(this.data)}},{key:"exportPic",value:function(){a.fileDialog_export||(a.fileDialog_export=$('<input type="file" accept=".png" nwsaveas/>').on({click:function(e,t,i,n){a.fileDialog_export.data({windowWidth:t,windowHeight:i,isMaxmize:n}),a.fileDialog_export_showing=!0},change:function(){var i=a.fileDialog_export.val();a.fileDialog_export.val(""),_g.log("changed"),setTimeout(function(){node.win.capturePage(function(e){var t=node.fs.createWriteStream(i);t.write(e),t.end()},{format:"png",datatype:"buffer"})},0)},resetCaptureMode:function(){!a.fileDialog_export.val()&&$body.hasClass("mod-capture")&&($body.removeClass("mod-capture"),node.win.resizeTo(a.fileDialog_export.data("windowWidth"),a.fileDialog_export.data("windowHeight")),a.fileDialog_export.data("isMaxmize")&&node.win.maximize(),a.fileDialog_export.data({windowWidth:null,windowHeight:null,isMaxmize:null}),_g.zoom(Scale.cur),_menu.hideAll())}}).appendTo(_frame.dom.hidden),$window.on("focus.resetCaptureMode",function(){a.fileDialog_export_showing&&setTimeout(function(){a.fileDialog_export.trigger("resetCaptureMode"),a.fileDialog_export_showing=!1},1e3)})),_g.zoom(1);var e=$window.width(),t=$window.height(),i=$html.hasClass("window-maxmize");i&&node.win.unmaximize(),$body.addClass("mod-capture"),node.win.resizeTo(1280,720),setTimeout(function(){a.fileDialog_export.trigger("click",[e,t,i])},200)}},{key:"remove",value:function(){a.modalRemove_show(this)}},{key:"_name",get:function(){return this.data.name},set:function(e){this.data.name=e,this.save()}},{key:"_theme",get:function(){return this.data.theme},set:function(e){this.data.theme=e||1,this.doms.theme.val(this.data.theme).attr("value",this.data.theme),_frame.infos.dom.main.attr("data-theme",this.data.theme),this.el.attr("data-theme",this.data.theme),_frame.dom.layout.attr("data-theme",this.data.theme),this.save()}},{key:"_hqlv",get:function(){return 0<this.data.hq_lv?this.data.hq_lv:0},set:function(e){e=parseInt(e);var t=this._hqlv;if(e&&0<e?(this.data.hq_lv=e,this.doms.hqlvOption.val(e)):(e=-1,this.data.hq_lv=-1,this.doms.hqlvOption.val(Lockr.get("hqLvDefault",_g.defaultHqLv))),t!=e){for(var i=0;i<4;)this.fleets[i].summaryCalc(!0),i++;this.save()}}},{key:"url",get:function(){if(this.data._id){var e=$.extend(!0,{},this.data),t=e._id;return delete e._id,delete e.time_create,delete e.time_modify,delete e.rating,delete e.user,"http://fleet.moe/fleets/build/?i="+t+"&d="+LZString.compressToEncodedURIComponent(JSON.stringify(e))}}}]),a}();InfosFleet.minSubFleetShipsCount=6,InfosFleet.modalExport=function(e){if(!InfosFleet.elModalExport){InfosFleet.elModalExport=$("<div/>").append(InfosFleet.elModalExportTextarea=$("<textarea/>",{readonly:!0})).append($('<p class="note-codeusage"/>').html('* 该配置代码可用于<a href="http://www.kancolle-calc.net/deckbuilder.html">艦載機厨デッキビルダー</a>'));var t=$('<button class="button">复制到剪切板</button>').appendTo(InfosFleet.elModalExport);new Clipboard(t[0],{text:function(){return InfosFleet.elModalExportTextarea.val()}})}return InfosFleet.elModalExportTextarea.val(e||""),InfosFleet.elModalExport},InfosFleet.modalExport_show=function(e){e=InfosFleet.decompress(e.data||[]),e=JSON.stringify(_g.kancolle_calc.encode(e)),_frame.modal.show(InfosFleet.modalExport(e),"导出配置代码",{classname:"infos_fleet infos_fleet_export",detach:!0})},InfosFleet.modalExportText_show=function(e){if(!e)return!1;var o="",i=[],t=InfosFleet.decompress(e.data).filter(function(e){return _g.log(e),!(!e||!e.length)&&e.some(function(t){if(_g.log("* ",t),t&&t.length){if(t.some(function(e){switch(_g.log("  * ",e),void 0===e?"undefined":_typeof(e)){case"number":case"string":return!0}}))return!0;t.some(function(e){if(_g.log("  * ",e),e&&e.length&&e[0])return i.push(t),!0})}return!1})})||[];o+=e.name||"",t.forEach(function(e,s){o+=(o?"\n":"")+(1<t.length?"\n第 "+(s+1)+" 舰队":""),e.filter(function(e){return e&&e[0]&&0<e.length}).forEach(function(e,t){o+="\n("+(s?s+1+"-":"")+(t+1)+") "+_g.data.ships[e[0]]._name+(e[1]&&e[1][0]?" Lv."+e[1][0]:"");var i=e[2]||[],n=e[3]||[],a=e[4]||[];i.filter(function(e){return e}).forEach(function(e,t){o+=(t?", ":" | ")+_g.data.items[e]._name+(n[t]?"★"+n[t]:"")+(a[t]?"["+_g.textRank[a[t]]+"]":"")})})}),_g.log(i),i.forEach(function(e,t){o+=(o?"\n":"")+(1<e.length?"\n第 "+(t+1)+" 航空队":""),e.filter(function(e){return e&&e.length&&e[0]}).forEach(function(e,t){o+="\n("+(t+1)+") "+_g.data.items[e[0]]._name+(e[1]?" ["+_g.textRank[e[1]]+"]":"")})}),o+=(o?"\n\n":"")+"* 创建自 是谁呼叫舰队 (fleet.moe)",_frame.modal.show(InfosFleet.modalExport(o),"导出配置文本",{classname:"infos_fleet infos_fleet_export mod-text",detach:!0})},InfosFleet.modalRemove_show=function(e,n){if(void 0!==e){e instanceof InfosFleet&&(e=e.data._id),InfosFleet.elModalRemove||(InfosFleet.elModalRemove=$("<form/>").append(InfosFleet.elModalRemoveId=$('<input name="id" type="hidden"/>')).append($("<p/>").html("是否删除该舰队配置？")).append($('<p class="actions"/>').append($("<button/>",{type:"submit",class:"button",html:"是"})).append($("<button/>",{type:"button",class:"button",html:"否"}).on("click",function(){_frame.modal.hide()}))).on("submit",function(e){e.preventDefault();var i=InfosFleet.elModalRemoveId.val();return i&&(_frame.app_main.loading_start("remove_fleet_"+i,!1),_db.fleets.remove({_id:i},{multi:!0},function(e,t){_g.log("Fleet "+i+" removed."),_frame.app_main.loading_complete("remove_fleet_"+i),_frame.modal.hide(),_g.badgeMsg("已删除配置"),"object"===(void 0===n?"undefined":_typeof(n))&&n.refresh?n.refresh():_frame.dom.navs.fleets.click()})),!1})),InfosFleet.elModalRemoveId.val(e),_frame.modal.show(InfosFleet.elModalRemove,"删除配置",{classname:"infos_fleet infos_fleet_remove",detach:!0})}},InfosFleet.clean=function(e){if(e)return function i(n){n&&n.length&&n.forEach(function(e,t){e&&e.push?i(e):t==n.length-1&&null===e&&(n.pop(),i(n))})}(e),e},InfosFleet.decompress=function(e){if(e&&!e.push)try{e=JSON.parse(LZString.decompressFromEncodedURIComponent(e))}catch(e){_g.error(e)}return e},InfosFleet.compress=function(e){if(e&&e.push)try{e=LZString.compressToEncodedURIComponent(JSON.stringify(e))}catch(e){_g.error(e)}return e},InfosFleet.compressMetaData=function(e){if(e&&e.data&&e.data.push)try{e.data=InfosFleet.compress(e.data)}catch(e){_g.error(e)}return e},InfosFleet.decompressMetaData=function(e){if(e&&e.data&&!e.data.push)try{e.data=InfosFleet.decompress(e.data)}catch(e){_g.error(e)}return e};var InfosFleetSubFleet=function(){function o(e,t,i,n){var a=this;_classCallCheck(this,o),t=t||[],this.data=t,this.infosFleet=e,this.el=$('<dl class="fleetships" scrollbody/>'),this.label=n,this.ships=[];for(var s=0;s<InfosFleet.minSubFleetShipsCount;)this.createShip(s),s++;this.elSummary=$('<span class="summary"/>').appendTo(this.el).append($('<span class="btn-add-ship"/>').on("click",function(){a.createShip(a.ships.length),a.ships[a.ships.length-1].el.trigger("click")})).append($('<span class="summary-item"/>').html("航速").append(this.elSummarySpeed=$("<strong/>").html("-"))).append($('<span class="summary-item"/>').html("制空战力").append(this.elSummaryFighterPower=$("<strong/>").html("-"))).append($('<span class="summary-item"/>').html("索敌能力").append(this.elSummaryLos=$("<strong/>").html("-"))).append($('<span class="summary-item summary-item-consummation"/>').html("总消耗").append(this.elSummaryConsummation=$("<strong/>").html("-"))).append(this.elSummaryTPcontainer=$('<span class="summary-item hide"/>').html("运输TP").append(this.elSummaryTP=$("<strong/>").html("-"))),$body.on("update_defaultHqLv.fleet"+e.data._id+"-"+(i+1),function(){this.infosFleet.is_showing&&this.summaryCalc(!0)}.bind(this))}return _createClass(o,[{key:"createShip",value:function(e){return this.ships[e]?this.ships[e]:(this.ships[e]=new InfosFleetShip(this.infosFleet,this,e),this.elSummary?this.ships[e].getEl().insertBefore(this.elSummary):this.ships[e].getEl().appendTo(this.el))}},{key:"updateEl",value:function(e){this.data=e||this.data;var i=0;e&&e.forEach(function(e,t){this.ships[t]||this.createShip(t),this.ships[t].updateEl(e),e&&e.push&&e[0]&&i++},this),i?this.label.addClass("highlight"):this.label.removeClass("highlight")}},{key:"getData",value:function(){return this.data}},{key:"getShipCount",value:function(){var t=0;return this.data&&this.data.forEach(function(e){e&&e.push&&e[0]&&t++}),t}},{key:"summaryCalc",value:function(u){if(this.summaryCalculating)return!1;this.summaryCalculating=setTimeout(function(){if(!u){var i=[0,0],n=1e3,a=0,s=0,o=0;if(this.ships.forEach(function(e){if(e.data[0]){var t=_g.data.ships[e.data[0]];n=Math.min(n,e.stat.speed||t.stat.speed),e.calculate("fighterPower_v2").forEach(function(e,t){i[t]+=0<e?e:0}),a+=t.getAttribute("fuel",e.shipLv)||0,s+=t.getAttribute("ammo",e.shipLv)||0,o+=e.calculate("TP"),o+=t.tp||0}}),this.elSummarySpeed.html(_g.getStatSpeed(n)),0<Math.max(i[0],i[1])){var e=Math.floor(i[0]),t=Math.floor(i[1]);this.elSummaryFighterPower.html(e==t?e:e+"~"+t),this.elSummaryFighterPower.removeClass("empty")}else this.elSummaryFighterPower.html("-"),this.elSummaryFighterPower.addClass("empty");if(this.elSummaryConsummation.html(a||s?'<span class="fuel">'+a+'</span><span class="ammo">'+s+"</span>":"-"),40<o){var r=Math.floor(o),l=Math.floor(.7*r);this.elSummaryTPcontainer.removeClass("hide"),this.elSummaryTP.html("A="+l+" / S="+r)}else this.elSummaryTPcontainer.addClass("hide")}var d=this.getShipCount()?this.summaryCalcLos():null;this.elSummaryLos.html(d?d.toFixed(2):"-"),this.summaryCalculating=null}.bind(this),10)}},{key:"summaryCalcLos",value:function(){var e=this.infosFleet.data.hq_lv||Lockr.get("hqLvDefault",_g.defaultHqLv);return e<0&&(e=Lockr.get("hqLvDefault",_g.defaultHqLv)),Formula.calcByFleet.los33(this.data,e)}},{key:"save",value:function(){var i=0;this.data=this.data||[],this.ships.forEach(function(e,t){this.data[t]=e.data,e.data&&e.data[0]&&i++},this),i?this.label.addClass("highlight"):(this.data=null,this.label.removeClass("highlight")),this.infosFleet&&this.infosFleet.save()}}]),o}(),InfosFleetShip=function(){function l(e,t,i,n){var a=this;if(_classCallCheck(this,l),this.el)return this.el;n=n||[null,[null,-1],[],[],[]],this.data=n,this.infosFleet=e,this.infosFleetSubFleet=t,this.equipments=[],this.index=i,this.stat={};for(var s=0;s<4;s++)this.equipments[s]=new InfosFleetShipEquipment(this,s);if(!Array.isArray(InfosFleetShipEquipment.exslotTypes))for(var o in InfosFleetShipEquipment.exslotTypes=[],_g.data.item_types)_g.data.item_types[o].equipable_exslot&&InfosFleetShipEquipment.exslotTypes.push(parseInt(o));if(!Array.isArray(InfosFleetShipEquipment.exslotEquipments))for(var r in InfosFleetShipEquipment.exslotEquipments=[],_g.data.items)_g.data.items[r].equipable_exslot&&InfosFleetShipEquipment.exslotEquipments.push(parseInt(r));this.equipments[4]=new InfosFleetShipEquipment(this,4,0,InfosFleetShipEquipment.exslotTypes,InfosFleetShipEquipment.exslotEquipments),this.el=$('<dd class="ship"/>').append($("<dt/>").append(this.elAvatar=$('<s touch-action="none"/>')).append(this.elInfos=$("<div/>").html("<span>"+(this.infosFleet.data._id?"选择舰娘":"无舰娘")+"...</span>").append(this.elInfosTitle=$('<div class="title"/>')).append($('<div class="info"/>').append($("<label/>").html("Lv.").append(this.elInputLevel=$("<input/>",{type:"number",min:0,max:_g.shipMaxLv}).on({checkValue:function(){var e=a.elInputLevel.val();void 0!==e&&""!==e||!a.data[1][0]||(a.shipLv=null),e=parseInt(e);var t=parseInt(a.elInputLevel.attr("min"));e<t?(e=t,a.elInputLevel.val(t)):e>_g.shipMaxLv&&(e=_g.shipMaxLv,a.elInputLevel.val(_g.shipMaxLv)),isNaN(e)||a.data[1][0]==e||(a.shipLv=e)},keydown:function(e){38!=e.keyCode&&40!=e.keyCode||a.elInputLevel.trigger("checkValue")},change:function(){a.elInputLevel.trigger("checkValue")}}))).append(this.elInfosSpeed=$("<span/>")).append(this.elInfosType=$("<span/>"))))).append(this.elEquipments=$('<div class="equipments"/>').append(function(){for(var e=$(),t=0;t<4;t++)e=e.add(this.equipments[t].el);return e}.bind(this))).append($('<div class="attributes"/>').append(this.elAttrShelling=$('<span class="shelling"/>')).append(this.elAttrTorpedo=$('<span class="torpedo"/>')).append(this.elAttrHitSum=$('<span class="hitsum"/>')).append(this.elAttrHp=$('<span class="hp"/>')).append(this.elAttrArmor=$('<span class="armor"/>')).append(this.elAttrEvasion=$('<span class="evasion"/>')).append(this.elAttrNightBattle=$('<span class="nightbattle" data-text="夜战"/>')).append(_huCss.csscheck_full("mask-image")?null:$('<div class="bg"/>'))).append($('<div class="options"/>').append(this.elBtnOptions=$('<button class="options"/>').on("click",function(e){this.showMenu()}.bind(this)))).append(this.equipments[4].el.addClass("equipment-extra")),this.after=$("<s/>"),this.els=this.el.add(this.after),this.infosFleet.data._id?(this.el.on({click:function(){this.data[0]||this.selectShipStart()}.bind(this),pointerenter:function(){l.dragEnter(this)}.bind(this),touchmove:function(e){l.dragTouchmove(e)}}),this.elAvatar.on({pointerdown:function(e){e.preventDefault(),this.data[0]&&(document.activeElement.blur(),l.dragStart(this))}.bind(this)})):this.elInputLevel.prop("readonly",!0),_huCss.csscheck_full("mask-image")||this.el.addClass("mod-nomask")}return _createClass(l,[{key:"getEl",value:function(){return this.els}},{key:"selectShipStart",value:function(){_g.log("开始选择舰娘"),_frame.app_main.load_page("ships",{callback_modeSelection_select:function(e){history.back(),this.shipId=e,this.shipLv=null,this.infosFleet&&_frame.infos.dom.main.attr("data-theme",this.infosFleet.data.theme)}.bind(this)})}},{key:"changeLuck",value:function(e){this.data[1][1]=e||-1}},{key:"updateAttrs",value:function(){if(this.shipId){var e=this.calculate("speed");this.stat.speed=_g.getStatSpeedNumber(e),this.elInfosSpeed.html(e),_g.data.ships[this.shipId].stat.speed!==this.stat.speed?this.elInfosSpeed.attr("data-speed",this.stat.speed):this.elInfosSpeed.removeAttr("data-speed");var t=this.calculate("shellingDamage");this.elAttrShelling.html(("-"!==t?this.calculate("fireRange")+" | ":"")+t),this.elAttrTorpedo.html(this.calculate("torpedoDamage"));var i=this.calculate("addHit");0<=i?this.elAttrHitSum.removeClass("negative"):this.elAttrHitSum.addClass("negative"),this.elAttrHitSum.html(i),this.elAttrHp.html(this.calculate("attribute","hp")),this.elAttrArmor.html(this.calculate("attribute","armor")+this.calculate("addArmor"));var n=this.shipLv?this.calculate("attribute","evasion"):-1;this.elAttrEvasion.html(0<=n?n+this.calculate("addEvasion"):"-"),this.elAttrNightBattle.html(this.calculate("nightBattle"))}}},{key:"calculate",value:function(e,t){if(!this.shipId)return"-";if("attribute"==e)return _g.data.ships[this.shipId].getAttribute(t,this.shipLv);if(Formula[e])switch(e){case"losPower":return Formula[e](this.shipId,this.data[2],this.data[3],this.data[4],{hqLv:this.infosFleet.data.hq_lv,shipLv:this.shipLv});default:return Formula[e](this.shipId,this.data[2],this.data[3],this.data[4])}return Formula.calculate[e]?Formula.calculate(e,this.shipId,this.data[2],this.data[3],this.data[4])||"-":Formula.calcByShip[e]?Formula.calcByShip[e](_g.data.ships[this.shipId],this.data[2].map(function(e){return _g.data.items[e]}))||0:"-"}},{key:"updateEl",value:function(e){var i=this;this._updating=!0,this.data=e||this.data,"string"==typeof this.data[0]&&(this.data[0]=parseInt(this.data[0])),this.data[2]||(this.data[2]=[]),this.data[3]||(this.data[3]=[]),this.data[4]||(this.data[4]=[]),this.data[0]&&(this.shipId=this.data[0],this.data[1][0]&&(this.shipLv=this.data[1][0]),this.equipments.forEach(function(e,t){e.id=i.data[2][t],e.star=i.data[3][t],e.rank=i.data[4][t]}),this.updateAttrs()),this._updating=!1}},{key:"getData",value:function(){return this.data}},{key:"showMenu",value:function(){l.menuCurObj=this,l.menu||(l.menuItems=[$('<menuitem class="move move-up"/>').html(" ").on({click:function(e){l.menuCurObj.moveUp()},show:function(){l.menuCurObj.index?l.menuItems[0].removeClass("disabled"):l.menuItems[0].addClass("disabled")}}),$('<menuitem class="move move-down"/>').html(" ").on({click:function(e){l.menuCurObj.moveDown()},show:function(){l.menuCurObj.index<l.menuCurObj.infosFleetSubFleet.ships.length-1?l.menuItems[1].removeClass("disabled"):l.menuItems[1].addClass("disabled")}}),$("<hr/>"),$("<menuitem/>").html("查看资料").on({show:function(){l.menuItems[3].attr("data-infos","[[SHIP::"+l.menuCurObj.shipId+"]]")}}),$("<menuitem/>").html("查看装备属性加成...").on({show:function(){var e=l.menuItems[4];e.off("click.fleet-ship-show-bonuses"),e.on("click.fleet-ship-show-bonuses",function(){modal.bonuses.show("ship",l.menuCurObj.shipId)})}}),$("<menuitem/>").html("移除").on({click:function(e){l.menuCurObj.shipId=null}}),$("<menuitem/>").html("替换为 ...").on({click:function(e){l.menuCurObj.selectShipStart()}}),$("<div/>").on("show",function(){var i=l.menuItems[7].empty();if(l.menuCurObj.shipId){var e=_g.data.ships[l.menuCurObj.shipId].getSeriesData()||[];1<e.length&&e.forEach(function(e,t){t||i.append($("<hr/>")),e.id!=l.menuCurObj.shipId&&i.append($("<menuitem/>").html("替换为 "+_g.data.ships[e.id].getName(!0)).on({click:function(){l.menuCurObj.shipId=e.id}}))})}})],l.menu=new _menu({className:"contextmenu-ship",items:l.menuItems})),l.menu.show(this.elBtnOptions)}},{key:"swap",value:function(e,t,i){if(l.dragIsSwapping)return!1;l.dragIsSwapping=!0,"number"==typeof e&&(e=this.infosFleetSubFleet.ships[e]),this.index>e.index?this.el.insertBefore(e.el):this.el.insertAfter(e.after),this.after.insertAfter(this.el);var n=e.index,a=this.index;console.log(n,a),this.index=n,e.index=a,(this.infosFleetSubFleet.ships[n]=this).infosFleetSubFleet.ships[a]=e,t&&this.save(),setTimeout(function(){i&&i(),setTimeout(function(){l.dragIsSwapping=!1},10)},10)}},{key:"moveUp",value:function(){this.index<=0||this.swap(this.index-1,!0)}},{key:"moveDown",value:function(){this.index>=this.infosFleetSubFleet.ships.length-1||this.swap(this.index+1,!0)}},{key:"save",value:function(){if(this._updating)return!1;this._updateTimeout||(this._updateTimeout=setTimeout(function(){this.updateAttrs(),this.infosFleetSubFleet&&(this.infosFleetSubFleet.summaryCalc(),this.infosFleetSubFleet.save()),this._updateTimeout=null}.bind(this),50))}},{key:"shipId",get:function(){return this.data[0]},set:function(e){var i=this;if(e!=this.data[0]&&(this.data[0]=e,this.shipLv=null,delete this.stat.speed),5<this.equipments.length&&this.equipments.splice(5,this.equipments.length-5).forEach(function(e){e.el.remove()}),e){var n=_g.data.ships[e],t=n.getSuffix(),a=n._speed,s=n._type;if(s=s.replace(a,""),this.el.attr("data-shipId",e),this.elAvatar.html('<img src="'+n.getPic(10,_g.imgExt)+'"/>'),this.elInfosTitle.html('<h4 data-content="'+n.name[_g.lang]+'">'+n.name[_g.lang]+"</h4>"+(t?'<h5 data-content="'+t+'">'+t+"</h5>":"")),this.elInputLevel.attr("min",n._minLv),this.elInfosSpeed.html(a),this.elInfosType.html(s),n&&Array.isArray(n.slot)&&4<n.slot.length)for(var o=5;o<n.slot.length+1;o++)this.equipments[o]=new InfosFleetShipEquipment(this,o),this.equipments[o].el.appendTo(this.elEquipments);this.equipments.forEach(function(e,t){t<4?e.carry=n.slot[t]:4===t?e.carry=0:4<t&&(e.carry=n.slot[t-1]),i._updating||(e.id=null,e.star=null,e.rank=null)})}else this.el.removeAttr("data-shipId"),this.elInputLevel.attr("min",0),this.elAvatar.html(""),this.data[2]=[],this.data[3]=[],this.data[4]=[],this.index>=InfosFleet.minSubFleetShipsCount&&this.getEl().remove();this.save()}},{key:"shipLv",get:function(){return this.data[1][0]},set:function(e){this.data[1][0]=e||null,e&&0<e?this.elInputLevel.val(e):this.elInputLevel.val(""),this.save()}}]),l}();InfosFleetShip.dragStart=function(e){if(InfosFleetShip.dragging||!e)return!1;(InfosFleetShip.dragging=e).el.addClass("moving"),InfosFleetShip.isInit||($body.on({"pointerup.InfosFleetShip_dragend pointercancel.InfosFleetShip_dragend":function(){InfosFleetShip.dragging&&(InfosFleetShip.dragging.el.removeClass("moving"),InfosFleetShip.dragging.save(),InfosFleetShip.dragging=null)}}),InfosFleetShip.isInit=!0)},InfosFleetShip.dragEnter=function(e){if(!InfosFleetShip.dragging||!e||InfosFleetShip.dragging==e)return!1;InfosFleetShip.dragging.swap(e)},InfosFleetShip.dragTouchGetPosition=function(){return InfosFleetShip.draggingTouchPosition=[],!!InfosFleetShip.dragging&&(InfosFleetShip.draggingTouchPosition=InfosFleetShip.dragging.infosFleetSubFleet.ships.map(function(e){var t=e.el.offset();return{top:t.top+10,bottom:t.top+e.el.height()-10,target:e}}),InfosFleetShip.draggingTouchPosition)},InfosFleetShip.dragTouchmove=function(e){if(!InfosFleetShip.dragging||InfosFleetShip.dragIsSwapping)return!1;var t=e.originalEvent.touches||e.originalEvent.changedTouches;if(!t||!t.length||1<t.length)return!1;InfosFleetShip.draggingTouch||(InfosFleetShip.dragTouchGetPosition(),InfosFleetShip.draggingTouch=!0);var i=t[0].clientY||t[0].pageY||-1;InfosFleetShip.draggingTouchPosition.some(function(e){if(InfosFleetShip.dragging==e.target)return!1;var t=!1;return i>=e.top&&i<=e.bottom&&(t=e.target),t&&InfosFleetShip.dragging.swap(t,!1,InfosFleetShip.dragTouchGetPosition),t})};var InfosFleetShipEquipment=function(){function s(e,t,i,n,a){if(_classCallCheck(this,s),this.index=t||0,this.isParentAirfield=e instanceof InfosFleetAirfield,this.infosParent=e,this.el)return this.el;this.elBlurTimeout,this.el=$('<div class="equipment equipment-'+this.index+'" tabindex="0"/>').on({focus:function(){s.cur=this.el.addClass("is-hover")}.bind(this),blur:function(){var e=this;this.elBlurTimeout=setTimeout(function(){e.el.removeClass("is-hover"),s.cur=null},10)}.bind(this),pointerenter:function(e){var t=this;if("touch"!=e.originalEvent.pointerType&&(s.cur=this.el.addClass("is-hover"),4<=this.index)){var i=this.el.attr("data-tip");this.el.attr("data-tip",""),i&&setTimeout(function(){t.el.attr("data-tip",i),setTimeout(function(){t.el.data("tip-filtered_")||(_p.tip.filters.forEach(function(e){i=e(i)||i}),t.el.data({"tip-filtered_":i})),_p.tip.show(t.el.data("tip-filtered_"),t.el,t.el.data("tip-position"))},100)},10)}}.bind(this),pointerleave:function(e){"touch"!=e.originalEvent.pointerType&&(this.el.removeClass("is-hover").blur(),s.cur=null)}.bind(this)}).append(this.elCarry=$('<div class="equipment-layer equipment-add"/>').on("click",function(){this.selectEquipmentStart()}.bind(this))).append($('<div class="equipment-layer equipment-infos"/>').append(this.elName=$('<span class="equipment-name"/>')).append(this.elStar=$('<span class="equipment-star"/>').html(0)).append(this.elRank=$('<span class="equipment-rank"/>')).append(function(){var e=$('<span class="equipment-carry"/>').html(0);return this.elCarry=this.elCarry.add(e),e}.bind(this))).append($('<div class="equipment-layer equipment-options"/>').append(this.elInputStar=$("<input/>",{class:"equipment-starinput",type:"number",placeholder:0,min:0,max:10}).on({input:function(){var e=this.elInputStar.val();void 0!==e&&""!==e||!this.star||(this.star=null),e=parseInt(e),isNaN(e)||this.star==e||(this.star=e)}.bind(this),focus:function(){clearTimeout(this.elBlurTimeout),this.el.addClass("is-hover")}.bind(this),blur:function(){setTimeout(function(){this.el.is(":focus")||this.el.removeClass("is-hover")}.bind(this),10)}.bind(this),pointerdown:function(e){var t=this;console.log("pointerdown"),"touch"==e.originalEvent.pointerType&&(s.cur=this.el.addClass("is-hover"),clearTimeout(this.elBlurTimeout),setTimeout(function(){t.elInputStar.trigger("focus")},10))}.bind(this),pointerenter:function(e){"touch"!=e.originalEvent.pointerType&&(s.cur=this.el.addClass("is-hover"),clearTimeout(this.elBlurTimeout))}.bind(this),mouseenter:function(e){s.cur=this.el.addClass("is-hover"),clearTimeout(this.elBlurTimeout)}.bind(this)})).append(this.elSelectRank=$("<div/>",{class:"equipment-rankselect",html:"<span>...</span>"}).on("click",function(){if(this.el.hasClass("is-rankupgradable")){if(!InfosFleet.menuRankSelect){InfosFleet.menuRankSelectItems=$("<div/>");for(var e=function(e){$('<button class="rank-'+e+'"/>').html(e?"":"...").on("click",function(){InfosFleet.menuRankSelectCur.rank=e}).appendTo(InfosFleet.menuRankSelectItems)},t=0;t<8;t++)e(t);InfosFleet.menuRankSelect=new _menu({className:"contextmenu-infos_fleet_rank_select",items:[InfosFleet.menuRankSelectItems]})}InfosFleet.menuRankSelectCur=this,InfosFleet.menuRankSelect.show(this.elSelectRank)}}.bind(this))).append(this.elButtonInspect=$('<span class="button inspect" icon="search"/>').on("click",function(){this.id&&_frame.infos.show("[[EQUIPMENT::"+this.id+"]]")}.bind(this))).append($('<span class="button change" icon="loop"/>').on("click",function(){this.selectEquipmentStart()}.bind(this))).append($('<span class="button remove"/>').on("click",function(){this.id=null}.bind(this)))),i&&(this.carry=i),n&&(this.equipmentTypes=n),this.extraEquipments=a||[]}return _createClass(s,[{key:"getEl",value:function(){return this.el}},{key:"selectEquipmentStart",value:function(){_g.log("开始选择装备"),_frame.app_main.load_page("equipments",{callback_modeSelection_select:function(e){history.back(),this.id=e,this.star=0,this.rank=Lockr.get("fleetlist-option-aircraftdefaultmax")&&e&&_g.data.items[e].rankupgradable&&-1<$.inArray(_g.data.items[e].type,Formula.equipmentType.Aircrafts)?7:0,this.infosParent.infosFleet&&_frame.infos.dom.main.attr("data-theme",this.infosParent.infosFleet.data.theme)}.bind(this),callback_modeSelection_enter:function(){var e=this.infosParent.shipId,t=e&&_g.data.ships[e],i=e&&t.additional_exslot_item_ids,n=e?t.getEquipmentTypes(this.index):[],a=e?n:[],s=!1;if(this.equipmentTypes&&this.equipmentTypes.length)if(a.length){var o=[];this.equipmentTypes.forEach(function(e){-1<a.indexOf(e)&&o.push(e)}),a=o,s=!0}else a=this.equipmentTypes;TablelistEquipments.isExtraSlot=s,TablelistEquipments.types=a,TablelistEquipments.shipId=this.infosParent.shipId||"FIELD";try{TablelistEquipments.currentSelected=this.infosParent.data[2]||[]}catch(e){TablelistEquipments.currentSelected=[]}TablelistEquipments.extraEquipments=this.extraEquipments?this.extraEquipments.concat():[],TablelistEquipments.extraEquipments=TablelistEquipments.extraEquipments.filter(function(e){return console.log(TablelistEquipments.types,_g.data.items[e].type),-1<n.indexOf(_g.data.items[e].type)}),s&&Array.isArray(i)&&(TablelistEquipments.extraEquipments=TablelistEquipments.extraEquipments.concat(i)),_frame.app_main.page.equipments.object.tablelistObj.apply_types()}.bind(this)})}},{key:"getData",value:function(){return this.data}},{key:"save",value:function(){if(this._updating)return!1;this.infosParent&&this.infosParent.save()}},{key:"id",get:function(){return this.isParentAirfield?this.infosParent.data[this.index][0]:this.infosParent.data[2][this.index]},set:function(e){e=parseInt(e)||null,_p.tip.hide(),this.el.removeData(["tip","tip-filtered","tip-filtered_"]),this.isParentAirfield||e==this.infosParent.data[2][this.index]||(this.star=0),e&&!isNaN(e)?(this.isParentAirfield?this.infosParent.data[this.index][0]=e:this.infosParent.data[2][this.index]=e,-1<s.improvableExtra.indexOf(e)?this.improvable=!0:this.improvable=_g.data.items[e].improvable||!1,this.el.attr({"data-equipmentid":e,"data-tip":"[[EQUIPMENT::"+e+"]]","touch-action":"none"}).css("background-image","url("+_g.data.items[e]._icon+")"),this.elName.html(_g.data.items[e]._name),-1<$.inArray(_g.data.items[e].type,Formula.equipmentType.Aircrafts)?(this.el.addClass("is-aircraft"),_g.data.items[e].rankupgradable&&this.el.addClass("is-rankupgradable")):this.el.removeClass("is-aircraft is-rankupgradable"),this.isParentAirfield&&(-1<Formula.equipmentType.Recons.indexOf(_g.data.items[e].type)?this.carry=4:this.carry=18)):(this.isParentAirfield?(this.infosParent.data[this.index][0]=null,this.carry=18):this.infosParent.data[2][this.index]=null,this.improvable=!1,this.el.removeAttr("data-equipmentId").removeAttr("data-tip").removeAttr("data-star").removeAttr("data-rank").removeAttr("touch-action").css("background-image","").removeClass("is-aircraft is-rankupgradable"),this.elName.html("")),this.isParentAirfield?this.infosParent.summaryCalc():this.infosParent.infosFleetSubFleet.summaryCalc(),this.save()}},{key:"star",get:function(){return this.infosParent.data[3][this.index]},set:function(e){var t=function(e){this.isParentAirfield?this.infosParent.data[this.index][2]=e:this.infosParent.data[3][this.index]=e}.bind(this);this._improvable?(10<(e=parseInt(e)||null)&&(e=10),e<0&&(e=0),e?(t(e),this.elInputStar.val(e),this.elStar.html(e),this.el.attr("data-star",e)):(t(null),this.elInputStar.val(""),this.elStar.html(0),this.el.attr("data-star",""))):(t(null),this.el.removeAttr("data-star")),this.isParentAirfield?this.infosParent.summaryCalc():this.infosParent.infosFleetSubFleet.summaryCalc(),this.save()}},{key:"rank",get:function(){return this.isParentAirfield?this.infosParent.data[this.index][1]:this.infosParent.data[4][this.index]},set:function(e){var t=function(e){this.isParentAirfield?this.infosParent.data[this.index][1]=e:this.infosParent.data[4][this.index]=e}.bind(this);this.id&&-1<$.inArray(_g.data.items[this.id].type,Formula.equipmentType.Aircrafts)?(7<(e=parseInt(e)||null)&&(e=7),e<0&&(e=0),e?(t(e),this.el.attr("data-rank",e)):(t(null),this.el.attr("data-rank",""))):(t(null),this.el.removeAttr("data-rank")),this.isParentAirfield?this.infosParent.summaryCalc():this.infosParent.infosFleetSubFleet.summaryCalc(),this.save()}},{key:"carry",set:function(e){void 0===e?(this.el.removeAttr("data-carry"),this.elCarry.html(0)):(e=parseInt(e)||0,this.el.attr("data-carry",e),this.elCarry.html(e))}},{key:"improvable",set:function(e){e?(this.el.attr("data-star",""),this.elInputStar.prop("disabled",!1).attr("placeholder","0"),this._improvable=!0):(this.el.removeAttr("data-star"),this.elInputStar.prop("disabled",!0).attr("placeholder","--"),this._improvable=!1)}}]),s}();InfosFleetShipEquipment.improvableExtra=[110];var InfosFleetSubAirfield=function(){function a(e,t,i){_classCallCheck(this,a),t=t||[],this.data=t,this.label=i,this.el=$('<dl class="fleetships fleetairfields"/>'),this.container=$('<dl class="airfields"/>').appendTo(this.el),this.fields=[];for(var n=0;n<3;)this.fields[n]=new InfosFleetAirfield(e,this,n),this.fields[n].getEl().appendTo(this.container),n++;$('<dl class="gap"/>').appendTo(this.el);$('<dl class="tips"/>').html('\n                    <ul class="tip-content">\n                        <h4 data-content="小贴士">小贴士</h4>\n                        '+["“航程”决定了该航空队在出击时所能抵达的最远作战点，数值由航程属性最小的中队决定，侦察机也可以提高这一数值。","“制空战力”表示该航空队执行出击任务时的制空能力，“防空战力”则表示防空任务能力。","局地战斗机的“迎击”属性也可以提高制空战力。装备列表中局战的“回避”列数值即为“迎击”属性。","除了局地战斗机的“迎击”和“对爆”属性外，在航空队种配置侦察机也可以有效提高防空战力。"].map(function(e){return"<li>"+e+"</li>"}).join("")+"\n                    </ul>\n                ").appendTo(this.el),this.infosFleet=e}return _createClass(a,[{key:"updateEl",value:function(e){var i=this;this.data=e||this.data;var n=0;e&&e.forEach(function(e,t){this.fields[t].updateEl(e),e&&e.push&&e.forEach(function(e){e&&e.push&&e[0]&&n++})},this),this.infosFleet.data.name_airfields&&this.infosFleet.data.name_airfields.push&&this.infosFleet.data.name_airfields.forEach(function(e,t){i.fields[t].elTitle.html(e).trigger("namechange",[e]).trigger("blur")}),n?this.label.addClass("highlight"):this.label.removeClass("highlight")}},{key:"getData",value:function(){return this.data}},{key:"save",value:function(){this.data=this.data||[];var i=0,n=[];this.fields.forEach(function(e,t){this.data[t]=e.data,e.data&&e.data.push&&e.data.forEach(function(e){e&&e.push&&e[0]&&i++}),n[t]=e.name||""},this),i?this.label.addClass("highlight"):this.label.removeClass("highlight"),this.infosFleet&&(this.infosFleet.data.name_airfields=n,this.infosFleet.save())}}]),a}(),InfosFleetAirfield=function(){function s(e,t,i,n){var a=this;if(_classCallCheck(this,s),this.el)return this.el;n=n||[[],[],[],[]],this.data=n,this.infosFleet=e,this.infosParent=t,this.aircrafts=[],this.index=i;this.el=$('<dd class="airfield"/>').append(this.elTitle=new InfosFleetEditableTitle({tagName:"h4",placeholder:"第"+["一","二","三"][i]+"航空队",onUpdate:function(e){a._name=e}}).$el).append($('<div class="aircrafts"/>').append(function(){for(var e=$(),t=0;t<4;t++)this.aircrafts[t]=new InfosFleetShipEquipment(this,t,18,s.equipmentTypes),e=e.add(this.aircrafts[t].el);return e}.bind(this))),this.elSummary=$('<span class="summary"/>').appendTo($('<div class="airfield-summary"/>').appendTo(this.el)).append($('<span class="summary-item"/>').html("航程").append(this.elSummaryDistance=$("<strong/>").html("-"))).append($('<span class="summary-item"/>').html("制空战力").append(this.elSummaryFighterPower=$("<strong/>").html("-"))).append($('<span class="summary-item"/>').html("防空战力").append(this.elSummaryFighterPowerAA=$("<strong/>").html("-"))),this.els=this.el}return _createClass(s,[{key:"getEl",value:function(){return this.els}},{key:"updateEl",value:function(e){this._updating=!0,this.data=e||this.data;for(var t=0;t<4;t++)this.data[t]?(this.data[t][0]&&(this.aircrafts[t].id=this.data[t][0]),this.data[t][1]&&(this.aircrafts[t].rank=this.data[t][1]),this.data[t][2]&&(this.aircrafts[t].star=this.data[t][2])):this.data[t]=[];this._updating=!1}},{key:"getData",value:function(){return this.data}},{key:"getCarry",value:function(e){return-1<Formula.equipmentType.Recons.indexOf(e.type)?KC.planesPerSlotLBAS.recon:KC.planesPerSlotLBAS.attacker}},{key:"summaryCalc",value:function(){return!(this.summaryCalculating||!this.data||!this.data.push)&&(this.summaryCalculating=setTimeout(function(){var e,t,a={min:0,max:0,recon:0},s=[];this.data.forEach(function(e){if(e[0]){var t=_g.data.items[e[0]],i=this.getCarry(t),n=t.stat.distance||0;-1<Formula.equipmentType.Recons.indexOf(t.type)?a.recon=Math.max(a.recon,n):(a.min=a.min<=0?n:Math.min(a.min,n),a.max=Math.max(a.max,n)),s.push({equipment:t,rank:e[1],star:e[2],carry:i})}},this),e=Formula.calcByField.fighterPower(s),t=Formula.calcByField.fighterPowerAA(s);var i=function(e,t){if(0<Math.max(e[0],e[1])){var i=Math.floor(e[0]),n=Math.floor(e[1]);t.removeClass("empty").html(i==n?i:i+"~"+n)}else t.addClass("empty").html("-")};if(i(e,this.elSummaryFighterPower),i(t,this.elSummaryFighterPowerAA),0<a.min+a.recon){var n=a.min;a.recon&&(n+=Math.round(Math.min(3,Math.max(0,Math.sqrt(a.recon-a.min))))),this.elSummaryDistance.removeClass("empty").html(n)}else this.elSummaryDistance.addClass("empty").html("-");this.summaryCalculating=null}.bind(this),10),!0)}},{key:"swap",value:function(e,t){"number"==typeof e&&(e=this.infosFleetSubFleet.ships[e]),this.index>e.index?this.el.insertBefore(e.el):this.el.insertAfter(e.after),this.after.insertAfter(this.el);var i=e.index,n=this.index;console.log(i,n),this.index=i,e.index=n,(this.infosFleetSubFleet.ships[i]=this).infosFleetSubFleet.ships[n]=e,t&&this.save()}},{key:"moveUp",value:function(){this.index<=0||this.swap(this.index-1,!0)}},{key:"moveDown",value:function(){5<=this.index||this.swap(this.index+1,!0)}},{key:"save",value:function(){if(this._updating)return!1;this._updateTimeout||(this._updateTimeout=setTimeout(function(){this.infosParent&&this.infosParent.save(),this._updateTimeout=null}.bind(this),50))}},{key:"_name",get:function(){return this.name},set:function(e){this.name=e,this.save()}}]),s}();InfosFleetAirfield.dragStart=function(e){if(e.dragging||!e)return!1;(e.dragging=e).el.addClass("moving"),e.isInit||($body.on({"pointerup.InfosFleetAirfield_dragend pointercancel.InfosFleetAirfield_dragend":function(){e.dragging&&(e.dragging.el.removeClass("moving"),e.dragging.save(),e.dragging=null)}}),e.isInit=!0)},InfosFleetAirfield.dragEnter=function(e){if(!InfosFleetAirfield.dragging||!e||InfosFleetAirfield.dragging==e)return!1;InfosFleetAirfield.dragging.swap(e)},InfosFleetAirfield.equipmentTypes=$.unique(Formula.equipmentType.LandBased.concat(Formula.equipmentType.Seaplanes).concat(Formula.equipmentType.CarrierBased).concat(Formula.equipmentType.Recons)),_frame.app_main.is_mode_selection=function(){return $html.hasClass("mode-selection")||_frame.dom.layout.hasClass("mode-selection")},_frame.app_main.mode_selection_callback=null,_frame.app_main.mode_selection_on=function(e){_frame.dom.navSelectionInfo||(_frame.dom.navSelectionInfo=$('<div class="selection-info"/>').html("请选择……").appendTo(_frame.dom.nav)),(e=e||function(){})(),_frame.dom.layout.addClass("mode-selection")},_frame.app_main.mode_selection_off=function(){this.cur_page&&this.page_dom[this.cur_page].trigger("modeSelectionExit"),_frame.dom.layout.removeClass("mode-selection")},void 0!==_p.tip&&(_p.tip.filters.push(function(e){var t=/^\[\[EQUIPMENT\:\:([0-9]+)\]\]$/.exec(e);if(t&&1<t.length)return _p.tip.content_equipment(_g.data.items[parseInt(t[1])])}),_p.tip.content_equipment=function(n){function e(e,t){if(!n.stat[e])return"";if(-1<Formula.equipmentType.Interceptors.indexOf(n.type))switch(e){case"hit":t="对爆";break;case"evasion":t="迎击"}switch(e){case"range":return"<span>射程: "+_g.getStatRange(n.stat[e])+"</span>";case"distance":return"<span>"+t+": "+n.stat[e]+"</span>";default:var i=parseInt(n.stat[e]);return"<span>"+(0<i?"+":"")+i+" "+t+"</span>"}}var t=n.getName(),i=-1<$.inArray(n.type,Formula.equipmentType.Aircrafts);return'<h3 class="itemstat"><s class="equiptypeicon mod-'+n.getIconId()+'"></s><strong data-content="'+t+'">'+t+"</strong><small>"+_g.data.item_types[n.type].name.zh_cn+"</small></h3>"+e("fire","火力")+e("torpedo","雷装")+e("aa","对空")+e("asw","对潜")+e("bomb","爆装")+e("hit","命中")+e("armor","装甲")+e("evasion","回避")+e("los","索敌")+e("range","射程")+(i?e("distance","航程"):"")},_p.tip.filters.push(function(e){var t=/^\[\[EQUIPABLE\:\:([0-9]+)\]\]$/.exec(e);if(t&&1<t.length)return _p.tip.content_equipable(_g.data.item_types[parseInt(t[1])])}),_p.tip.content_equipable_results={},_p.tip.content_equipable=function(t){if(!_p.tip.content_equipable_results[t.id]){var e='<h4 class="item_equipable_on">可装备于以下舰种</h4>',i=t.equipable_extra_ship||[];if(e+="<p>",t.equipable_on_type.length){var n=[];_g.ship_type_order_full.forEach(function(e){-1<t.equipable_on_type.indexOf(e)&&n.push(e)}),e+=n.map(function(e){var t=_g.data.ship_types[e];return"<span>"+(t.name.zh_cn||t.name.ja_jp)+"("+t.code+")</span>"}).join(" / ")}else e+="无...";e+="</p>",i.length&&(e+='<h4 class="item_equipable_on">也可装备于以下舰娘</h4>',e+=t.equipable_extra_ship.map(function(e){var t=_g.data.ships[e],i=t.getType();return'<span><a href="?infos=ship&id='+e+'" data-shipid="'+e+'" data-infos="[[SHIP::'+e+']]" data-tip="[[SHIP::'+e+']]">'+(i?"["+i+"] ":"")+t.getName(_g.joint)+"</a></span>"}).join(" / ")),_p.tip.content_equipable_results[t.id]=e}return _p.tip.content_equipable_results[t.id]}),void 0!==_p.tip&&(_p.tip.filters.push(function(e){var t=/^\[\[SHIP\:\:([0-9]+)\]\]$/.exec(e);if(t&&1<t.length)return _p.tip.content_ship(_g.data.ships[parseInt(t[1])])}),_p.tip.content_ship=function(e){var t=e.getName(_g.joint);return'<h3 class="shipinfo"><img src="'+KC.getFolderGroup(_g.path.pics.ships,e.id)+"/"+e.id+'/0.webp" width="160" height="40"/><strong data-content="'+t+'">'+t+"</strong>"+(e.type?"<small>"+_g.data.ship_types[e.type].name.zh_cn+"</span>":"")+"</h3>"});var modal={};modal.equipable={frames:{},frame:function(e){if(!e)return!1;if(!this.frames[e]){var t=$("<div/>"),i=_g.data.item_types[e],n=i.equipable_on_type||[],a=i.equipable_extra_ship||[],s=[];if(_g.ship_type_order_full.forEach(function(e){-1<n.indexOf(e)&&s.push(e)}),_p.el.flexgrid.create().appendTo(t).addClass("equipable-types").prepend($(_g.ship_type_order_full.map(function(e){var t=_g.data.ship_types[e];return t.hide||t.donotcompare?"":'<span class="unit'+(-1<n.indexOf(e)?" on":"")+'">'+(t.name.zh_cn||t.name.ja_jp)+" ("+t.code+")</span>"}).join(""))).appendTo(t),a.length){t.append("<p>以及以下舰娘...</p>");var o=_p.el.flexgrid.create().appendTo(t).addClass("list-ship equipable-extra-ships");a.forEach(function(e){o.appendDOM(_tmpl.link_ship(e).addClass("unit"))})}this.frames[e]=t}return this.frames[e]},show:function(e){return _frame.modal.show(this.frame(e),_g.data.item_types[e].name.zh_cn+" 可装备于...",{classname:"modal-equipable",detach:!0})}},modal.bonuses={show:function(e,t){switch(this.type=void 0,this.ship=void 0,this.equipment=void 0,e.toLowerCase()){case"ship":this.type="ship",this.ship=_g.data.ships[t];break;case"equipment":case"item":this.type="equipment",this.equipment=_g.data.items[t]}return _frame.modal.show(this.getFrame(),this.getTitle(),{classname:"modal-bonuses modal-bonuses-"+this.type,detach:!0})},_cache:{ship:{},equipment:{}},getFrame:function(){var t=this,i=this._cache[this.type],e=this.ship||this.equipment,n=e.id;if(i[n])return i[n];i[n]=$();var a={single:[],set:[]};return e.getBonuses().forEach(function(e){"object"===_typeof(e.equipments)?a.set.push(e):a.single.push(e)}),a.single.length&&a.single.forEach(function(e){i[n]=i[n].add(t.renderBonusSingle(e))}),a.set.length&&(i[n]=i[n].add(this.renderSubTitle("set")),a.set.forEach(function(e){i[n]=i[n].add(t.renderBonusSet(e))})),a.single.length||a.set.length||(i[n]=$('<span class="no-bonuses">无</span>')),i[n]},renderSubTitle:function(e){return $('<div class="bonus bonus-title">'+("set"===e?"套装加成":"")+"</div>")},renderStat:function(s){var o="";return _g.stats.forEach(function(e){var t=_slicedToArray(e,1)[0];if(isNaN(s[t])||!s[t])return!1;var i=s[t],n="";switch(t){case"range":i<=1&&(n="射程提高一档")}var a=["stat"];"string"==typeof i?n+="+"+i+" (该属性不叠加)":i<0?(n=""+i,a.push("negative")):n="+"+i,o+='<span class="'+a.join(" ")+'" data-stat="'+t+'">'+n+"</span>"}),o},renderConditionShips:function(e){var t="";return void 0!==e.ship.isType&&(t+='<div class="condition">'+(Array.isArray(e.ship.isType)?e.ship.isType:[e.ship.isType]).map(function(e){var t=_g.data.ship_types[parseInt(e)];return t.name.zh_cn||t.name.ja_jp}).map(function(e){return'<span class="item ship-class">'+e+"</span>"}).join("")+"</div>"),void 0!==e.ship.isNotType&&(t+='<div class="condition">'+(Array.isArray(e.ship.isNotType)?e.ship.isNotType:[e.ship.isNotType]).map(function(e){var t=_g.data.ship_types[parseInt(e)];return t.name.zh_cn||t.name.ja_jp}).map(function(e){return'<span class="item ship-exclude">'+e+"</span>"}).join("")+"</div>"),void 0!==e.ship.isClass&&(t+='<div class="condition">'+(Array.isArray(e.ship.isClass)?e.ship.isClass:[e.ship.isClass]).map(function(e){var t=_g.data.ship_classes[parseInt(e)],i=_g.data.ship_types[parseInt(t.ship_type_id)];return(t.name.zh_cn||t.name.ja_jp)+"级"+(i.name.zh_cn||i.name.ja_jp)}).map(function(e){return'<span class="item ship-class">'+e+"</span>"}).join("")+"</div>"),void 0!==e.ship.isID&&(t+='<div class="condition">'+(Array.isArray(e.ship.isID)?e.ship.isID:[e.ship.isID]).map(function(e){var t=_g.data.ships[parseInt(e)];return'<a class="item ship ship-link" href="'+_g.getLink("ships",t.id)+'" data-shipid="'+t.id+'"><em class="avatar"><img src="'+t.getPic(0,_g.imgExt)+'"/></em>'+t._name+"</a>"}).join("")+"</div>"),void 0!==e.ship.isNotID&&(t+='<div class="condition">'+(Array.isArray(e.ship.isNotID)?e.ship.isNotID:[e.ship.isNotID]).map(function(e){return'<span class="item ship-exclude">'+_g.data.ships[parseInt(e)]._name+"</span>"}).join("")+"</div>"),t?'<div class="ships">'+t+"</div>":""},renderBonusSingle:function(t){var i=this,e="",n="",a="";switch(this.type){case"ship":e='<div class="equipments">'+_tmpl.link_equipment(t.equipment,void 0,!0)+"</div>";break;case"equipment":e=this.renderConditionShips(t);var s="object"===_typeof(t.ship)?Object.keys(t.ship).filter(function(e){return"canequip"!==e.toLowerCase()}):[],o="object"===_typeof(t.ship)&&0===s.length,r="object"===_typeof(t.ship)&&1===s.length&&"undefined"!==t.ship.isNotType;a=o?"装备于任意舰娘时，":r?"":"装备于以上舰娘时，"}if("object"===_typeof(t.bonusCount))a+="该装备根据数量提供属性加成 (超额的部分不提供加成)</span>",Object.keys(t.bonusCount).sort(function(e,t){return parseInt(e)-parseInt(t)}).forEach(function(e){n+='<div class="has-extra"><div class="extra count" data-count="'+e+'">'+e+"</div>"+i.renderStat(t.bonusCount[e])+"</div>"});else if("object"===_typeof(t.bonusImprove))a+="每个该装备根据改修星级提供属性加成",Object.keys(t.bonusImprove).sort(function(e,t){return parseInt(e)-parseInt(t)}).forEach(function(e){n+='<div class="has-extra"><div class="extra star" data-star="'+e+'">'+e+"</div>"+i.renderStat(t.bonusImprove[e])+"</div>"});else if("object"===_typeof(t.bonusArea)){a+="每个该装备根据所处海域提供属性加成";var l={north:"北方"};Object.keys(t.bonusArea).forEach(function(e){n+='<div class="has-extra"><div class="extra area">'+l[e.toLowerCase()]+"</div>"+i.renderStat(t.bonusArea[e])+"</div>"})}else"object"===_typeof(t.bonus)&&(a+="每个该装备提供属性加成",n=this.renderStat(t.bonus));return $('<div class="bonus bonus-single">'+e+'<div class="stats"><span class="info">'+a+"</span>"+n+"</div></div>")},renderBonusSet:function(e){var t=this,i="",n="",a="";switch(this.type){case"ship":break;case"equipment":i=this.renderConditionShips(e)}return"object"===_typeof(e.bonus)&&(a="满足该条件时提供额外属性加成",n=this.renderStat(e.bonus)),$('<div class="bonus bonus-set">'+i+'<div class="equipments">'+e.list.map(function(e){if(!isNaN(e))return _tmpl.link_equipment(e,"equipment"===t.type&&e==t.equipment.id?"span":void 0,!0);if(Array.isArray(e))return e.map(function(e){return _tmpl.link_equipment(e,"equipment"===t.type&&e==t.equipment.id?"span":void 0,!0)}).join(" / ");if("object"===(void 0===e?"undefined":_typeof(e))&&e.id)return _tmpl.link_equipment(e.id,"equipment"===t.type&&e.id==t.equipment.id?"span":void 0,!0,e.star);if("string"==typeof e)switch(e){case"SurfaceRadar":return'<span class="link_equipment"><i style="background-image:url(assets/images/itemicon/11.png)"></i><span>对水面雷达/电探</span></span>';case"AARadar":return'<span class="link_equipment"><i style="background-image:url(assets/images/itemicon/11.png)"></i><span>对空雷达/电探</span></span>'}}).map(function(e){return'<div class="equipment">'+e+"</div>"}).join("")+'</div><div class="stats"><span class="info">'+a+"</span>"+n+"</div></div>")},getTitle:function(){switch(this.type){case"ship":return $("<strong>"+this.ship._name+'</strong><span>装备属性加成</span><img src="'+this.ship.getPic(10,_g.imgExt)+'" />');case"equipment":return $("<strong>"+this.equipment._name+'</strong><span>属性加成</span><i style="background-image:url(assets/images/itemicon/'+this.equipment.getIconId()+'.png)"></i>')}}},_p.el.tablelist={init_el:function(e){if(e.data("tablelist"))return!0;e.hasClass("ships")?e.data({tablelist:new TablelistShips(e)}):e.hasClass("tablelist-equipments")?e.data({tablelist:new TablelistEquipments(e)}):e.hasClass("fleets")?e.data({tablelist:new TablelistFleets(e)}):e.hasClass("entities")&&e.data({tablelist:new TablelistEntities(e)})},init:function(e,t){e=e||$body,(t=t||e.find(".tablelist")).each(function(){_p.el.tablelist.init_el($(this))})}};var Tablelist=function(){function u(e,t){_classCallCheck(this,u),this.dom={container:e},t=t||{},this._index=u.index++,this.trIndex=0,this.flexgrid_empty_count=t.flexgrid_empty_count||8,this.sort_data_by_stat=t.sort_data_by_stat||{},this.sort_default_order_by_stat=t.sort_default_order_by_stat||{},e.on("mouseenter.hovercolumn",".tablelist-body dd",this.hovercolumn_delegate.bind(this)).on("mouseleave.hovercolumn",".tablelist-body dd",this.hovercolumn_delegate_leave.bind(this))}return _createClass(u,[{key:"append_option",value:function(t,r,e,l,i,d){d=d||{};var n=$("<p/>").addClass(r).appendTo(this.dom.filters),a=function(){var s=void 0,e=void 0,i=void 0,o=u.genId();switch(t){case"text":case"number":case"hidden":s=$('<input type="'+t+'" name="'+r+'" id="'+o+'" />').val(l);break;case"select":s=$('<select name="'+r+'" id="'+o+'" />'),e=$('<option value=""/>').html("").appendTo(s),l.forEach(function(e,t){i="object"==(void 0===e?"undefined":_typeof(e))?$('<option value="'+(void 0===e.val?e.value:e.val)+'"/>').html(e.title||e.name).appendTo(s):$('<option value="'+e+'"/>').html(e).appendTo(s),void 0!==d.default&&i.val()==d.default&&i.prop("selected",!0)}),l&&l.length||(e.remove(),$('<option value=""/>').html("...").appendTo(s)),d.new&&($('<option value=""/>').html("==========").insertAfter(e),$('<option value="___new___"/>').html("+ 新建").insertAfter(e),s.on("change.___new___",function(){var e=$(this);"___new___"==e.val()&&(e.val(""),d.new(s))}));break;case"checkbox":s=$('<input type="'+t+'" name="'+r+'" id="'+o+'" />').prop("checked",l);break;case"radio":s=$(),l.forEach(function(e,t){var i,n,a=!1;l[t].push?(n=l[t][0],i=l[t][1]):(n=l[t].val||l[t].value,i=l[t].title||l[t].name),d.radio_default&&d.radio_default==n&&(a=!0),s=(s=s.add($('<input type="radio" name="'+r+'" id="'+o+"-"+n+'" ischecked="'+a+'" />').val(n).prop("checked",a||!a&&0==t))).add($('<label for="'+o+"-"+n+'"/>').html(i))})}return d.required&&s.prop("required",!0),d.onchange&&(s.on("change.___onchange___",function(e){d.onchange(e,$(this))}),d.default&&s.trigger("change")),r||s.attr("name",null),s}().appendTo(n),s=a.attr("id")||u.genId();return e=e?$("<label"+("checkbox"==t?' class="checkbox"':"")+' for="'+s+'"/>').html(e).appendTo(n):null,"checkbox"==t&&e&&e.insertAfter(a),i&&$('<label for="'+s+'"/>').html(i).appendTo(n),n}},{key:"thead_redraw",value:function(e){}},{key:"sort_column",value:function(e,i,t){if(!t){var n=this.dom.tbody;n&&n.length||(n=this.dom.table.children(".tablelist-body")),t=n.children("dl:visible:not([data-donotcompare])")}e=e||1,this._tmp_values=[],this._tmp_value_map_cell={},t.children("dd:nth-of-type("+e+")").each(function(e,t){var i=$(t),n=i.attr("value");n=parseFloat(n),$.inArray(n,this._tmp_values)<0&&this._tmp_values.push(n),this._tmp_value_map_cell[n]||(this._tmp_value_map_cell[n]=$()),this._tmp_value_map_cell[n]=this._tmp_value_map_cell[n].add(i)}.bind(this)),this._tmp_values.sort(function(e,t){return i?e-t:t-e});var a=[];return this._tmp_values.forEach(function(e){a.push(this._tmp_value_map_cell[e])},this),delete this._tmp_values,delete this._tmp_value_map_cell,a}},{key:"mark_high",value:function(r){var e=this.dom.tbody;e&&e.length||(e=this.dom.table.children(".tablelist-body"));var l=e.children("dl:visible:not([data-donotcompare])");return l.children("dd[value]").removeClass("sort-first sort-second"),l.eq(0).children("dd[value]").each(function(e,t){var i=!1,n=$(t).attr("stat"),a=n.match(/\b(speed|range|extra_illust)\b/);void 0===this.sort_default_order_by_stat[n]?(n.match(/\b(consum_fuel|consum_ammo)\b/)&&(i=!0),this.sort_default_order_by_stat[n]=i?"asc":"desc"):i="asc"==this.sort_default_order_by_stat[n];var s=this.sort_column(e+1,i,l),o=Math.min(6,Math.ceil(l.length/2)+1);!a&&1<s.length&&s[0].length<o&&(s[0].addClass("sort-first"),2<s.length&&s[1].length<o&&s[1].addClass("sort-second")),r?this.sort_data_by_stat[n]=s:delete this.sort_data_by_stat[n]}.bind(this)),l}},{key:"sort_table_from_theadcell",value:function(e){if(e){var t=e.attr("stat"),i=this.sort_data_by_stat[t];if(!t||!i)return!1;t!=this.lastSortedStat&&(this.lastSortedHeader&&this.lastSortedHeader.removeClass("sorting desc asc"),e.addClass("sorting"));var n=t==this.lastSortedStat&&"obverse"==this.lastSortedOrder?"reverse":"obverse",a="reverse"==n?i.length-1:0;if(this.sort_default_order_by_stat[t]){var s="asc"==this.sort_default_order_by_stat[t]?"desc":"asc";"obverse"==n?e.removeClass(s).addClass(this.sort_default_order_by_stat[t]):e.removeClass(this.sort_default_order_by_stat[t]).addClass(s)}for(this.sortedRow=$();i[a];)this._tmpDOM=i[a].parent(),this.sortedRow=this.sortedRow.add(this._tmpDOM),this._tmpDOM.appendTo(this.dom.tbody),a="reverse"==n?a-1:a+1;this.dom.btn_compare_sort.removeClass("disabled").html("取消排序"),this.lastSortedStat=t,this.lastSortedOrder=n,this.lastSortedHeader=e,delete this._tmpDOM}}},{key:"sort_table_restore",value:function(){if(!this.sortedRow)return!0;var a=void 0,s=[];return this.sortedRow.each(function(e,t){var i=$(t),n=parseInt(i.attr("trindex"));a=a||i.parent(),s.push({index:n,el:i,prev:a.children('[trindex="'+(n-1)+'"]')})}),s.sort(function(e,t){return e.index-t.index}),s.forEach(function(e){e.el.insertAfter(e.prev)}),this.dom.btn_compare_sort.addClass("disabled").html("点击表格标题可排序"),this.lastSortedHeader.removeClass("sorting desc asc"),delete this.sortedRow,delete this.lastSortedStat,delete this.lastSortedOrder,delete this.lastSortedHeader,!0}},{key:"hovercolumn_delegate",value:function(e){if(!$body_preventMouseover&&e&&e.originalEvent.path&&this.dom.tbody){var t=e.currentTarget.getAttribute("data-index");if(t)t=parseInt(t);else{var i=$(e.currentTarget);t=i.index(),i.attr("data-index",t)}this.dom.tbody.find("dl:visible dd:nth-child("+(t+1)+")").addClass("is-hover")}}},{key:"hovercolumn_delegate_leave",value:function(e){!$body_preventMouseover&&e&&e.originalEvent.path&&this.dom.tbody&&(this.dom.tbody.find("dd.is-hover").removeClass("is-hover"),_p.el.tablelist.hovercolumn_mouseleave_delay=null)}}]),u}();Tablelist.index=0,Tablelist.genId=function(e){var t,i,n=0;if(0==(e=e||(new Date).toISOString()+_g.randInt(1e4)).length)return n;for(t=0,i=e.length;t<i;t++)n=(n<<5)-n+e.charCodeAt(t),n|=0;return"tablelist"+n};var TablelistEntities=function(e){function n(e,t){_classCallCheck(this,n);var i=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e,t));return _frame.app_main.loading.push("tablelist_"+i._index),_frame.app_main.is_loaded=!1,e.children(".tablelist-list").length?i.init_parse():i.init_new&&i.init_new(t),i}return _inherits(n,Tablelist),_createClass(n,[{key:"init_parse",value:function(){this.generated=!0,_frame.app_main.loaded("tablelist_"+this._index,!0)}}]),n}(),TablelistShips=function(e){function a(e,t){_classCallCheck(this,a);var i=_possibleConstructorReturn(this,(a.__proto__||Object.getPrototypeOf(a)).call(this,e,t));return i.columns=["  ",["火力","fire"],["雷装","torpedo"],["夜战","nightpower"],["对空","aa"],["对潜","asw"],["耐久","hp"],["装甲","armor"],["回避","evasion"],["搭载","carry"],["航速","speed"],["射程","range"],["索敌","los"],["运","luck"],["油耗","consum_fuel"],["弹耗","consum_ammo"],["多立绘","extra_illust"]],i.header_checkbox=[],i.mode_selection_filters=$(),i.rows=$(),i.rowsById={},i.rowsByHeader={},i.functionsOnEnter=[],i.functionsOnExit=[],_frame.app_main.loading.push("tablelist_"+i._index),_frame.app_main.is_loaded=!1,i.initProgressMax=0,i.initProgressCur=0,i.dom.container.on({initprogress:function(e,t,i){this.initProgressCur=t||this.initProgressCur,this.initProgressMax=i||this.initProgressMax}}),e.children(".tablelist-container").length&&i.init_parse(),i}return _inherits(a,Tablelist),_createClass(a,[{key:"compare_btn_show",value:function(e){!e&&this.rows.filter('[compare="true"]').length||e?this.dom.msg_container.attr("data-msgs","comparestart"):this.dom.msg_container.removeAttr("data-msgs")}},{key:"compare_start",value:function(){this.dom.msg_container.removeAttr("data-msgs"),this.last_viewtype=this.dom.filter_container.attr("viewtype"),_config.set("shiplist-viewtype",this.last_viewtype),this.last_scrollTop=this.dom.tbody.scrollTop(),this.dom.filter_container.attr("viewtype","compare"),this.dom.tbody.scrollTop(0),this.dom.table.addClass("sortable"),this.mark_high(!0),this.thead_redraw(500)}},{key:"compare_off",value:function(){this.dom.filter_container.attr("viewtype",this.last_viewtype),this.sort_table_restore(),this.mark_high(),this.thead_redraw(500),this.dom.tbody.scrollTop(this.last_scrollTop),this.dom.table.removeClass("sortable"),delete this.last_viewtype,delete this.last_scrollTop}},{key:"compare_end",value:function(){this.rows.filter('[compare="true"]').each(function(e,t){this.check(t,!1)}.bind(this)),this.dom.msg_container.removeAttr("data-msgs"),this.compare_off()}},{key:"compare_continue",value:function(){this.dom.msg_container.attr("data-msgs","comparestart"),this.compare_off()}},{key:"contextmenu_show",value:function(e,t,i){if("compare"==this.dom.filter_container.attr("viewtype")||"true"==e.attr("data-donotcompare"))return!1;if(!a.contextmenu){var n=function(){var e=[$("<menuitem/>").html("选择").on({click:function(e){_frame.app_main.is_mode_selection()&&_frame.app_main.mode_selection_callback(a.contextmenu._curid)},show:function(){_frame.app_main.is_mode_selection()?$(this).show():$(this).hide()}}),$("<menuitem/>").html("查看资料").on({click:function(e){a.contextmenu._curel.trigger("click",[!0])}}),$("<menuitem/>").html("将该舰娘加入对比").on({click:function(e){this.check(this.rowsById[a.contextmenu._curid])}.bind(this),show:function(e){if(!a.contextmenu._curid)return!1;_g.data.ship_types[_g.data.ships[a.contextmenu._curid].type].donotcompare?$(e.target).hide():$(e.target).show(),"true"===this.rowsById[a.contextmenu._curid].attr("compare")?$(e.target).html("取消对比"):$(e.target).html("将该舰娘加入对比")}.bind(this)}),$("<div/>").on("show",function(e){var n=$(e.target).empty();a.contextmenu._curid&&(_g.data.ships[a.contextmenu._curid].getSeriesData()||[]).forEach(function(t,e){e||n.append($("<hr/>"));var i=null;try{i=this.rowsById[t.id]}catch(e){}n.append($('<div class="item"/>').html("<span>"+_g.data.ships[t.id].getName(!0)+"</span>").append($('<div class="group"/>').append(function(){var e=$();return _frame.app_main.is_mode_selection()&&(e=e.add($("<menuitem/>").html("选择").on({click:function(){_frame.app_main.is_mode_selection()&&_frame.app_main.mode_selection_callback(t.id)}}))),e}).append($('<menuitem data-infos="[[SHIP::'+t.id+']]"/>').html("查看资料")).append($("<menuitem/>").html(i&&"true"===i.attr("compare")?"取消对比":"加入对比").on({click:function(e){i&&this.check(i)}.bind(this)}))))},this)}.bind(this))];return a.contextmenu?a.contextmenu.showing?a.contextmenu.hide(function(){a.contextmenu.dom.body.empty(),e.forEach(function(e){e.appendTo(a.contextmenu.dom.body)}),a.contextmenu._is_rightclick?a.contextmenu.show(a.contextmenu._is_rightclick.x,a.contextmenu._is_rightclick.y):a.contextmenu.show(a.contextmenu._curel)}):(a.contextmenu.dom.body.empty(),e.forEach(function(e){e.appendTo(a.contextmenu.dom.body)})):a.contextmenu=new _menu({className:"contextmenu-ship",items:e}),a.contextmenu}.bind(this);this.is_init?n():(a.contextmenu=new _menu({className:"contextmenu-ship",items:[$("<menuitem/>").html("数据处理中，请稍候……　　")]}),this.dom.container.on({initprogress:function(e,t,i){a.contextmenu.showing&&a.contextmenu.dom.body.empty().append($("<menuitem/>").html("数据处理中，请稍候 ("+(t/i*100).toFixed(1)+"%)"))},initdone:function(){n()}}))}a.contextmenu._curid=t||e.data("shipid"),a.contextmenu._curel=e,i?(a.contextmenu._is_rightclick={x:i.clientX,y:i.clientY},a.contextmenu.show(i.clientX,i.clientY)):(a.contextmenu._is_rightclick=!1,a.contextmenu.show(e))}},{key:"init_parse",value:function(){var i=this;this.dom.filter_container=this.dom.container.children(".options"),this.dom.filters=this.dom.filter_container.children(".filters"),this.dom.exit_compare=this.dom.filter_container.children(".exit_compare"),this.dom.exit_compare.children('button[icon="arrow-set2-left"]').on("click",function(){this.compare_end()}.bind(this)),this.dom.exit_compare.children('button[icon="checkbox-checked"]').on("click",function(){this.compare_continue()}.bind(this)),this.dom.btn_compare_sort=this.dom.exit_compare.children('button[icon="sort-amount-desc"]').on("click",function(){this.dom.btn_compare_sort.hasClass("disabled")||this.sort_table_restore()}.bind(this)),this.dom.search=$('<p class="search"/>').prependTo(this.dom.filters).append(this.dom.searchInput=$('<input type="search" placeholder="搜索舰娘..."/>').on({input:function(e){clearTimeout(this.searchDelay),this.searchDelay=setTimeout(function(){this.search(e.target.value)}.bind(this),100)}.bind(this),focus:function(){this.dom.search.addClass("on")}.bind(this),blur:function(e,t){!t&&this.dom.container.hasClass("mod-search")||this.dom.search.removeClass("on")}.bind(this)})),this.dom.btn_hide_premodel=this.dom.filters.find('[name="hide-premodel"]').prop("checked","false"!==_config.get("shiplist-filter-hide-premodel")||null).on("change",function(e){_config.set("shiplist-filter-hide-premodel",this.dom.btn_hide_premodel.prop("checked")),this.dom.filter_container.attr("filter-hide-premodel",this.dom.btn_hide_premodel.prop("checked")),this.thead_redraw()}.bind(this)),this.dom.filters.find('[name="viewtype"]').each(function(e,t){t=$(t);var i=_config.get("shiplist-viewtype")||"card";t.val()==i&&t.prop("checked",!0),t.on("change",function(e){t.is(":checked")&&(_config.set("shiplist-viewtype",t.val()),this.dom.filter_container.attr("viewtype",t.val()),this.thead_redraw())}.bind(this))}.bind(this)),this.dom.filters.find("input").trigger("change"),this.dom.table=this.dom.container.children(".tablelist-container"),this.dom.thead=this.dom.table.children(".tablelist-header").on("click","[stat]",function(e){this.sort_table_from_theadcell($(e.currentTarget))}.bind(this)),this.dom.tbody=this.dom.table.children(".tablelist-body").on("contextmenu.contextmenu_ship","[data-shipid]",function(e){this.contextmenu_show($(e.currentTarget),null,e),e.preventDefault()}.bind(this)).on("click","[data-shipid]",function(e,t){"label"==e.target.tagName.toLowerCase()?(this.check(e.currentTarget),e.stopPropagation()):"em"==e.target.tagName.toLowerCase()?(this.contextmenu_show($(e.target),e.currentTarget.getAttribute("data-shipid")),e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation()):!t&&_frame.app_main.is_mode_selection()&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),e.currentTarget.getAttribute("data-donotcompare")||_frame.app_main.mode_selection_callback(e.currentTarget.getAttribute("data-shipid"))),this.dom.searchInput.trigger("blur",[!0])}.bind(this)),this.dom.msg_container=this.dom.container.children(".msgs"),_config.get("hide-compareinfos")?this.dom.msg_container.removeAttr("data-msgs"):this.dom.msg_container.attr("data-msgs","compareinfos"),this.parse_all_items(),this.dom.msg_container.children(".compareinfos").children("button").on("click",function(){this.dom.msg_container.removeAttr("data-msgs"),_config.set("hide-compareinfos",!0)}.bind(this)),this.dom.msg_container.children(".comparestart").on("click",function(){this.compare_start()}.bind(this));if(_g.getCurrentEvent().some(function(e){return"leyteB"===e.code&&(e,!0)})){var n={},a=function(e){for(var t in n)n[t].removeClass("on");e?(n[e].addClass("on"),i.dom.container.attr("data-leyte-fleet",e)):(n._.addClass("on"),i.dom.container.removeAttr("data-leyte-fleet"))},s=$('<div class="event-container"/>').insertAfter(this.dom.filter_container);[[!1,"全部"],["kurita","栗田"],["ozawa","小泽"],["nishimura","西村"],["shima","志摩"],["ta_go","多号作战"],["off","无所属"]].forEach(function(e){var t=e[0],i=e[1];n[t||"_"]=$("<span/>",{class:"filter","data-leyte-fleet":t||void 0,html:i}).on("click",function(){return a(t)}).appendTo(s)}),console.log(n),a(!1);a(!1)}}},{key:"parse_all_items",value:function(){var e=Q.defer(),t=Q.fcall(function(){}),o=this.dom.tbody.children("h4, dl");return o.each(function(a,s){t=t.then(function(){(s=$(s)).attr("trindex",a);var e=Q.defer(),t=s.attr("data-shipid"),i=s.attr("data-header");if(this.rowsByHeader[i]||(this.rowsByHeader[i]=$()),"H4"==s[0].tagName){var n=s.find('input[type="checkbox"]').on({change:function(){this.rowsByHeader[i].filter(":visible").each(function(e,t){this.check(t,n.prop("checked"),!0)}.bind(this))}.bind(this),docheck:function(){var e=this.rowsByHeader[i].filter(":visible"),t=e.filter('[compare="true"]');t.length?t.length<e.length?n.prop({checked:!1,indeterminate:!0}):n.prop({checked:!0,indeterminate:!1}):n.prop({checked:!1,indeterminate:!1})}.bind(this)});this.header_checkbox[i]=n,this.mode_selection_filters.add($("<input/>",{value:i,type:"checkbox",class:"shiptype",id:"shiptype-"+i}).prop("checked",!i).prependTo(this.dom.container)),$("<label/>",{for:"shiptype-"+i,class:"shiptype"}).prependTo(s),s.attr("inited",!0)}else t&&(this.rowsByHeader[i]=this.rowsByHeader[i].add(s),this.rowsById[t]=s,this.rows=this.rows.add(s));return this.dom.container.trigger("initprogress",[a+1,o.length]),setTimeout(e.resolve,0),e.promise}.bind(this))}.bind(this)),t=t.then(function(){this.mark_high(),this.thead_redraw(),this.is_init=!0,this.dom.container.trigger("initdone"),e.resolve()}.bind(this)).catch(function(e){_g.log(e)}),_frame.app_main.loaded("tablelist_"+this._index,!0),e.promise}},{key:"check",value:function(e,t,i){e.length&&(e=e[0]),null==t&&(t=!("true"==e.getAttribute("compare"))),t?e.setAttribute("compare","true"):e.removeAttribute("compare"),this.compare_btn_show(t),i||this.header_checkbox[parseInt(e.getAttribute("data-header"))].trigger("docheck")}},{key:"search",value:function(e){if(this.dom.style||(this.dom.style=$("<style/>").appendTo(this.dom.container)),!e)return this.dom.container.removeClass("mod-search"),this.dom.filter_container.attr("filter-hide-premodel",this.dom.btn_hide_premodel.prop("checked")),this.dom.style.empty(),e;if(!(e=_g.search(e,"ships")).length)return e;this.dom.container.addClass("mod-search"),this.dom.filter_container.attr("filter-hide-premodel",!1);var t=".tablelist.ships .tablelist-body dl:not(:empty)";return e.forEach(function(e){t+=':not([data-shipid="'+e.id+'"])'}),t+="{display:none!important}",this.dom.style.html(t),e}},{key:"onEnter",value:function(){console.log("tablelist-ship on-enter"),this.functionsOnEnter.forEach(function(e){"function"==typeof e&&e()})}},{key:"onExit",value:function(){console.log("tablelist-ship on-exit"),this.functionsOnExit.forEach(function(e){"function"==typeof e&&e()})}}]),a}(),TablelistEquipments=function(e){function d(e,t){_classCallCheck(this,d);var i=_possibleConstructorReturn(this,(d.__proto__||Object.getPrototypeOf(d)).call(this,e,t));return i.columns=["  ",["火力","fire"],["雷装","torpedo"],["对空","aa"],["对潜","asw"],["爆装","bomb"],["命中","hit"],["装甲","armor"],["回避","evasion"],["索敌","los"],["射程","range"],["可改修","improvable"]],i.equipmentsHasBonus={},_frame.app_main.loading.push("tablelist_"+i._index),_frame.app_main.is_loaded=!1,e.children(".tablelist-container").length&&i.init_parse(),i}return _inherits(d,Tablelist),_createClass(d,[{key:"apply_types",value:function(){var a=this;if(this.dom.filter_types.removeAttr("class"),d.types.length&&(this.dom.filter_types.addClass("type"+d.types.join(" type")),this.generated&&this.apply_types_check()),this.dom.tbody.children(".extra").removeClass("extra").removeAttr("style"),"FIELD"===d.shipId?this.dom.container.addClass("mod-field"):this.dom.container.removeClass("mod-field"),d.extraEquipments&&d.extraEquipments.forEach(function(e){a.dom.tbody.children('[data-equipmentid="'+e+'"]').css({display:"flex",opacity:1}).addClass("extra")}),!d.shipId||isNaN(d.shipId))for(var e in this.equipmentsHasBonus)this.equipmentsHasBonus[e].removeClass("disabled");else!function(){var n={};Array.isArray(d.currentSelected)&&d.currentSelected.forEach(function(e){var t=parseInt(e);void 0===n[t]&&(n[t]=0),n[t]++});var e=function(e){var t=_g.data.items[e],i=_g.data.ships[d.shipId];t.getBonuses().filter(function(e){if(!KC.check.ship(i,e.ship))return!1;if(e.equipment&&"object"===_typeof(e.bonusCount)&&parseInt(Object.keys(e.bonusCount).sort(function(e,t){return parseInt(t)-parseInt(e)})[0])<=(n[e.equipment]||0))return!1;return!0}).length?a.equipmentsHasBonus[e].removeClass("disabled"):a.equipmentsHasBonus[e].addClass("disabled")};for(var t in a.equipmentsHasBonus)e(t)}()}},{key:"apply_types_check",value:function(){var e=this;if(d.shipIdLast&&d.shipIdLast==d.shipId)this.dom&&this.dom.container&&this.dom.container.length&&this.dom.container.find("[scrollbody]").each(function(e,t){var i=t.getAttribute("scrollbody");isNaN(i)||(t.scrollTop=i)});else{if(d.shipIdLast=d.shipId,!d.isExtraSlot&&d.shipId&&_g.data.ships[d.shipId]&&-1<$.inArray(_g.data.ships[d.shipId].type,[9,10,11,30])){for(var t=0,i=void 0,n=void 0;this.dom.types[t++]&&this.dom.types[t]&&(3!=this.dom.types[t].attr("data-equipmentcollection")||$.inArray(parseInt(this.dom.types[t].attr("data-type"))||null,d.types)<=-1);)i=this.dom.types[t+1];return i=i||this.dom.types[0],this.dom.type_radios[3].prop("checked",!0).trigger("change"),(n=i[0].offsetTop)&&(n-=32),void this.dom.tbody.scrollTop(n||0)}if("FIELD"===d.shipId){this.dom.type_radios[3].prop("checked",!0).trigger("change");var a=void 0;this.dom.types.some(function(e){return 45==e.attr("data-type")&&(a=e,!0)});var s=a[0].offsetTop;return s&&(s-=32),this.dom.tbody.scrollTop(s||0),void setTimeout(function(){(!e.dom.tbody.attr("scrollbody")||e.dom.tbody.attr("scrollbody")<10)&&(e.dom.tbody.scrollTop(s||0),e.dom.tbody.attr("scrollbody",s||0))},100)}if(d.types.length){for(var o=0,r=void 0,l=void 0;$.inArray(parseInt(this.dom.types[o++].attr("data-type"))||null,d.types)<=-1;)r=this.dom.types[o];r=r||this.dom.types[0],this.dom.type_radios[parseInt(r.attr("data-equipmentcollection"))||1].prop("checked",!0).trigger("change"),(l=r[0].offsetTop)&&(l-=32),this.dom.tbody.scrollTop(l||0)}}}},{key:"reset_types",value:function(){this.dom.container.removeClass("mod-field")}},{key:"init_parse",value:function(){this.dom.filter_container=this.dom.container.children(".options"),this.dom.filters=this.dom.filter_container.children(".filters"),this.dom.type_radios={},this.dom.container.children('input[type="radio"][name="equipmentcollection"]').each(function(e,t){t=$(t);var i=parseInt(t.val());this.dom.type_radios[i]=t.prop("checked",1==i).on("change",function(){this.dom.tbody.scrollTop(0),this.thead_redraw()}.bind(this))}.bind(this)),this.dom.filter_types=this.dom.container.children('input[name="types"][type="hidden"]'),this.dom.table=this.dom.container.children(".tablelist-container"),this.dom.thead=this.dom.table.children(".tablelist-header"),this.dom.tbody=this.dom.table.children(".tablelist-body"),this.parse_all_items(),this.dom.msg_container=this.dom.container.children(".msgs"),_config.get("hide-equipmentsinfos")?this.dom.msg_container.removeAttr("data-msgs"):this.dom.msg_container.attr("data-msgs","equipmentsinfos"),this.dom.msg_container.children(".equipmentsinfos").children("button").on("click",function(){this.dom.msg_container.removeAttr("data-msgs"),_config.set("hide-equipmentsinfos",!0)}.bind(this))}},{key:"parse_all_items",value:function(){this.generated=!1,this.dom.types=[];var r=-1;this.dom.tbody.children("h4, dl").each(function(e,i){var n=this;if("H4"==(i=$(i))[0].tagName){if(r++,this.dom.types[r]=i,Formula.equipmentType.Interceptors.includes(i.data("type"))){var t=i.next().clone();t.addClass("header-alt"),t.removeAttr("data-equipmentid"),t.removeAttr("data-infos"),t.removeAttr("data-equipmenttype"),t.find("dt").empty(),t.find("dd").empty().removeAttr("value"),t.find('[stat="hit"]').text("对爆"),t.find('[stat="evasion"]').text("迎击"),t.find('[stat="craftable"]').html("<em>制空</em><em>防空</em>"),t.insertAfter(i)}}else{var a=parseInt(i.attr("data-equipmenttype"))||-1,s=parseInt(i.attr("data-equipmentid")),o=_g.data.items[s];!function e(){if(o){var t=o.getBonuses();Array.isArray(t)&&t.length&&(n.equipmentsHasBonus[s]=i).addClass("has-bonus")}else setTimeout(e,100)}(),i.on("click",function(e,t){!t&&_frame.app_main.is_mode_selection()&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),(-1<$.inArray(a,d.types||[])||-1<$.inArray(s,d.extraEquipments||[]))&&_frame.app_main.mode_selection_callback(s),setTimeout(function(){d.types=[],d.extraEquipments=[],d.shipId=null,i.removeAttr("style"),n.reset_types()},20))}),Formula.equipmentType.Interceptors.includes(i.data("equipmenttype"))&&i.find('[stat="craftable"]').removeAttr("value").html("<em>"+((o.stat.aa||0)+(1.5*o.stat.evasion||0))+"</em><em>"+((o.stat.aa||0)+(o.stat.evasion||0)+(2*o.stat.hit||0))+"</em>")}}.bind(this)),this.thead_redraw(),this.generated=!0,this.apply_types_check(),_frame.app_main.loaded("tablelist_"+this._index,!0)}}]),d}();TablelistEquipments.gen_helper_equipable_on=function(n){var a="";return _g.data.item_types[n].equipable_on_type.forEach(function(e,t){var i=_g.data.item_types[n].equipable_on_type[t];a+="<span>"+_g.data.ship_types[i].name.zh_cn+(t<_g.data.item_types[n].equipable_on_type.length-1?",&nbsp;":"")+"</span>"}),'<em class="helper" data-tip="<h4 class=item_equipable_on>可装备于</h4>'+a+'">?</em>'},TablelistEquipments.types=[],TablelistEquipments.shipId=null,TablelistEquipments.shipIdLast=null,TablelistEquipments.currentSelected=[];var TablelistFleets=function(e){function l(e,t){_classCallCheck(this,l);var i=_possibleConstructorReturn(this,(l.__proto__||Object.getPrototypeOf(l)).call(this,e,t));return i.columns=["  ",["创建者","user"],["修改时间","time_modify"],["评价","rating"],["","options"]],i.kancolle_calc={_ApplicationId:"l1aps8iaIfcq2ZzhOHJWNUU2XrNySIzRahodijXW",_ClientVersion:"js1.2.19",_InstallationId:"62522018-ec82-b434-f5a5-08c3ab61d932",_JavaScriptKey:"xOrFpWEQZFxUDK2fN1DwbKoj3zTKAEkgJHzwTuZ4"},_frame.app_main.loading.push("tablelist_"+i._index),_frame.app_main.is_loaded=!1,i.dom.filter_container=$('<div class="options" viewtype="card"/>').appendTo(i.dom.container),i.dom.filters=$('<div class="filters"/>').appendTo(i.dom.filter_container),i.dom.btn_new=$('<button class="new" icon="import"/>').html("新建/导入").on("click",function(e,t){this.btn_new(t)}.bind(i)).appendTo(i.dom.filters),l.support.buildfile&&(i.dom.btn_exportFile=$('<button class="export" icon="floppy-disk"/>').html("导出配置文件").on("click",function(){if(_db.fleets.persistence.compactDatafile(),_g.isNWjs)_g.save(_db.fleets.filename,"fleets.json");else{_frame.app_main.loading_start("tablelist_fleets_export",!1);var n="";_db.fleets.find({},function(e,t){if(e)_g.error(e);else{t.forEach(function(e){n+=JSON.stringify(e)+"\n"});var i=new Blob([n],{type:"application/json"});_g.save(URL.createObjectURL(i),"fleets.json")}_frame.app_main.loading_complete("tablelist_fleets_export")})}}).appendTo(i.dom.filters)),i.dom.buttons_right=$('<div class="buttons_right"/>').appendTo(i.dom.filters),i.dom.setting_hqlv=$("<label/>",{class:"setting setting-hqlv",html:"默认司令部等级","data-tip":"如果舰队配置没有设置司令部等级，<br/>则会使用该默认数值<br/>司令部等级会影响索敌能力的计算"}).on({"mouseenter mouseleave":function(e){_p.tip.is_showing&&!_p.tip.timeout_fade&&this.dom.setting_hqlv_input.is(":focus")&&(e.stopImmediatePropagation(),e.stopPropagation())}.bind(i)}).append(i.dom.setting_hqlv_input=$("<input/>",{type:"number",min:0,max:_g.hqMaxLv}).val(Lockr.get("hqLvDefault",_g.defaultHqLv)).on({input:function(){_g.updateDefaultHqLv(this.dom.setting_hqlv_input.val())}.bind(i),"focus.tipshow":function(){this.dom.setting_hqlv_input.trigger("tipshow")}.bind(i),"blur.tiphide":function(){this.dom.setting_hqlv_input.trigger("tiphide"),this.dom.setting_hqlv_input.val()>_g.hqMaxLv&&(this.dom.setting_hqlv_input.val(_g.hqMaxLv),this.dom.setting_hqlv_input.trigger("input"))}.bind(i),click:function(e){e.stopImmediatePropagation(),e.stopPropagation()}})).appendTo(i.dom.buttons_right),$body.on("update_defaultHqLv.update_fleets_hqlv_input",function(e,t){this.dom.setting_hqlv_input.val(t)}.bind(i)),i.dom.btn_settings=$('<button icon="cog"/>').on("click",function(){this.btn_settings()}.bind(i)).appendTo(i.dom.buttons_right),i.dom.table=$('<div class="tablelist-container"/>').appendTo(i.dom.container),i.dom.thead=$("<dl/>").appendTo($('<div class="tablelist-header"/>').appendTo(i.dom.table)),i.dom.tbody=$('<div class="tablelist-body" scrollbody/>').appendTo(i.dom.table).on("contextmenu.contextmenu_fleet","[data-fleetid]",function(e){this.contextmenu_show($(e.currentTarget),null,e),e.preventDefault()}.bind(i)).on("click.contextmenu_fleet","[data-fleetid]>dt>em",function(e){this.contextmenu_show($(e.currentTarget).parent().parent(),$(e.currentTarget)),e.stopImmediatePropagation(),e.stopPropagation()}.bind(i)),i.columns.forEach(function(e,t){"object"==(void 0===e?"undefined":_typeof(e))?$("<dd/>",{stat:e[1],html:e[0]}).appendTo(this.dom.thead):$("<dt/>").html(e[0]).appendTo(this.dom.thead)}.bind(i)),$('<div class="nocontent container"/>').append($($("<div/>").append($("<span>").html("暂无舰队配置")).append($("<button>").html("新建/导入").on("click",function(e){this.dom.btn_new.trigger("click",[e])}.bind(i))))).appendTo(i.dom.table),i.dom.container.on("focus.number_input_select",'input[type="number"]',function(e){e.currentTarget.select()}),i.genlist(),i}return _inherits(l,Tablelist),_createClass(l,[{key:"new_data",value:function(e){return $.extend({data:[],time_create:(new Date).valueOf(),time_modify:(new Date).valueOf(),hq_lv:-1,name:"",note:"",user:{},rating:-1,theme:_g.randNumber(10)},e||{})}},{key:"loaddata",value:function(){var i=Q.defer();return _db.fleets.find({}).sort({name:1}).exec(function(e,t){e?i.resolve([]):(t.forEach(function(e){e.data=InfosFleet.decompress(e.data)}),console.log(t),i.resolve(t))}),i.promise}},{key:"validdata",value:function(i){for(var n=Q.defer(),e=[],t=0,a=function(e){if(-1<e.hq_lv||e.name||e.note||-1<e.rating)return!0;if(!e.data||!e.data.length||!e.data.push)return!1;var t=!1,i=!0,n=!1,a=void 0;try{for(var s,o=e.data[Symbol.iterator]();!(i=(s=o.next()).done);i=!0){var r=s.value;if(r&&r.length&&r.push){var l=!0,d=!1,u=void 0;try{for(var c,h=r[Symbol.iterator]();!(l=(c=h.next()).done);l=!0){var m=c.value;void 0!==m&&m&&m.push&&void 0!==m[0]&&m[0]&&(t=!0)}}catch(e){d=!0,u=e}finally{try{!l&&h.return&&h.return()}finally{if(d)throw u}}}}}catch(e){n=!0,a=e}finally{try{!i&&o.return&&o.return()}finally{if(n)throw a}}return t};t<i.length;)a(i[t])?t++:(e.push(i[t]._id),i.splice(t,1));return e.length?_db.fleets.remove({_id:{$in:e}},{multi:!0},function(e,t){n.resolve(i)}):n.resolve(i),n.promise}},{key:"datacheck",value:function(e){return(e=e||[]).length?this.dom.container.removeClass("nocontent"):this.dom.container.addClass("nocontent"),e}},{key:"append_all_items",value:function(n){var a=this;(n=n||[]).sort(function(e,t){return e.name<t.name?-1:e.name>t.name?1:0}),void(this.trIndex=0)===Lockr.get("fleetlist-option-groupbytheme")&&Lockr.set("fleetlist-option-groupbytheme",!0);var s=Q.defer(),o=0;if(Lockr.get("fleetlist-option-groupbytheme"))!function(){var i={},t=0;for(var e in n.forEach(function(e,t){i[e.theme]||(i[e.theme]=[]),i[e.theme].push(t)}),i){for(o=0;o<a.flexgrid_empty_count;)o?$('<dl data-fleetid trindex="99999"/>').appendTo(a.dom.tbody):a.flexgrid_ph=$('<dl data-fleetid trindex="99999"/>').appendTo(a.dom.tbody),o++;i[e].forEach(function(e){setTimeout(function(e){this.append_item(n[e]),++t>=n.length-1&&s.resolve()}.bind(this)(e),0)}.bind(a)),$("<h4/>",{trindex:++a.trIndex,html:"&nbsp;"}).appendTo(a.dom.tbody),a.trIndex++}}();else{for(;o<this.flexgrid_empty_count;)o?$('<dl data-fleetid trindex="99999"/>').appendTo(this.dom.tbody):this.flexgrid_ph=$('<dl data-fleetid trindex="99999"/>').appendTo(this.dom.tbody),o++;n.forEach(function(e,t){setTimeout(function(e){this.append_item(n[e]),e>=n.length-1&&s.resolve()}.bind(this)(t),0)}.bind(this))}return n.length||s.resolve(),s.promise}},{key:"append_item",value:function(o,e,t){if(!o)return!1;void 0===e&&(e=this.trIndex,this.trIndex++);var r=$("<dl/>").attr({trindex:e,"data-fleetid":o._id||"PLACEHOLDER","data-infos":"[[FLEET::"+o._id+"]]","data-theme":o.theme,class:"link_fleet"}).data({initdata:o});return this.columns.forEach(function(e){switch(e[1]){case" ":for(var t=o.data[0]||[],i=0,n=Math.min(8,Math.max(6,t.length)),a='<i data-count="'+n+'">';i<n;)t[i]&&t[i][0]?a+='<img class="img'+(_huCss.csscheck_full("mask-image")?"":" nomask")+'" src="'+KC.getFolderGroup(_g.path.pics.ships,t[i][0])+"/"+t[i][0]+"/0"+l.avatarImgSuffix+'" contextmenu="disabled"/>':a+='<s class="img'+(_huCss.csscheck_full("mask-image")?"":" nomask")+'"/>',i++;a+="</i>",$("<dt/>").attr("value",o.name).html(a+"<strong>"+o.name+"</strong><em></em>").appendTo(r);break;default:var s=o[e[1]];$("<dd/>").attr("value",s).html(s).appendTo(r)}}),!0===t||(t?r.prependTo(this.dom.tbody):r.insertBefore(this.flexgrid_ph)),r}},{key:"btn_new",value:function(e){if(!this.menu_new){var t=[$('<div class="menu-fleets-new"/>').append($("<menuitem/>").html("新建配置").on("click",function(){this.action_new()}.bind(this))).append($("<menuitem/>").html("导入配置代码").on("click",function(){l.modalImport||(l.modalImport=$("<div/>").append(l.modalImportTextarea=$("<textarea/>",{placeholder:"输入配置代码..."})).append($("<p/>").html('* 配置代码兼容<a href="http://www.kancolle-calc.net/deckbuilder.html">艦載機厨デッキビルダー</a>')).append($('<p class="aircraftimportmax"/>').append(l.modalImportCheckAircraftMax=$("<input/>",{type:"checkbox",id:"_input_g"+_g.inputIndex}).prop("checked",Lockr.get("fleetlist-option-aircraftimportmax"))).append($("<label/>",{class:"checkbox",for:"_input_g"+_g.inputIndex++,html:"飞行器熟练度自动提升至"}))).append(l.modalImportBtn=$('<button class="button"/>').html("导入").on("click",function(){var e=l.modalImportTextarea.val();e&&((e=JSON.parse(e)).length&&e.push||(e=_g.kancolle_calc.decode(e)),this.action_new({data:e},{aircraftmax:l.modalImportCheckAircraftMax.prop("checked")}),_frame.modal.hide(),l.modalImportTextarea.val(""))}.bind(this)))),l.modalImportTextarea.val(""),_frame.modal.show(l.modalImport,"导入配置代码",{classname:"infos_fleet infos_fleet_import",detach:!0})}.bind(this))).append(l.support.buildfile?$('<menuitem class="import_file"/>').html("导入配置文件").on("click",function(){this.dbfile_selector.trigger("click")}.bind(this)):null)],i=void 0;_g.getCurrentEvent().some(function(e){return"leyteB"===e.code&&(i=e,!0)})&&(t.push($("<hr/>")),t.push($('<small class="subtitle">期间限定</small>')),t.push($('<div class="title">'+i.title[_g.lang]+"</div>")),t.push($('<menuitem class="shipavatar"/>').html('<small class="sup">新建配置</small>第一游击部队 第三部队（西村队）').on("click",function(){this.action_new({name:"第一游击部队 第三部队（西村队）",data:_g.kancolle_calc.decode({version:4,f1:{s1:{id:411,luck:-1,items:{}},s2:{id:412,luck:-1,items:{}},s3:{id:73,luck:-1,items:{}},s4:{id:489,luck:-1,items:{}},s5:{id:327,luck:-1,items:{}},s6:{id:328,luck:-1,items:{}},s7:{id:145,luck:-1,items:{}}},f2:{},f3:{},f4:{},fField:{}})},{aircraftmax:Lockr.get("fleetlist-option-aircraftimportmax")})}.bind(this))),t.push($('<menuitem class="shipavatar"/>').html('<small class="sup">新建配置</small>第二游击部队（志摩队）').on("click",function(){this.action_new({name:"第二游击部队（志摩队）",data:_g.kancolle_calc.decode({version:4,f1:{s1:{id:192,luck:-1,items:{}},s2:{id:193,luck:-1,items:{}},s3:{id:200,luck:-1,items:{}},s4:{id:231,luck:-1,items:{}},s5:{id:407,luck:-1,items:{}},s6:{id:226,luck:-1,items:{}},s7:{id:470,luck:-1,items:{}}},f2:{},f3:{},f4:{},fField:{}})},{aircraftmax:Lockr.get("fleetlist-option-aircraftimportmax")})}.bind(this)))),this.menu_new=new _menu({target:this.dom.btn_new,className:"menu-fleets-new",items:t}),this.dbfile_selector=$('<input type="file" class="none"/>').on("change",function(e){return this.importBuilds(this.dbfile_selector)}.bind(this)).appendTo(this.dom.filters)}return e&&e.clientX?this.menu_new.show(e.clientX,e.clientY):this.menu_new.show(e)}},{key:"btn_settings",value:function(){l.menuOptions_show(this.dom.btn_settings,this)}},{key:"action_new",value:function(e,n){if(n=n||{},(e=e||{}).data){var t=0;e.data.forEach(function(e){e&&e.push&&(t<4?e.forEach(function(i){i&&i.push&&i[2].forEach(function(e,t){e&&-1<$.inArray(_g.data.items[e].type,Formula.equipmentType.Aircrafts)&&_g.data.items[e].rankupgradable&&n.aircraftmax&&(i[4][t]=7)})}):e.forEach(function(e){e&&e.push&&e.forEach(function(e,t){e&&e[0]&&-1<$.inArray(_g.data.items[e[0]].type,Formula.equipmentType.Aircrafts)&&_g.data.items[e[0]].rankupgradable&&n.aircraftmax&&(e[1]=7)})}),t++)}),InfosFleet.clean(e.data)}_db.fleets.insert(this.new_data(e,n),function(e,t){console.log(e,t),e?_g.error(e):"fleets"==_frame.app_main.cur_page&&(_frame.infos.show("[[FLEET::"+t._id+"]]"),this.menu_new.hide())}.bind(this))}},{key:"parse_kancolle_calc_data",value:function(e){return this.new_data(e)}},{key:"contextmenu_show",value:function(e,t,i){if(!l.contextmenu){var n=[$("<menuitem/>").html("详情").on({click:function(e){l.contextmenu.curel.trigger("click",[!0])}}),$("<menuitem/>").html("导出配置代码").on({click:function(e){InfosFleet.modalExport_show(l.contextmenu.curel.data("initdata"))}}),$("<menuitem/>").html("导出配置文本").on({click:function(e){InfosFleet.modalExportText_show(l.contextmenu.curel.data("initdata"))}}),$("<menuitem/>").html("移除").on({click:function(e){var t=l.contextmenu.curel.attr("data-fleetid");t&&InfosFleet.modalRemove_show(t,l.contextmenu.curobject)}}),$('<menuitem class="remove-all-same-theme"/>').html('<span class="theme-block"></span>移除所有该主题颜色的配置').on({click:function(e){l.modalRemoveAllSameTheme_show(l.contextmenu.curobject)}})];l.contextmenu=new _menu({className:"contextmenu-fleet",items:n})}l.contextmenu.curobject=this,l.contextmenu.curel=e,l.contextmenu.dom.menu.attr("data-theme",e.data("theme")),i?l.contextmenu.show(i.clientX,i.clientY):l.contextmenu.show(t||e)}},{key:"genlist",value:function(e){Q.fcall(function(){}).then(function(){return this.loaddata()}.bind(this)).then(function(e){return this.validdata(e)}.bind(this)).then(function(e){return this.datacheck(e)}.bind(this)).then(function(e){return this.append_all_items(e)}.bind(this)).then(function(){setTimeout(function(){_frame.app_main.loaded("tablelist_"+this._index,!0)}.bind(this),100)}.bind(this)).catch(function(e){_g.log(e)}).done(function(){e&&e(),_g.log("Fleets list DONE")})}},{key:"refresh",value:function(){console.log("refresh"),this.dom.tbody.empty(),this.genlist(function(){this.dom.tbody.scrollTop(this.dom.tbody.attr("scrollbody")||0)}.bind(this))}},{key:"importBuilds",value:function(s,o){s=s||this.dbfile_selector,_frame.app_main.loading_start("tablelist_fleets_import",!1),s.prop("disabled",!0);var i=Q.defer(),e=Q.fcall(function(){var i=Q.defer();if(_g.isNWjs&&o){var e=s.val();-1<e.indexOf(";")&&(e=node.path.dirname(e.split(";")[0])),node.fs.readFile(node.path.join(e,o),"utf8",function(e,t){e?i.reject("文件载入失败",new Error(e)):i.resolve(t)})}else for(var t,n=0;t=s[0].files[n];n++){var a=new FileReader;a.onload=function(e){return i.resolve(e.target.result)},a.readAsText(t)}return i.promise});return e=(e=e.then(function(e){s.val("");var t=[],i=Q.defer();return e.split("\n").forEach(function(e){if(e){try{t.push(JSON.parse(e))}catch(e){i.reject("文件格式错误",e)}i.resolve(t)}else i.reject("文件无内容")}),i.promise}).then(function(e){var t=Q.defer(),n=Q();return e.forEach(function(i){n=n.then(function(){var t=Q.defer();return _db.fleets.insert(i,function(e){e?"uniqueViolated"==e.errorType?l.modalBuildConflictShow(i,t):t.reject(e):t.resolve()}),t.promise})}),n=n.then(function(){t.resolve()}).catch(function(e){t.reject(e)}).done(function(){_frame.modal.hide()}),t.promise})).then(function(){this.refresh(),_g.badgeMsg("成功导入配置"),i.resolve()}.bind(this)).catch(function(e,t){_g.log(e),_g.error(t,"[舰队] 导入配置文件"),_g.badgeError(e),i.reject(e,t)}).done(function(){_frame.app_main.loading_complete("tablelist_fleets_import"),s.prop("disabled",!1)}),i.promise}}]),l}();TablelistFleets.support={},TablelistFleets.support.buildfile=!!(_g.isNWjs||window.File&&window.FileReader&&window.FileList&&window.Blob&&window.URL),TablelistFleets.avatarImgSuffix=_huCss.csscheck_full("mask-image")?"."+_g.imgExt:"-2.png",TablelistFleets.menuOptions_show=function(e,t){if(!TablelistFleets.menuOptions){var i=[$('<menuitem class="mod-checkbox donot_hide option-in-tablelist option-groupbytheme"/>').append($("<input/>",{type:"checkbox",id:"_input_g"+_g.inputIndex}).prop("checked",Lockr.get("fleetlist-option-groupbytheme")).on("change",function(e){Lockr.set("fleetlist-option-groupbytheme",e.target.checked),TablelistFleets.menuOptions.curTablelist&&(TablelistFleets.menuOptions.curTablelist.dom.tbody.empty(),TablelistFleets.menuOptions.curTablelist.genlist())})).append($("<label/>",{for:"_input_g"+_g.inputIndex++,html:"按主题颜色进行分组"})),$('<menuitem class="mod-checkbox donot_hide option-in-tablelist option-aircraftdefaultmax option-aircraftimportmax"/>').append($("<input/>",{type:"checkbox",id:"_input_g"+_g.inputIndex}).prop("checked",Lockr.get("fleetlist-option-aircraftimportmax")).on("change",function(e){Lockr.set("fleetlist-option-aircraftimportmax",e.target.checked)})).append($("<label/>",{for:"_input_g"+_g.inputIndex++,html:"导入配置时提升飞行器熟练度至"})),$('<menuitem class="mod-checkbox donot_hide option-aircraftdefaultmax"/>').append($("<input/>",{type:"checkbox",id:"_input_g"+_g.inputIndex}).prop("checked",Lockr.get("fleetlist-option-aircraftdefaultmax")).on("change",function(e){Lockr.set("fleetlist-option-aircraftdefaultmax",e.target.checked)})).append($("<label/>",{for:"_input_g"+_g.inputIndex++,html:'<span class="inline option-in-tablelist">配装时</span>新增飞行器熟练度默认为'})),$('<hr class="option-in-infos"/>'),$("<menuitem/>",{class:"option-in-infos",html:"移除配置"}).on("click",function(){console.log(InfosFleet.cur),InfosFleet.cur&&InfosFleet.cur.remove()})];_g.isNWjs&&(i=i.concat(TablelistFleets.menuOptionsItemsBuildsLocation())),TablelistFleets.menuOptions=new _menu({className:"menu-tablelistfleets-options",items:i})}TablelistFleets.menuOptions.curTablelist=t||null,t?TablelistFleets.menuOptions.dom.menu.addClass("is-tablelist"):TablelistFleets.menuOptions.dom.menu.removeClass("is-tablelist"),TablelistFleets.menuOptions.show(e)},TablelistFleets.modalBuildConflictShow=function(n,a){if(n){TablelistFleets.modalBuildConflict||(TablelistFleets.modalBuildConflict=$("<div/>").append($("<h4>原配置</h4>")).append(TablelistFleets.modalBuildConflictOld=$('<dl class="link_fleet"/>')).append($("<h4>新配置</h4>")).append(TablelistFleets.modalBuildConflictNew=$('<dl class="link_fleet"/>')).append($('<p class="actions"/>').append(TablelistFleets.modalBuildConflictButtonConfirm=$("<button/>",{class:"button",html:"替换"})).append(TablelistFleets.modalBuildConflictButtonCancel=$("<button/>",{class:"button",html:"跳过"}))));var s=void 0,e=function(e){for(var t="<i>",i=InfosFleet.decompress(e.data)[0]||[],n=0;n<6;)i[n]&&i[n][0]?t+='<img class="img'+(_huCss.csscheck_full("mask-image")?"":" nomask")+'" src="'+KC.getFolderGroup(_g.path.pics.ships,i[n][0])+"/"+i[n][0]+"/0"+TablelistFleets.avatarImgSuffix+'" contextmenu="disabled"/>':t+='<s class="img'+(_huCss.csscheck_full("mask-image")?"":" nomask")+'"/>',n++;return t="<dt>"+(t+="</i>")+"<strong>"+e.name+"</strong></dt><span>最后更新: "+new Date(e.time_modify).format("%Y年%m月%d日 %G:%i:%s")+"</span>"};Q.fcall(function(){var i=Q.defer();return _db.fleets.find({_id:n._id},function(e,t){e?a?a.reject(e):_g.log(e):(s=t[0],i.resolve())}),i.promise}).then(function(){TablelistFleets.modalBuildConflictButtonConfirm.off("click").on("click",function(){_db.fleets.update({_id:n._id},n,{},function(e,t){if(e)a?a.reject(e):_g.log(e);else if(_g.log("build updated "+t),_frame.infos.contentCache.fleet&&_frame.infos.contentCache.fleet[n._id]){_frame.infos.contentCache.fleet[n._id].remove(),delete _frame.infos.contentCache.fleet[n._id];try{delete _frame.app_main.loading_state[_g.state2URI({infos:"fleet",id:n._id})]}catch(e){}}a&&a.resolve()})}),n.time_modify>s.time_modify?TablelistFleets.modalBuildConflictButtonConfirm.trigger("click"):n.time_modify<s.time_modify?(TablelistFleets.modalBuildConflictOld.attr({"data-theme":s.theme,class:"link_fleet"}).html(e(s)),TablelistFleets.modalBuildConflictNew.attr({"data-theme":n.theme,class:"link_fleet"}).html(e(n)),TablelistFleets.modalBuildConflictButtonCancel.off("click").on("click",function(){a&&a.resolve()}),_frame.modal.show(TablelistFleets.modalBuildConflict,"配置冲突",{classname:"infos_fleet infos_fleet_import_conflict",detach:!0,onClose:function(){a&&a.resolve()}})):a&&a.resolve()})}},TablelistFleets.modalRemoveAllSameTheme_show=function(n){TablelistFleets.elModalRemoveAllSameTheme||(TablelistFleets.elModalRemoveAllSameTheme=$("<form/>").append($("<p/>").html("是否删除所有该主题颜色的舰队配置？")).append($('<p class="actions"/>').append($("<button/>",{type:"submit",class:"button",html:"是"})).append($("<button/>",{type:"button",class:"button",html:"否"}).on("click",function(){_frame.modal.hide()}))).on("submit",function(e){var t,i;return e.preventDefault(),t=TablelistFleets.contextmenu.curel.data("theme"),i="remove_fleet_same_theme_"+t,_g.log("Removing all fleet in theme "+t+"..."),_frame.app_main.loading_start(i,!1),_db.fleets.remove({theme:parseInt(t)},{multi:!0},function(e,t){_frame.app_main.loading_complete(i),_frame.modal.hide(),_g.badgeMsg("已删除配置"),"object"===(void 0===n?"undefined":_typeof(n))&&n.refresh&&n.refresh()}),!1})),_frame.modal.show(TablelistFleets.elModalRemoveAllSameTheme,"删除配置",{classname:"infos_fleet infos_fleet_remove",detach:!0})};