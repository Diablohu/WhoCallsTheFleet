"use strict";function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _b(e){return _support.check(e)}function addHandler(e,t,i){if("undefined"!=typeof e.addEventListener)e.addEventListener(t,i,!1);else{if("undefined"==typeof e.attachEvent)throw"Incompatible browser";e.attachEvent("on"+t,i)}}function eventName(e,t){return t=t?"."+t:"",_g.event[e]?_g.event[e].split(" ").map(function(e){return e+t}).join(" "):e+t}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},$window=$(window),$document=$(document),$html=$("html"),$body=$("body"),$body_preventMouseover=!1,$body_isTouch=!1,_g={isinit:!1,isload:!1,isfocus:!document.hasFocus||document.hasFocus(),everfocus:!document.hasFocus||document.hasFocus(),posttime:[],time_format:"m月d日",time_format2:"Y年m月d日",time_diff_range:3456e5,time_diff_range2:31536e6,last:{width:0,height:0},interval:{},initSize:20,baseSize:10,baseMultiper:1,lastBaseSize:10,pixelRatio:window.devicePixelRatio?window.devicePixelRatio:screen.deviceXDPI?screen.deviceXDPI/72:1,maxMultiper:Math.max(1,Math.ceil((screen.availHeight||screen.height||$window.height())/800*10)/10),strings:{},inputIndex:0,lang:"zh_cn",_:!1},_p={comp:{},el:{}},_frame={dom:{},init_all:function(){for(var e in _frame)_frame[e].init&&_frame[e].init()}},_module={},_page={},_data={};if("undefined"==typeof _huScrolled)var _huScrolled={};if(!_huScrolled.ver||_huScrolled.ver<1.2){_huScrolled.ver=1.2,_huScrolled.timeout=!1,_huScrolled.throttle=_huScrolled.throttle||100;var bIEnew=/\(Windows NT [0-9\.]+.+Trident\/[0-9\.]+.+rv.{1}[0-9\.]+\)/.test(navigator.userAgent),bIE=!(!window.attachEvent||window.opera)||bIEnew,el=bIE&&parseFloat(navigator.appVersion.split("MSIE")[1])<9?$window:$document;el.on({"scroll.huScrolled":function(){return!!_huScrolled.timeout||void(_huScrolled.timeout=setTimeout(function(){$document.trigger("huScrolled"),_huScrolled.timeout=null},_huScrolled.throttle))}})}if("undefined"==typeof _huResized)var _huResized={};if((!_huResized.ver||_huResized.ver<2.1)&&(_huResized.ver=2.1,_huResized.throttle=_huResized.throttle||300,_huResized.startSize={},_huResized.viewport=function(){var e=window,t="inner";return"innerWidth"in window||(t="client",e=document.documentElement||document.body),{width:e[t+"Width"],height:e[t+"Height"]}},$window.on({"resize.huResized":function(e,t){t=t||{};var i=_huResized.viewport(),n=_huResized.startSize.width||i.width,a=_huResized.startSize.height||i.height,s=Math.abs(i.width-n)>50||Math.abs(i.height-a)>50;_huResized.timeout&&(clearTimeout(_huResized.timeout),_huResized.timeout=null),_huResized.topmask||(_huResized.topmask=$("<div/>").css({"z-index":"16777269",display:"none",position:"fixed",width:"100%",height:"100%",top:0,left:0,"background-color":"rgba(0,0,0,.5)"}).appendTo($body)),!s||t.isInitial||_huResized.maskShowing||(_huResized.topmask.css("display","block"),_huResized.maskShowing=!0),s||_huResized.isChanging||(_huResized.startSize={width:i.width,height:i.height}),_huResized.isChanging=!0,_huResized.timeout=setTimeout(function(){$window.trigger("huResized"),_huResized.timeout=null,_huResized.maskShowing=!1,_huResized.isChanging=!1,_huResized.topmask.css("display","none"),i=_huResized.viewport(),_huResized.startSize={width:i.width,height:i.height}},t.isInitial?0:_huResized.throttle)}})),"undefined"==typeof _huCss)var _huCss={};(!_huCss.ver||_huCss.ver<1.2)&&(_huCss.ver=1.2,_huCss.cssprefix_result={},_huCss.csscheck=function(e){if(_huCss.csscheck_div||(_huCss.csscheck_div=document.documentElement),e in _huCss.csscheck_div.style)return!0;var t=e.split("-");e=t[0];for(var i=1;i<t.length;i++)e+=t[1].substr(0,1).toUpperCase()+t[1].substr(1);return e in _huCss.csscheck_div.style},_huCss.csscheck_full=function(e){return _huCss.cssprefix(e,null,!0)},_huCss.cssprefix=function(e,t,i){if(_huCss.cssprefix_result[e])var n=_huCss.cssprefix_result[e];else if(_huCss.cssprefix_result[e]===!1){if(i)return!1;var n=""}else{var n="",a=["-webkit-","-moz-","-ms-","-o-"],s=_huCss.csscheck(e);if(!s){n=!1;for(var o=0;o<a.length;o++)if(_huCss.csscheck(a[o]+e)){n=a[o];break}}if(_huCss.cssprefix_result[e]=n,i)return n=n!==!1}return n=n===!1?"":n,t?n:n+e},_huCss.csscheck_3d=function(){return _huCss.csscheck_full("perspective")},_huCss.createSheet=function(e){var t=document.createElement("style");if(e&&(t.title=e),document.getElementsByTagName("head")[0].appendChild(t),window.createPopup||t.appendChild(document.createTextNode("")),e)for(var i=0;i<document.styleSheets.length;i++)if(document.styleSheets[i].title==e)return document.styleSheets[i];return document.styleSheets[document.styleSheets.length-1]},_huCss.getSheet=function(e){return e=e||_huCss.sheet,e||(_huCss.sheet=_huCss.createSheet("__huCss_sheet"),e=_huCss.sheet),e},_huCss.getCssRulesNum=function(e){return e=_huCss.getSheet(e),e.cssRules?e.cssRules.length:0},_huCss.addRule=function(e,t,i,n){var a="";n=_huCss.getSheet(n);for(var s in t)_huCss.csscheck_full(s)?a+=_huCss.cssprefix(s)+":"+t[s]+";":"opacity"==s&&_huCss.csscheck_full("filter")&&(a+="filter:alpha(opacity="+100*t[s]+")");if(i||0===i||(i=n.cssRules?n.cssRules.length:_huCss.getCssRulesNum()),n.insertRule)n.insertRule(e+"{"+a+"}",i);else for(e=e.split(","),s=0;s<e.length;s++)n.addRule(e[s],a,i)},_huCss.removeRule=function(e,t){if(!e&&0!==e)return!1;t=_huCss.getSheet(t);try{t.deleteRule(e)}catch(i){t.removeRule(e)}});var _UA=navigator.userAgent,bChrome=/Chrome/.test(_UA),bChromeVer=!!bChrome&&/Chrome\/([0-9\.]+)/.exec(navigator.appVersion),bSafari=/Safari/.test(_UA)&&!bChrome,bFirefox=/Firefox/.test(_UA),bOpera=/Opera/.test(_UA),bWebkit=/WebKit/.test(_UA),bWebkitVer=!!bWebkit&&/(AppleWebKit|Safari)\/([0-9\.]+)/.exec(navigator.appVersion),bIEnew=/\(Windows NT [0-9\.]+.+Trident\/[0-9\.]+.+rv.{1}[0-9\.]+\)/.test(_UA),bIEnewVer=!!bIEnew&&parseFloat(_UA.split("rv:")[1]),bIE=!(!window.attachEvent||window.opera)||bIEnew,bIE6=bIE&&parseFloat(navigator.appVersion.split("MSIE")[1])<7,bIE7=bIE&&parseFloat(navigator.appVersion.split("MSIE")[1])<8,bIE8=bIE&&parseFloat(navigator.appVersion.split("MSIE")[1])<9,bIE9=bIE&&parseFloat(navigator.appVersion.split("MSIE")[1])<10,bIE10=bIE&&parseFloat(navigator.appVersion.split("MSIE")[1])<11,bIE11=bIEnewVer&&bIEnewVer<12,bGecko=!bIE&&!bIEnew&&!bWebkit&&_UA.indexOf("Gecko")!=-1,bIphone=/iPhone/i.test(_UA),bIpad=/iPad/i.test(_UA),bAndroid=/Android/i.test(_UA),bIOS=!1,bIOSver=!(!bIphone&&!bIpad)&&/CPU.*OS\s*([0-9_]+)/i.exec(navigator.appVersion),bMobile=bIphone||bIpad||bAndroid,bCSSrem=!bIE8,bCSS3=_huCss.csscheck_full("border-radius"),bCSS3A=_huCss.csscheck_full("animation"),bCSS3flex=_huCss.csscheck_full("flex"),b3D=_huCss.csscheck_full("perspective"),bCSS3calc=bCSSrem,bTouch=/Touch/.test(_UA),bUnsupport=bIE7,bHTML5m3u8=bMobile,bAccessYoutube=!1,bAccessTwitter=!1,bAccessFacebook=!1;if(bWebkitVer&&bWebkitVer.length&&(bWebkitVer=bWebkitVer[2]),bChromeVer&&bChromeVer.length&&(bChromeVer=parseFloat(bChromeVer[1])),bIOSver&&bIOSver.length&&(bIOSver=parseFloat(bIOSver[1].replace(/_/,".")),bIOS=!0),(bChromeVer&&bChromeVer<29||bIOSver&&bIOSver<7)&&(bCSS3flex=!1),bIOSver&&bIOSver<6&&(bCSS3calc=!1),bGecko?$html.addClass("is-gecko"):bIE11&&!bIE10?$html.removeClass("ie9").addClass("ie11"+(bTouch?" ie-touch":"")):bIE10&&!bIE9?$html.removeClass("ie9").addClass("ie10"+(bTouch?" ie-touch":"")):bMobile?($html.addClass("mobile"),bIOS&&$html.addClass("ios"),bIphone&&$html.addClass("iphone"),bIpad&&$html.addClass("ipad"),bAndroid&&$html.addClass("android")):bWebkitVer<537&&$html.addClass("oldwebkit"),bTouch&&$html.addClass("touch"),navigator.userAgent.match(/IEMobile\/10\.0/)){var msViewportStyle=document.createElement("style");msViewportStyle.appendChild(document.createTextNode("@-ms-viewport{width:auto!important}")),document.getElementsByTagName("head")[0].appendChild(msViewportStyle)}_g.getUrl=function(){return location.href.split("#")[0]},_g.uriSearchArr={},_g.uriHashArr={},_g.timeHash=function(){var e=new Date;return e=e.getTime()},_g.uriSearch=function(e){if(!_g.uriSearchArr.length){var t=location.search?location.search.split("?")[1]:"";t=t.split("&");for(var i=0;i<t.length;i++){var n=t[i].split("=");_g.uriSearchArr[n[0]]=n[1]||""}}return e?_g.uriSearchArr[e]:location.search.substr(location.search.indexOf("?")+1)},_g.uriHash=function(e,t,i){var n=location.hash,a=n?n.split("#")[1]:"";if(a=a.split("&"),!_g.uriHashInited){_g.uriHashArr={};for(var s in a){var o=a[s].split("=");""!==o[0]&&(_g.uriHashArr[o[0]]=o[1]||!1)}_g.uriHashInited=!0}if("object"==("undefined"==typeof e?"undefined":_typeof(e))){for(var r in e)n=_g.uriHash(r,e[r],n);location.hash=n}else if(t===!1||""===t)n=n.replace("&"+e+"="+_g.uriHashArr[e],"").replace(e+"="+_g.uriHashArr[e],""),"#"!=n&&""!=n&&n||(n="_"),location.hash=n;else if("undefined"!=typeof t){if(t==_g.uriHashArr[e])return t;var l=_g.uriHashArr[e]?n.replace(e+"="+_g.uriHashArr[e],e+"="+t):n+(""==n?"#":"&")+e+"="+t;return _g.uriHashArr[e]=t,i?l:(location.hash=l,t)}return e?_g.uriHashArr[e]||!1:location.hash.substr(location.hash.indexOf("#")+1)},_g.randNumber=function(e){var t=new Date;return t=t.getTime(),t=(9301*t+49297)%233280,e||(e=1e3),Math.ceil(t/233280*e)},_g.randInt=function(e,t){return Math.floor(Math.random()*parseInt(e)+(t?parseInt(t):0))},_g.scrollTo=function(e,t){if(isNaN(e)){e=$(e);var i=e.scrollTop()}else{t=e,e=$("html,body");var i=$window.scrollTop()}var n=Math.abs(i-t),a=$window.height(),s=n<=a?200:200*(n/a)*(2/3);e.stop().animate({scrollTop:t},s)},_g.get_em=function(e,t,i){var n=parseFloat(e);return t=t||$body,i=i||0,isNaN(n)?e:n/parseFloat(t.css("font-size"))+i+"em"},_g.get_fontsize=function(e){return e=e||$body,parseInt(e.css("font-size"))},_g.get_basesize=function(){return parseInt($body.css("font-size"))/_g.initSize*10},_g.get_basesize_true=function(){return parseInt($body.css("font-size"))},_g.get_basemultiper=function(){return parseFloat(_g.get_basesize()/10)},_g.get_rem=function(e){var t=parseFloat(e);return isNaN(t)?e:bCSSrem?t/_g.initSize+"rem":e},_g.rem=function(e,t){var i=parseFloat(e);return isNaN(i)?e:bCSSrem?(i=i/(_g.get_basesize()/10)/_g.initSize,t?i+"rem":Math.round(10*i)/10+"rem"):e},_g.px=function(e,t){var i=parseFloat(e);return isNaN(i)?e:bIE8?e:i*_g.initSize+(t?0:"px")},_g.get_animate_duration=function(e){return _g.isfocus?e:0},_g.goto_hash=function(e,t){if(e=e||location.hash,e=e.replace(/^([\#]{0,1})(.+)/,"$2"),"!"==e[0])return!1;var i=$("#"+e);if(!i.length)return!1;var n=i.offset().top,a=$window.scrollTop(),s=Math.abs(a-n),o=$window.height();return t=null==t?s<=o?200:200*(s/o)*(2/3):t,t?$("html,body").stop().animate({scrollTop:n},t,function(){location.hash=e}):($("html,body").scrollTop(n),location.hash=e),e},_g.time=function(e){if(!e)return _g.timeNow();for(var t,i=[{exp:/(\d{4}).(\d{1,2}).(\d{1,2})[^0-9]*(\d{0,2})[:]{0,1}(\d{0,2})[:]{0,1}(\d{0,2})([\+\-])(\d{2})\:(\d{2})/i,p:{year:1,month:2,day:3,hour:4,min:5,sec:6,zoneD:7,zoneH:8,zoneM:9}},{exp:/(\d{1,2}).(\d{1,2}).(\d{4})[^0-9]*(\d{0,2})[:]{0,1}(\d{0,2})[:]{0,1}(\d{0,2})/i,p:{year:3,month:1,day:2,hour:4,min:5,sec:6}},{exp:/(\d{4}).(\d{1,2}).(\d{1,2})[^0-9]*(\d{0,2})[:]{0,1}(\d{0,2})[:]{0,1}(\d{0,2})/i,p:{year:1,month:2,day:3,hour:4,min:5,sec:6}}],n=0;n<i.length;n++){var a=i[n].exp,s=e.match(a);if(!t&&s&&s.length){var o=parseInt(s[i[n].p.year]),r=parseInt(s[i[n].p.month])||0,l=parseInt(s[i[n].p.day])||1,d=parseInt(s[i[n].p.hour])||0,u=parseInt(s[i[n].p.min])||0,c=parseInt(s[i[n].p.sec])||0;if(t=new Date(o,r-1,l,d,u,c,0),i[n].p.zoneD&&s[i[n].p.zoneD]){var h="+"==s[i[n].p.zoneD]?-1:1,d=parseInt(s[i[n].p.zoneH])||0,u=parseInt(s[i[n].p.zoneM])||0,m=h*(u+60*d+t.getTimezoneOffset())*60*1e3;t=new Date(t.valueOf()+m)}}}return t},_g.timeCal=function(e,t){return e<6e4?Math.floor(e/1e3)+"秒"+(t?"前":""):e<36e5?Math.floor(e/6e4)+"分钟"+(t?"前":""):e<864e5?Math.floor(e/36e5)+"小时"+(t?"前":""):e<1728e5?"昨天":e<2592e6?Math.floor(e/864e5)+"天"+(t?"前":""):e<31536e6?Math.floor(e/2592e6)+"月"+(t?"前":""):Math.floor(e/31536e6)+"年"+(t?"前":"")},_g.timeNow=function(){var e=new Date;return e.getTime()},_g.timeDiff=function(e){var t={time:_g.timeNow(),obj:null,format:_g.time_format,format2:_g.time_format2,range:_g.time_diff_range,range2:_g.time_diff_range2,is_init:!0};return $.extend(t,e),!!t.obj&&(e=t)},_g.timeDiffInterval=function(){function e(){if(!_g.isfocus)return!1;for(var e=0;e<_g.posttime.length;e++){var t=_g.posttime[e].is_init?_g.posttime[e]:_g.timeDiff(_g.posttime[e]),i=new Date,n=i.getTime()-t.time,a=t.range,s=t.range2;if(n<a)t.obj.html(n<6e4?"刚刚":_g.timeCal(n,!0));else{var o=n>s?t.format2:t.format,r=t.time;o=o.replace(/Y/g,r.getFullYear()),o=o.replace(/M/g,r.getMonth()+1<10?"0"+(r.getMonth()+1):r.getMonth()+1),o=o.replace(/m/g,r.getMonth()+1),o=o.replace(/D/g,r.getDate()<10?"0"+r.getDate():r.getDate()),o=o.replace(/d/g,r.getDate()),t.obj.html(o)}}}clearInterval(_g.interval.posttime),e(),_g.interval.posttime=setInterval(function(){e()},6e4)};var _support={cache:{},check:function(e){return e=e.toLowerCase().replace(/[ :-_]/g,""),"undefined"==typeof _support.cache[e]&&_support["_"+e]&&(_support.cache[e]=_support["_"+e]()),_support.cache[e]}};_support._css3=function(){return _huCss.csscheck_full("border-radius")},_support._css3animation=function(){return _huCss.csscheck_full("animation")},_support._css3transition=function(){return _huCss.csscheck_full("transition")},_support._css3flex=function(){return _huCss.csscheck_full("flex")},_support._css33d=function(){return _huCss.csscheck_full("perspective")},_support._css3d=_support._css33d,_support._css3mediaquery=function(){return!(!window.matchMedia&&!window.msMatchMedia)},_support._mediaquery=_support._css3mediaquery,_support._css3imageset=function(){function e(e){i.css("background-image","image-set(url("+_g.pathImg+"_g-p.gif) 1x)");var t=i.css("background-image");return!(!t||"none"==t)||!(!e||(i.css("background-image",e+"image-set(url("+_g.pathImg+"_g-p.gif) 1x)"),t=i.css("background-image"),!t||"none"==t))&&e}var t=null,i=$("<div/>",{style:"background-image:url("+_g.pathImg+"_g-p.gif)"});return t=bWebkit?e("-webkit-"):bGecko?e("-moz-"):bIE?e("-ms-"):e()},_support._pluginflash=function(){var e=!1;try{e="undefined"!=typeof navigator.plugins&&"object"==_typeof(navigator.plugins["Shockwave Flash"])||window.ActiveXObject&&0!=new ActiveXObject("ShockwaveFlash.ShockwaveFlash")}catch(t){}return e},_support._flash=_support._pluginflash,_support._html5attrdownload=function(){return"download"in document.createElement("a")},_support._html5download=_support._html5attrdownload,_support._html5attributedownload=_support._html5attrdownload,_support._html5videomp4=function(){var e=document.createElement("video"),t=!1;return e.canPlayType&&e.canPlayType("video/mp4").replace(/no/,"")&&(t=!0),t},_support._html5mp4=_support._html5videomp4,_g.init=function(){if(_g.baseSize=_g.get_basesize(),_g.baseMultiper=parseFloat(_g.baseSize/10),_g.lastBaseSize=_g.get_basesize(),_g.isfocus="visible"==Visibility.state(),_g.everfocus=_g.isfocus,Visibility.change(function(e,t){"visible"==t?(_g.isfocus=!0,_g.everfocus||(_g.everfocus=!0,_g.last.width=-1,_g.last.height=-1,_frame.main.last.width=-1,_frame.main.last.height=-1),$window.trigger("resized_check._g"),_g.timeDiffInterval()):_g.isfocus=!1}),$window.on({orientationchange:function(){$window.trigger("resize")},huResized:function(){$window.trigger("resized_check._g")},"resized_check._g":function(){if(!_g.isfocus)return!1;var e=$window,t=e.width(),i=e.height();if(_g.baseSize=_g.get_basesize(),_g.orientation=t>=i?"landscape":"portrait",_g.baseSize!=_g.lastBaseSize&&(_g.baseMultiper=parseFloat(_g.baseSize/10),_g.lastBaseSize=_g.baseSize,_g.isBaseChange=!0,e.trigger("basechange")),t!=_g.last.width||i!=_g.last.height){var n={is_widthchange:t!=_g.last.width,is_heightchange:i!=_g.last.height};e.trigger("resized_before",[n]).trigger("resized",[n]),_g.isEverResized=!0}_g.last.width=t,_g.last.height=i},basechange:function(){_g.isBaseChange&&(_g.isBaseChange=!1,setTimeout(function(){$window.trigger("resized_before").trigger("resized",[{is_basechange:!0}])},_g.animate_duration_delay))},"load.trigger_resized":function(){return!!_g.isfocus&&(setTimeout(function(){$window.trigger("resized_before",[{is_load:!0}]).trigger("resized",[{is_load:!0}])},_g.readyLock?4*_g.animate_duration+10:0),void(_g.isload=!0))},"hashchange._global":function(e){_g.uriHashArr={};var t=(location.hash?location.hash.split("#")[1]:"").split("&");for(var i in t){var n=t[i].split("=");""!==n[0]&&(_g.uriHashArr[n[0]]=n[1]||!1)}_g.uriHashInited=!0,_g.uriHash()&&""!=_g.uriHash()||(e.preventDefault(),e.stopPropagation())},"unload.focuswindow":function(){$(this).focus()}}),setTimeout(function(){$window.trigger("hashchange")},_g.animate_duration_delay+10),$document.on({huScrolled:function(){$window.trigger("scrolled")}}),$body.on({"touchstart.preventMouseover":function(){$body.removeClass("hover"),$body_preventMouseover=!0,$body_isTouch=!0},pointerenter:function(e){"touch"==e.originalEvent.pointerType?$body.trigger("touchstart.preventMouseover"):($body_preventMouseover=!1,$body_isTouch=!1)},mouseover:function(){$body_isTouch?($body_isTouch=!1,$body_preventMouseover=!0):($body.addClass("hover"),$body_preventMouseover=!1)},mouseleave:function(){$body.removeClass("hover")}}),top!=self)try{self.location.host!=top.location.host&&top.location.replace(self.location.href),self.location.host==top.location.host&&($body.addClass("only-content"),_g.changeTheme(top._g.getTheme())),$html.css("font-size",top.$html.css("font-size")),$window.on({"resized.iframe_resize":function(){$html.css("font-size",top.$html.css("font-size"))}})}catch(e){}_hotkey.init(),_frame.init_all(),_p.init_document_ready(),$html.addClass("ready"),$window.trigger("resize",[{isInitial:!0}]),_g.readyLock=!0,setTimeout(function(){_g.readyLock=null},4*_g.animate_duration+10);try{window.external.msSiteModeClearBadge()}catch(e){}return _g.isinit=!0,!1},jQuery.cookie=function(e,t,i){if("undefined"==typeof t){var n=null;if(document.cookie&&""!=document.cookie)for(var a=document.cookie.split(";"),s=0;s<a.length;s++){var o=jQuery.trim(a[s]);if(o.substring(0,e.length+1)==e+"="){n=decodeURIComponent(o.substring(e.length+1));break}}return n}i=i||{},null===t&&(t="",i.expires=-1);var r="";if(i.expires&&("number"==typeof i.expires||i.expires.toUTCString)){var l;"number"==typeof i.expires?(l=new Date,l.setTime(l.getTime()+24*i.expires*60*60*1e3)):l=i.expires,r="; expires="+l.toUTCString()}var d="; path="+(i.path?i.path:"/"),u=i.domain?"; domain="+i.domain:/(.*)([\.]*)acgdb\.com/.test(location.host)?"; domain=.acgdb.com":"",c=i.secure?"; secure":"";document.cookie=[e,"=",encodeURIComponent(t),r,d,u,c].join("")},function(e){e.fn.innerWidth=function(){return parseFloat(this.css("width"))},e.fn.innerHeight=function(){return parseFloat(this.css("height"))}}(jQuery),$.fn.serializeObject=function(){function e(i,n,a){if(!n.length)return i;var s=n[0];"undefined"==typeof i[s]?i[s]=n.length>1?{}:a:1==n.length&&(i[s].push||(i[s]=[i[s]]),i[s].push(t(a))),n.shift(),e(i[s],n,a)}function t(e){return"number"==typeof e&&0===e?e:e||""}var i={},n=this.serializeArray();return $.each(n,function(){if(!/^_tabview\-/.test(this.name))if(this.value=isNaN(this.value)||!this.value?this.value:parseFloat(this.value),this.name.indexOf(".")>-1){var n=this.name.split(".");e(i,n,this.value)}else i[this.name]||0===i[this.name]?(i[this.name].push||(i[this.name]=[i[this.name]]),i[this.name].push(t(this.value))):i[this.name]=t(this.value)}),i},_p.initDOM=function(e){return e=e||_frame.dom.layout||_frame.dom.layout||$body,e.initAll()},_p.initAll=_p.initDOM,$.fn.initDOM=function(){for(var e in _p.el)_p.el[e].init&&_p.el[e].init(this);return this},$.fn.initAll=$.fn.initDOM,_p.init_document_ready=function(){_p.is_init_document_ready||(_p.initDOM($body),_p.is_init_document_ready=!0)},_p.getSummary=function(){var e=$("#summary").text()||!1;return!e&&$("head").find("meta[name=keywords]").length&&(e=$("head").find("meta[name=Description]").attr("content"),e=e.substr(0,e.indexOf(" - ACGDB"))),e},_p.get_tar=function(e,t,i){return e=e||_frame.dom.layout||$("#layout")||$body,"."==t.substr(0,1)&&(t=t.substr(1)),e.hasClass(t)?e:i?e.find('[class^="'+t+'"]'):e.find("."+t)},_p.hashlinks=function(e){e=e||$body,e.find("a[href^=#]").each(function(){$(this).off("click.hashlink").on({"click.hashlink":function(){return _g.goto_hash($(this).attr("href")),!1}})})},_p.get_lines=function(e,t){return t=t||e,Math.max(1,Math.floor(Math.min(e.innerHeight(),e.height())/parseFloat(t.css("line-height"))))},_p.el.time={init:function(e){var t=_p.get_tar(e,".time");t.each(function(){var e=$(this),t=e.text();time=t?_g.time(t):null,time&&_g.posttime.push({time:time,obj:e})}),_g.timeDiffInterval()}},_p.el.timeSec={init:function(e){var t=_p.get_tar(e,".time-sec");t.each(function(){var e=$(this);if(e.data("acgdb-time-sec"))return e.data("acgdb-time-sec");var t=e.text(),i=/\s*([0-9]+)/.exec(t);if(i&&i.length>1){i=parseInt(i[1]);var n=Math.floor(i/60),a=i%60,s=(n<10?"0":"")+n+":"+(a<10?"0":"")+a+"'";e.text(s)}e.data("acgdb-time-sec",i)})}},_p.removeEmptyTextNode=function(e){return e=$(e),!!e.length&&void e.contents().filter(function(){return 3===this.nodeType}).remove()},Object.defineProperty(Array.prototype,"mergeFrom",{enumerable:!1,value:function(e){return Array.prototype.push.apply(this,e instanceof Array||e.push?e:[e]),this}}),Date.prototype.format=function(e,t){return _g.formatTime(this,e,t)},_g.formatTime_string={zh_CN:{Midnight:"深夜",Sunday:"周日",Monday:"周一",Tuesday:"周二",Wednesday:"周三",Thursday:"周四",Friday:"周五",Saturday:"周六"}},_g.formatTime_weekdaymappding=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],_g.formatTime=function(e,t,i){function n(e){return e<10?"0"+e:e}if(!e)return!1;i=i||{},t=t||"%Y年%m月%d日","date"!=typeof e&&(e=new Date(e));var a=e.valueOf();"undefined"!=typeof i.output_timezone&&(a+=60*(i.output_timezone+e.getTimezoneOffset()/60)*60*1e3,e=new Date(a));var s=e.getHours(),o=n(s);return i.midnight_astoday&&(s<6||24==s)?(s+=24,o=s,a-=864e5,e=new Date(a),t=t.replace(/\%midnight/g,"Midnight"._(_g.formatTime_string))):t=t.replace(/\%midnight/g,""),t.replace(/\%Y/g,e.getFullYear()).replace(/\%m/g,n(e.getMonth()+1)).replace(/\%n/g,e.getMonth()+1).replace(/\%d/g,n(e.getDate())).replace(/\%j/g,e.getDate()).replace(/\%G/g,s).replace(/\%H/g,o).replace(/\%i/g,n(e.getMinutes())).replace(/\%s/g,n(e.getSeconds())).replace(/\%l/g,_g.formatTime_weekdaymappding[e.getDay()]._(_g.formatTime_string))},Object.defineProperty(Object.prototype,"_size",{enumerable:!1,get:function(){var e=0;for(var t in this)e++;return e}}),String.prototype.getText=function(e,t){return _g.getText(this,e,t,!0)},String.prototype._=String.prototype.getText,_g.getText=function(e,t,n,a){function s(e){return"object"==("undefined"==typeof e?"undefined":_typeof(e))&&e.length?e[0]:e}if(!e||!t)return e;n=n||_g.lang;if(t[e]){if("string"==typeof t[e])return s(t[e]);if(t[e][n])return s(t[e][n])}if(t[n]&&t[n][e])return s(t[n][e]);if("string"!=typeof e&&a){for(_t="",i=0;i<e.length;i++)_t+=e[i];e=_t}return s(e)},_g.hashCode=function(e){var t=5;e=encodeURIComponent(e);try{return e.split("").reduce(function(e,i){return e=(e<<t)-e+i.charCodeAt(0),e&e},0).toString(16)}catch(i){var n,a,s=0;if(0==e.length)return s;for(n=0,l=e.length;n<l;n++)a=e.charCodeAt(n),s=(s<<t)-s+a,s|=0;return s.toString(16)}},String.prototype.hashCode=function(){return _g.hashCode(this)},String.prototype.filter=function(){return _g.stringFilter(this)},String.prototype.filterCensored=function(){return _g.stringFilterCensored(this)},String.prototype.escape=function(){return $("<div />").text(this).html()};var _tmpl={"export":function(e,t){return e.attr&&t?e.prop("outerHTML"):e.attr&&!t?e:!e.attr&&t?e:e.attr||t?void 0:$(e)}},_hotkey={allowed:!0,keyCodeBindings:{}};_hotkey.bind=function(e,t,i,n){if("function"==typeof t)return _hotkey.bind(e,null,t,i);if(!e||!i)return!1;e=parseInt(e),t="text"==typeof t?[t]:t||[],n=n||{},"undefined"==typeof _hotkey.keyCodeBindings[e]&&(_hotkey.keyCodeBindings[e]={"default":[],meta:[],alt:[],shift:[],"meta+alt":[],"meta+shift":[],"alt+shift":[],"meta+alt+shift":[]});var a=!1,s=!1,o=!1;for(var r in t)t[r]=t[r].toLowerCase(),"ctrl"!=t[r]&&"meta"!=t[r]||(a=!0),"alt"==t[r]&&(s=!0),"shift"==t[r]&&(o=!0);return a&&s&&o?_hotkey.keyCodeBindings[e]["meta+alt+shift"].push(i):a&&s?_hotkey.keyCodeBindings[e]["meta+alt"].push(i):a&&o?_hotkey.keyCodeBindings[e]["meta+shift"].push(i):s&&o?_hotkey.keyCodeBindings[e]["alt+shift"].push(i):a?_hotkey.keyCodeBindings[e].meta.push(i):s?_hotkey.keyCodeBindings[e].alt.push(i):o?_hotkey.keyCodeBindings[e].shift.push(i):_hotkey.keyCodeBindings[e]["default"].push(i),!0},_hotkey._run=function(e){for(var t in e)e[t]()},_hotkey.init=function(){return _hotkey.is_init?_hotkey:($window.on("keydown._hotkey",function(e){if("INPUT"!=document.activeElement.tagName&&"TEXTAREA"!=document.activeElement.tagName&&"SELECT"!=document.activeElement.tagName&&!document.activeElement.hasAttribute("contenteditable")&&_hotkey.allowed){var t=parseInt(e.keyCode||e.which);_hotkey.keyCodeBindings[t]&&((e.ctrlKey||e.metaKey)&&e.altKey&&e.shiftKey?_hotkey._run(_hotkey.keyCodeBindings[t]["meta+alt+shift"]):(e.ctrlKey||e.metaKey)&&e.altKey?_hotkey._run(_hotkey.keyCodeBindings[t]["meta+alt"]):(e.ctrlKey||e.metaKey)&&e.shiftKey?_hotkey._run(_hotkey.keyCodeBindings[t]["meta+shift"]):e.altKey&&e.shiftKey?_hotkey._run(_hotkey.keyCodeBindings[t]["alt+shift"]):e.ctrlKey||e.metaKey?_hotkey._run(_hotkey.keyCodeBindings[t].meta):e.altKey?_hotkey._run(_hotkey.keyCodeBindings[t].alt):e.shiftKey?_hotkey._run(_hotkey.keyCodeBindings[t].shift):e.altKey||e.ctrlKey||e.metaKey||e.shiftKey||_hotkey._run(_hotkey.keyCodeBindings[t]["default"]))}}),void(_hotkey.is_init=!0))};var _form={};_form.section=function(e,t,i,n,a,s){if(!e)return!1;if("object"==("undefined"==typeof e?"undefined":_typeof(e)))return _form.section(e.type,e.name||null,e.label||null,e.value||null,e.suffix||null,e);if("object"==("undefined"==typeof t?"undefined":_typeof(t)))return _form.section(e,t,t.label||null,t.value||null,t.suffix||null,t);if("object"==("undefined"==typeof i?"undefined":_typeof(i)))return _form.section(e,t,i.label||null,i.value||null,i.suffix||null,i);if("object"==("undefined"==typeof n?"undefined":_typeof(n)))return _form.section(e,t,d,n.value||null,n.suffix||null,n);if("object"==("undefined"==typeof a?"undefined":_typeof(a)))return _form.section(e,t,d,n||null,a.suffix||null,a);s=s||{};var o=$("<dl/>").addClass(e,s.className),r=$("<dt/>").appendTo(o),l=$("<dd/>").appendTo(o),d="_input_g"+_g.inputIndex;switch(_g.inputIndex++,e){case"directory":$("<label/>").html(i).appendTo(r);break;default:a?$("<label/>").html(i).appendTo(r):$('<label for="'+d+'"/>').html(i).appendTo(r)}return _form.element(e,t,d,n,s).appendTo(l),a&&$('<label for="'+d+'"/>').html(a).appendTo(l),s.add&&l.append(s.add),l},_form.line=_form.section,_form.element=function(e,t,i,n,a){if(!e)return!1;if("object"==("undefined"==typeof e?"undefined":_typeof(e)))return _form.element(e.type,e.name||null,e.id||null,e.value||null,e);if("object"==("undefined"==typeof t?"undefined":_typeof(t)))return _form.element(e,t,t.id||null,t.value||null,t);if("object"==("undefined"==typeof i?"undefined":_typeof(i)))return _form.element(e,t,i.id||null,i.value||null,i);if("object"==("undefined"==typeof n?"undefined":_typeof(n)))return _form.element(e,t,i,n.value||null,n);a=a||{},i=i||null,null===i&&(i="_input_g"+_g.inputIndex,_g.inputIndex++);var s=$(),o=a["default"]||a.defaultValue;switch(e){default:s=$("<input/>",{type:e,name:t,id:i}).val(n);break;case"select":s=$("<select/>",{name:t,id:i}).val(n);var r=$('<option value=""/>').appendTo(s);for(var l in n){if("object"==_typeof(n[l]))var d=n[l].value||n[l].val,u=$('<option value="'+d+'"/>').html(n[l].title||n[l].name).appendTo(s);else var d=n[l],u=$('<option value="'+d+'"/>').html(d).appendTo(s);"undefined"!=typeof o&&d==o&&u.prop("selected",!0),u.val()||u.attr("disabled",!0)}n&&n.length||r.html("..."),a["new"]&&($('<option value="" disabled/>').html("==========").insertAfter(r),$('<option value="___new___"/>').html("+ 新建").insertAfter(r),s.on("change.___new___",function(){"___new___"==s.val()&&(s.val(""),a["new"](s))}));break;case"select_group":case"selectGroup":s=$("<select/>",{name:t,id:i}).val(n);var r=$('<option value=""/>').appendTo(s);for(var l in n){var c=$('<optgroup label="'+n[l][0]+'"/>').appendTo(s);for(var h in n[l][1]){var m=n[l][1][h];if("object"==("undefined"==typeof m?"undefined":_typeof(m)))var u=$('<option value="'+("undefined"==typeof m.val?m.value:m.val)+'"/>').html(m.title||m.name).appendTo(c);else var u=$('<option value="'+m+'"/>').html(m).appendTo(c);"undefined"!=typeof o&&u.val()==o&&u.prop("selected",!0),u.val()||u.attr("disabled",!0)}}n&&n.length||r.html("..."),a["new"]&&($('<option value="" disabled/>').html("==========").insertAfter(r),$('<option value="___new___"/>').html("+ 新建").insertAfter(r),s.on("change.___new___",function(){"___new___"==s.val()&&(s.val(""),a["new"](s))}));break;case"checkbox":s=$("<input/>",{type:e,name:t,id:i}),"string"==typeof n&&"true"!==n.toLowerCase()?s.val(n).prop("checked",a.checked):s.prop("checked","undefined"==typeof a.checked?n:a.checked);break;case"checkboxes":for(var l in n){var d=n[l];"object"!=("undefined"==typeof d?"undefined":_typeof(d))&&(d=[d,!1]),parseInt(l)&&(_g.inputIndex++,i="_input_g"+_g.inputIndex),s=s.add($('<input type="checkbox" name="'+t+'" id="'+i+'" value="'+d[0]+'" />').prop("checked",d[1])).add($('<label for="'+i+'"/>').html(d[2]||d[0]))}break;case"directory":case"file":s=$('<input type="text" name="'+t+'" id="'+i+'" />').on({input:function(){s.trigger("change")},click:function(){s.val()||f.trigger("click")}}).val(n);var p=$('<input type="file" class="none"'+("directory"==e?" nwdirectory":"")+" />").on("change",function(){s.val($(this).val()).trigger("change")}),f=$('<button type="button" value="Browse..."/>').html("Browse...").on("click",function(){p.trigger("click")}),_=s.add(p).add(f);a.accept&&p.attr("accept",a.accept)}return a.required&&s.prop("required",!0),a.onchange&&(s.on("change.___onchange___",a.onchange),a["default"]&&s.trigger("change")),_?_:s},_frame.dom={},_frame.main={last:{}},_frame.global={key_registerd:[],esc_funcs:[],allowKeyNav:!0,esc_register:function(e){_frame.global.esc_funcs.push(e)},disableBodyScroll:function(){$(document.body).on("touchmove.disableBodyScroll mousewheel.disableBodyScroll",function(e){e.preventDefault(),e.stopPropagation()})},enableBodyScroll:function(){$(document.body).off("touchmove.disableBodyScroll mousewheel.disableBodyScroll")}},_frame.global.init=function(){return!!_frame.global.is_init||(_frame.dom={layout:$("#layout")},$body.on({"keydown.esckey":function(e){if("INPUT"!=document.activeElement.tagName&&"TEXTAREA"!=document.activeElement.tagName&&"SELECT"!=document.activeElement.tagName&&!$(document.activeElement).attr("contenteditable")&&_frame.global.allowKeyNav){if(!(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)){var t=window.event?e.keyCode:e.which;t=t.toString()}}else if(!_frame.global.allowKeyNav&&!(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)){var t=window.event?e.keyCode:e.which;
switch(t=t.toString()){case"27":for(var i=0;i<_frame.global.esc_funcs.length;i++)_frame.global.esc_funcs[i]()}}}}),_frame.dom.hidden=$("<div/>",{"class":"none"}).appendTo($body),_frame.dom.hiddenVisible=$("<div/>",{"class":"none-visible"}).appendTo($body),_frame.dom.hiddenIframe=$("<iframe/>",{"class":"none",name:"hiddeniframe"}).appendTo($body),$body.on("submit.check_submitting_status","form",function(e){var t=$(this);(t.hasClass("submitting")||t.hasClass("loading")||t.hasClass("disabled"))&&e.preventDefault()}),_frame.global.is_init=!0,!0)};var _menu=function(e){this.settings||(this.settings=$.extend(!0,{},this.defaults,e||{}),this.init())};_menu.prototype.defaults={items:[],target:null,className:null},_menu.prototype.init=function(){var e=this;this.dom={},this.dom.menu=$('<div class="menu"/>').addClass(this.settings.className).on("click",function(){e.timeout_hideself||(e.timeout_hideself=setTimeout(function(){e.timeout_hideself=null,e.hide()},10))}),this.dom.body=$('<div class="body"/>').appendTo(this.dom.menu),this.dom.menu.on({"transitionend.menu_hide webkitTransitionEnd.menu_hide mozTransitionEnd.menu_hide":function(t){t.currentTarget==t.target&&"opacity"==t.originalEvent.propertyName&&0===parseFloat(e.dom.menu.css("opacity"))&&e.hideTrue()}});for(var t,i=0;t=this.settings.items[i];i++)if(t){switch(t){case"separator":t=$("<hr/>")}t.hasClass("donot_hide")&&t.on("click",function(){setTimeout(function(){clearTimeout(e.timeout_hideself),e.timeout_hideself=null},1)}),e.appendItem(t)}this.dom.body.find('input[type="checkbox"]+label').addClass("checkbox"),"undefined"!=typeof node&&this.dom.menu.addClass("mod-blur-shot"),_frame.menu.menus.push(this)},_menu.prototype.show=function(e,t,i){return this.showing?this:"number"==typeof e?this.show("mouse",e,t):(e=e||this.settings.target,clearTimeout(_frame.menu.timeout_hideall),_frame.menu.timeout_hideall=null,this.dom.menu.appendTo(_frame.menu.dom.container).addClass("show"),_frame.menu.dom.container.addClass("on"),this.showing=!0,this.dom.body.children().trigger("show"),this.position(e,t,i),void("undefined"!=typeof node?node.win.capturePage(this.capturePage_callback.bind(this),"jpg","datauri"):this.dom.menu.addClass("on")))},_menu.prototype.hide=function(e){return!!this.showing&&(e&&(this.callback_hide=e),this.dom.menu.hasClass("on")||this.hideTrue(),void this.dom.menu.removeClass("on"))},_menu.prototype.hideTrue=function(){this.dom.menu.removeClass("show").css({top:"",left:""}).detach(),this.dom.blured instanceof jQuery&&(this.dom.blured.remove(),delete this.dom.blured),this.showing=!1,_frame.menu.dom.container.removeClass("on"),this.callback_hide&&this.callback_hide(),delete this.callback_hide},_menu.prototype.position=function(e,t,i){var n,a,s,o,r,l;if(e=e||this.settings.target,this.dom.menu.css({top:"",left:""}),e&&e instanceof jQuery){var d=e.offset();n=d.top+e.height()-$body.scrollTop()+(i||0),a=d.left-$body.scrollLeft()+(t||0)}else("mouse"==e||!e&&"number"==typeof t)&&(a=t||0,n=i+5||0);s=$window.height()-10,o=$window.width()-10,r=this.dom.menu.outerHeight(),l=this.dom.menu.outerWidth(),this.dom.menu.css({top:n+r>s?s-r:n,left:a+l>o?o-l:a})},_menu.prototype.appendItem=function(e){if(e instanceof jQuery)return e.appendTo(this.dom.body)},_menu.prototype.capturePage_callback=function(e){this.showing&&(this.dom.blured=$('<s class="blured"/>').css("background-image","url("+e+")").appendTo(this.dom.menu.addClass("on")))},_menu.hideAll=function(e){_frame.menu.timeout_hideall=setTimeout(function(){for(var e in _frame.menu.menus)_frame.menu.menus[e].hide&&_frame.menu.menus[e].hide();_frame.menu.timeout_hideall=null},e||1)},_frame.menu={dom:{},menus:[],init:function(){return this.is_init?this:(this.dom.container=$('<div class="menus"/>').on({click:function(e,t){_menu.hideAll(t)},contextmenu:function(e){_frame.menu.dom.container.trigger("click"),e.preventDefault()}}).appendTo($body),$body.on("click.cancel_hideall",".menus>.menu",function(e){clearTimeout(_frame.menu.timeout_hideall),_frame.menu.timeout_hideall=null}),void(this.is_init=!0))}},_frame.modal={dom:{},defaults:{classname:"",showBlured:!0},show:function(e,t,i,n){clearTimeout(this.hide_timeout),this.hide_timeout=null,this.dom.container.addClass("show"),this.showing=!0;var a=$.extend({},this.defaults,i);a.detach&&(this.content=e),e.appendTo(this.dom.content),a.onClose&&_frame.modal.dom.container.on("close",a.onClose),t?(this.dom.titlebar.html(t),this.dom.container.addClass("hastitle")):(this.dom.titlebar.html(""),this.dom.container.removeClass("hastitle")),this.dom.box.css({width:a.width||null,height:a.height||null}),a.showBlured&&(this.dom.blured||"undefined"==typeof node||(node.win.capturePage(function(e){_frame.modal.dom.blured=$("<img/>").attr("src",e).appendTo(_frame.modal.dom.bg)},"jpg","datauri"),this.dom.container.addClass("mod-blur-shot"))),setTimeout(function(){_frame.modal.dom.container.addClass("on "+a.classname).data("customclass",a.classname)},0),_p.initDOM(this.dom.content),this.dom.bg.off("click.blank_to_close").on("click.blank_to_close",function(){a.blank_to_close&&_frame.modal.dom.btn_close.trigger("click")}),n&&n(this.dom.content)},hide:function(){return!!this.showing&&(clearTimeout(this.hide_timeout),this.hide_timeout=null,void this.dom.container.removeClass("on"))},reset:function(){this.resetContent(),this.dom.blured&&(parseInt(this.dom.container.css("opacity"))||(this.dom.blured.remove(),this.dom.blured=null),this.dom.container.removeClass("mod-blur-shot"))},resetContent:function(){this.content&&(this.content.detach(),this.content=null),this.dom.content.empty(),this.dom.container.removeClass(this.dom.container.data("customclass")),this.dom.container.data("customclass",""),this.dom.titlebar.html(""),this.dom.container.removeClass("hastitle")}},_frame.modal.init=function(){return!!this.is_init||(this.dom.container=$('<div class="modal" />').on({"transitionend.modal_hide webkitTransitionEnd.modal_hide mozTransitionEnd.modal_hide":function(e){_frame.modal.showing&&e.currentTarget==e.target&&"opacity"==e.originalEvent.propertyName&&0==_frame.modal.dom.container.css("opacity")&&(_frame.modal.hide_timeout=setTimeout(function(){_frame.modal.reset(),_frame.modal.dom.container.removeClass("show"),_frame.modal.showing=!1,_frame.modal.dom.container.trigger("close").off("close")},10))}}).prependTo($body),this.dom.box=$("<div/>").appendTo(this.dom.container),this.dom.titlebar=$("<header/>").appendTo(this.dom.box),this.dom.content=$("<section/>").appendTo(this.dom.box),this.dom.btn_close=$('<button class="close" />').html("&times;").on("click",function(){_frame.modal.hide()}).appendTo(this.dom.box),this.dom.bg=$("<s/>").appendTo(this.dom.container),_hotkey.bind("27",function(){_frame.modal.hide()}),this.is_init=!0,!0)},_p.tip={pos:"bottom",size_indicator:8,filters:[],countdown_fade:250,init_global:function(){return!this.is_init&&(this.dom=$('<div id="tip"/>').on("transitionend webkitTransitionEnd mozTransitionEnd",function(e){e.currentTarget==e.target&&"opacity"==e.originalEvent.propertyName&&0==_p.tip.dom.css("opacity")&&(_p.tip.dom.removeClass("show").css({top:"",left:""}).attr({"data-tip-indicator-pos":"","data-tip-indicator-offset-x":"","data-tip-indicator-offset-y":""}),_p.tip.dom_bluredbg&&_p.tip.dom_bluredbg.css("background-image",""))}).appendTo($body),this.dom_body=$('<div class="body"/>').appendTo(this.dom),"undefined"!=typeof node&&(this.dom.addClass("mod-blur-shot"),this.dom_bluredbg=$("<div/>").appendTo($('<div class="bluredbg"/>').appendTo(this.dom))),void(this.is_init=!0))},show:function(e,t,i){return!!e&&(clearTimeout(this.timeout_fade),this.timeout_fade=null,t=t||"body",this.el=$(t),i=i||this.pos,e=this.content(e),this.init_global(),this.dom.hasClass("show")||(this.dom_bluredbg&&"undefined"!=typeof node&&node.win.capturePage(function(e){_p.tip.dom_bluredbg.css("background-image","url("+e+")")},"jpg","datauri"),this.dom.addClass("show")),this.position(e,i),void(this.is_showing=!0))},position:function(e,t){var i=e.hashCode();this.curContent!=i&&(this.dom.css({top:"-1000px",left:"-1000px"}),this.dom_body.html(e),_p.initDOM(this.dom_body),this.curContent=i);var n=this["pos_"+t](this.dom.outerWidth(),this.dom.outerHeight());n&&this.move(n.x,n.y)},hide:function(e){return!(!this.is_init||!this.is_showing)&&void(this.timeout_fade=setTimeout(function(){_p.tip.el=null,_p.tip.dom.removeClass("on"),_p.tip.is_showing=!1,_p.tip.curContent=null,_p.tip.timeout_fade=null},e?0:this.countdown_fade))},content:function(e,t){return t=t||this.el,e},move:function(e,t){this.dom.css({top:t,left:e}).addClass("on")},get_indicator_size:function(){return this.size_indicator*_g.baseMultiper},pos_mouse:function(e,t){this.el.unbind("mousemove.tooltip").bind("mousemove.tooltip",function(i){var n=25,a=i.pageX+n,s=i.pageY+20,o=jQuery(window).innerWidth(),r=jQuery(window).innerHeight(),l=jQuery(window).scrollTop(),d=jQuery(window).scrollLeft();a+e+n>o+d&&(a=a-e-n-20),s+10+t>r+l&&(s=r+l-t-10),_p.tip.move(a,s)})},pos_bottom:function(e,t){var i=this.el,n=this.dom,a=i.offset(),s=a.left+(i.outerWidth()-n.outerWidth())/2,o=a.top+i.outerHeight()+this.get_indicator_size();return this.dom.attr("data-tip-indicator-pos","top"),this.checkpos(s,o,e,t)},pos_top:function(e,t){var i=this.el,n=this.dom,a=i.offset(),s=a.left+(i.outerWidth()-n.outerWidth())/2,o=a.top-t-this.get_indicator_size();return this.dom.attr("data-tip-indicator-pos","bottom"),this.checkpos(s,o,e,t)},pos_left:function(e,t){var i=this.el,n=this.dom,a=i.offset(),s=a.left-e-this.get_indicator_size(),o=a.top+(i.outerHeight()-n.outerHeight())/2;return this.dom.attr("data-tip-indicator-pos","right"),this.checkpos(s,o,e,t)},pos_right:function(e,t){var i=this.el,n=this.dom,a=i.offset(),s=a.left+i.outerWidth()+this.get_indicator_size(),o=a.top+(i.outerHeight()-n.outerHeight())/2;return this.dom.attr("data-tip-indicator-pos","left"),this.checkpos(s,o,e,t)},checkpos:function(e,t,i,n){var a=this.el,s=this.dom,o=a.offset(),r=e,l=t,d={x:r,y:l},u=$document.width()||$window.width();return e+i>u?d=i>o.left?{x:u-i-2,y:t}:this.pos_left(i,n):e<0&&(d=this.pos_right(i,n)),t+n>$(window).scrollTop()+$(window).height()?d=this.pos_top(i,n):t<$(window).scrollTop()&&(d=this.pos_bottom(i,n)),s.attr({"data-tip-indicator-offset-x":e-r+"px","data-tip-indicator-offset-y":t-l+"px"}),d},trigger_by_el:function(e){var t=e.data("tip");e.data("tip-filtered")||(this.filters.forEach(function(e){t=e(t)||t}),e.data({tip:t,"tip-filtered":!0})),this.show(t,e,e.data("tip-position"))}},_p.el.tip={init:function(){return!_p.el.tip.isInit&&($body.on("mouseenter._tip","[data-tip]",function(){$body_preventMouseover||_p.tip.trigger_by_el($(this))}).on("mouseleave._tip","[data-tip]",function(){_p.tip.hide()}).on("click._tip","[data-tip]",function(){_p.tip.hide(!0)}).on("tipshow._tip","[data-tip]",function(){_p.tip.trigger_by_el($(this))}).on("tiphide._tip","[data-tip]",function(){_p.tip.hide()}),void(_p.el.tip.isInit=!0))}},_p.el.links={is_init:!1,click:function(e,t){e.attr("href");if(e.hasClass("disabled"))return t&&(t.preventDefault(),t.stopImmediatePropagation(),t.stopPropagation()),!1},init:function(e){_p.el.links.is_init||($body.on("click.link_delegate","a",function(e){var t=$(this),i=t.attr("target");return"undefined"!=typeof node&&(this.hostname!=window.location.hostname&&(i="_external"),"_external"==i||"_blank"==i)?(node.gui.Shell.openExternal(t.attr("href")),e.preventDefault(),!0):void _p.el.links.click(t,e)}),_p.el.links.is_init=!0)}},_p.el.form={init_el:function(e){return!!e.data("is_init_form_el")||(e.find("textarea").on({"keyup.ctrl_enter_submit":function(t){var i=window.event?t.keyCode:t.which;switch(i=i.toString()){case"13":(t.metaKey||t.ctrlKey)&&e.submit()}}}),void e.data("is_init_form_el",!0))},init:function(e,t){e=e||$body,t=t||e.find("form"),t.each(function(){_p.el.form.init_el($(this))})}},_p.el.flexgrid={create:function(){var e=$('<div class="flexgrid"/>');return _p.el.flexgrid.init_el(e),e},init_el:function(e){if(e.data("is_init_flexgrid"))return!0;if(!e.data("append_before_this")){e.data("append_before_this",$('<div class="unit"/>').appendTo(e));for(var t=0;t<9;)$('<div class="unit"/>').appendTo(e),t++}e.data("is_init_flexgrid",!0)},init:function(e,t){e=e||$body,t=t||e.find(".flexgrid"),t.each(function(){_p.el.flexgrid.init_el($(this))})}},jQuery.fn.extend({appendDOM:function(e){return"function"==typeof e&&(e=e()),e&&e.insertBefore(this.data("append_before_this")),this}}),$document.ready(function(){$body=$("body");for(var e in _g.func_first)_g.func_first[e]();_g.init();for(var e in _g.func_last)_g.func_last[e]()});var Ship=KC.Ship,Equipment=KC.Equipment,Entity=KC.Entity,Consumable=KC.Consumable,Formula=KC.formula;_g.animate_duration_delay=320,_g.inputIndex=0,_g.lang=KC.lang,_g.joint=KC.joint,_g.defaultHqLv=90,_g.shipMaxLv=Ship.lvlMax,_g.resourcesTable=["fuel","ammo","steel","bauxite"],_g.isNWjs="undefined"!=typeof node||"undefined"!=typeof nw,_g.isWebApp=navigator.standalone||"web_app_manifest"==_g.uriSearch("utm_source"),_g.isUWP="undefined"!=typeof Windows&&"undefined"!=typeof Windows.UI&&"undefined"!=typeof Windows.UI.Notifications,_g.isClient=_g.isNWjs||_g.isWebApp||_g.isUWP,_g.updateDefaultHqLv=function(e){e=parseInt(e)||_g.defaultHqLv,e<=0&&(e=_g.defaultHqLv),e!=Lockr.get("hqLvDefault",_g.defaultHqLv)&&(Lockr.set("hqLvDefault",e),clearTimeout(_g.delay_updateDefaultHqLv),_g.delay_updateDefaultHqLv=setTimeout(function(){$body.trigger("update_defaultHqLv",[e]),clearTimeout(_g.delay_updateDefaultHqLv),_g.delay_updateDefaultHqLv=null},200))},_g.statSpeed=KC.statSpeed,_g.statRange=KC.statRange,_g.textRank=KC.textRank,_g.getStatSpeed=KC.getStatSpeed,_g.getStatRange=KC.getStatRange,_g.getStatSpeedNumber=function(e){for(var t in _g.statSpeed)if(_g.statSpeed[t]==e)return t;return-1},_g.getSize=function(e,t){function i(e){return Math.floor(100*e)/100}return t=t.toUpperCase(),"B"==t[t.length-1]&&(t=t.substr(0,t.length-1)),e/=1024,"K"==t?i(e)+"KB":(e/=1024,"M"==t?i(e)+"MB":(e/=1024,"G"==t?i(e)+"GB":(e/=1024,"T"==t?i(e)+"TB":void 0)))};var _l={},Support={};Support._webp=function(){var e=document.createElement("canvas");return!(!e.getContext||!e.getContext("2d"))&&0==e.toDataURL("image/webp").indexOf("data:image/webp")},Support.webp=!!_g.isClient||Support._webp(),_g.imgExt=Support.webp?"webp":"png",String.prototype.printf=function(){return"undefined"!=typeof vsprintf?vsprintf(this,Array.prototype.slice.call(arguments)):this},_g.badge=function(e,t){switch("string"==typeof t&&(t=t.toLowerCase()),t){case"error":return _g.badgeError(e);default:return _g.badgeMsg(e)}},_g.badgeMsg=function(e){_frame.dom.layout.attr("data-msgbadge",e),clearTimeout(this.timeout_badgeMsg_hiding),this.timeout_badgeMsg_hiding=setTimeout(function(){_frame.dom.layout.removeAttr("data-msgbadge"),delete _g.timeout_badgeMsg_hiding},3e3)},_g.badgeError=function(e){_frame.dom.layout.attr("data-errorbadge",e),clearTimeout(this.timeout_badgeError_hiding),this.timeout_badgeError_hiding=setTimeout(function(){_frame.dom.layout.removeAttr("data-errorbadge"),delete _g.timeout_badgeError_hiding},3e3)},_g.pageChangeBefore=function(){_frame.dom.mobilemenu.prop("checked",!1),_frame.modal.hide()},_g.title=function(e){if(!e){var t=document.title.split(" - ");return 1==t.length?t[0]:(t.pop(),t.join(" - "))}return _frame.dom.title&&_frame.dom.title.text(e===!0?"是谁呼叫舰队":e),e},_g.index={ships:{},equipments:{}},_g.buildIndex=function(){function e(e,i){for(var n in e){var a="ships"==i?e[n].getSeriesData().map(function(e){return e.id}):[e[n].id];a.push&&0==a.length&&(a=[e[n].id]);for(var s in e[n].name)if(e[n].name[s]){var o=e[n].name[s];"suffix"!=s?!function(){var t=o.toLowerCase();_g.index[i][t]||(_g.index[i][t]=[]),a.forEach(function(n){_g.index[i][t].some(function(e){return e.id==n})||_g.index[i][t].push(e[n])})}():"ships"==i&&(t[o]||(t[o]=[]),t[o].push(e[n]))}}}var t={};e(_g.data.ships,"ships"),e(_g.data.items,"equipments");var i=function(e){var i=_g.data.ship_namesuffix[e],n=["ja_jp","ja_romaji","zh_cn"];n.forEach(function(e){_g.index.ships[i[e]]=t[i.id]})};for(var n in _g.data.ship_namesuffix)i(n)},_g.search=function(e,t){function i(e){n=n.concat(e.filter(function(e){return!(a.indexOf(t+e.id)>-1)&&(a.push(t+e.id),!0)}))}t=_g.index[t];var n=[],a=[];if(!t||!e)return n;e=e.trim().toLowerCase(),t[e]&&i(t[e]);for(var s in t)e!==s&&s.indexOf(e)>-1&&i(t[s]);return n},_g.searchTest=function(e,t){var i=[];e=_g.search(e,t);for(var n in e)i.push(e[n]._name||e[n].name[_g.lang]);return i};var _ga={counter:function(e,t,i){return!!debugmode||(this.init_count?void("undefined"!=typeof ga&&ga("send","pageview",{location:location.href,page:location.pathname})):void(this.init_count=!0))}};_g.kancolle_calc={version:4,max_fleets:4,max_ships_per_fleet:6,max_equipments_per_ship:4,decode:function(e,t){if(e&&("string"==typeof e&&(e=JSON.parse(e)),"object"==("undefined"==typeof e?"undefined":_typeof(e)))){t=parseInt(e.version)||this.version;var i=void 0,n=0,a=0,s=0,o=void 0,r=void 0,l=void 0,d=4,u=6;switch(t){case 3:for(i=[],n=0;n<d;){if(o=e["f"+(n+1)],i[n]=[],o)for(a=0;a<u;){if(r=o["s"+(a+1)],r&&r.id){if(i[n][a]=[r.id,[r.lv||null,r.luck||-1],[],[],[]],r.items)for(s=0;s<_g.kancolle_calc.max_equipments_per_ship;)l=r.items["i"+(s+1)],l&&l.id?(i[n][a][2][s]=l.id,i[n][a][3][s]=l.rf||null,i[n][a][4][s]=l.rp||null):(i[n][a][2][s]=null,i[n][a][3][s]=null,i[n][a][4][s]=null),s++}else i[n][a]=null;a++}n++}var c=e.fField;if(c)for(i[4]=[],a=0;a<3;){i[4][a]=[];var h=c["f"+(a+1)]||{};for(s=0;s<4;){i[4][a][s]=[];var m=h["i"+(s+1)];m&&(i[4][a][s][0]=m.id,i[4][a][s][1]=m.rp,i[4][a][s][2]=m.rf),s++}a++}break;case 4:for(i=[],n=0;n<d;){o=e["f"+(n+1)];var p=i[n]=[];if(o)for(a=0;a<u;){if(r=o["s"+(a+1)],r&&r.id){var f=_g.data.ships[r.id],_=p[a]=[r.id,[r.lv||null,r.luck||-1],[],[],[]];if(r.items){s=0;for(var g=r.items.ix;s<_g.kancolle_calc.max_equipments_per_ship;)l=r.items["i"+(s+1)],l&&l.id?s+1>f.slot.length?(g=l,_[2][s]=null,_[3][s]=null,_[4][s]=null):(_[2][s]=l.id,_[3][s]=l.rf||null,_[4][s]=l.mas||null):(_[2][s]=null,_[3][s]=null,_[4][s]=null),s++;g&&g.id&&(_[2][4]=g.id,_[3][4]=g.rf||null,_[4][4]=g.mas||null)}}else p[a]=null;a++}n++}var c=e.fField;if(c)for(i[4]=[],a=0;a<3;){i[4][a]=[];var h=c["f"+(a+1)]||{};for(s=0;s<4;){i[4][a][s]=[];var m=h["i"+(s+1)];m&&(i[4][a][s][0]=m.id,i[4][a][s][1]=m.mas,i[4][a][s][2]=m.rf),s++}a++}}return i}},encode:function(e,t){if(e&&(e.length&&e.push||(e=JSON.parse(e)),e.length&&e.push)){t=parseInt(t)||this.version;var i=void 0,n=this.max_fleets,a=void 0;switch(t){case 3:i={version:3},e.forEach(function(e,t){e&&(t<n?(i["f"+(t+1)]={},e.forEach(function(e,n){e&&e[0]&&(i["f"+(t+1)]["s"+(n+1)]={id:parseInt(e[0]),lv:parseInt(e[1][0])||null,luck:parseInt(e[1][1])||-1,items:{ix:{}}},e[2].forEach(function(a,s){a&&(i["f"+(t+1)]["s"+(n+1)].items["i"+(s+1)]={id:parseInt(a)},e[3]&&(i["f"+(t+1)]["s"+(n+1)].items["i"+(s+1)].rf=parseInt(e[3][s])||0),e[4]&&(i["f"+(t+1)]["s"+(n+1)].items["i"+(s+1)].rp=parseInt(e[4][s])||0))}))})):4==t&&(i.fField={},e.forEach(function(e,t){e&&(i.fField["f"+(t+1)]={},e.forEach(function(e,n){e&&e[0]&&(i.fField["f"+(t+1)]["i"+(n+1)]={id:e[0],rp:e[1],rf:e[2]})}))})))});break;case 4:i={version:4},e.forEach(function(e,t){if(e)if(t<n){var s=i["f"+(t+1)]={};e.forEach(function(e,t){if(e&&e[0]){var i=_g.data.ships[parseInt(e[0])],n=s["s"+(t+1)]={id:parseInt(e[0]),lv:parseInt(e[1][0])||a,luck:parseInt(e[1][1])||-1,items:{}};e[2].forEach(function(t,a){if(t){var s=4==a?i.slot.length<4?["i"+(i.slot.length+1)]:"ix":["i"+(a+1)];n.items[s]={id:parseInt(t)};var o=n.items[s];e[3]&&(o.rf=parseInt(e[3][a])||0),e[4]&&(o.mas=parseInt(e[4][a])||0)}})}})}else 4==t&&(i.fField={},e.forEach(function(e,t){e&&(i.fField["f"+(t+1)]={},e.forEach(function(e,n){e&&e[0]&&(i.fField["f"+(t+1)]["i"+(n+1)]={id:e[0],mas:e[1],rf:e[2]})}))}))})}return i}}};var _config={getFullKeyname:function(e){return"config_"+e},get:function(e){if(!localStorage)return!1;var t=localStorage[_config.getFullKeyname(e)];return"true"===t||("undefined"===t?(delete localStorage[_config.getFullKeyname(e)],null):t)},set:function(e,t){return!!localStorage&&void(null===t&&localStorage[_config.getFullKeyname(e)]?delete localStorage[_config.getFullKeyname(e)]:localStorage[_config.getFullKeyname(e)]=t)}};_frame.app_config={init:function(){return!!_frame.app_config.is_init||void(_frame.app_config.is_init=!0)}},_g.db_version="20170509",_g.bgimg_count=0,_g.event={animationend:"animationend webkitAnimationEnd",animationiteration:"animationiteration webkitAnimationIteration",transitionend:"transitionend webkitTransitionEnd mozTransitionEnd"},_g.path={db:"/!/db/",bgimg_dir:"/!/assets/images/homebg/",pics:{ships:"/!/pics-ships/",shipsExtra:"/!/pics-ships-extra/",items:"/!/pics/items/"}},KC.path.pics=_g.path.pics,_g.dbs=["ships","ship_types","ship_classes","ship_series","ship_namesuffix","items","item_types"],_g.data={ships:{},items:{}},KC.db=_g.data;var _db={fleets:new Nedb({filename:"fleets"})};Nedb.prototype.updateById=function(e,t,i){this._updateByIdQueue||(this._updateByIdQueue={},Object.defineProperty(this._updateByIdQueue,"running",{enumerable:!1,value:!1,writable:!0})),t=t||{},t._id=e,this._updateByIdQueue[e]={docReplace:t,callback:i||function(){}},this._updateById()},Nedb.prototype._updateById=function(){if(!this._updateByIdQueue||this._updateByIdQueue.running)return!1;var e=void 0;for(var t in this._updateByIdQueue)if(this._updateByIdQueue[t]){e=t;break}if(!e)return!1;var i=this._updateByIdQueue[e];this._updateByIdQueue[e]=null,delete this._updateByIdQueue[e],this._updateByIdQueue.running=!0,this.update({_id:e},i.docReplace,{},function(e,t){i.callback.call(this,e,t),this._updateByIdQueue.running=!1,this._updateById()}.bind(this))},_g.log=function(){console.log.apply(console,arguments)},_g.parseURI=function(e){e=e||location.pathname;var t=e.split("/").filter(function(e){return e});if(!t.length)return{page:"home"};if(1==t.length)return{page:t[0]};if(2==t.length){var i=t[0];switch(i){case"ships":i="ship";break;case"equipments":i="equipment";break;case"entities":i="entity";break;case"fleets":i="fleet",t[1]=_g.uriSearch("i")||"__NEW__"}return{infos:i,id:t[1]}}},_g.state2URI=function(e){if(!e||"home"==e.page)return"/";if(e.page)return"/"+e.page+"/";if(e.infos){var t=e.infos,i="";switch(t){case"ship":t="ships";break;case"equipment":t="equipments";break;case"entity":t="entities";break;case"fleet":t="fleets",i="?i="+e.id,e.id="build"}return"/"+t+"/"+e.id+"/"+i}},_g.save=function(e,t){_g.save_||(_g.save_=document.createElement("a")),_g.save_.href=e,"undefined"!=typeof _g.save_.download?_g.save_.download=t:_g.save_.target="_blank",_g.save_.click()},_g.getScriptCanvas=function(){var e=Q.defer();return $.getScript("/!/assets/lib.canvas.min.js",function(){e.resolve()}),e.promise},_g.getLink=function(e,t){return _g.state2URI({infos:e,id:t})},_g.getImg=function(e,t,i){return _g.path.pics[e]+"/"+t+"/"+i+".png"},_frame.app_main={page:{},page_dom:{},page_html:{},page_title:{},loading:["dbs","bgimgs"],functions_on_ready:[],loaded:function(e,t){_g.log(e+" loaded."),e&&this.loading.indexOf(e)>-1&&(this.loading.splice(this.loading.indexOf(e),1),this.is_loaded=!1),this.loading.length||this.is_loaded||(setTimeout(function(){!_frame.app_main.is_loaded||_frame.app_main.loading.length||$html.hasClass("app-ready")||(_frame.dom.layout.addClass("ready"),$html.addClass("app-ready"),setTimeout(function(){for(var e=0;_frame.app_main.functions_on_ready[e];)_frame.app_main.functions_on_ready[e++]()},1500))},t?300:1e3),this.window_event_bound||($window.on("popstate._global",function(e){e.originalEvent&&e.originalEvent.state?_frame.app_main.state(e.originalEvent.state):_frame.app_main.state(_g.parseURI())}).trigger("popstate._global"),this.window_event_bound=!0),this.is_loaded=!0)},pushState:function(e,t,i){history.pushState(e,t,i)},state:function(e){e.infos?_frame.infos.show_func(e.infos,e.id,null,e.infosHistoryIndex):_frame.infos.hide(),e.page&&this.load_page_func(e.page)},loading_queue:[],loading_state:{},loading_start:function(e,t,i,n,a,s){e=e||location.pathname;var o=!0;"object"==("undefined"==typeof t?"undefined":_typeof(t))?(o="undefined"==typeof t.isUrl||t.isUrl,i=t.error,n=t.successAfter,a=t.beforeSend,s=t.complete,t=t.success):t===!1&&(o=!1),a=a||function(){},t=t||function(){},n=n||function(){},i=i||function(){},s=s||function(){},this.loading_cur=e,"undefined"==typeof this.loading_state[e]||"fail"==this.loading_state[e]?("fail"!=this.loading_state[e]&&(this.loading_state[e]="loading"),this.loading_queue.push(e),_frame.dom.layout.addClass("is-loading"),o&&$.ajax({url:e,type:"get",dataType:"html",beforeSend:function(t,i){a(e,t,i)},success:function(i){var a=/\<main\>(.+)\<\/main\>/.exec(i),s=/\<title\>([^\<]+)\<\/title\>/.exec(i);s&&s.length>1&&(_frame.app_main.page_title[e]=s[1]),t(a&&a.length>1?a[1]:""),e==_frame.app_main.loading_cur&&n(a&&a.length>1?a[1]:""),_frame.app_main.loading_state[e]="complete"},error:function(t,n,a){return a=a||"",_g.log("Loading Fail: "+e+" ["+n+"] ("+a+")"),"fail"==_frame.app_main.loading_state[e]||["Bad Request","Not Found","Forbidden"].indexOf(a)>-1?_frame.app_main.loading_fail(e,n,a,i):void(_frame.app_main.loading_state[e]="fail")},complete:function(o,r){_frame.app_main.loading_complete(e),s(e,o,r),"fail"==_frame.app_main.loading_state[e]&&(console.log("retry"),e+=("/"==e.substr(e.length-1)?"":"/")+"index.html",_frame.app_main.loading_start(e,t,i,n,a,s))}})):"complete"==this.loading_state[e]&&(t(),n())},loading_complete:function(e){if(e){e==this.loading_cur&&(this.loading_cur=null);var t=this.loading_queue.indexOf(e);t>=0&&this.loading_queue.splice(t,1),this.loading_queue.length||_frame.dom.layout.removeClass("is-loading")}},loading_fail:function(e,t,i,n){if(e)return this.loading_state&&delete this.loading_state[e],_frame.dom.layout.attr("data-errorbadge",e+" 载入失败 ("+i+")"),clearTimeout(this.loading_fail_timeout_errorbadge),this.loading_fail_timeout_errorbadge=setTimeout(function(){_frame.dom.layout.removeAttr("data-errorbadge"),delete _frame.app_main.loading_fail_timeout_errorbadge},3e3),console.log(n),n(e,t,i)},load_page:function(e,t){return this.cur_page!=e&&e?(t=t||{},this.pushState({page:e},null,_g.state2URI({page:e})),void this.load_page_func(e,t)):e},load_page_func:function(e,t){function i(){return _frame.infos.hide(),t.callback_modeSelection_select||(document.title=_frame.app_main.page_title[a],_g.title(_frame.app_main.navtitle[e]||!0),_ga.counter(location.search)),_frame.app_main.cur_page==e?e:(Page.show(e),t.callback_modeSelection_select||"about"!=e&&Lockr.set("last_page",e),_g.log("LOADED: "+e),void(t.callback_modeSelection_select?_frame.app_main.page_dom[e].trigger("modeSelectionEnter",[t.callback_modeSelection_select||function(){},t.callback_modeSelection_enter||function(){}]):_frame.app_main.mode_selection_off()))}if(_g.pageChangeBefore(),_g.log("PREPARE LOADING: "+e),t=t||{},!e)return e;var n=!1;if("donate"==e&&(n=!0),this.cur_page?n=!0:this.nav.forEach(function(t){e==t.page&&(n=!0)}),!n)return e=this.nav[0].page,this.load_page(e,t),e;var a=_g.state2URI({page:e});this.page_dom[e]?i():(this.page_dom[e]=_frame.dom.main.find('.page-container[page="'+e+'"]'),this.page_dom[e].length?(Page.init(e),this.page_title[a]=document.title,i()):this.loading_start(a,{success:function(t){t&&(_frame.app_main.page_dom[e]=$(t).appendTo(_frame.dom.main),a!=location.pathname&&_frame.app_main.page_dom[e].addClass("off"),Page.init(e))},successAfter:i,error:function(){delete _frame.app_main.page_dom[e],history.back()}}))},init:function(){if(this.is_init)return!0;_frame.dom.mobilemenu=_frame.dom.layout.children("#view-mobile-menu"),_frame.dom.logo=$('<div class="logo"/>').on(_g.event.animationend,function(){_frame.dom.logo.addClass("ready-animated")}).appendTo(_frame.dom.layout),_frame.dom.nav=_frame.dom.layout.children("nav"),_frame.dom.navlinks=_frame.dom.nav.children(".pages"),_frame.dom.globaloptions=_frame.dom.nav.children("section.options").append($('<button class="show_only_bg" icon="images"/>').on("click",function(){BgImg.controlsToggle()})),_g.isClient&&(_frame.dom.btnsHistory=$('<div class="history"/>').insertBefore(_frame.dom.navlinks),_frame.dom.btnHistoryBack=$('<button class="button back" icon="arrow-set2-left"/>').on({click:function(){_frame.dom.btnHistoryForward.removeClass("disabled"),history.back()}}).appendTo(_frame.dom.btnsHistory),_frame.dom.btnHistoryForward=$('<button class="button forward disabled" icon="arrow-set2-right"/>').on("click",function(){history.forward()}).appendTo(_frame.dom.btnsHistory)),_frame.dom.main=_frame.dom.layout.children("main"),_frame.dom.title=_frame.dom.nav.children(".title").children("span"),$('<div class="nav-mask"/>').appendTo(_frame.dom.layout).on("click",function(){_frame.dom.mobilemenu.prop("checked",!1)});var e=Q.fcall(function(){});this.nav=[],this.navtitle={},e.then(function(){return _frame.dom.navs={},_frame.dom.navlinks.find("a").each(function(e,t){t=$(t);var i=_g.parseURI(t.attr("href")).page,n=t.text();_frame.app_main.nav.push({title:n,state:t.attr("mod-state"),page:i}),_frame.app_main.navtitle[i]=n,t.hasClass("button")||(t=t.parent()),_frame.dom.navs[i]=t.on("click",function(){Page.resetScroll(i)})}),_frame.app_main.nav}).then(BgImg.init).then(function(){_g.log("Preload All DBs (JSON ver.): START");var e=Q(),t=Q.defer();return _g.dbs.forEach(function(t){e=e.then(function(){var e=Q.defer();return $.ajax({url:"/!/db/"+t+".nedb?v="+_g.db_version,dataType:"text",success:function(e){e=LZString.decompressFromBase64(e);var i=e.split("\n");switch(t){default:"undefined"==typeof _g.data[t]&&(_g.data[t]={}),i.forEach(function(e){if(e){var i=JSON.parse(e);switch(t){case"ships":_g.data[t][i.id]=new Ship(i);break;case"items":_g.data[t][i.id]=new Equipment(i);break;case"entities":_g.data[t][i.id]=new Entity(i);break;default:_g.data[t][i.id]=i}}})}},complete:function(t,i){e.resolve()}}),e.promise})}),e=e["catch"](function(e){console.log(e)}).done(function(){_g.log("Preload All DBs (JSON ver.): DONE"),t.resolve()}),t.promise}).then(function(){_g.log("Preload All DBs: START");var e=[],t=[],i=0;for(var n in _db)t.push(n);return t.forEach(function(n){function a(e){_g.log("DB "+e+" DONE"),s.resolve(),i++,i>=t.length&&(_g.log("Preload All DBs: DONE"),setTimeout(function(){_frame.app_main.loaded("dbs")},100))}var s=Q.defer();_db[n].loadDatabase(function(e){e?s.reject(new Error(e)):_db[n].find({},function(e,t){e?s.reject(new Error(e)):("undefined"==typeof _g.data[n]&&(_g.data[n]={}),t.forEach(function(e){_g.data[n][e.id]=e}),a(n))})}),e.push(s.promise)}),Q.all(e)}).then(function(){var e=function(e){e.preventDefault(),_frame.app_main.load_page($(this).attr("href").substr("?page=".length))},t=function(e){e.preventDefault();var t=$(this);if(!t.attr("data-infos")){var i=/^[\?]{0,1}infos\=([^\&]+)\&id\=([^\&]+)/gi.exec(t.attr("href"));t.attr("data-infos","[["+i[1].toUpperCase()+"::"+i[2]+"]]"),_frame.infos.click(t)}},i=function(e){e.preventDefault();var t=$(this),i=_g.parseURI(t.attr("href"));i.page?_frame.app_main.load_page(i.page):i.infos&&_frame.infos.click(t.attr("data-infos","[["+i.infos.toUpperCase()+"::"+i.id+"]]"))},n=function(e){if(e.currentTarget.getAttribute("href").indexOf("//"+location.host)<0)return e.currentTarget.setAttribute("target","_blank")};return $body.on("click.global_delegate_page",'a[href^="?page="]',e).on("click.global_delegate_infos",'a[href^="?infos="]',t).on("click.global_delegate_default",'a[href^="/"]',i).on("click.global_external_links pointerdown.global_external_links",'a:not([target]):not([href^="/"]):not([href^="javascript:"])',n),!0}).then(function(){_frame.gg(_frame.dom.layout)})["catch"](function(e){_g.error(e)}).done(function(){_g.buildIndex(),_g.log("Global initialization DONE")}),this.is_init=!0}},_g.error=function(e){e instanceof Error||(e=new Error(e)),_g.badgeError(e instanceof Error?e.message:e),_g.log(e)};var debugmode=!1;_g.ship_type_order_full=[6,7,18,20,8,10,11,9,4,23,5,2,28,3,1,19,13,14,17,12,24,15,21,16,29,25,26,27];var ShareBar=function(){function e(t){return _classCallCheck(this,e),t=t||{},this.settings=$.extend(!0,{},e.defaults,t),
this.el=this.create(),this}return _createClass(e,[{key:"create",value:function(){return this.el=$('<div class="sharebar"/>'),this.settings.sites.forEach(function(t){var i=$("<a/>",{"class":"sharebar-share sharebar-site-"+t,"data-share-site":t,href:"javascript:;",target:"_self",icon:e.iconmap[t]||t}).appendTo(this.el);this.settings.modifyItem&&this.settings.modifyItem(i)}.bind(this)),this.el.on("click.sharebar-share","a[data-share-site]",function(e,t){var i=$(e.target),n=i.attr("data-share-site");i.attr({href:"http://s.jiathis.com/?webid="+n+"&url="+encodeURIComponent(this.getContent("url",location.href))+"&title="+encodeURIComponent(this.getContent("title",document.title))+"&summary="+encodeURIComponent(this.getContent("summary",$('meta[name="description"]').attr("content")))+(this.settings.uid?"&uid="+this.settings.uid:"")+(this.settings.appkey[n]?"&appkey="+this.settings.appkey[n]:"")+"&shortUrl=true",target:"_blank"})}.bind(this)),this.el}},{key:"getContent",value:function(e,t){return"function"==typeof this.settings[e]?this.settings[e](this):this.settings[e]?this.settings[e]:t}}]),e}();ShareBar.defaults={sites:["tsina","tqq","cqq","twitter","tieba"],appkey:{}},ShareBar.iconmap={tsina:"weibo",tqq:"tencent-weibo",cqq:"qq"};var duoshuoQuery={short_name:"duoshuo",sso:{login:"/?msg=loginsuccess",logout:"/?msg=logoutsuccess"}};!function(){if(!_g.isClient){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="http://static.duoshuo.com/embed.js",e.charset="UTF-8",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}}(),_tmpl.improvement=function(e,t,i,n){if("undefined"==typeof e)return!1;if("object"!=("undefined"==typeof e?"undefined":_typeof(e))&&!(e=_g.data.items[e]))return!1;t=t||0,i=i||[0],n=n||!1;var a=e.improvement[t],s=!!a.upgrade&&_g.data.items[a.upgrade[0]],o=[],r="";if(i.forEach(function(e){var t=a.req[e];t[1]&&o.mergeFrom(t[1])}),o.length){var l=[];o.forEach(function(e){l.push('<a href="?infos=ship&id='+e+'" data-infos="[[SHIP::'+e+']]" data-tip="[[SHIP::'+e+']]">'+_g.data.ships[e].getName()+"</a>")}),r="<font>"+l.join(" / ")+"</font>"}else r='<font class="no">'+(a.resource[0][0]>=0?"无秘书舰":"未知")+"要求</font>";return _tmpl["export"]('<span class="improvement">'+_tmpl.improvement__title(e,s,a.upgrade[1])+r+_tmpl.improvement__resource(a,!!s)+"</span>",n)},_tmpl.improvement_detail=function(e,t){if("undefined"==typeof e)return!1;if("object"!=("undefined"==typeof e?"undefined":_typeof(e))&&!(e=_g.data.items[e]))return!1;var i="",n=e.improvement||[];return n.forEach(function(t){var n=!!t.upgrade&&_g.data.items[t.upgrade[0]],a=this.improvement__reqdetails(t.req,t.resource[0][0]>=0);i+='<span class="improvement improvement-details">'+_tmpl.improvement__title(e,n,t.upgrade[1])+a+_tmpl.improvement__resource(t,!!n)+"</span>"},this),_tmpl["export"](i,t)},_tmpl.improvement_inEquipmentInfos=function(e,t){if("undefined"==typeof e)return!1;if("object"!=("undefined"==typeof e?"undefined":_typeof(e))&&!(e=_g.data.items[e]))return!1;var i="",n=e.improvement||[];return n.forEach(function(e){var t=!!e.upgrade&&_g.data.items[e.upgrade[0]],n=this.improvement__reqdetails(e.req,e.resource[0][0]>=0);i+='<span class="unit improvement improvement-details"><b>'+(t?'<span class="indicator true">可升级为</span><a class="equiptypeicon mod-left mod-'+t.getIconId()+'" href="?infos=equipment&id='+t.id+'" data-infos="[[EQUIPMENT::'+t.id+']]" data-tip="[[EQUIPMENT::'+t.id+']]">'+t.getName(!0)+"</a>"+(e.upgrade[1]?"<i>+"+e.upgrade[1]+"</i>":""):'<span class="indicator false">不可升级</span>')+"</b>"+n+_tmpl.improvement__resource(e,!!t)+"</span>"},this),_tmpl["export"](i,t)},_tmpl.improvement__title=function(e,t,i){var n=function(e){return e.replace(/舰本/g,"")};return'<strong><a class="equiptypeicon mod-left mod-'+e.getIconId()+'" href="?infos=equipment&id='+e.id+'" data-infos="[[EQUIPMENT::'+e.id+']]" data-tip="[[EQUIPMENT::'+e.id+']]">'+n(e.getName(!0))+"</a>"+(t?'<b></b><a class="equiptypeicon mod-left mod-'+t.getIconId()+'" href="?infos=equipment&id='+t.id+'" data-infos="[[EQUIPMENT::'+t.id+']]" data-tip="[[EQUIPMENT::'+t.id+']]">'+n(t.getName(!0))+"</a>"+(i?"<i>+"+i+"</i>":""):"")+"</strong>"},_tmpl.improvement__resource=function(e,t){function i(e){return e=parseInt(e),e<0?"?":e}var n={};n.all='<span><em>必要资源</em><i class="fuel">'+i(e.resource[0][0])+'</i><i class="ammo">'+i(e.resource[0][1])+'</i><i class="steel">'+i(e.resource[0][2])+'</i><i class="bauxite">'+i(e.resource[0][3])+"</i></span>";for(var a=1;a<4;a++){var s="";switch(a){case 1:s="★+0 ~ +6";break;case 2:s="★+6 ~ MAX";break;case 3:s="升级"}var o=e.resource[a][4]||"";if(o)if(isNaN(o)){var r=/^consumable_([0-9]+)/.exec(o);if(r&&r.length>1){var l=_g.data.consumables[r[1]]._name,d=i(e.resource[a][5]);o="<i>"+l+"<i>x"+d+"</i></i>"}}else o='<a class="equiptypeicon mod-left mod-'+_g.data.items[e.resource[a][4]].getIconId()+'" href="?infos=equipment&id='+e.resource[a][4]+'" data-infos="[[EQUIPMENT::'+e.resource[a][4]+']]" data-tip="[[EQUIPMENT::'+e.resource[a][4]+']]">'+_g.data.items[e.resource[a][4]].getName(!0)+"<i>x"+i(e.resource[a][5])+"</i></a>";n[a]="<span><em>"+s+"</em>"+(3!=a||t?'<i class="dev_mat">'+i(e.resource[a][0])+"<i>("+i(e.resource[a][1])+')</i></i><i class="imp_mat">'+i(e.resource[a][2])+"<i>("+i(e.resource[a][3])+")</i></i>"+o:'<i class="no">-</i>')+"</span>"}return"<span>"+n.all+n[1]+n[2]+n[3]+"</span>"},_tmpl.improvement__reqdetails=function(e,t){if(!e||!e.push||!e.length)return"";var i="<font>";return e.forEach(function(e){var n,a=[];i+="<b>";for(var s=0;s<7;s++){switch(s){case 0:n="日";break;case 1:n="一";break;case 2:n="二";break;case 3:n="三";break;case 4:n="四";break;case 5:n="五";break;case 6:n="六"}i+="<i"+(e[0][s]?' class="on"':"")+">"+n+"</i>"}e[1]?(e[1].forEach(function(e){a.push('<a href="?infos=ship&id='+e+'" data-infos="[[SHIP::'+e+']]" data-tip="[[SHIP::'+e+']]">'+_g.data.ships[e].getName()+"</a>")}),i+=a.join(" / ")):i+="<b>"+(t?"无秘书舰":"未知")+"要求</b>",i+="</b>"}),i+="</font>"},_tmpl.link_entity=function(e,t,i,n){if(!e)return!1;if(t&&"object"==("undefined"==typeof t?"undefined":_typeof(t)))return _tmpl.link_entity(e,t.tagName||null,t.returnHTML||null,t.count||null);if(t=t||"a",i=i||!1,n="undefined"!=typeof n&&n,"object"!=("undefined"==typeof e?"undefined":_typeof(e))){var a=parseInt(e);e=_g.data.entities[a]}else var a=e.id;return _tmpl["export"]("<"+t+("a"==t?' href="?infos=entity&id='+a+'"':"")+' class="link_entity" data-entityid="'+a+'" data-infos="[[ENTITY::'+a+']]">'+(e.picture&&e.picture.avatar?'<i style="background-image:url('+e.picture.avatar+')"></i>':"<i></i>")+"<span>"+e._name+("undefined"==typeof n?"":" <small>("+n+")</small>")+"</span></"+t+">",i)},_tmpl.link_equipment=function(e,t,i,n){if(!e)return!1;if(t&&"object"==("undefined"==typeof t?"undefined":_typeof(t)))return _tmpl.link_equipment(e,t.tagName||null,t.returnHTML||null,"undefined"==typeof t.improvementStar?null:t.improvementStar);if(t=t||"a",i=i||!1,n="undefined"==typeof n?null:n,"object"!=("undefined"==typeof e?"undefined":_typeof(e))){var a=parseInt(e);e=_g.data.items[a]}else var a=e.id;return _tmpl["export"]("<"+t+("a"==t?' href="?infos=equipment&id='+a+'"':"")+' class="link_equipment" data-equipmentid="'+a+'" data-tip-position="right" data-infos="[[EQUIPMENT::'+a+']]" data-tip="[[EQUIPMENT::'+a+']]"><i style="background-image:url(assets/images/itemicon/'+e.getIconId()+'.png)"></i><span>'+e.getName(!0)+"</span>"+(null!==n?"<em"+(n<=0?' class="zero"':"")+">+"+n+"</em>":"")+"</"+t+">",i)},_tmpl.link_ship=function(e,t,i,n,a){if(!e)return!1;if(t&&"object"==("undefined"==typeof t?"undefined":_typeof(t)))return _tmpl.link_ship(e,t.tagName||null,t.returnHTML||null,t.mode||null,t.extraIllust||null);if(t=t||"a",i=i||!1,n=n||"default","object"!=("undefined"==typeof e?"undefined":_typeof(e))){var s=parseInt(e);e=_g.data.ships[s]}else var s=e.id;var o="",r=e.getType(),l=!1;switch(n){case"names":var d=[];e.getSeriesData().forEach(function(e){var t=_g.data.ships[e.id].getNameNoSuffix();$.inArray(t,d)<0&&d.push(t)}),o=d.join(" / ");break;default:o=(r?"<small>"+r+"</small>":"")+e.getName(_g.joint)}if(a){var u=e.getSeriesData();u.forEach(function(e,t){if(l=!!(e.illust_extra&&e.illust_extra.length&&e.illust_extra[0]),!l&&e.illust_delete){var i=t?u[t-1]:null;i&&(l=!!(i.illust_extra&&i.illust_extra.length&&i.illust_extra[0]))}})}return _tmpl["export"]("<"+t+("a"==t?' href="'+_g.getLink("ships",s)+'"':"")+(' class="link_ship" data-shipid="'+s+'" data-infos="[[SHIP::'+s+']]"')+(l?' icon="hanger"':"")+">"+('<img src="'+_g.getImg("ships",s,0)+'"/>')+("<span>"+o+"</span>")+("</"+t+">"),i)},_tmpl.textlink_entity=function(e,t,i){if(!e)return!1;if(t&&"object"==("undefined"==typeof t?"undefined":_typeof(t)))return _tmpl.textlink_entity(e,t.tagName||null,t.returnHTML||null);if(t=t||"a",i=i||!1,"object"!=("undefined"==typeof e?"undefined":_typeof(e))){var n=parseInt(e);e=_g.data.entities[n]}else var n=e.id;return _tmpl["export"]("<"+t+("a"==t?' href="?infos=entity&id='+n+'"':"")+' data-entityid="'+n+'" data-infos="[[ENTITY::'+n+']]">'+e._name+"</"+t+">",i)},_tmpl.textlink_ship=function(e,t,i){if(!e)return!1;if(t&&"object"==("undefined"==typeof t?"undefined":_typeof(t)))return _tmpl.textlink_ship(e,t.tagName||null,t.returnHTML||null);if(t=t||"a",i=i||!1,"object"!=("undefined"==typeof e?"undefined":_typeof(e))){var n=parseInt(e);e=_g.data.ships[n]}else var n=e.id;var a=e.getType();return _tmpl["export"]("<"+t+("a"==t?' href="?infos=ship&id='+n+'"':"")+' data-shipid="'+n+'" data-infos="[[SHIP::'+n+']]">'+(a?"["+a+"] ":"")+e.getName(_g.joint)+"</"+t+">",i)};var Page=function(){function e(t){_classCallCheck(this,e),t.on({pageHide:function(){this.modeSelectionExit()}.bind(this)})}return _createClass(e,[{key:"modeSelectionEnter",value:function(e,t){var i=void 0;return e=e||function(){},i=function(){e(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7],arguments[8],arguments[9],arguments[10]),setTimeout(function(){this.modeSelectionExit()}.bind(this),10)}.bind(this),_frame.app_main.mode_selection_callback=i,_frame.app_main.mode_selection_on(t),i}},{key:"modeSelectionExit",value:function(){return!!_frame.dom.layout.hasClass("mode-selection")&&void _frame.app_main.mode_selection_off()}}]),e}();Page.hide=function(e){if(e=e||_frame.app_main.cur_page,"string"==typeof e)_frame.app_main.page_dom[e]&&_frame.app_main.page_dom[e].addClass("off").trigger("pageHide").detach(),_frame.dom.navs[e]&&_frame.dom.navs[e].removeClass("on");else{e.addClass("off").trigger("pageHide").detach();var t=e.attr("page");t&&_frame.dom.navs[t]&&_frame.dom.navs[t].removeClass("on")}_frame.app_main.cur_page=null},Page.show=function(e){e=e||_frame.app_main.cur_page;var t=void 0;"string"==typeof e?(_frame.app_main.page_dom[e]&&_frame.app_main.page_dom[e].appendTo(_frame.dom.main).removeClass("off").trigger("pageShow"),_frame.dom.navs[e]&&_frame.dom.navs[e].addClass("on"),t=e):(e.appendTo(_frame.dom.main).removeClass("off").trigger("pageShow"),t=e.attr("page")),_frame.app_main.cur_page&&Page.hide(_frame.app_main.cur_page),t&&(_frame.dom.navs[t]&&_frame.dom.navs[t].addClass("on"),_frame.dom.layout.attr("data-theme",t),_frame.app_main.cur_page=t)},Page.resetScroll=function(e){e=e||_frame.app_main.cur_page,"string"==typeof e&&(e=_frame.app_main.page_dom[e]),e&&e.length&&(e.attr("scrollbody",0),e.find("[scrollbody]").each(function(e,t){t.setAttribute("scrollbody",0)}))},Page.init=function(e){function t(e){e.currentTarget.setAttribute("scrollbody",e.currentTarget.scrollTop)}e=e||_frame.app_main.cur_page;var i=void 0;"string"==typeof e?(i=e,e=_frame.app_main.page_dom[e]):(e.appendTo(_frame.dom.main).removeClass("off").trigger("pageShow"),i=e.attr("page")),e&&e.length&&(i&&_frame.app_main.page[i]&&_frame.app_main.page[i].init&&_frame.app_main.page[i].init(e),_p.initDOM(e),e.find("[scrollbody]").on("scroll",t),e.on({scroll:t,"pageShow.scrollbody":function(){e.scrollTop(e.attr("scrollbody")||0),e.find("[scrollbody]").each(function(e,t){t.scrollTop=t.getAttribute("scrollbody")||0,setTimeout(function(){t.scrollTop=t.getAttribute("scrollbody")||0},10)})}}))},_frame.app_main.page.fleets={init:function(e){this.object=new(function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return e.on({pageShow:function(){this.inited&&e.children(".tablelist").data("tablelist").refresh(),this.inited=!0}}),i}return _inherits(t,e),t}(Page))(e)}},_frame.app_main.page.ships={init:function(e){this.object=new(function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.tablelist=e.find(".tablelist"),i.tablelistObj=i.tablelist.data("tablelist"),e.on({modeSelectionEnter:function(e,t){this.modeSelectionEnter(t)}.bind(i),pageShow:function(){this.tablelistObj||(this.tablelistObj=this.tablelist.data("tablelist"))}.bind(i),pageHide:function(){this.tablelistObj&&(this.tablelistObj.search(),this.tablelistObj.dom.searchInput.val(""))}.bind(i)}),i}return _inherits(t,e),t}(Page))(e)}},_frame.app_main.page.equipments={init:function(e){this.object=new(function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.tablelist=e.find(".tablelist"),i.tablelistObj=i.tablelist.data("tablelist"),e.on({modeSelectionEnter:function(e,t,i){this.modeSelectionEnter(t,i)}.bind(i),pageShow:function(){this.tablelistObj||(this.tablelistObj=this.tablelist.data("tablelist")),this.tablelistObj&&(this.tablelistObj.thead_redraw(),this.tablelistObj.apply_types())}.bind(i),pageHide:function(){TablelistEquipments.types=[],TablelistEquipments.shipId=null,this.tablelistObj&&this.tablelistObj.apply_types()}.bind(i)}),i}return _inherits(t,e),t}(Page))(e)}},_frame.app_main.page.arsenal={},_frame.app_main.page.arsenal.init=function(e){e.find(".akashi").attr({animation:Math.floor(3*Math.random()+1)}).on(_g.event.animationiteration,function(e){e.target.setAttribute("animation",Math.floor(3*Math.random()+1))}),this.elMain=e.children(".main"),this.parse_weekday(this.elMain.children(".body-weekday")),this.parse_all(this.elMain.children(".body-all")),e.find('input[type="radio"]').on("change",function(){_frame.app_main.page.arsenal.elMain.scrollTop(0)})},_frame.app_main.page.arsenal.parse_weekday=function(e){var t=e.find("#arsenal_weekday-showmeterials");t.prop("checked",!!Lockr.get("arsenal_weekday-showmeterials",!0)).on("change",function(){Lockr.set("arsenal_weekday-showmeterials",t.prop("checked")?1:0)});var i=new Date;return i.setTime(i.getTime()+60*i.getTimezoneOffset()*1e3),i.setTime(i.getTime()+324e5),e.find("#arsenal_weekday-"+i.getDay()).prop("checked",!0),e},_frame.app_main.page.arsenal.parse_all=function(e){},_frame.app_main.page.about={},_frame.app_main.page.about.journal_parse=function(e){for(var t,i=/\[\[([^\:]+)\:([0-9]+)\]\]/gi,n=markdown.toHTML(e);null!==(t=i.exec(e));)try{n=n.replace(t[0],_tmpl["link_"+t[1].toLowerCase()](t[2],null,!0))}catch(a){}for(t=null,i=/\[\[([^\:]+)\:([0-9]+)\:TEXT\]\]/gi;null!==(t=i.exec(e));)try{n=n.replace(t[0],_tmpl["textlink_"+t[1].toLowerCase()](t[2],null,!0))}catch(a){}return n},_frame.app_main.page.about.journaltitle=function(e,t){return e=e||{},t=t||"h3","<h3>"+(e.hotfix?"HOTFIX - ":"")+("app"==e.type?"":("app-db"==e.type?"DB":e.type).toUpperCase()+" / ")+e.version+"<small>"+(e.date?e.date:"WIP")+"</small></h3>"},_frame.app_main.page.about.init=function(e){function t(t){var n=new Journal(t);n.genSection(i<3).appendTo(e),i++}var i=0,n=Q.fcall(function(){});n.then(function(){var e=Q.defer();return _db.updates.find({date:""}).sort({date:-1,version:-1}).exec(function(i,n){n.forEach(function(e){t(e)}),e.resolve(i)}),e.promise}).then(function(){var e=Q.defer();return _db.updates.find({$not:{date:""}}).sort({date:-1,version:-1}).exec(function(i,n){n.forEach(function(e){t(e)}),e.resolve(i)}),e.promise})};var Journal=function(){function e(t){_classCallCheck(this,e),this.data=t}return _createClass(e,[{key:"genTitle",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"h3";return $("<"+e+">"+(this.data.hotfix?"[hotfix] ":"")+("app"==this.data.type?"":("app-db"==this.data.type?"DB":this.data.type).toUpperCase())+("app"==this.data.type?this.data.version:"")+"<small>"+(this.data.date?this.data.date:"WIP")+"</small>"+("</"+e+">"))}},{key:"genContent",value:function(){for(var e=this.data.journal,t=void 0,i=/\[\[([^\:]+)\:([0-9]+)\]\]/gi,n=markdown.toHTML(e);null!==(t=i.exec(e));)try{n=n.replace(t[0],_tmpl["link_"+t[1].toLowerCase()](t[2],null,!0))}catch(a){}for(t=null,i=/\[\[([^\:]+)\:([0-9]+)\:TEXT\]\]/gi;null!==(t=i.exec(e));)try{n=n.replace(t[0],_tmpl["textlink_"+t[1].toLowerCase()](t[2],null,!0))}catch(a){}return this.content=$(n),this.content}},{key:"genSection",value:function(e){var t=this,i="update_journal_"+this.data._id,n=$('<input type="checkbox" id="'+i+'"/>').prop("checked",!!e).on("change",function(e){e.target.checked&&t.show()});return this.section=$('<section class="update_journal" data-version-'+this.data.type+'="'+this.data.version+'"/>').append($('<label for="'+i+'"/>').append(this.genTitle())),e&&this.show(),this.section.add(n.insertBefore(this.section))}},{key:"show",value:function(){this.content||this.genContent().appendTo(this.section)}}]),e}();_frame.app_main.page.calctp={init:function(e){e.find("form.tpcalculator").each(function(e,t){t=$(t);var i=t.find(".result_a"),n=t.find(".result_s");t.on("input","input",function(){t.trigger("submit")}).on("submit",function(e){e.preventDefault();var a=t.serializeObject(),s={ship:{},equipment:{}},o=0,r=0;for(var l in a){var d=parseInt(a[l])||0;switch(l){case"e75":s.equipment[75]=d;break;case"e68":s.equipment[68]=d;break;case"e145":s.equipment[145]=d;break;case"e150":s.equipment[150]=d;break;case"e166":s.equipment[166]=d;break;case"e167":s.equipment[167]=d;break;case"e26":s.equipment[26]=d;break;case"e62":s.equipment[62]=d;break;default:s.ship[l]=d}}r=Math.floor(Formula.calc.TP(s)),o=.7*r,n.html(r),i.html(Math.floor(o))})})}},_frame.gg=function(){$.ajax({url:"http://fleet.moe/!/g/",method:"get",dataType:"html",success:function(e){_g.isOnline=!0,e&&_frame.dom.layout.append($('<div class="g"/>').html(e).append($('<button type="button" class="close"/>').on("click",function(){_frame.dom.layout.css("padding-bottom","").removeClass("mod-g")}))).addClass("mod-g")}})};var BgImg=function(){function e(t){_classCallCheck(this,e),t=t||{},$.extend(!0,this,e.defaults,t)}return _createClass(e,[{key:"show",value:function(){return e.change(this)}},{key:"save",value:function(){return e.save(this)}},{key:"append",value:function(){this.isDefault?e.controlsEls.listDefault&&this.elThumbnail.appendTo(e.controlsEls.listDefault):e.controlsEls.listCustomAdd&&this.elThumbnail.insertBefore(e.controlsEls.listCustomAdd),e.cur&&e.cur.name===this.name&&this.elThumbnail.addClass("on")}},{key:"delete",value:function(){e["delete"](this)}},{key:"filename",get:function(){return this.isDefault?this.name.substr(1):this.name}},{key:"index",get:function(){var t=-1;return e.list.some(function(e,i){return e.name===this.name&&(t=i),e.name===this.name}.bind(this)),t}},{key:"els",get:function(){return this._els||(this._els=$('<s class="bgimg"/>').css("background-image","url("+this.path+")").add($('<s class="bgimg"/>').css("background-image","url("+this.blur+")")).add($('<s class="bgimg"/>').css("background-image","url("+this.blur+")")).add($('<s class="bgimg"/>').css("background-image","url("+this.blur+")"))),this._els}},{key:"elThumbnail",get:function(){return this._elThumbnail||(this._elThumbnail=$("<dd/>").on("click",function(){e.change(this)}.bind(this)).append($("<s/>").css("background-image","url("+this.thumbnail+")")).append($("<i/>").on("click",function(e){e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),this.visible=!this.visible}.bind(this))),this.isDefault||this._elThumbnail.append($("<del/>").on("click",function(e){e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),this["delete"]()}.bind(this)))),this._elThumbnail}},{key:"path",get:function(){return this._path||(this._path=e.getPath(this)),this._path}},{key:"blur",get:function(){return this._blured||(this._blured=e.getPath(this,"blured")),this._blured}},{key:"thumbnail",get:function(){return this._thumbnail||(this._thumbnail=e.getPath(this,"thumbnail")),this._thumbnail}},{key:"visible",get:function(){return this.elThumbnail.hasClass("is-visible")},set:function(t){t?this.visible||(this.elThumbnail.addClass("is-visible"),e.listVisible.push(this),e.namesHidden.forEach(function(t,i){t===this.name&&e.namesHidden.splice(i,1)}.bind(this))):this.visible&&(this.elThumbnail.removeClass("is-visible"),e.listVisible.forEach(function(t,i){t===this&&e.listVisible.splice(i,1)}.bind(this)),e.namesHidden.push(this.name)),Lockr.set("BgImgHidden",e.namesHidden)}}]),e}();BgImg["default"]={isEnable:!0},BgImg.list=[],BgImg.listVisible=[],BgImg.countCustom=0,BgImg.init=function(){if(BgImg.isInit)return BgImg.list;_g.log("背景图: START"),BgImg.controlsInit(),_frame.dom.bgimg=$('<div class="bgimgs"/>').appendTo(_frame.dom.layout).on(_g.event.animationend,"s",function(){BgImg.changeAfter()});var e=Q.defer(),t=void 0;return BgImg.namesHidden=Lockr.get("BgImgHidden",[]),Q.fcall(BgImg.getDefaultImgs).then(function(){BgImg.list.forEach(function(e){BgImg.namesHidden.indexOf(e.name)>-1?e.visible=!1:e.visible=!0}),BgImg.ensureVisible(),BgImg.listVisible.some(function(e){return t||e.name==Lockr.get("BgImgLast","")||(t=e),e.name==Lockr.get("BgImgLast","")}),Lockr.set("BgImgLast",BgImg.listVisible[0].name),BgImg.change(t),_frame.app_main.loaded("bgimgs"),BgImg.isInit=!0,_g.log("背景图: DONE"),e.resolve()}),e.promise},BgImg.getObj=function(e){if("string"==typeof e){var t=void 0;return BgImg.list.some(function(i){return i.name===e&&(t=i),i.name===e}),t}return"number"==typeof e?BgImg.list[e]:"undefined"==typeof e?BgImg.cur:e},BgImg.change=function(e){if(BgImg.list.length){if("undefined"==typeof e){if(BgImg.ensureVisible(),e=BgImg.listVisible[_g.randInt(BgImg.listVisible.length)],BgImg.cur&&e.name===BgImg.cur.name)return 1==BgImg.listVisible.length?e:BgImg.change()}else if(e=BgImg.getObj(e),BgImg.cur&&e.name===BgImg.cur.name)return e;return BgImg.cur&&(BgImg.lastToHide=BgImg.cur,BgImg.cur.elThumbnail.removeClass("on")),e.els.addClass(BgImg.cur?"fadein":""),e.els.eq(0).appendTo(_frame.dom.bgimg),e.els.eq(1).appendTo(_frame.dom.nav),e.els.eq(2).appendTo(_frame.dom.main),e.els.eq(3).appendTo(BgImg.controlsEls.bgimgs),e.elThumbnail.addClass("on"),BgImg.cur=e,e}},BgImg.changeAfter=function(){BgImg.lastToHide&&(BgImg.lastToHide.els.detach(),delete BgImg.lastToHide)},BgImg.upload=function(){BgImg.fileSelector||(BgImg.fileSelector=$('<input type="file" class="none"/>').on("change",function(e){if(BgImg.fileSelector.val()){var t=function(){BgImg.controlsEls.body.removeClass("is-loading"),BgImg.fileSelector.prop("disabled",!1),BgImg.fileSelector.val(""),_g.log("BgImg.add() complete")},i=void 0,n=e.target.files[0].type;if(!n)return _g.badgeError("文件格式未知"),void t();if(n=n.split("/"),"image"!=n[0].toLowerCase())return _g.badgeError("请选择图片文件"),void t();if(["bmp","jpg","jpeg","png","gif","tif","tiff","webp"].indexOf(n[1].toLowerCase())<0)return _g.badgeError("当前仅支持以下格式: BMP、JPG、PNG、GIF、TIFF"),void t();Q.fcall(function(){return BgImg.controlsEls.body.addClass("is-loading"),BgImg.fileSelector.prop("disabled",!0),BgImg.readFile(e)}).then(function(e){return i=e,BgImg.list.push(i),BgImg.generate(i,"thumbnail")}).then(function(e){return BgImg.set(i,"thumbnail",e)}).then(function(){return BgImg.generate(i,"blured")}).then(function(e){return BgImg.set(i,"blured",e)}).then(function(){BgImg.countCustom||BgImg.list.forEach(function(e){e.visible&&(e.visible=!1)}),i.append(),i.show(),i.visible=!0,BgImg.countCustom++})["catch"](function(e){_g.error(e,"自定义背景图"),i&&i["delete"]()}).done(t)}})),BgImg.fileSelector.trigger("click")},BgImg.generate=function(e,t){function i(e){n.reject("读取图片文件发生错误")}e=BgImg.getObj(e);var n=Q.defer(),a=void 0;switch(t){case"thumbnail":a=$("<img/>",{src:e.path}).on({load:function(){var e=canvas.downScale(a[0],150/Math.min(a[0].width,a[0].height));a.remove(),n.resolve(e)},error:i}).appendTo($body);break;case"blured":a=$("<img/>",{src:e.path}).on({load:function(){var e=$("<canvas/>");canvas.blur.image(a[0],e[0],20*Math.min(a[0].width,a[0].height)/1080),a.remove(),n.resolve(e[0])},error:i}).appendTo($body)}return n.promise},BgImg.getUniqueName=function(e){var t=void 0,i=1,n=e;for("number"==typeof e&&(e=""+e);t=BgImg.getObj(n);){n=e.split(".");var a=n.pop();n=n.join(".")+"-"+i++ +"."+a}return n},BgImg.ensureVisible=function(){BgImg.listVisible.length||BgImg.list.forEach(function(e){(BgImg.countCustom&&!e.isDefault||!BgImg.countCustom&&e.isDefault)&&(e.visible=!0)})},BgImg.controlsInit=function(){return BgImg.controlsEls?BgImg.controlsEls.container:(BgImg.controlsEls={},BgImg.controlsEls.body=$('<div class="bgcontrols"/>').appendTo(_frame.dom.layout).on(_g.event.animationend,function(e){e.currentTarget==e.target&&(BgImg.controlsShowing?BgImg.controlsHideAfter():BgImg.controlsShowAfter())}).append(BgImg.controlsEls.container=$('<div class="wrapper"/>').append(BgImg.controlsEls.bgimgs=$('<div class="bgimgs"/>'))),BgImg.controlsEls.container)},BgImg.controlsShow=function(){BgImg.controlsEls&&!BgImg.controlsShowing&&(BgImg.controlsEls.listDefault||($('<div class="controls"/>').appendTo(BgImg.controlsEls.container).append(BgImg.controlsEls.btnViewingToggle=$('<button icon="eye"/>').on("click",BgImg.controlsViewingToggle)).append($('<button icon="floppy-disk"/>').on("click",function(){BgImg.save()})).append($('<button icon="arrow-set2-right"/>').on("click",BgImg.controlsHide)),$('<div class="list"/>').appendTo(BgImg.controlsEls.container).append($("<dl/>",{"class":"notes",html:"勾选的图片将会出现在背景图随机队列中"})).append(BgImg.controlsEls.listCustom=$("<dl/>",{html:"<dt>自定义</dt>"}).prepend(function(){if(BgImg.quota)return $("<small/>").append(BgImg.controlsEls.listCustomQuotaUsed=$("<span>"+_g.getSize(BgImg.quotaUsed,"m")+"</span>")).append(" / <span>"+_g.getSize(BgImg.quota,"m")+"</span>")}).append(BgImg.controlsEls.listCustomAdd=$("<dd/>",{"class":"add",html:"<s></s>"}).on("click",function(){BgImg.upload()}))).append(BgImg.controlsEls.listDefault=$("<dl/>",{html:"<dt></dt>"})),BgImg.list.forEach(function(e){e.append()})),_frame.dom.layout.addClass("mod-bgcontrols"))},BgImg.controlsShowAfter=function(){BgImg.controlsEls&&!BgImg.controlsShowing&&(BgImg.controlsEls.body.addClass("is-on"),BgImg.controlsShowing=!0)},BgImg.controlsHide=function(){BgImg.controlsEls&&BgImg.controlsShowing&&BgImg.controlsEls.body.addClass("is-hiding")},BgImg.controlsHideAfter=function(){BgImg.controlsEls&&BgImg.controlsShowing&&(_frame.dom.layout.removeClass("mod-bgcontrols"),BgImg.controlsEls.body.removeClass("is-on is-hiding"),BgImg.controlsShowing=!1)},BgImg.controlsToggle=function(){return BgImg.controlsShowing?BgImg.controlsHide():BgImg.controlsShow()},BgImg.controlsViewingToggle=function(){BgImg.controlsEls.body.toggleClass("mod-viewing"),BgImg.controlsEls.btnViewingToggle.toggleClass("on")},BgImg.quota=10485760,BgImg.quotaUsed=0,BgImg.getDefaultImgs=function(){for(var e=Q.defer(),t=_g.bgimg_count-1;t>=0;t--)BgImg.list.push(new BgImg({name:"*"+t+".jpg",isDefault:!0}));return BgImg.dataCustom={},localforage.getItem("bgcustomlist",function(t,i){BgImg.dataCustom=i||{};for(var n in BgImg.dataCustom){var a=BgImg.dataCustom[n];a.name=n,BgImg.list.push(new BgImg(a)),BgImg.countCustom++,BgImg.quotaUsed+=a.size}BgImg.updateQuotaUsed(),e.resolve(BgImg.list)}),e.promise},BgImg.updateQuotaUsed=function(){BgImg.controlsEls.listCustomQuotaUsed&&BgImg.controlsEls.listCustomQuotaUsed.html(_g.getSize(BgImg.quotaUsed,"m"))},BgImg.getPath=function(e,t){return e=BgImg.getObj(e),e.isDefault?_g.path.bgimg_dir+(t?t+"/":"")+e.filename:t?e["_"+t]:e._path},BgImg.save=function(e){e=BgImg.getObj(e),_g.save(e.path,"fleet.moe - "+e.filename)},BgImg.readFile=function(e){var t=Q.defer();return Q.fcall(_g.getScriptCanvas).then(function(){for(var i,n=0;i=e.target.files[n];n++){if(BgImg.quotaUsed+i.size>BgImg.quota){t.reject("已超过 "+_g.getSize(BgImg.quota,"m")+" 上限");break}var a=new FileReader;a.onload=function(e){return function(i){var n=BgImg.getUniqueName(e.name);BgImg.quotaUsed+=e.size,BgImg.updateQuotaUsed(),BgImg.dataCustom[n]={_path:i.target.result,size:e.size},localforage.setItem("bgcustomlist",BgImg.dataCustom,function(a,s){t.resolve(new BgImg({name:n,_path:i.target.result,size:e.size}))})}}(i),a.readAsDataURL(i)}}),t.promise},BgImg.set=function(e,t,i){e=BgImg.getObj(e);var n=i.toDataURL("image/jpeg","blured"==t?.4:.6),a=Q.defer();return e["_"+t]=n,BgImg.dataCustom[e.name]["_"+t]=n,localforage.setItem("bgcustomlist",BgImg.dataCustom,function(e,t){a.resolve()}),a.promise},BgImg["delete"]=function(e){e=BgImg.getObj(e);var t=Q.defer();return e.elThumbnail.remove(),e.els.remove(),BgImg.listVisible.forEach(function(t,i){t===e&&BgImg.listVisible.splice(i,1)}),BgImg.namesHidden.forEach(function(t,i){t===e.name&&BgImg.namesHidden.splice(i,1)}),Lockr.set("BgImgHidden",BgImg.namesHidden),delete BgImg.dataCustom[e.name],localforage.setItem("bgcustomlist",BgImg.dataCustom,function(i,n){BgImg.countCustom--,BgImg.quotaUsed-=e.size,BgImg.updateQuotaUsed(),BgImg.list.forEach(function(t,i){t===e&&BgImg.list.splice(i,1)}),BgImg.cur===e&&BgImg.change(),t.resolve()}),t.promise},_frame.infos={historyLength:-1,historyCurrent:-1,contentCache:{},getContent:function(e,t,i){function n(e){return i&&i(e),e}function a(i){return"fleet"==e&&(i=_frame.infos["__"+e](t,i)),_p.initDOM(i.addClass("infosbody").attr({"data-infos-type":e,"data-infos-id":t}))}if(this.contentCache[e]||(this.contentCache[e]={}),!this.firstrun){var s=this.dom.container.children(".infosbody").eq(0);if(this.firstrun=!0,s.attr("data-infos-type")==e&&s.attr("data-infos-id")==t)return this.contentCache[e][t]=_p.initDOM(s),_frame.app_main.page_title[_g.state2URI({infos:e,id:t})]=document.title,n(this.contentCache[e][t]);s.attr("data-infos-type")==e&&s.remove()}return"__NEW__"==t?n(a(this["__"+e](t))):this.contentCache[e][t]?n(this.contentCache[e][t]):void _frame.app_main.loading_start(_g.state2URI({infos:e,id:t}),{success:function(i){if(i){var n=/\<div class\=\"wrapper\"\>(.+)\<\/div\>/.exec(i);_frame.infos.contentCache[e][t]=a($(n.length>1?n[1]:""))}},successAfter:function(){return n(_frame.infos.contentCache[e][t])},error:function(){"undefined"!=typeof _frame.infos.contentCache[e][t]&&delete _frame.infos.contentCache[e][t],history.back()}})},show:function(e,t,i){var n=/^\[\[([^\:]+)\:\:(.+)\]\]$/.exec(e),a=null,s=null;if(!(n&&n.length>2))return!1;switch(a=n[1].toLowerCase(),s=isNaN(n[2])?n[2]:parseInt(n[2]),a){case"item":case"equip":case"equipments":a="equipment"}return this.curContent==a+"::"+s?this.dom.container.children("div:first-child"):(i||(this.historyCurrent++,this.historyLength=this.historyCurrent,_frame.app_main.pushState({infos:a,id:s,infosHistoryIndex:this.historyCurrent},null,_g.state2URI({infos:a,id:s}))),void this.show_func(a,s,i))},show_func:function(e,t,i,n){return!(!e||!t)&&(_g.pageChangeBefore(),this.curContent==e+"::"+t?this.dom.container.children("div:first-child"):(e=e.toLowerCase(),isNaN(t)||(t=parseInt(t)),this.dom||(this.dom={main:_frame.dom.main.children(".page-container.infos")},this.dom.main.length?this.dom.container=this.dom.main.children(".wrapper"):(this.dom.main=$('<div class="page-container infos"/>').appendTo(_frame.dom.main),this.dom.container=$('<div class="wrapper"/>').appendTo(this.dom.main)),this.dom.main.on(eventName("transitionend","infos_hide"),function(e){e.currentTarget==e.target&&"opacity"==e.originalEvent.propertyName&&0==_frame.infos.dom.main.css("opacity")&&_frame.infos.hide_finish()}),_frame.dom.btnHistoryBack&&_frame.dom.btnHistoryBack.on(eventName("transitionend","infos_hide"),function(e){e.currentTarget==e.target&&"opacity"==e.originalEvent.propertyName&&0==_frame.dom.btnHistoryBack.css("opacity")&&_frame.infos.hide_finish();
})),_frame.dom.layout.addClass("is-infos-show"),this.curContent=e+"::"+t,void this.getContent(e,t,function(i){switch(this.dom.container.children().not(i).each(function(e,t){var i=$(t);0==i.css("opacity")&&i.trigger("hidden")}),e){case"ship":case"equipment":case"entity":this.dom.main.attr("data-infostype",e);break;case"fleet":this.dom.main.attr("data-infostype","fleet"),TablelistEquipments.types=[]}switch(e){case"ship":_g.title(_frame.app_main.navtitle.ships);break;case"equipment":_g.title(_frame.app_main.navtitle.equipments);break;case"entity":_g.title(_frame.app_main.navtitle.entities);break;case"fleet":_g.title(_frame.app_main.navtitle.fleets)}var n=!i.data("is_infosinit");if(!i.data("is_infosinit")){if("ship"==e){var a=parseInt(_config.get("ship_infos_lvl")||99);i.find('input[type="radio"][name^="ship_infos_lvl_"]').each(function(){var e=$(this),t=e.val();e.prop("checked",a==t).on("change",function(){_config.set("ship_infos_lvl",t)})})}_frame.infos["__"+e+"_init"]&&_frame.infos["__"+e+"_init"](i),i.data("is_infosinit",!0).on("hidden",function(){i.detach().data("is_show",!1)}).on(eventName("transitionend","hide"),function(n){n.currentTarget==n.target&&"opacity"==n.originalEvent.propertyName&&0==i.css("opacity")&&i.data("is_show")&&(_frame.infos.curContent==e+"::"+t?i.prependTo(_frame.infos.dom.container):i.trigger("hidden"))})}this.curContent==e+"::"+t&&(i.prependTo(this.dom.container).trigger("show",[n]).data("is_show",!0),this.dom.main.scrollTop(0),_frame.app_main.cur_page&&Page.hide(_frame.app_main.cur_page),_frame.dom.main.attr("data-theme",i.attr("data-theme")||e),_frame.dom.layout.attr("data-theme",i.attr("data-theme")||e),setTimeout(function(){_frame.dom.layout.addClass("is-infos-on"),document.title=_frame.app_main.page_title[_g.state2URI({infos:e,id:t})],_ga.counter(location.search)},1))}.bind(this))))},hide:function(){return!(!this.dom||!this.curContent)&&(_frame.dom.layout.removeClass("is-infos-on"),void(this.curContent=null))},hide_finish:function(){return!this.curContent&&(this.dom.container.children().trigger("hidden"),_frame.dom.layout.removeClass("is-infos-show"),this.dom.main.attr({"data-infostype":"","data-theme":""}),this.historyLength=-1,void(this.historyCurrent=-1))},click:function(e){this.show(e.attr("data-infos"),e,e.attr("data-infos-nohistory"))},init:function(){return!!this.is_init||($body.on("click._infos","[data-infos]",function(e){"input"==e.target.tagName.toLowerCase()&&"compare"==e.target.className||(_frame.infos.click($(this)),"a"==e.target.tagName.toLowerCase()&&e.preventDefault())}),this.is_init=!0,!0)}},_frame.infos.__equipment_init=function(e){function t(e){return modal.equipable.show(e.currentTarget.getAttribute("data-equipment-type"))}e.on("click.equipable","button[data-equipment-type]",t)},_frame.infos.__ship_init=function(e){function t(){E=parseInt(x.filter(":checked").val())-1,B=Math.ceil(x.length/T.filter(":visible").length),F=k.hasClass("is-singlelast")&&2==B?1:0}function i(){E=0,B=0,F=0}function n(){c=I.scrollLeft(),S=I.width(),t()}function a(){c>=0&&(u=I.scrollLeft(),g||requestAnimationFrame(s),g=!0)}function s(){var e=u-c,t=(Math.floor(Math.abs(e)/S)+(Math.abs(e%S)>S/2?1:0))*(u<c?-1:1);if(g=!1,0!==e){var i=E+t*B;i<0&&(i=0),i+B>x.length+F&&(i=x.length-B),x.eq(i).prop("checked",!0)}}function o(){c=-1,x.filter(":checked").trigger("change",0),v&&n()}function r(e){$window.on("resized."+C,o),o()}function l(){$window.off("resized."+C)}function d(e,a){if(e&&!b){var s=-10;t(),1==e?s=E+B:e==-1&&(s=E-1),s<0&&s>-10?s=a?x.length-B:0:s+B>x.length+F&&(s=a?0:x.length-B),i(),s>=0&&(v&&n(),x.eq(s).prop("checked",!0).trigger("change"))}}var u=void 0,c=-1,h=void 0,m=void 0,p=void 0,f=void 0,_=void 0,g=!1,v=_huCss.csscheck_full("scroll-snap-type")&&!bFirefox,b=!1,y=!1,k=e.find(".illustrations"),I=k.find(".body"),w=I.children("span"),C="e"+_g.timeNow(),T=k.children("label"),x=k.children('input[type="radio"]').on("change",function(e,t){var i=parseInt(e.target.getAttribute("value"))-1;T.eq(i).is(":visible")||(i--,x.eq(i).prop("checked",!0)),v&&!b&&(b=!0,I.off("scroll").animate({scrollLeft:w.eq(i)[0].offsetLeft},"undefined"==typeof t?200:t,function(){setTimeout(function(){b=!1,I.on("scroll",a)},50)}))}),S=0,E=0,B=1,F=0;if(e.on({show:r,hidden:l}),v)k.addClass("mod-scroll-snap"),I.on({scroll:a,pointerdown:function(e){c<0&&"touch"==e.originalEvent.pointerType&&n()},touchstart:function(){c<0&&n()}});else{var q=function(){I.css("transform","").removeClass("is-panning"),c=0,h=0,m=0,f=0,_=0,i(),j=!1,$(document).off("touchmove.infosShipIllust touchend.infosShipIllust touchcancel.infosShipIllust")},A=function(){g=!1;var e=E<=0&&f>0||E>=x.length-B&&f<0;I.css("transform","translateX("+(f*(e?.3333:1)+c)+"px)")},O=function(){g||requestAnimationFrame(A),g=!0},P=function(e){if(!g&&(h||m)&&1==e.originalEvent.targetTouches.length)if(f=e.originalEvent.targetTouches[0].clientX-h,j)O();else{_=e.originalEvent.targetTouches[0].clientY-m;var t=Math.abs(f),i=Math.abs(_);t<20&&i<20||t>i?(e.preventDefault(),t>i&&(j=!0,I.addClass("is-panning"),O())):q()}},M=function(e){requestAnimationFrame(function(){if(f&&(Math.abs(f)>S/3||_g.timeNow()-p<300)){var e=void 0;f<0&&E<x.length-1?e=E+B:f>0&&E>0&&(e=E-1),e<0&&(e=0),e+B>x.length+F&&(e=x.length-B),x.eq(e).prop("checked",!0).trigger("change")}q()})},j=!1;k.on({touchstart:function(e){if(e.originalEvent.targetTouches&&1==e.originalEvent.targetTouches.length){var i=I.css("transform").replace(/[^0-9\-.,]/g,"").split(",");c=parseInt(i[12]||i[4]||0),h=e.originalEvent.targetTouches[0].clientX,m=e.originalEvent.targetTouches[0].clientY,p=_g.timeNow(),t(),S=I.width(),$(document).on({"touchmove.infosShipIllust":P,"touchend.infosShipIllust":M,"touchcancel.infosShipIllust":M})}},touchmove:function(e){j&&e.preventDefault()}})}k.on("mousewheel",function(t){if(!(y||b||e.get(0).scrollHeight>e.get(0).clientHeight)){var i=void 0;v&&t.originalEvent.deltaY?i=t.originalEvent.deltaY<0?-1:1:t.originalEvent.wheelDelta?i=t.originalEvent.wheelDelta>0?-1:1:t.originalEvent.deltaX?i=t.originalEvent.deltaX<0?-1:1:t.originalEvent.deltaY&&(i=t.originalEvent.deltaY<0?-1:1),i&&(y=!0,d(i),setTimeout(function(){y=!1},100))}}),$('<button class="arrow prev" icon="arrow-left"/>').on("click",function(){d(-1,!0)}).insertBefore(x.eq(0)),$('<button class="arrow next" icon="arrow-right"/>').on("click",function(){d(1,!0)}).insertAfter(T.eq(T.length-1))},_frame.infos.__fleet=function(e,t,i){var n=new InfosFleet(e,t,i),a=n.el.on({show:function(){InfosFleet.cur=n},hide:function(){InfosFleet.cur=null}});return a};var InfosFleetEditableTitle=function e(t){_classCallCheck(this,e);var i=$.extend(!0,{},e.defaults,t),n=$("<"+i.tagName+"/>",{contenteditable:!0,"class":"title-editable "+i.className,html:i.placeholder}).on({input:function(){n.trigger("namechange")},focus:function(){n.text()==i.placeholder&&n.html("")},blur:function(){n.text()||n.html(i.placeholder)},namechange:function(e,t){return"undefined"==typeof t&&(t=n.text()),t!=n.html()&&n.html(t),i.onUpdate(t),t?n.attr("data-content",t):n.removeAttr("data-content"),n},keydown:function(e){13==e.keyCode&&(n.blur(),setTimeout(function(){n.blur()},1)),setTimeout(function(){!n.text()&&i.targetObj&&(i.onUpdate(content),n.removeAttr("data-content"))},100)}});this.options=i,this.$el=n,this.el=n[0]};InfosFleetEditableTitle.defaults={tagName:"span",className:"",placeholder:"点击编辑",onUpdate:function(e){}};var InfosFleet=function(){function e(t,i,n){_classCallCheck(this,e),this.el=i||$("<div/>"),this.el.addClass("infos-fleet infosbody loading").attr({"data-infos-type":"fleet","data-infos-title":"舰队 ("+t+")"}),this.doms={},this.fleets=[],this.tip_hqlv_input="输入 0 表示采用默认等级 (Lv.%1$d)",n?this.init(n):"__NEW__"==t?_db.fleets.insert(_tablelist.prototype._fleets_new_data(),function(e,t){e?_g.error(e):"fleet::__NEW__"==_frame.infos.curContent&&_frame.infos.show("[[FLEET::"+t._id+"]]")}.bind(this)):_db.fleets.find({_id:t},function(e,n){if(e||!n)_g.error(e);else if(_frame.infos.curContent=="fleet::"+t)if(n.length)this.init(n[0]);else try{this._infos_state_id=t,this.init(TablelistFleets.prototype.new_data(JSON.parse(LZString.decompressFromEncodedURIComponent(_g.uriSearch("d")))))}catch(a){_g.error(a)}else i.remove(),delete _frame.infos.contentCache.fleet[t]}.bind(this)),e.cur=this}return _createClass(e,[{key:"init",value:function(t){var i=this;if(!t)return!1;this.el.on({show:function(e,t){if(this.is_showing=!0,InfosFleetShipEquipment.cur&&InfosFleetShipEquipment.cur.trigger("blur"),!t){for(var i=0,n=Lockr.get("hqLvDefault",_g.defaultHqLv);i<4;)this.fleets[i].summaryCalc(!0),i++;this._hqlv||this.doms.hqlvOption.val(n),this.doms.hqlvOptionLabel.data("tip",this.tip_hqlv_input.printf(n)),this.doms.hqlvOption.attr("placeholder",n)}this.is_init&&this.updateURI()}.bind(this),hidden:function(){this.is_showing=!1,InfosFleetShipEquipment.cur&&InfosFleetShipEquipment.cur.trigger("blur")}}).on("focus.number_input_select",'input[type="number"]:not([readonly])',function(e){e.currentTarget.select()}),this.data=t;var n=0,a=Lockr.get("hqLvDefault",_g.defaultHqLv);for(this.el.attr({"data-fleetid":t._id,"data-infos-id":t._id}).removeClass("loading"),this.el.find(".loading-msg").remove(),$("<header/>").append(this.doms.name=new InfosFleetEditableTitle({tagName:"h3",placeholder:"点击编辑标题",onUpdate:function(e){i._name=e}}).$el).append(this.doms.preview=$('<div class="preview"/>')).appendTo(this.el),$('<div class="fleets"/>').append(this.doms.tabs=$('<div class="tabs"/>')).append(this.doms.options=$('<div class="options"/>').append(this.doms.hqlvOptionLabel=$("<label/>",{"class":"option option-hqlv",html:"司令部等级","data-tip":this.tip_hqlv_input.printf(a)}).on({"mouseenter mouseleave":function(e){_p.tip.is_showing&&!_p.tip.timeout_fade&&this.doms.hqlvOption.is(":focus")&&(e.stopImmediatePropagation(),e.stopPropagation())}.bind(this)}).append(this.doms.hqlvOption=$("<input/>",{type:"number",min:0,max:_g.shipMaxLv,placeholder:a}).val(this._hqlv||a).on({input:function(){this._hqlv=this.doms.hqlvOption.val()}.bind(this),"focus.tipshow":function(){this.doms.hqlvOption.trigger("tipshow")}.bind(this),"blur.tiphide":function(){this.doms.hqlvOption.trigger("tiphide")}.bind(this),click:function(e){e.stopImmediatePropagation(),e.stopPropagation()}}))).append(this.doms.theme=$('<select class="option option-theme-value"/>').on("change",function(){this._theme=this.doms.theme.val()}.bind(this)).append(function(){for(var e=$(),t=1;t<11;t++)e=e.add($("<option/>",{value:t,html:"主题-"+t}));return e})).append(this.doms.themeOption=$('<button class="option option-theme mod-dropdown"/>').html("主题").on("click",function(){var t=this;if(!e.menuTheme){e.menuThemeItems=$("<div/>");for(var i=function(i){$('<button class="theme-'+i+'"/>').html(i).on("click",function(){e.menuCur._theme=i,this.el.attr("data-theme",this._theme)}.bind(t)).appendTo(e.menuThemeItems)},n=1;n<11;n++)i(n);e.menuTheme=new _menu({className:"contextmenu-infos_fleet_themes",items:[e.menuThemeItems]})}e.menuCur=this,e.menuTheme.show(this.doms.themeOption)}.bind(this))).append(this.doms.exportOption=$('<button class="option mod-dropdown"/>').html("分享").on("click",function(){if(!e.menuExport){var t=[];_g.isClient&&!_g.isOnline||t.push($('<div class="item"/>').html("分享当前配置"+(_g.isClient?"":"<small>可直接分享网址</small>")).add(new ShareBar({title:function(){return e.menuCur.data.name},summary:"分享自 是谁呼叫舰队（ http://fleet.moe ）",sites:["tsina","tqq","cqq","twitter","tieba"],uid:1552359,modifyItem:function(e){e.addClass("menuitem")},url:function(){return e.menuCur.url}}).el.addClass("item")).add($("<hr/>"))),_g.isClient&&t.push($("<menuitem/>",{html:"在浏览器中打开当前配置"}).on("click",function(){node.gui.Shell.openExternal(e.menuCur.url)})),t=t.concat([$("<menuitem/>",{html:"导出配置代码"}).on("click",function(){e.menuCur.modalExport_show()}),$("<menuitem/>",{html:"导出配置文本"}).on("click",function(){e.menuCur.modalExportText_show()})]),_g.isNWjs&&t.push($("<menuitem/>",{html:"生成图片"}).on("click",function(){e.menuCur.exportPic()})),e.menuExport=new _menu({className:"contextmenu-infos_fleet_themes",items:t})}e.menuCur=this,e.menuExport.show(this.doms.exportOption)}.bind(this))).append(this.doms.optionOptions=$('<button class="icon" icon="cog"/>').on("click",function(){TablelistFleets.menuOptions_show(this.doms.optionOptions)}.bind(this)))).appendTo(this.el),this.doms.ships=$('<div class="ships"/>').appendTo(this.el);n<4;)$("<input/>",{type:"radio",name:"fleet_"+t._id+"_tab",id:"fleet_"+t._id+"_tab_"+n,value:n}).prop("checked",0==n).prependTo(this.el),this.fleets[n]=new InfosFleetSubFleet(this,[],n,$("<label/>",{"for":"fleet_"+t._id+"_tab_"+n,"data-fleet":n,html:"#"+(n+1)}).appendTo(this.doms.tabs)),this.fleets[n].el.attr("data-fleet",n).appendTo(this.doms.ships),n++;$("<input/>",{type:"radio",name:"fleet_"+t._id+"_tab",id:"fleet_"+t._id+"_tab_airfileds",value:4}).prop("checked",!1).prependTo(this.el),this.fleet_airfileds=new InfosFleetSubAirfield(this,[],$("<label/>",{"for":"fleet_"+t._id+"_tab_airfileds","data-fleet":4,html:"基地"}).appendTo(this.doms.tabs)),this.fleet_airfileds.el.attr("data-fleet",4).appendTo(this.doms.ships),this.data._id||(this.el.addClass("mod-preview"),this.doms.preview.html("若要编辑配置或保存以备日后查看，请").append($("<button/>",{html:"保存配置"}).on("click",function(){this.previewSave()}.bind(this))),this.doms.name.removeAttr("contenteditable"),this.doms.hqlvOptionLabel.data("tip","若要编辑配置或保存以备日后查看，<br/>请点击上方的“保存配置”按钮"),this.doms.hqlvOption.prop("readonly",!0)),this.update(t),this._theme=this._theme,$body.on("update_defaultHqLv.fleet"+this.data._id,function(e,t){this.is_showing&&(this._hqlv||this.doms.hqlvOption.val(t),this.doms.hqlvOptionLabel.data("tip",this.tip_hqlv_input.printf(t)),this.doms.hqlvOption.attr("placeholder",t))}.bind(this))}},{key:"update",value:function(t){this._updating=!0,t=t||{},t.data=e.decompress(t.data),"undefined"!=typeof t.theme&&(_frame.infos.dom.main.attr("data-theme",t.theme),this.doms.theme.val(t.theme).attr("value",t.theme)),"undefined"!=typeof t.name&&this.doms.name.html(t.name).trigger("namechange",[t.name]).trigger("blur"),t.data&&t.data.push&&t.data.forEach(function(e,t){4==t?this.fleet_airfileds.updateEl(e):this.fleets[t].updateEl(e)},this),this._updating=!1}},{key:"update_data",value:function(e){e=e||{},this.update(e)}},{key:"previewSave",value:function(){_db.fleets.insert(TablelistFleets.prototype.new_data(this.data),function(e,t){if(e)_g.error(e);else{this.el.attr({"data-infos-id":t._id}),_frame.infos.curContent="fleet::"+t._id;var i=_frame.infos.__fleet(t._id,null,t);_frame.infos.contentCache.fleet[t._id]=i,_frame.infos.contentCache.fleet[this._infos_state_id]=i,i.insertBefore(this.el),this.el.remove(),delete this,_g.badgeMsg("舰队配置已保存")}}.bind(this))}},{key:"updateURI",value:function(){if(!_g.isNWjs&&this.data._id&&_g.uriSearch()){var e=$.extend(!0,{},this.data),t=e._id;delete e._id,delete e.time_create,delete e.time_modify,delete e.rating,delete e.user,history.replaceState(history.state,document.title,location.pathname+"?i="+t+"&d="+LZString.compressToEncodedURIComponent(JSON.stringify(e)))}}},{key:"save",value:function(t){return this._updating?this:(this.is_init?(this.data.data=[],this.fleets.forEach(function(e,t){this.data.data[t]=e.data},this),this.data.data[4]=this.fleet_airfileds.data,e.clean(this.data.data),this.data.time_modify=_g.timeNow(),this.updateURI(),t||(clearTimeout(this.delay_updateDb),this.delay_updateDb=setTimeout(function(){_db.fleets.updateById(this.data._id,e.compressMetaData(this.data),function(){_g.log("saved"),e.decompressMetaData(this.data)}.bind(this)),clearTimeout(this.delay_updateDb),this.delay_updateDb=null}.bind(this),200))):(e.clean(this.data.data),this.updateURI()),this.is_init=!0,this)}},{key:"modalExport_show",value:function(){e.modalExport_show(this.data)}},{key:"modalExportText_show",value:function(){e.modalExportText_show(this.data)}},{key:"exportPic",value:function(){e.fileDialog_export||(e.fileDialog_export=$('<input type="file" accept=".png" nwsaveas/>').on({click:function(t,i,n,a){e.fileDialog_export.data({windowWidth:i,windowHeight:n,isMaxmize:a}),e.fileDialog_export_showing=!0},change:function(){var t=e.fileDialog_export.val();e.fileDialog_export.val(""),_g.log("changed"),setTimeout(function(){node.win.capturePage(function(e){var i=node.fs.createWriteStream(t);i.write(e),i.end()},{format:"png",datatype:"buffer"})},0)},resetCaptureMode:function(){!e.fileDialog_export.val()&&$body.hasClass("mod-capture")&&($body.removeClass("mod-capture"),node.win.resizeTo(e.fileDialog_export.data("windowWidth"),e.fileDialog_export.data("windowHeight")),e.fileDialog_export.data("isMaxmize")&&node.win.maximize(),e.fileDialog_export.data({windowWidth:null,windowHeight:null,isMaxmize:null}),_g.zoom(Scale.cur),_menu.hideAll())}}).appendTo(_frame.dom.hidden),$window.on("focus.resetCaptureMode",function(){e.fileDialog_export_showing&&setTimeout(function(){e.fileDialog_export.trigger("resetCaptureMode"),e.fileDialog_export_showing=!1},1e3)})),_g.zoom(1);var t=$window.width(),i=$window.height(),n=$html.hasClass("window-maxmize");n&&node.win.unmaximize(),$body.addClass("mod-capture"),node.win.resizeTo(1280,720),setTimeout(function(){e.fileDialog_export.trigger("click",[t,i,n])},200)}},{key:"remove",value:function(){e.modalRemove_show(this)}},{key:"_name",get:function(){return this.data.name},set:function(e){this.data.name=e,this.save()}},{key:"_theme",get:function(){return this.data.theme},set:function(e){this.data.theme=e||1,this.doms.theme.val(this.data.theme).attr("value",this.data.theme),_frame.infos.dom.main.attr("data-theme",this.data.theme),this.el.attr("data-theme",this.data.theme),_frame.dom.layout.attr("data-theme",this.data.theme),this.save()}},{key:"_hqlv",get:function(){return this.data.hq_lv>0?this.data.hq_lv:0},set:function(e){e=parseInt(e);var t=this._hqlv;if(e&&e>0?(this.data.hq_lv=e,this.doms.hqlvOption.val(e)):(e=-1,this.data.hq_lv=-1,this.doms.hqlvOption.val(Lockr.get("hqLvDefault",_g.defaultHqLv))),t!=e){for(var i=0;i<4;)this.fleets[i].summaryCalc(!0),i++;this.save()}}},{key:"url",get:function(){if(this.data._id){var e=$.extend(!0,{},this.data),t=e._id;return delete e._id,delete e.time_create,delete e.time_modify,delete e.rating,delete e.user,"http://fleet.moe/fleets/build/?i="+t+"&d="+LZString.compressToEncodedURIComponent(JSON.stringify(e))}}}]),e}();InfosFleet.modalExport=function(e){if(!InfosFleet.elModalExport){InfosFleet.elModalExport=$("<div/>").append(InfosFleet.elModalExportTextarea=$("<textarea/>",{readonly:!0})).append($('<p class="note-codeusage"/>').html('* 该配置代码可用于<a href="http://www.kancolle-calc.net/deckbuilder.html">艦載機厨デッキビルダー</a>'));var t=$('<button class="button">复制到剪切板</button>').appendTo(InfosFleet.elModalExport);new Clipboard(t[0],{text:function(){return InfosFleet.elModalExportTextarea.val()}})}return InfosFleet.elModalExportTextarea.val(e||""),InfosFleet.elModalExport},InfosFleet.modalExport_show=function(e){e=InfosFleet.decompress(e.data||[]),e=JSON.stringify(_g.kancolle_calc.encode(e)),_frame.modal.show(InfosFleet.modalExport(e),"导出配置代码",{classname:"infos_fleet infos_fleet_export",detach:!0})},InfosFleet.modalExportText_show=function(e){if(!e)return!1;var t="",i=[],n=InfosFleet.decompress(e.data).filter(function(e){return _g.log(e),!(!e||!e.length)&&e.some(function(e){if(_g.log("* ",e),e&&e.length){if(e.some(function(e){switch(_g.log("  * ",e),"undefined"==typeof e?"undefined":_typeof(e)){case"number":case"string":return!0}}))return!0;e.some(function(t){if(_g.log("  * ",t),t&&t.length&&t[0])return i.push(e),!0})}return!1})})||[];t+=e.name||"",n.forEach(function(e,i){t+=(t?"\n":"")+(n.length>1?"\n第 "+(i+1)+" 舰队":""),e.filter(function(e){return e&&e[0]&&e.length>0}).forEach(function(e,n){t+="\n("+(i?i+1+"-":"")+(n+1)+") "+_g.data.ships[e[0]]._name+(e[1]&&e[1][0]?" Lv."+e[1][0]:"");var a=e[2]||[],s=e[3]||[],o=e[4]||[];a.filter(function(e){return e}).forEach(function(e,i){t+=(i?", ":" | ")+_g.data.items[e]._name+(s[i]?"★"+s[i]:"")+(o[i]?"["+_g.textRank[o[i]]+"]":"")})})}),_g.log(i),i.forEach(function(e,i){t+=(t?"\n":"")+(e.length>1?"\n第 "+(i+1)+" 航空队":""),e.filter(function(e){return e&&e.length&&e[0]}).forEach(function(e,i){t+="\n("+(i+1)+") "+_g.data.items[e[0]]._name+(e[1]?" ["+_g.textRank[e[1]]+"]":"")})}),t+=(t?"\n\n":"")+"* 创建自 是谁呼叫舰队 (fleet.moe)",_frame.modal.show(InfosFleet.modalExport(t),"导出配置文本",{classname:"infos_fleet infos_fleet_export mod-text",detach:!0})},InfosFleet.modalRemove_show=function(e,t){if("undefined"!=typeof e){var i=void 0;e instanceof InfosFleet&&(i=e,e=i.data._id),InfosFleet.elModalRemove||(InfosFleet.elModalRemove=$("<form/>").append(InfosFleet.elModalRemoveId=$('<input name="id" type="hidden"/>')).append($("<p/>").html("是否删除该舰队配置？")).append($('<p class="actions"/>').append($("<button/>",{type:"submit","class":"button",html:"是"})).append($("<button/>",{type:"button","class":"button",html:"否"}).on("click",function(){_frame.modal.hide()}))).on("submit",function(e){e.preventDefault();var i=InfosFleet.elModalRemoveId.val();return i&&(_frame.app_main.loading_start("remove_fleet_"+i,!1),_db.fleets.remove({_id:i},{multi:!0},function(e,n){_g.log("Fleet "+i+" removed."),_frame.app_main.loading_complete("remove_fleet_"+i),_frame.modal.hide(),_g.badgeMsg("已删除配置"),t&&t instanceof TablelistFleets?t.refresh():_frame.dom.navs.fleets.click()})),!1})),InfosFleet.elModalRemoveId.val(e),_frame.modal.show(InfosFleet.elModalRemove,"删除配置",{classname:"infos_fleet infos_fleet_remove",detach:!0})}},InfosFleet.clean=function(e){function t(e){e&&e.length&&e.forEach(function(i,n){i&&i.push?t(i):n==e.length-1&&null===i&&(e.pop(),t(e))})}if(e)return t(e),e},InfosFleet.decompress=function(e){if(e&&!e.push)try{e=JSON.parse(LZString.decompressFromEncodedURIComponent(e))}catch(t){_g.error(t)}return e},InfosFleet.compress=function(e){if(e&&e.push)try{e=LZString.compressToEncodedURIComponent(JSON.stringify(e))}catch(t){_g.error(t)}return e},InfosFleet.compressMetaData=function(e){if(e&&e.data&&e.data.push)try{e.data=InfosFleet.compress(e.data)}catch(t){_g.error(t)}return e},InfosFleet.decompressMetaData=function(e){if(e&&e.data&&!e.data.push)try{e.data=InfosFleet.decompress(e.data)}catch(t){_g.error(t)}return e};var InfosFleetSubFleet=function(){function e(t,i,n,a){_classCallCheck(this,e),i=i||[],this.data=i,this.el=$('<dl class="fleetships"/>'),this.label=a,this.ships=[];for(var s=0;s<6;)this.ships[s]=new InfosFleetShip(t,this,s),this.ships[s].getEl().appendTo(this.el),s++;this.elSummary=$('<span class="summary"/>').appendTo(this.el).append($('<span class="summary-item"/>').html("航速").append(this.elSummarySpeed=$("<strong/>").html("-"))).append($('<span class="summary-item"/>').html("制空战力").append(this.elSummaryFighterPower=$("<strong/>").html("-"))).append($('<span class="summary-item"/>').html("索敌能力").append(this.elSummaryLos=$("<strong/>").html("-"))).append($('<span class="summary-item summary-item-consummation"/>').html("总消耗").append(this.elSummaryConsummation=$("<strong/>").html("-"))).append(this.elSummaryTPcontainer=$('<span class="summary-item hide"/>').html("运输TP").append(this.elSummaryTP=$("<strong/>").html("-"))),this.infosFleet=t,$body.on("update_defaultHqLv.fleet"+t.data._id+"-"+(n+1),function(){this.infosFleet.is_showing&&this.summaryCalc(!0)}.bind(this))}return _createClass(e,[{key:"updateEl",value:function(e){this.data=e||this.data;var t=0;e&&e.forEach(function(e,i){this.ships[i].updateEl(e),e&&e.push&&e[0]&&t++},this),t?this.label.addClass("highlight"):this.label.removeClass("highlight")}},{key:"getData",value:function(){return this.data}},{key:"getShipCount",value:function(){var e=0;return this.data&&this.data.forEach(function(t){t&&t.push&&t[0]&&e++}),e}},{key:"summaryCalc",value:function(e){return!this.summaryCalculating&&void(this.summaryCalculating=setTimeout(function(){if(!e){var t=[0,0],i=1e3,n=0,a=0,s=0;if(this.ships.forEach(function(e){if(e.data[0]){var o=_g.data.ships[e.data[0]];i=Math.min(i,e.stat.speed||o.stat.speed),e.calculate("fighterPower_v2").forEach(function(e,i){t[i]+=e>0?e:0}),n+=o.getAttribute("fuel",e.shipLv)||0,a+=o.getAttribute("ammo",e.shipLv)||0,s+=e.calculate("TP"),s+=o.tp||0}}),this.elSummarySpeed.html(_g.getStatSpeed(i)),Math.max(t[0],t[1])>0){var o=Math.floor(t[0]),r=Math.floor(t[1]);this.elSummaryFighterPower.html(o==r?o:o+"~"+r),this.elSummaryFighterPower.removeClass("empty")}else this.elSummaryFighterPower.html("-"),this.elSummaryFighterPower.addClass("empty");if(this.elSummaryConsummation.html(n||a?'<span class="fuel">'+n+'</span><span class="ammo">'+a+"</span>":"-"),s>40){var l=Math.floor(s),d=Math.floor(.7*l);this.elSummaryTPcontainer.removeClass("hide"),this.elSummaryTP.html("A="+d+" / S="+l)}else this.elSummaryTPcontainer.addClass("hide")}var u=this.getShipCount()?this.summaryCalcLos():null;this.elSummaryLos.html(u?u.toFixed(2):"-"),this.summaryCalculating=null}.bind(this),10))}},{key:"summaryCalcLos",value:function(){var e=this.infosFleet.data.hq_lv||Lockr.get("hqLvDefault",_g.defaultHqLv);return e<0&&(e=Lockr.get("hqLvDefault",_g.defaultHqLv)),Formula.calcByFleet.los33(this.data,e)}},{key:"save",value:function(){var e=0;this.data=this.data||[],this.ships.forEach(function(t,i){this.data[i]=t.data,t.data&&t.data[0]&&e++},this),e?this.label.addClass("highlight"):(this.data=null,this.label.removeClass("highlight")),this.infosFleet&&this.infosFleet.save()}}]),e}(),InfosFleetShip=function(){function e(t,i,n,a){var s=this;if(_classCallCheck(this,e),this.el)return this.el;a=a||[null,[null,-1],[],[],[]],this.data=a,this.infosFleet=t,this.infosFleetSubFleet=i,this.equipments=[],this.index=n,this.stat={};for(var o=0;o<4;o++)this.equipments[o]=new InfosFleetShipEquipment(this,o);this.equipments[4]=new InfosFleetShipEquipment(this,4,0,$.unique(Formula.equipmentType.AAGuns.concat([33,34,35,48,49])),[33]),this.el=$('<dd class="ship"/>').append($("<dt/>").append(this.elAvatar=$('<s touch-action="none"/>')).append(this.elInfos=$("<div/>").html("<span>"+(this.infosFleet.data._id?"选择舰娘":"无舰娘")+"...</span>").append(this.elInfosTitle=$('<div class="title"/>')).append($('<div class="info"/>').append($("<label/>").html("Lv.").append(this.elInputLevel=$("<input/>",{type:"number",min:0,max:_g.shipMaxLv}).on({checkValue:function(){var e=s.elInputLevel.val();"undefined"!=typeof e&&""!==e||!s.data[1][0]||(s.shipLv=null),e=parseInt(e);var t=parseInt(s.elInputLevel.attr("min"));e<t?(e=t,s.elInputLevel.val(t)):e>_g.shipMaxLv&&(e=_g.shipMaxLv,s.elInputLevel.val(_g.shipMaxLv)),isNaN(e)||s.data[1][0]==e||(s.shipLv=e)},keydown:function(e){38!=e.keyCode&&40!=e.keyCode||s.elInputLevel.trigger("checkValue")},change:function(){s.elInputLevel.trigger("checkValue")}}))).append(this.elInfosSpeed=$("<span/>")).append(this.elInfosType=$("<span/>"))))).append($('<div class="equipments"/>').append(function(){for(var e=$(),t=0;t<4;t++)e=e.add(this.equipments[t].el);return e}.bind(this))).append($('<div class="attributes"/>').append(this.elAttrShelling=$('<span class="shelling"/>')).append(this.elAttrTorpedo=$('<span class="torpedo"/>')).append(this.elAttrHitSum=$('<span class="hitsum"/>')).append(this.elAttrHp=$('<span class="hp"/>')).append(this.elAttrArmor=$('<span class="armor"/>')).append(this.elAttrEvasion=$('<span class="evasion"/>')).append(this.elAttrNightBattle=$('<span class="nightbattle" data-text="夜战"/>')).append(_huCss.csscheck_full("mask-image")?null:$('<div class="bg"/>'))).append($('<div class="options"/>').append(this.elBtnOptions=$('<button class="options"/>').on("click",function(e){this.showMenu()}.bind(this)))).append(this.equipments[4].el.addClass("equipment-extra")),this.after=$("<s/>"),this.els=this.el.add(this.after),this.infosFleet.data._id?(this.el.on({click:function(){this.data[0]||this.selectShipStart()}.bind(this),pointerenter:function(){e.dragEnter(this)}.bind(this),touchmove:function(t){e.dragTouchmove(t)}}),this.elAvatar.on({pointerdown:function(t){t.preventDefault(),this.data[0]&&(document.activeElement.blur(),e.dragStart(this))}.bind(this)})):this.elInputLevel.prop("readonly",!0),_huCss.csscheck_full("mask-image")||this.el.addClass("mod-nomask")}return _createClass(e,[{key:"getEl",value:function(){return this.els}},{key:"selectShipStart",value:function(){_g.log("开始选择舰娘"),_frame.app_main.load_page("ships",{callback_modeSelection_select:function(e){history.back(),this.shipId=e,this.shipLv=null,this.infosFleet&&_frame.infos.dom.main.attr("data-theme",this.infosFleet.data.theme)}.bind(this)})}},{key:"changeLuck",value:function(e){this.data[1][1]=e||-1}},{key:"updateAttrs",value:function(){if(this.shipId){var e=this.calculate("speed");this.stat.speed=_g.getStatSpeedNumber(e),this.elInfosSpeed.html(e),_g.data.ships[this.shipId].stat.speed!==this.stat.speed?this.elInfosSpeed.attr("data-speed",this.stat.speed):this.elInfosSpeed.removeAttr("data-speed");var t=this.calculate("shellingDamage");this.elAttrShelling.html(("-"!==t?this.calculate("fireRange")+" | ":"")+t),this.elAttrTorpedo.html(this.calculate("torpedoDamage"));var i=this.calculate("addHit");i>=0?this.elAttrHitSum.removeClass("negative"):this.elAttrHitSum.addClass("negative"),this.elAttrHitSum.html(i),this.elAttrHp.html(this.calculate("attribute","hp")),this.elAttrArmor.html(this.calculate("attribute","armor")+this.calculate("addArmor"));var n=this.shipLv?this.calculate("attribute","evasion"):-1;this.elAttrEvasion.html(n>=0?n+this.calculate("addEvasion"):"-"),this.elAttrNightBattle.html(this.calculate("nightBattle"))}}},{key:"calculate",value:function(e,t){if(!this.shipId)return"-";if("attribute"==e)return _g.data.ships[this.shipId].getAttribute(t,this.shipLv);if(Formula[e])switch(e){case"losPower":return Formula[e](this.shipId,this.data[2],this.data[3],this.data[4],{hqLv:this.infosFleet.data.hq_lv,shipLv:this.shipLv});default:return Formula[e](this.shipId,this.data[2],this.data[3],this.data[4])}return Formula.calculate[e]?Formula.calculate(e,this.shipId,this.data[2],this.data[3],this.data[4])||"-":Formula.calcByShip[e]?Formula.calcByShip[e](_g.data.ships[this.shipId],this.data[2].map(function(e){return _g.data.items[e]}))||0:"-"}},{key:"updateEl",value:function(e){var t=this;this._updating=!0,this.data=e||this.data,"string"==typeof this.data[0]&&(this.data[0]=parseInt(this.data[0])),this.data[2]||(this.data[2]=[]),this.data[3]||(this.data[3]=[]),this.data[4]||(this.data[4]=[]),this.data[0]&&(this.shipId=this.data[0],this.data[1][0]&&(this.shipLv=this.data[1][0]),this.equipments.forEach(function(e,i){e.id=t.data[2][i],e.star=t.data[3][i],e.rank=t.data[4][i]}),this.updateAttrs()),this._updating=!1}},{key:"getData",value:function(){return this.data}},{key:"showMenu",value:function(){e.menuCurObj=this,e.menu||(e.menuItems=[$('<menuitem class="move move-up"/>').html(" ").on({click:function(t){e.menuCurObj.moveUp()},show:function(){e.menuCurObj.index?e.menuItems[0].removeClass("disabled"):e.menuItems[0].addClass("disabled")}}),$('<menuitem class="move move-down"/>').html(" ").on({click:function(t){e.menuCurObj.moveDown()},show:function(){e.menuCurObj.index<5?e.menuItems[1].removeClass("disabled"):e.menuItems[1].addClass("disabled")}}),$("<hr/>"),$("<menuitem/>").html("查看资料").on({show:function(){e.menuItems[3].attr("data-infos","[[SHIP::"+e.menuCurObj.shipId+"]]")}}),$("<menuitem/>").html("移除").on({click:function(t){e.menuCurObj.shipId=null}}),$("<menuitem/>").html("替换为 ...").on({click:function(t){e.menuCurObj.selectShipStart()}}),$("<div/>").on("show",function(){var t=e.menuItems[6].empty();if(e.menuCurObj.shipId){var i=_g.data.ships[e.menuCurObj.shipId].getSeriesData()||[];i.length>1&&i.forEach(function(i,n){n||t.append($("<hr/>")),i.id!=e.menuCurObj.shipId&&t.append($("<menuitem/>").html("替换为 "+_g.data.ships[i.id].getName(!0)).on({click:function(){e.menuCurObj.shipId=i.id}}))})}})],e.menu=new _menu({className:"contextmenu-ship",items:e.menuItems})),e.menu.show(this.elBtnOptions)}},{key:"swap",value:function(t,i,n){if(e.dragIsSwapping)return!1;e.dragIsSwapping=!0,"number"==typeof t&&(t=this.infosFleetSubFleet.ships[t]),this.index>t.index?this.el.insertBefore(t.el):this.el.insertAfter(t.after),this.after.insertAfter(this.el);
var a=t.index,s=this.index;console.log(a,s),this.index=a,t.index=s,this.infosFleetSubFleet.ships[a]=this,this.infosFleetSubFleet.ships[s]=t,i&&this.save(),setTimeout(function(){n&&n(),setTimeout(function(){e.dragIsSwapping=!1},10)},10)}},{key:"moveUp",value:function(){this.index<=0||this.swap(this.index-1,!0)}},{key:"moveDown",value:function(){this.index>=5||this.swap(this.index+1,!0)}},{key:"save",value:function(){return!this._updating&&void(this._updateTimeout||(this._updateTimeout=setTimeout(function(){this.updateAttrs(),this.infosFleetSubFleet&&(this.infosFleetSubFleet.summaryCalc(),this.infosFleetSubFleet.save()),this._updateTimeout=null}.bind(this),50)))}},{key:"shipId",get:function(){return this.data[0]},set:function(e){var t=this;if(e!=this.data[0]&&(this.data[0]=e,this.shipLv=null,delete this.stat.speed),e){var i=_g.data.ships[e],n=i.getSuffix(),a=i._speed,s=i._type;s=s.replace(a,""),this.el.attr("data-shipId",e),this.elAvatar.html('<img src="'+i.getPic(10,_g.imgExt)+'"/>'),this.elInfosTitle.html('<h4 data-content="'+i.name[_g.lang]+'">'+i.name[_g.lang]+"</h4>"+(n?'<h5 data-content="'+n+'">'+n+"</h5>":"")),this.elInputLevel.attr("min",i._minLv),this.elInfosSpeed.html(a),this.elInfosType.html(s),this.equipments.forEach(function(e,n){e.carry=n<4?i.slot[n]:0,t._updating||(e.id=null,e.star=null,e.rank=null)})}else this.el.removeAttr("data-shipId"),this.elInputLevel.attr("min",0),this.elAvatar.html(""),this.data[2]=[],this.data[3]=[],this.data[4]=[];this.save()}},{key:"shipLv",get:function(){return this.data[1][0]},set:function(e){this.data[1][0]=e||null,e&&e>0?this.elInputLevel.val(e):this.elInputLevel.val(""),this.save()}}]),e}();InfosFleetShip.dragStart=function(e){return!(InfosFleetShip.dragging||!e)&&(InfosFleetShip.dragging=e,e.el.addClass("moving"),void(InfosFleetShip.isInit||($body.on({"pointerup.InfosFleetShip_dragend pointercancel.InfosFleetShip_dragend":function(){InfosFleetShip.dragging&&(InfosFleetShip.dragging.el.removeClass("moving"),InfosFleetShip.dragging.save(),InfosFleetShip.dragging=null)}}),InfosFleetShip.isInit=!0)))},InfosFleetShip.dragEnter=function(e){return!(!InfosFleetShip.dragging||!e||InfosFleetShip.dragging==e)&&void InfosFleetShip.dragging.swap(e)},InfosFleetShip.dragTouchGetPosition=function(){return InfosFleetShip.draggingTouchPosition=[],!!InfosFleetShip.dragging&&(InfosFleetShip.draggingTouchPosition=InfosFleetShip.dragging.infosFleetSubFleet.ships.map(function(e){var t=e.el.offset();return{top:t.top+10,bottom:t.top+e.el.height()-10,target:e}}),InfosFleetShip.draggingTouchPosition)},InfosFleetShip.dragTouchmove=function(e){if(!InfosFleetShip.dragging||InfosFleetShip.dragIsSwapping)return!1;var t=e.originalEvent.touches||e.originalEvent.changedTouches;if(!t||!t.length||t.length>1)return!1;InfosFleetShip.draggingTouch||(InfosFleetShip.dragTouchGetPosition(),InfosFleetShip.draggingTouch=!0);var i=t[0].clientY||t[0].pageY||-1;InfosFleetShip.draggingTouchPosition.some(function(e){if(InfosFleetShip.dragging==e.target)return!1;var t=!1;return i>=e.top&&i<=e.bottom&&(t=e.target),t&&InfosFleetShip.dragging.swap(t,!1,InfosFleetShip.dragTouchGetPosition),t})};var InfosFleetShipEquipment=function(){function e(t,i,n,a,s){return _classCallCheck(this,e),this.index=i||0,this.isParentAirfield=t instanceof InfosFleetAirfield,this.infosParent=t,this.el?this.el:(this.elBlurTimeout,this.el=$('<div class="equipment equipment-'+this.index+'" tabindex="0"/>').on({focus:function(){e.cur=this.el.addClass("is-hover")}.bind(this),blur:function(){var t=this;this.elBlurTimeout=setTimeout(function(){t.el.removeClass("is-hover"),e.cur=null},10)}.bind(this),pointerenter:function(t){var i=this;if("touch"!=t.originalEvent.pointerType&&(e.cur=this.el.addClass("is-hover"),this.index>=4)){var n=this.el.attr("data-tip");this.el.attr("data-tip",""),n&&setTimeout(function(){i.el.attr("data-tip",n),setTimeout(function(){i.el.data("tip-filtered_")||(_p.tip.filters.forEach(function(e){n=e(n)||n}),i.el.data({"tip-filtered_":n})),_p.tip.show(i.el.data("tip-filtered_"),i.el,i.el.data("tip-position"))},100)},10)}}.bind(this),pointerleave:function(t){"touch"!=t.originalEvent.pointerType&&(this.el.removeClass("is-hover").blur(),e.cur=null)}.bind(this)}).append(this.elCarry=$('<div class="equipment-layer equipment-add"/>').on("click",function(){this.selectEquipmentStart()}.bind(this))).append($('<div class="equipment-layer equipment-infos"/>').append(this.elName=$('<span class="equipment-name"/>')).append(this.elStar=$('<span class="equipment-star"/>').html(0)).append(this.elRank=$('<span class="equipment-rank"/>')).append(function(){var e=$('<span class="equipment-carry"/>').html(0);return this.elCarry=this.elCarry.add(e),e}.bind(this))).append($('<div class="equipment-layer equipment-options"/>').append(this.elInputStar=$("<input/>",{"class":"equipment-starinput",type:"number",placeholder:0,min:0,max:10}).on({input:function(){var e=this.elInputStar.val();"undefined"!=typeof e&&""!==e||!this.star||(this.star=null),e=parseInt(e),isNaN(e)||this.star==e||(this.star=e)}.bind(this),focus:function(){clearTimeout(this.elBlurTimeout),this.el.addClass("is-hover")}.bind(this),blur:function(){setTimeout(function(){this.el.is(":focus")||this.el.removeClass("is-hover")}.bind(this),10)}.bind(this),pointerdown:function(t){var i=this;console.log("pointerdown"),"touch"==t.originalEvent.pointerType&&(e.cur=this.el.addClass("is-hover"),clearTimeout(this.elBlurTimeout),setTimeout(function(){i.elInputStar.trigger("focus")},10))}.bind(this),pointerenter:function(t){"touch"!=t.originalEvent.pointerType&&(e.cur=this.el.addClass("is-hover"),clearTimeout(this.elBlurTimeout))}.bind(this),mouseenter:function(t){e.cur=this.el.addClass("is-hover"),clearTimeout(this.elBlurTimeout)}.bind(this)})).append(this.elSelectRank=$("<div/>",{"class":"equipment-rankselect",html:"<span>...</span>"}).on("click",function(){if(this.el.hasClass("is-rankupgradable")){if(!InfosFleet.menuRankSelect){InfosFleet.menuRankSelectItems=$("<div/>");for(var e=function(e){$('<button class="rank-'+e+'"/>').html(e?"":"...").on("click",function(){InfosFleet.menuRankSelectCur.rank=e}).appendTo(InfosFleet.menuRankSelectItems)},t=0;t<8;t++)e(t);InfosFleet.menuRankSelect=new _menu({className:"contextmenu-infos_fleet_rank_select",items:[InfosFleet.menuRankSelectItems]})}InfosFleet.menuRankSelectCur=this,InfosFleet.menuRankSelect.show(this.elSelectRank)}}.bind(this))).append(this.elButtonInspect=$('<span class="button inspect" icon="search"/>').on("click",function(){this.id&&_frame.infos.show("[[EQUIPMENT::"+this.id+"]]")}.bind(this))).append($('<span class="button change" icon="loop"/>').on("click",function(){this.selectEquipmentStart()}.bind(this))).append($('<span class="button remove"/>').on("click",function(){this.id=null}.bind(this)))),n&&(this.carry=n),a&&(this.equipmentTypes=a),void(this.extraEquipments=s||[]))}return _createClass(e,[{key:"getEl",value:function(){return this.el}},{key:"selectEquipmentStart",value:function(){_g.log("开始选择装备"),_frame.app_main.load_page("equipments",{callback_modeSelection_select:function(e){history.back(),this.id=e,this.star=0,this.rank=Lockr.get("fleetlist-option-aircraftdefaultmax")&&e&&_g.data.items[e].rankupgradable&&$.inArray(_g.data.items[e].type,Formula.equipmentType.Aircrafts)>-1?7:0,this.infosParent.infosFleet&&_frame.infos.dom.main.attr("data-theme",this.infosParent.infosFleet.data.theme)}.bind(this),callback_modeSelection_enter:function(){var e=this.infosParent.shipId,t=e&&_g.data.ships[e],i=e&&_g.data.ship_classes[t["class"]],n=e&&i&&i.extraSlotExtra,a=e?t.getEquipmentTypes():[],s=e?a:[],o=!1;if(this.equipmentTypes&&this.equipmentTypes.length)if(s.length){var r=[];this.equipmentTypes.forEach(function(e){s.indexOf(e)>-1&&r.push(e)}),s=r,o=!0}else s=this.equipmentTypes;TablelistEquipments.isExtraSlot=o,TablelistEquipments.types=s,TablelistEquipments.shipId=this.infosParent.shipId,TablelistEquipments.extraEquipments=this.extraEquipments?this.extraEquipments.concat():[],TablelistEquipments.extraEquipments=TablelistEquipments.extraEquipments.filter(function(e){return console.log(TablelistEquipments.types,_g.data.items[e].type),a.indexOf(_g.data.items[e].type)>-1}),o&&n&&n.length&&(TablelistEquipments.extraEquipments=TablelistEquipments.extraEquipments.concat(n)),_frame.app_main.page.equipments.object.tablelistObj.apply_types()}.bind(this)})}},{key:"getData",value:function(){return this.data}},{key:"save",value:function(){return!this._updating&&void(this.infosParent&&this.infosParent.save())}},{key:"id",get:function(){return this.isParentAirfield?this.infosParent.data[this.index][0]:this.infosParent.data[2][this.index]},set:function(t){t=parseInt(t)||null,_p.tip.hide(),this.el.removeData(["tip","tip-filtered","tip-filtered_"]),this.isParentAirfield||t==this.infosParent.data[2][this.index]||(this.star=0),t&&!isNaN(t)?(this.isParentAirfield?this.infosParent.data[this.index][0]=t:this.infosParent.data[2][this.index]=t,e.improvableExtra.indexOf(t)>-1?this.improvable=!0:this.improvable=_g.data.items[t].improvable||!1,this.el.attr({"data-equipmentid":t,"data-tip":"[[EQUIPMENT::"+t+"]]","touch-action":"none"}).css("background-image","url("+_g.data.items[t]._icon+")"),this.elName.html(_g.data.items[t]._name),$.inArray(_g.data.items[t].type,Formula.equipmentType.Aircrafts)>-1?(this.el.addClass("is-aircraft"),_g.data.items[t].rankupgradable&&this.el.addClass("is-rankupgradable")):this.el.removeClass("is-aircraft is-rankupgradable"),this.isParentAirfield&&(Formula.equipmentType.Recons.indexOf(_g.data.items[t].type)>-1?this.carry=4:this.carry=18)):(this.isParentAirfield?(this.infosParent.data[this.index][0]=null,this.carry=18):this.infosParent.data[2][this.index]=null,this.improvable=!1,this.el.removeAttr("data-equipmentId").removeAttr("data-tip").removeAttr("data-star").removeAttr("data-rank").removeAttr("touch-action").css("background-image","").removeClass("is-aircraft is-rankupgradable"),this.elName.html("")),this.isParentAirfield?this.infosParent.summaryCalc():this.infosParent.infosFleetSubFleet.summaryCalc(),this.save()}},{key:"star",get:function(){return this.infosParent.data[3][this.index]},set:function(e){var t=function(e){this.isParentAirfield?this.infosParent.data[this.index][2]=e:this.infosParent.data[3][this.index]=e}.bind(this);this._improvable?(e=parseInt(e)||null,e>10&&(e=10),e<0&&(e=0),e?(t(e),this.elInputStar.val(e),this.elStar.html(e),this.el.attr("data-star",e)):(t(null),this.elInputStar.val(""),this.elStar.html(0),this.el.attr("data-star",""))):(t(null),this.el.removeAttr("data-star")),this.isParentAirfield?this.infosParent.summaryCalc():this.infosParent.infosFleetSubFleet.summaryCalc(),this.save()}},{key:"rank",get:function(){return this.isParentAirfield?this.infosParent.data[this.index][1]:this.infosParent.data[4][this.index]},set:function(e){var t=function(e){this.isParentAirfield?this.infosParent.data[this.index][1]=e:this.infosParent.data[4][this.index]=e}.bind(this);this.id&&$.inArray(_g.data.items[this.id].type,Formula.equipmentType.Aircrafts)>-1?(e=parseInt(e)||null,e>7&&(e=7),e<0&&(e=0),e?(t(e),this.el.attr("data-rank",e)):(t(null),this.el.attr("data-rank",""))):(t(null),this.el.removeAttr("data-rank")),this.isParentAirfield?this.infosParent.summaryCalc():this.infosParent.infosFleetSubFleet.summaryCalc(),this.save()}},{key:"carry",set:function(e){"undefined"==typeof e?(this.el.removeAttr("data-carry"),this.elCarry.html(0)):(e=parseInt(e)||0,this.el.attr("data-carry",e),this.elCarry.html(e))}},{key:"improvable",set:function(e){e?(this.el.attr("data-star",""),this.elInputStar.prop("disabled",!1).attr("placeholder","0"),this._improvable=!0):(this.el.removeAttr("data-star"),this.elInputStar.prop("disabled",!0).attr("placeholder","--"),this._improvable=!1)}}]),e}();InfosFleetShipEquipment.improvableExtra=[110];var InfosFleetSubAirfield=function(){function e(t,i,n){_classCallCheck(this,e),i=i||[],this.data=i,this.label=n,this.el=$('<dl class="fleetships fleetairfields"/>'),this.container=$('<dl class="airfields"/>').appendTo(this.el),this.fields=[];for(var a=0;a<3;)this.fields[a]=new InfosFleetAirfield(t,this,a),this.fields[a].getEl().appendTo(this.container),a++;$('<dl class="gap"/>').appendTo(this.el);var s=["“航程”决定了该航空队在出击时所能抵达的最远作战点，数值由航程属性最小的中队决定，侦察机也可以提高这一数值。","“制空战力”表示该航空队执行出击任务时的制空能力，“防空战力”则表示防空任务能力。","局地战斗机的“迎击”属性也可以提高制空战力。装备列表中局战的“回避”列数值即为“迎击”属性。","除了局地战斗机的“迎击”和“对爆”属性外，在航空队种配置侦察机也可以有效提高防空战力。"];$('<dl class="tips"/>').html('\n                    <ul class="tip-content">\n                        <h4 data-content="小贴士">小贴士</h4>\n                        '+s.map(function(e){return"<li>"+e+"</li>"}).join("")+"\n                    </ul>\n                ").appendTo(this.el),this.infosFleet=t}return _createClass(e,[{key:"updateEl",value:function(e){var t=this;this.data=e||this.data;var i=0;e&&e.forEach(function(e,t){this.fields[t].updateEl(e),e&&e.push&&e.forEach(function(e){e&&e.push&&e[0]&&i++})},this),this.infosFleet.data.name_airfields&&this.infosFleet.data.name_airfields.push&&this.infosFleet.data.name_airfields.forEach(function(e,i){t.fields[i].elTitle.html(e).trigger("namechange",[e]).trigger("blur")}),i?this.label.addClass("highlight"):this.label.removeClass("highlight")}},{key:"getData",value:function(){return this.data}},{key:"save",value:function(){this.data=this.data||[];var e=0,t=[];this.fields.forEach(function(i,n){this.data[n]=i.data,i.data&&i.data.push&&i.data.forEach(function(t){t&&t.push&&t[0]&&e++}),t[n]=i.name||""},this),e?this.label.addClass("highlight"):this.label.removeClass("highlight"),this.infosFleet&&(this.infosFleet.data.name_airfields=t,this.infosFleet.save())}}]),e}(),InfosFleetAirfield=function(){function e(t,i,n,a){var s=this;if(_classCallCheck(this,e),this.el)return this.el;a=a||[[],[],[],[]],this.data=a,this.infosFleet=t,this.infosParent=i,this.aircrafts=[],this.index=n;var o=["一","二","三"];this.el=$('<dd class="airfield"/>').append(this.elTitle=new InfosFleetEditableTitle({tagName:"h4",placeholder:"第"+o[n]+"航空队",onUpdate:function(e){s._name=e}}).$el).append($('<div class="aircrafts"/>').append(function(){for(var t=$(),i=0;i<4;i++)this.aircrafts[i]=new InfosFleetShipEquipment(this,i,18,e.equipmentTypes),t=t.add(this.aircrafts[i].el);return t}.bind(this))),this.elSummary=$('<span class="summary"/>').appendTo($('<div class="airfield-summary"/>').appendTo(this.el)).append($('<span class="summary-item"/>').html("航程").append(this.elSummaryDistance=$("<strong/>").html("-"))).append($('<span class="summary-item"/>').html("制空战力").append(this.elSummaryFighterPower=$("<strong/>").html("-"))).append($('<span class="summary-item"/>').html("防空战力").append(this.elSummaryFighterPowerAA=$("<strong/>").html("-"))),this.els=this.el}return _createClass(e,[{key:"getEl",value:function(){return this.els}},{key:"updateEl",value:function(e){this._updating=!0,this.data=e||this.data;for(var t=0;t<4;t++)this.data[t]?(this.data[t][0]&&(this.aircrafts[t].id=this.data[t][0]),this.data[t][1]&&(this.aircrafts[t].rank=this.data[t][1]),this.data[t][2]&&(this.aircrafts[t].star=this.data[t][2])):this.data[t]=[];this._updating=!1}},{key:"getData",value:function(){return this.data}},{key:"getCarry",value:function(e){return Formula.equipmentType.Recons.indexOf(e.type)>-1?4:18}},{key:"summaryCalc",value:function(){return!(this.summaryCalculating||!this.data||!this.data.push)&&(this.summaryCalculating=setTimeout(function(){var e=[0,0],t={min:0,max:0,recon:0},i=[0,0],n=[];this.data.forEach(function(i){if(i[0]){var a=_g.data.items[i[0]],s=this.getCarry(a),o=Formula.calc.fighterPower(a,s,i[1],i[2]),r=a.stat.distance||0;e[0]+=o[0],e[1]+=o[1],Formula.equipmentType.Recons.indexOf(a.type)>-1?t.recon=Math.max(t.recon,r):(t.min=t.min<=0?r:Math.min(t.min,r),t.max=Math.max(t.max,r)),n.push({equipment:a,rank:i[1],star:i[2],carry:s})}},this),i=Formula.calcByField.fighterPowerAA(n);var a=function(e,t){if(Math.max(e[0],e[1])>0){var i=Math.floor(e[0]),n=Math.floor(e[1]);t.removeClass("empty").html(i==n?i:i+"~"+n)}else t.addClass("empty").html("-")};if(a(e,this.elSummaryFighterPower),a(i,this.elSummaryFighterPowerAA),t.min+t.recon>0){var s=t.min;t.recon&&(s+=Math.round(Math.min(3,Math.max(0,Math.sqrt(t.recon-t.min))))),this.elSummaryDistance.removeClass("empty").html(s)}else this.elSummaryDistance.addClass("empty").html("-");this.summaryCalculating=null}.bind(this),10),!0)}},{key:"swap",value:function(e,t){"number"==typeof e&&(e=this.infosFleetSubFleet.ships[e]),this.index>e.index?this.el.insertBefore(e.el):this.el.insertAfter(e.after),this.after.insertAfter(this.el);var i=e.index,n=this.index;console.log(i,n),this.index=i,e.index=n,this.infosFleetSubFleet.ships[i]=this,this.infosFleetSubFleet.ships[n]=e,t&&this.save()}},{key:"moveUp",value:function(){this.index<=0||this.swap(this.index-1,!0)}},{key:"moveDown",value:function(){this.index>=5||this.swap(this.index+1,!0)}},{key:"save",value:function(){return!this._updating&&void(this._updateTimeout||(this._updateTimeout=setTimeout(function(){this.infosParent&&this.infosParent.save(),this._updateTimeout=null}.bind(this),50)))}},{key:"_name",get:function(){return this.name},set:function(e){this.name=e,this.save()}}]),e}();InfosFleetAirfield.dragStart=function(e){return!(e.dragging||!e)&&(e.dragging=e,e.el.addClass("moving"),void(e.isInit||($body.on({"pointerup.InfosFleetAirfield_dragend pointercancel.InfosFleetAirfield_dragend":function(){e.dragging&&(e.dragging.el.removeClass("moving"),e.dragging.save(),e.dragging=null)}}),e.isInit=!0)))},InfosFleetAirfield.dragEnter=function(e){return!(!InfosFleetAirfield.dragging||!e||InfosFleetAirfield.dragging==e)&&void InfosFleetAirfield.dragging.swap(e)},InfosFleetAirfield.equipmentTypes=$.unique(Formula.equipmentType.LandBased.concat(Formula.equipmentType.Seaplanes).concat(Formula.equipmentType.CarrierBased).concat(Formula.equipmentType.Recons)),_frame.app_main.is_mode_selection=function(){return $html.hasClass("mode-selection")||_frame.dom.layout.hasClass("mode-selection")},_frame.app_main.mode_selection_callback=null,_frame.app_main.mode_selection_on=function(e){_frame.dom.navSelectionInfo||(_frame.dom.navSelectionInfo=$('<div class="selection-info"/>').html("请选择……").appendTo(_frame.dom.nav)),e=e||function(){},e(),_frame.dom.layout.addClass("mode-selection")},_frame.app_main.mode_selection_off=function(){this.cur_page&&this.page_dom[this.cur_page].trigger("modeSelectionExit"),_frame.dom.layout.removeClass("mode-selection")},"undefined"!=typeof _p.tip&&(_p.tip.filters.push(function(e){var t=/^\[\[EQUIPMENT\:\:([0-9]+)\]\]$/.exec(e);if(t&&t.length>1)return _p.tip.content_equipment(_g.data.items[parseInt(t[1])])}),_p.tip.content_equipment=function(e){function t(t,i){if(!e.stat[t])return"";if(Formula.equipmentType.Interceptors.indexOf(e.type)>-1)switch(t){case"hit":i="对爆";break;case"evasion":i="迎击"}switch(t){case"range":return"<span>射程: "+_g.getStatRange(e.stat[t])+"</span>";case"distance":return"<span>"+i+": "+e.stat[t]+"</span>";default:var n=parseInt(e.stat[t]);return"<span>"+(n>0?"+":"")+n+" "+i+"</span>"}}var i=e.getName(),n=$.inArray(e.type,Formula.equipmentType.Aircrafts)>-1;return'<h3 class="itemstat"><s class="equiptypeicon mod-'+e.getIconId()+'"></s><strong data-content="'+i+'">'+i+"</strong><small>"+_g.data.item_types[e.type].name.zh_cn+"</small></h3>"+t("fire","火力")+t("torpedo","雷装")+t("aa","对空")+t("asw","对潜")+t("bomb","爆装")+t("hit","命中")+t("armor","装甲")+t("evasion","回避")+t("los","索敌")+t("range","射程")+(n?t("distance","航程"):"")},_p.tip.filters.push(function(e){var t=/^\[\[EQUIPABLE\:\:([0-9]+)\]\]$/.exec(e);if(t&&t.length>1)return _p.tip.content_equipable(_g.data.item_types[parseInt(t[1])])}),_p.tip.content_equipable_results={},_p.tip.content_equipable=function(e){if(!_p.tip.content_equipable_results[e.id]){var t='<h4 class="item_equipable_on">可装备于以下舰种</h4>',i=e.equipable_extra_ship||[];if(t+="<p>",e.equipable_on_type.length){var n=[];_g.ship_type_order_full.forEach(function(t){e.equipable_on_type.indexOf(t)>-1&&n.push(t)}),t+=n.map(function(e){var t=_g.data.ship_types[e];return"<span>"+(t.full_zh||t.full_game)+("("+t.code+")")+"</span>"}).join(" / ")}else t+="无...";t+="</p>",i.length&&(t+='<h4 class="item_equipable_on">也可装备于以下舰娘</h4>',t+=e.equipable_extra_ship.map(function(e){var t=_g.data.ships[e],i=t.getType();return'<span><a href="?infos=ship&id='+e+'" data-shipid="'+e+'" data-infos="[[SHIP::'+e+']]" data-tip="[[SHIP::'+e+']]">'+(i?"["+i+"] ":"")+t.getName(_g.joint)+"</a></span>"}).join(" / ")),_p.tip.content_equipable_results[e.id]=t}return _p.tip.content_equipable_results[e.id]}),"undefined"!=typeof _p.tip&&(_p.tip.filters.push(function(e){var t=/^\[\[SHIP\:\:([0-9]+)\]\]$/.exec(e);if(t&&t.length>1)return _p.tip.content_ship(_g.data.ships[parseInt(t[1])])}),_p.tip.content_ship=function(e){var t=e.getName(_g.joint),i='<h3 class="shipinfo"><img src="'+_g.path.pics.ships+"/"+e.id+'/0.webp" width="160" height="40"/><strong data-content="'+t+'">'+t+"</strong>"+(e.type?"<small>"+_g.data.ship_types[e.type].full_zh+"</span>":"")+"</h3>";return i});var modal={};modal.equipable={frames:{},frame:function(e){if(!e)return!1;if(!this.frames[e]){var t=$("<div/>"),i=_g.data.item_types[e],n=i.equipable_on_type||[],a=i.equipable_extra_ship||[],s=[];if(_g.ship_type_order_full.forEach(function(e){n.indexOf(e)>-1&&s.push(e)}),_p.el.flexgrid.create().appendTo(t).addClass("equipable-types").prepend($(_g.ship_type_order_full.map(function(e){var t=_g.data.ship_types[e];return t.hide||t.donotcompare?"":'<span class="unit'+(n.indexOf(e)>-1?" on":"")+'">'+(t.full_zh||t.full_game)+(" ("+t.code+")")+"</span>"}).join(""))).appendTo(t),a.length){t.append("<p>以及以下舰娘...</p>");var o=_p.el.flexgrid.create().appendTo(t).addClass("list-ship equipable-extra-ships");a.forEach(function(e){o.appendDOM(_tmpl.link_ship(e).addClass("unit"))})}this.frames[e]=t}return this.frames[e]},show:function(e){return _frame.modal.show(this.frame(e),_g.data.item_types[e].name.zh_cn+" 可装备于...",{classname:"modal-equipable",detach:!0})}},_p.el.tablelist={init_el:function(e){return!!e.data("tablelist")||void(e.hasClass("ships")?e.data({tablelist:new TablelistShips(e)}):e.hasClass("tablelist-equipments")?e.data({tablelist:new TablelistEquipments(e)}):e.hasClass("fleets")?e.data({tablelist:new TablelistFleets(e)}):e.hasClass("entities")&&e.data({tablelist:new TablelistEntities(e)}))},init:function(e,t){e=e||$body,t=t||e.find(".tablelist"),t.each(function(){_p.el.tablelist.init_el($(this))})}};var Tablelist=function(){function e(t,i){_classCallCheck(this,e),this.dom={container:t},i=i||{},this._index=e.index++,this.trIndex=0,this.flexgrid_empty_count=i.flexgrid_empty_count||8,this.sort_data_by_stat=i.sort_data_by_stat||{},this.sort_default_order_by_stat=i.sort_default_order_by_stat||{},t.on("mouseenter.hovercolumn",".tablelist-body dd",this.hovercolumn_delegate.bind(this)).on("mouseleave.hovercolumn",".tablelist-body dd",this.hovercolumn_delegate_leave.bind(this))}return _createClass(e,[{key:"append_option",value:function(t,i,n,a,s,o){function r(){var n=void 0,s=void 0,r=void 0,l=e.genId();switch(t){case"text":case"number":case"hidden":n=$('<input type="'+t+'" name="'+i+'" id="'+l+'" />').val(a);break;case"select":n=$('<select name="'+i+'" id="'+l+'" />'),s=$('<option value=""/>').html("").appendTo(n),a.forEach(function(e,t){r="object"==("undefined"==typeof e?"undefined":_typeof(e))?$('<option value="'+("undefined"==typeof e.val?e.value:e.val)+'"/>').html(e.title||e.name).appendTo(n):$('<option value="'+e+'"/>').html(e).appendTo(n),"undefined"!=typeof o["default"]&&r.val()==o["default"]&&r.prop("selected",!0)}),a&&a.length||(s.remove(),$('<option value=""/>').html("...").appendTo(n)),o["new"]&&($('<option value=""/>').html("==========").insertAfter(s),$('<option value="___new___"/>').html("+ 新建").insertAfter(s),n.on("change.___new___",function(){var e=$(this);"___new___"==e.val()&&(e.val(""),o["new"](n))}));break;case"checkbox":n=$('<input type="'+t+'" name="'+i+'" id="'+l+'" />').prop("checked",a);break;case"radio":n=$(),a.forEach(function(e,t){var s,r,d=!1;a[t].push?(r=a[t][0],s=a[t][1]):(r=a[t].val||a[t].value,s=a[t].title||a[t].name),o.radio_default&&o.radio_default==r&&(d=!0),n=n.add($('<input type="radio" name="'+i+'" id="'+l+"-"+r+'" ischecked="'+d+'" />').val(r).prop("checked",d||!d&&0==t)),n=n.add($('<label for="'+l+"-"+r+'"/>').html(s))})}return o.required&&n.prop("required",!0),o.onchange&&(n.on("change.___onchange___",function(e){o.onchange(e,$(this))}),o["default"]&&n.trigger("change")),i||n.attr("name",null),n}o=o||{};var l=$("<p/>").addClass(i).appendTo(this.dom.filters),d=r().appendTo(l),u=d.attr("id")||e.genId();return n=n?$("<label"+("checkbox"==t?' class="checkbox"':"")+' for="'+u+'"/>').html(n).appendTo(l):null,"checkbox"==t&&n&&n.insertAfter(d),s&&$('<label for="'+u+'"/>').html(s).appendTo(l),l}},{key:"thead_redraw",value:function(e){}},{key:"sort_column",value:function(e,t,i){if(!i){var n=this.dom.tbody;n&&n.length||(n=this.dom.table.children(".tablelist-body")),i=n.children("dl:visible:not([data-donotcompare])")}e=e||1,this._tmp_values=[],this._tmp_value_map_cell={},i.children("dd:nth-of-type("+e+")").each(function(e,t){var i=$(t),n=i.attr("value");n=parseFloat(n),$.inArray(n,this._tmp_values)<0&&this._tmp_values.push(n),this._tmp_value_map_cell[n]||(this._tmp_value_map_cell[n]=$()),this._tmp_value_map_cell[n]=this._tmp_value_map_cell[n].add(i)}.bind(this)),this._tmp_values.sort(function(e,i){return t?e-i:i-e});var a=[];return this._tmp_values.forEach(function(e){a.push(this._tmp_value_map_cell[e])},this),delete this._tmp_values,delete this._tmp_value_map_cell,a}},{key:"mark_high",value:function(e){var t=this.dom.tbody;t&&t.length||(t=this.dom.table.children(".tablelist-body"));var i=t.children("dl:visible:not([data-donotcompare])");return i.children("dd[value]").removeClass("sort-first sort-second"),i.eq(0).children("dd[value]").each(function(t,n){var a=!1,s=$(n),o=s.attr("stat"),r=o.match(/\b(speed|range|extra_illust)\b/);"undefined"==typeof this.sort_default_order_by_stat[o]?(o.match(/\b(consum_fuel|consum_ammo)\b/)&&(a=!0),this.sort_default_order_by_stat[o]=a?"asc":"desc"):a="asc"==this.sort_default_order_by_stat[o];var l=this.sort_column(t+1,a,i),d=Math.min(6,Math.ceil(i.length/2)+1);!r&&l.length>1&&l[0].length<d&&(l[0].addClass("sort-first"),l.length>2&&l[1].length<d&&l[1].addClass("sort-second")),e?this.sort_data_by_stat[o]=l:delete this.sort_data_by_stat[o]}.bind(this)),i}},{key:"sort_table_from_theadcell",value:function(e){if(e){var t=e.attr("stat"),i=this.sort_data_by_stat[t];if(!t||!i)return!1;t!=this.lastSortedStat&&(this.lastSortedHeader&&this.lastSortedHeader.removeClass("sorting desc asc"),e.addClass("sorting"));var n=t==this.lastSortedStat&&"obverse"==this.lastSortedOrder?"reverse":"obverse",a="reverse"==n?i.length-1:0;if(this.sort_default_order_by_stat[t]){var s="asc"==this.sort_default_order_by_stat[t]?"desc":"asc";"obverse"==n?e.removeClass(s).addClass(this.sort_default_order_by_stat[t]):e.removeClass(this.sort_default_order_by_stat[t]).addClass(s)}for(this.sortedRow=$();i[a];)this._tmpDOM=i[a].parent(),this.sortedRow=this.sortedRow.add(this._tmpDOM),this._tmpDOM.appendTo(this.dom.tbody),a="reverse"==n?a-1:a+1;this.dom.btn_compare_sort.removeClass("disabled").html("取消排序"),this.lastSortedStat=t,this.lastSortedOrder=n,this.lastSortedHeader=e,delete this._tmpDOM}}},{key:"sort_table_restore",value:function(){if(!this.sortedRow)return!0;var e=void 0,t=[];return this.sortedRow.each(function(i,n){var a=$(n),s=parseInt(a.attr("trindex"));e=e||a.parent(),t.push({index:s,el:a,prev:e.children('[trindex="'+(s-1)+'"]')})}),t.sort(function(e,t){return e.index-t.index}),t.forEach(function(e){e.el.insertAfter(e.prev)}),this.dom.btn_compare_sort.addClass("disabled").html("点击表格标题可排序"),this.lastSortedHeader.removeClass("sorting desc asc"),delete this.sortedRow,delete this.lastSortedStat,delete this.lastSortedOrder,delete this.lastSortedHeader,!0}},{key:"hovercolumn_delegate",value:function(e){if(!$body_preventMouseover&&e&&e.originalEvent.path&&this.dom.tbody){var t=e.currentTarget.getAttribute("data-index");if(t)t=parseInt(t);else{var i=$(e.currentTarget);t=i.index(),i.attr("data-index",t)}this.dom.tbody.find("dl:visible dd:nth-child("+(t+1)+")").addClass("is-hover")}}},{key:"hovercolumn_delegate_leave",value:function(e){!$body_preventMouseover&&e&&e.originalEvent.path&&this.dom.tbody&&(this.dom.tbody.find("dd.is-hover").removeClass("is-hover"),_p.el.tablelist.hovercolumn_mouseleave_delay=null)}}]),e}();Tablelist.index=0,Tablelist.genId=function(e){var t,i,n,a=0;if(e=e||(new Date).toISOString()+_g.randInt(1e4),0==e.length)return a;for(t=0,n=e.length;t<n;t++)i=e.charCodeAt(t),a=(a<<5)-a+i,a|=0;return"tablelist"+a};var TablelistEntities=function(e){function t(e,i){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return _frame.app_main.loading.push("tablelist_"+n._index),_frame.app_main.is_loaded=!1,e.children(".tablelist-list").length?n.init_parse():n.init_new&&n.init_new(i),n}return _inherits(t,e),_createClass(t,[{key:"init_parse",value:function(){this.generated=!0,_frame.app_main.loaded("tablelist_"+this._index,!0)}}]),t}(Tablelist),TablelistShips=function(e){function t(e,i){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return n.columns=["  ",["火力","fire"],["雷装","torpedo"],["夜战","nightpower"],["对空","aa"],["对潜","asw"],["耐久","hp"],["装甲","armor"],["回避","evasion"],["搭载","carry"],["航速","speed"],["射程","range"],["索敌","los"],["运","luck"],["油耗","consum_fuel"],["弹耗","consum_ammo"],["多立绘","extra_illust"]],n.header_checkbox=[],n.mode_selection_filters=$(),n.rows=$(),n.rowsById={},n.rowsByHeader={},_frame.app_main.loading.push("tablelist_"+n._index),_frame.app_main.is_loaded=!1,n.initProgressMax=0,n.initProgressCur=0,n.dom.container.on({initprogress:function(e,t,i){this.initProgressCur=t||this.initProgressCur,this.initProgressMax=i||this.initProgressMax}}),e.children(".tablelist-container").length&&n.init_parse(),n}return _inherits(t,e),_createClass(t,[{key:"compare_btn_show",value:function(e){!e&&this.rows.filter('[compare="true"]').length||e?this.dom.msg_container.attr("data-msgs","comparestart"):this.dom.msg_container.removeAttr("data-msgs")}},{key:"compare_start",value:function(){this.dom.msg_container.removeAttr("data-msgs"),this.last_viewtype=this.dom.filter_container.attr("viewtype"),_config.set("shiplist-viewtype",this.last_viewtype),this.last_scrollTop=this.dom.tbody.scrollTop(),this.dom.filter_container.attr("viewtype","compare"),this.dom.tbody.scrollTop(0),this.dom.table.addClass("sortable"),this.mark_high(!0),this.thead_redraw(500)}},{key:"compare_off",value:function(){this.dom.filter_container.attr("viewtype",this.last_viewtype),this.sort_table_restore(),this.mark_high(),this.thead_redraw(500),this.dom.tbody.scrollTop(this.last_scrollTop),this.dom.table.removeClass("sortable"),delete this.last_viewtype,delete this.last_scrollTop}},{key:"compare_end",value:function(){this.rows.filter('[compare="true"]').each(function(e,t){this.check(t,!1)}.bind(this)),this.dom.msg_container.removeAttr("data-msgs"),this.compare_off()}},{key:"compare_continue",value:function(){this.dom.msg_container.attr("data-msgs","comparestart"),this.compare_off()}},{key:"contextmenu_show",value:function(e,i,n){if("compare"==this.dom.filter_container.attr("viewtype")||"true"==e.attr("data-donotcompare"))return!1;if(!t.contextmenu){var a=function(){var e=[$("<menuitem/>").html("选择").on({click:function(e){_frame.app_main.is_mode_selection()&&_frame.app_main.mode_selection_callback(t.contextmenu._curid)},show:function(){_frame.app_main.is_mode_selection()?$(this).show():$(this).hide()}}),$("<menuitem/>").html("查看资料").on({click:function(e){t.contextmenu._curel.trigger("click",[!0])}}),$("<menuitem/>").html("将该舰娘加入对比").on({click:function(e){this.check(this.rowsById[t.contextmenu._curid])}.bind(this),show:function(e){return!!t.contextmenu._curid&&(_g.data.ship_types[_g.data.ships[t.contextmenu._curid].type].donotcompare?$(e.target).hide():$(e.target).show(),
void("true"===this.rowsById[t.contextmenu._curid].attr("compare")?$(e.target).html("取消对比"):$(e.target).html("将该舰娘加入对比")))}.bind(this)}),$("<div/>").on("show",function(e){var i=$(e.target).empty();if(t.contextmenu._curid){var n=_g.data.ships[t.contextmenu._curid].getSeriesData()||[];n.forEach(function(e,t){t||i.append($("<hr/>"));var n=null;try{n=this.rowsById[e.id]}catch(a){}i.append($('<div class="item"/>').html("<span>"+_g.data.ships[e.id].getName(!0)+"</span>").append($('<div class="group"/>').append(function(){var t=$();return _frame.app_main.is_mode_selection()&&(t=t.add($("<menuitem/>").html("选择").on({click:function(){_frame.app_main.is_mode_selection()&&_frame.app_main.mode_selection_callback(e.id)}}))),t}).append($('<menuitem data-infos="[[SHIP::'+e.id+']]"/>').html("查看资料")).append($("<menuitem/>").html(n&&"true"===n.attr("compare")?"取消对比":"加入对比").on({click:function(e){n&&this.check(n)}.bind(this)}))))},this)}}.bind(this))];return t.contextmenu?t.contextmenu.showing?t.contextmenu.hide(function(){t.contextmenu.dom.body.empty(),e.forEach(function(e){e.appendTo(t.contextmenu.dom.body)}),t.contextmenu._is_rightclick?t.contextmenu.show(t.contextmenu._is_rightclick.x,t.contextmenu._is_rightclick.y):t.contextmenu.show(t.contextmenu._curel)}):(t.contextmenu.dom.body.empty(),e.forEach(function(e){e.appendTo(t.contextmenu.dom.body)})):t.contextmenu=new _menu({className:"contextmenu-ship",items:e}),t.contextmenu}.bind(this);this.is_init?a():(t.contextmenu=new _menu({className:"contextmenu-ship",items:[$("<menuitem/>").html("数据处理中，请稍候……　　")]}),this.dom.container.on({initprogress:function(e,i,n){t.contextmenu.showing&&t.contextmenu.dom.body.empty().append($("<menuitem/>").html("数据处理中，请稍候 ("+(i/n*100).toFixed(1)+"%)"))},initdone:function(){a()}}))}t.contextmenu._curid=i||e.data("shipid"),t.contextmenu._curel=e,n?(t.contextmenu._is_rightclick={x:n.clientX,y:n.clientY},t.contextmenu.show(n.clientX,n.clientY)):(t.contextmenu._is_rightclick=!1,t.contextmenu.show(e))}},{key:"init_parse",value:function(){this.dom.filter_container=this.dom.container.children(".options"),this.dom.filters=this.dom.filter_container.children(".filters"),this.dom.exit_compare=this.dom.filter_container.children(".exit_compare"),this.dom.exit_compare.children('button[icon="arrow-set2-left"]').on("click",function(){this.compare_end()}.bind(this)),this.dom.exit_compare.children('button[icon="checkbox-checked"]').on("click",function(){this.compare_continue()}.bind(this)),this.dom.btn_compare_sort=this.dom.exit_compare.children('button[icon="sort-amount-desc"]').on("click",function(){this.dom.btn_compare_sort.hasClass("disabled")||this.sort_table_restore()}.bind(this)),this.dom.search=$('<p class="search"/>').prependTo(this.dom.filters).append(this.dom.searchInput=$('<input type="search" placeholder="搜索舰娘..."/>').on({input:function(e){clearTimeout(this.searchDelay),this.searchDelay=setTimeout(function(){this.search(e.target.value)}.bind(this),100)}.bind(this),focus:function(){this.dom.search.addClass("on")}.bind(this),blur:function(e,t){!t&&this.dom.container.hasClass("mod-search")||this.dom.search.removeClass("on")}.bind(this)})),this.dom.btn_hide_premodel=this.dom.filters.find('[name="hide-premodel"]').prop("checked","false"!==_config.get("shiplist-filter-hide-premodel")||null).on("change",function(e){_config.set("shiplist-filter-hide-premodel",this.dom.btn_hide_premodel.prop("checked")),this.dom.filter_container.attr("filter-hide-premodel",this.dom.btn_hide_premodel.prop("checked")),this.thead_redraw()}.bind(this)),this.dom.filters.find('[name="viewtype"]').each(function(e,t){t=$(t);var i=_config.get("shiplist-viewtype")||"card";t.val()==i&&t.prop("checked",!0),t.on("change",function(e){t.is(":checked")&&(_config.set("shiplist-viewtype",t.val()),this.dom.filter_container.attr("viewtype",t.val()),this.thead_redraw())}.bind(this))}.bind(this)),this.dom.filters.find("input").trigger("change"),this.dom.table=this.dom.container.children(".tablelist-container"),this.dom.thead=this.dom.table.children(".tablelist-header").on("click","[stat]",function(e){this.sort_table_from_theadcell($(e.currentTarget))}.bind(this)),this.dom.tbody=this.dom.table.children(".tablelist-body").on("contextmenu.contextmenu_ship","[data-shipid]",function(e){this.contextmenu_show($(e.currentTarget),null,e),e.preventDefault()}.bind(this)).on("click","[data-shipid]",function(e,t){"label"==e.target.tagName.toLowerCase()?(this.check(e.currentTarget),e.stopPropagation()):"em"==e.target.tagName.toLowerCase()?(this.contextmenu_show($(e.target),e.currentTarget.getAttribute("data-shipid")),e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation()):!t&&_frame.app_main.is_mode_selection()&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),e.currentTarget.getAttribute("data-donotcompare")||_frame.app_main.mode_selection_callback(e.currentTarget.getAttribute("data-shipid"))),this.dom.searchInput.trigger("blur",[!0])}.bind(this)),this.dom.msg_container=this.dom.container.children(".msgs"),_config.get("hide-compareinfos")?this.dom.msg_container.removeAttr("data-msgs"):this.dom.msg_container.attr("data-msgs","compareinfos"),this.parse_all_items();var e=this.dom.msg_container.children(".compareinfos");e.children("button").on("click",function(){this.dom.msg_container.removeAttr("data-msgs"),_config.set("hide-compareinfos",!0)}.bind(this)),this.dom.msg_container.children(".comparestart").on("click",function(){this.compare_start()}.bind(this))}},{key:"parse_all_items",value:function(){var e=Q.defer(),t=Q.fcall(function(){}),i=this.dom.tbody.children("h4, dl");return i.each(function(e,n){t=t.then(function(){n=$(n),n.attr("trindex",e);var t=Q.defer(),a=n.attr("data-shipid"),s=n.attr("data-header");if(this.rowsByHeader[s]||(this.rowsByHeader[s]=$()),"H4"==n[0].tagName){var o=n.find('input[type="checkbox"]').on({change:function(){this.rowsByHeader[s].filter(":visible").each(function(e,t){this.check(t,o.prop("checked"),!0)}.bind(this))}.bind(this),docheck:function(){var e=this.rowsByHeader[s].filter(":visible"),t=e.filter('[compare="true"]');t.length?t.length<e.length?o.prop({checked:!1,indeterminate:!0}):o.prop({checked:!0,indeterminate:!1}):o.prop({checked:!1,indeterminate:!1})}.bind(this)});this.header_checkbox[s]=o,this.mode_selection_filters.add($("<input/>",{value:s,type:"checkbox","class":"shiptype",id:"shiptype-"+s}).prop("checked",!s).prependTo(this.dom.container)),$("<label/>",{"for":"shiptype-"+s,"class":"shiptype"}).prependTo(n),n.attr("inited",!0)}else a&&(this.rowsByHeader[s]=this.rowsByHeader[s].add(n),this.rowsById[a]=n,this.rows=this.rows.add(n));return this.dom.container.trigger("initprogress",[e+1,i.length]),setTimeout(t.resolve,0),t.promise}.bind(this))}.bind(this)),t=t.then(function(){this.mark_high(),this.thead_redraw(),this.is_init=!0,this.dom.container.trigger("initdone"),e.resolve()}.bind(this))["catch"](function(e){_g.log(e)}),_frame.app_main.loaded("tablelist_"+this._index,!0),e.promise}},{key:"check",value:function(e,t,i){e.length&&(e=e[0]),"undefined"!=typeof t&&null!==t||(t=!("true"==e.getAttribute("compare"))),t?e.setAttribute("compare","true"):e.removeAttribute("compare"),this.compare_btn_show(t),i||this.header_checkbox[parseInt(e.getAttribute("data-header"))].trigger("docheck")}},{key:"search",value:function(e){if(this.dom.style||(this.dom.style=$("<style/>").appendTo(this.dom.container)),!e)return this.dom.container.removeClass("mod-search"),this.dom.filter_container.attr("filter-hide-premodel",this.dom.btn_hide_premodel.prop("checked")),this.dom.style.empty(),e;if(e=_g.search(e,"ships"),!e.length)return e;this.dom.container.addClass("mod-search"),this.dom.filter_container.attr("filter-hide-premodel",!1);var t=".tablelist.ships .tablelist-body dl:not(:empty)";return e.forEach(function(e){t+=':not([data-shipid="'+e.id+'"])'}),t+="{display:none!important}",this.dom.style.html(t),e}}]),t}(Tablelist),TablelistEquipments=function(e){function t(e,i){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return n.columns=["  ",["火力","fire"],["雷装","torpedo"],["对空","aa"],["对潜","asw"],["爆装","bomb"],["命中","hit"],["装甲","armor"],["回避","evasion"],["索敌","los"],["射程","range"],["可改修","improvable"]],_frame.app_main.loading.push("tablelist_"+n._index),_frame.app_main.is_loaded=!1,e.children(".tablelist-container").length&&n.init_parse(),n}return _inherits(t,e),_createClass(t,[{key:"apply_types",value:function(){var e=this;this.dom.filter_types.removeAttr("class"),t.types.length&&(this.dom.filter_types.addClass("type"+t.types.join(" type")),this.generated&&this.apply_types_check()),this.dom.tbody.children(".extra").removeClass("extra").removeAttr("style"),t.extraEquipments&&t.extraEquipments.forEach(function(t){e.dom.tbody.children('[data-equipmentid="'+t+'"]').css({display:"flex",opacity:1}).addClass("extra")})}},{key:"apply_types_check",value:function(){if(!t.shipIdLast||t.shipIdLast!=t.shipId){if(t.shipIdLast=t.shipId,!t.isExtraSlot&&t.shipId&&_g.data.ships[t.shipId]&&$.inArray(_g.data.ships[t.shipId].type,[9,10,11,30])>-1){for(var e=0,i=void 0,n=void 0;this.dom.types[e++]&&this.dom.types[e]&&(3!=this.dom.types[e].attr("data-equipmentcollection")||$.inArray(parseInt(this.dom.types[e].attr("data-type"))||null,t.types)<=-1);)i=this.dom.types[e+1];return i=i||this.dom.types[0],this.dom.type_radios[3].prop("checked",!0).trigger("change"),n=i[0].offsetTop,n&&(n-=32),void this.dom.tbody.scrollTop(n||0)}if(t.types.length){for(var a=0,s=void 0,o=void 0;$.inArray(parseInt(this.dom.types[a++].attr("data-type"))||null,t.types)<=-1;)s=this.dom.types[a];s=s||this.dom.types[0],this.dom.type_radios[parseInt(s.attr("data-equipmentcollection"))||1].prop("checked",!0).trigger("change"),o=s[0].offsetTop,o&&(o-=32),this.dom.tbody.scrollTop(o||0)}}}},{key:"init_parse",value:function(){this.dom.filter_container=this.dom.container.children(".options"),this.dom.filters=this.dom.filter_container.children(".filters"),this.dom.type_radios={},this.dom.container.children('input[type="radio"][name="equipmentcollection"]').each(function(e,t){t=$(t);var i=parseInt(t.val());this.dom.type_radios[i]=t.prop("checked",1==i).on("change",function(){this.dom.tbody.scrollTop(0),this.thead_redraw()}.bind(this))}.bind(this)),this.dom.filter_types=this.dom.container.children('input[name="types"][type="hidden"]'),this.dom.table=this.dom.container.children(".tablelist-container"),this.dom.thead=this.dom.table.children(".tablelist-header"),this.dom.tbody=this.dom.table.children(".tablelist-body"),this.parse_all_items(),this.dom.msg_container=this.dom.container.children(".msgs"),_config.get("hide-equipmentsinfos")?this.dom.msg_container.removeAttr("data-msgs"):this.dom.msg_container.attr("data-msgs","equipmentsinfos");var e=this.dom.msg_container.children(".equipmentsinfos");e.children("button").on("click",function(){this.dom.msg_container.removeAttr("data-msgs"),_config.set("hide-equipmentsinfos",!0)}.bind(this))}},{key:"parse_all_items",value:function(){this.generated=!1,this.dom.types=[];var e=-1;this.dom.tbody.children("h4, dl").each(function(i,n){if(n=$(n),"H4"==n[0].tagName)e++,this.dom.types[e]=n;else{var a=parseInt(n.attr("data-equipmenttype"))||-1,s=parseInt(n.attr("data-equipmentid"));n.on("click",function(e,i){!i&&_frame.app_main.is_mode_selection()&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),($.inArray(a,t.types||[])>-1||$.inArray(s,t.extraEquipments||[])>-1)&&_frame.app_main.mode_selection_callback(s),setTimeout(function(){t.types=[],t.extraEquipments=[],t.shipId=null,n.removeAttr("style")},20))})}}.bind(this)),this.thead_redraw(),this.generated=!0,this.apply_types_check(),_frame.app_main.loaded("tablelist_"+this._index,!0)}}]),t}(Tablelist);TablelistEquipments.gen_helper_equipable_on=function(e){var t="";return _g.data.item_types[e].equipable_on_type.forEach(function(i,n){var a=_g.data.item_types[e].equipable_on_type[n];t+="<span>"+_g.data.ship_types[a].full_zh+(n<_g.data.item_types[e].equipable_on_type.length-1?",&nbsp;":"")+"</span>"}),'<em class="helper" data-tip="<h4 class=item_equipable_on>可装备于</h4>'+t+'">?</em>'},TablelistEquipments.types=[],TablelistEquipments.shipId=null,TablelistEquipments.shipIdLast=null;var TablelistFleets=function(e){function t(e,i){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return n.columns=["  ",["创建者","user"],["修改时间","time_modify"],["评价","rating"],["","options"]],n.kancolle_calc={_ApplicationId:"l1aps8iaIfcq2ZzhOHJWNUU2XrNySIzRahodijXW",_ClientVersion:"js1.2.19",_InstallationId:"62522018-ec82-b434-f5a5-08c3ab61d932",_JavaScriptKey:"xOrFpWEQZFxUDK2fN1DwbKoj3zTKAEkgJHzwTuZ4"},_frame.app_main.loading.push("tablelist_"+n._index),_frame.app_main.is_loaded=!1,n.dom.filter_container=$('<div class="options" viewtype="card"/>').appendTo(n.dom.container),n.dom.filters=$('<div class="filters"/>').appendTo(n.dom.filter_container),n.dom.btn_new=$('<button class="new" icon="import"/>').html("新建/导入").on("click",function(e,t){this.btn_new(t)}.bind(n)).appendTo(n.dom.filters),t.support.buildfile&&(n.dom.btn_exportFile=$('<button class="export" icon="floppy-disk"/>').html("导出配置文件").on("click",function(){if(_db.fleets.persistence.compactDatafile(),_g.isNWjs)_g.save(_db.fleets.filename,"fleets.json");else{_frame.app_main.loading_start("tablelist_fleets_export",!1);var e="";_db.fleets.find({},function(t,i){if(t)_g.error(t);else{i.forEach(function(t){e+=JSON.stringify(t)+"\n"});var n=new Blob([e],{type:"application/json"});_g.save(URL.createObjectURL(n),"fleets.json")}_frame.app_main.loading_complete("tablelist_fleets_export")})}}).appendTo(n.dom.filters)),n.dom.buttons_right=$('<div class="buttons_right"/>').appendTo(n.dom.filters),n.dom.setting_hqlv=$("<label/>",{"class":"setting setting-hqlv",html:"默认司令部等级","data-tip":"如果舰队配置没有设置司令部等级，<br/>则会使用该默认数值<br/>司令部等级会影响索敌能力的计算"}).on({"mouseenter mouseleave":function(e){_p.tip.is_showing&&!_p.tip.timeout_fade&&this.dom.setting_hqlv_input.is(":focus")&&(e.stopImmediatePropagation(),e.stopPropagation())}.bind(n)}).append(n.dom.setting_hqlv_input=$("<input/>",{type:"number",min:0,max:_g.shipMaxLv}).val(Lockr.get("hqLvDefault",_g.defaultHqLv)).on({input:function(){_g.updateDefaultHqLv(this.dom.setting_hqlv_input.val())}.bind(n),"focus.tipshow":function(){this.dom.setting_hqlv_input.trigger("tipshow")}.bind(n),"blur.tiphide":function(){this.dom.setting_hqlv_input.trigger("tiphide")}.bind(n),click:function(e){e.stopImmediatePropagation(),e.stopPropagation()}})).appendTo(n.dom.buttons_right),$body.on("update_defaultHqLv.update_fleets_hqlv_input",function(e,t){this.dom.setting_hqlv_input.val(t)}.bind(n)),n.dom.btn_settings=$('<button icon="cog"/>').on("click",function(){this.btn_settings()}.bind(n)).appendTo(n.dom.buttons_right),n.dom.table=$('<div class="tablelist-container"/>').appendTo(n.dom.container),n.dom.thead=$("<dl/>").appendTo($('<div class="tablelist-header"/>').appendTo(n.dom.table)),n.dom.tbody=$('<div class="tablelist-body" scrollbody/>').appendTo(n.dom.table).on("contextmenu.contextmenu_fleet","[data-fleetid]",function(e){this.contextmenu_show($(e.currentTarget),null,e),e.preventDefault()}.bind(n)).on("click.contextmenu_fleet","[data-fleetid]>dt>em",function(e){this.contextmenu_show($(e.currentTarget).parent().parent(),$(e.currentTarget)),e.stopImmediatePropagation(),e.stopPropagation()}.bind(n)),n.columns.forEach(function(e,t){"object"==("undefined"==typeof e?"undefined":_typeof(e))?$("<dd/>",{stat:e[1],html:e[0]}).appendTo(this.dom.thead):$("<dt/>").html(e[0]).appendTo(this.dom.thead)}.bind(n)),$('<div class="nocontent container"/>').append($($("<div/>").append($("<span>").html("暂无舰队配置")).append($("<button>").html("新建/导入").on("click",function(e){this.dom.btn_new.trigger("click",[e])}.bind(n))))).appendTo(n.dom.table),n.dom.container.on("focus.number_input_select",'input[type="number"]',function(e){e.currentTarget.select()}),n.genlist(),n}return _inherits(t,e),_createClass(t,[{key:"new_data",value:function(e){return $.extend({data:[],time_create:(new Date).valueOf(),time_modify:(new Date).valueOf(),hq_lv:-1,name:"",note:"",user:{},rating:-1,theme:_g.randNumber(10)},e||{})}},{key:"loaddata",value:function(){var e=Q.defer();return _db.fleets.find({}).sort({name:1}).exec(function(t,i){t?e.resolve([]):(i.forEach(function(e){e.data=InfosFleet.decompress(e.data)}),console.log(i),e.resolve(i))}),e.promise}},{key:"validdata",value:function(e){for(var t=Q.defer(),i=[],n=0,a=function(e){if(e.hq_lv>-1||e.name||e.note||e.rating>-1)return!0;if(!e.data||!e.data.length||!e.data.push)return!1;var t=!1,i=!0,n=!1,a=void 0;try{for(var s,o=e.data[Symbol.iterator]();!(i=(s=o.next()).done);i=!0){var r=s.value;if(r&&r.length&&r.push){var l=!0,d=!1,u=void 0;try{for(var c,h=r[Symbol.iterator]();!(l=(c=h.next()).done);l=!0){var m=c.value;"undefined"!=typeof m&&m&&m.push&&"undefined"!=typeof m[0]&&m[0]&&(t=!0)}}catch(p){d=!0,u=p}finally{try{!l&&h["return"]&&h["return"]()}finally{if(d)throw u}}}}}catch(p){n=!0,a=p}finally{try{!i&&o["return"]&&o["return"]()}finally{if(n)throw a}}return t};n<e.length;)a(e[n])?n++:(i.push(e[n]._id),e.splice(n,1));return i.length?_db.fleets.remove({_id:{$in:i}},{multi:!0},function(i,n){t.resolve(e)}):t.resolve(e),t.promise}},{key:"datacheck",value:function(e){return e=e||[],e.length?this.dom.container.removeClass("nocontent"):this.dom.container.addClass("nocontent"),e}},{key:"append_all_items",value:function(e){var t=this;e=e||[],e.sort(function(e,t){return e.name<t.name?-1:e.name>t.name?1:0}),this.trIndex=0,"undefined"==typeof Lockr.get("fleetlist-option-groupbytheme")&&Lockr.set("fleetlist-option-groupbytheme",!0);var i=Q.defer(),n=0;if(Lockr.get("fleetlist-option-groupbytheme"))!function(){var a={},s=0;e.forEach(function(e,t){a[e.theme]||(a[e.theme]=[]),a[e.theme].push(t)});for(var o in a){for(n=0;n<t.flexgrid_empty_count;)n?$('<dl data-fleetid trindex="99999"/>').appendTo(t.dom.tbody):t.flexgrid_ph=$('<dl data-fleetid trindex="99999"/>').appendTo(t.dom.tbody),n++;a[o].forEach(function(t){setTimeout(function(t){this.append_item(e[t]),s++,s>=e.length-1&&i.resolve()}.bind(this)(t),0)}.bind(t)),$("<h4/>",{trindex:++t.trIndex,html:"&nbsp;"}).appendTo(t.dom.tbody),t.trIndex++}}();else{for(;n<this.flexgrid_empty_count;)n?$('<dl data-fleetid trindex="99999"/>').appendTo(this.dom.tbody):this.flexgrid_ph=$('<dl data-fleetid trindex="99999"/>').appendTo(this.dom.tbody),n++;e.forEach(function(t,n){setTimeout(function(t){this.append_item(e[t]),t>=e.length-1&&i.resolve()}.bind(this)(n),0)}.bind(this))}return e.length||i.resolve(),i.promise}},{key:"append_item",value:function(e,i,n){if(!e)return!1;"undefined"==typeof i&&(i=this.trIndex,this.trIndex++);var a=$("<dl/>").attr({trindex:i,"data-fleetid":e._id||"PLACEHOLDER","data-infos":"[[FLEET::"+e._id+"]]","data-theme":e.theme,"class":"link_fleet"}).data({initdata:e});return this.columns.forEach(function(i){switch(i[1]){case" ":for(var n="<i>",s=e.data[0]||[],o=0;o<6;)n+=s[o]&&s[o][0]?'<img class="img'+(_huCss.csscheck_full("mask-image")?"":" nomask")+'" src="'+_g.path.pics.ships+"/"+s[o][0]+"/0"+t.avatarImgSuffix+'" contextmenu="disabled"/>':'<s class="img'+(_huCss.csscheck_full("mask-image")?"":" nomask")+'"/>',o++;n+="</i>",$("<dt/>").attr("value",e.name).html(n+"<strong>"+e.name+"</strong><em></em>").appendTo(a);break;default:var r=e[i[1]];$("<dd/>").attr("value",r).html(r).appendTo(a)}}),n===!0?a:(n?a.prependTo(this.dom.tbody):a.insertBefore(this.flexgrid_ph),a)}},{key:"btn_new",value:function(e){return this.menu_new||(this.menu_new=new _menu({target:this.dom.btn_new,className:"menu-fleets-new",items:[$('<div class="menu-fleets-new"/>').append($("<menuitem/>").html("新建配置").on("click",function(){this.action_new()}.bind(this))).append($("<menuitem/>").html("导入配置代码").on("click",function(){t.modalImport||(t.modalImport=$("<div/>").append(t.modalImportTextarea=$("<textarea/>",{placeholder:"输入配置代码..."})).append($("<p/>").html('* 配置代码兼容<a href="http://www.kancolle-calc.net/deckbuilder.html">艦載機厨デッキビルダー</a>')).append($('<p class="aircraftimportmax"/>').append(t.modalImportCheckAircraftMax=$("<input/>",{type:"checkbox",id:"_input_g"+_g.inputIndex}).prop("checked",Lockr.get("fleetlist-option-aircraftimportmax"))).append($("<label/>",{"class":"checkbox","for":"_input_g"+_g.inputIndex++,html:"飞行器熟练度自动提升至"}))).append(t.modalImportBtn=$('<button class="button"/>').html("导入").on("click",function(){var e=t.modalImportTextarea.val();e&&(e=JSON.parse(e),e.length&&e.push||(e=_g.kancolle_calc.decode(e)),this.action_new({data:e},{aircraftmax:t.modalImportCheckAircraftMax.prop("checked")}),_frame.modal.hide(),t.modalImportTextarea.val(""))}.bind(this)))),t.modalImportTextarea.val(""),_frame.modal.show(t.modalImport,"导入配置代码",{classname:"infos_fleet infos_fleet_import",detach:!0})}.bind(this))).append(t.support.buildfile?$('<menuitem class="import_file"/>').html("导入配置文件").on("click",function(){this.dbfile_selector.trigger("click")}.bind(this)):null)]}),this.dbfile_selector=$('<input type="file" class="none"/>').on("change",function(e){return this.importBuilds(this.dbfile_selector)}.bind(this)).appendTo(this.dom.filters)),e&&e.clientX?this.menu_new.show(e.clientX,e.clientY):this.menu_new.show(e)}},{key:"btn_settings",value:function(){t.menuOptions_show(this.dom.btn_settings,this)}},{key:"action_new",value:function(e,t){if(e=e||{},t=t||{},e.data){var i=0;e.data.forEach(function(e){e&&e.push&&(i<4?e.forEach(function(e){e&&e.push&&e[2].forEach(function(i,n){i&&$.inArray(_g.data.items[i].type,Formula.equipmentType.Aircrafts)>-1&&_g.data.items[i].rankupgradable&&t.aircraftmax&&(e[4][n]=7)})}):e.forEach(function(e){e&&e.push&&e.forEach(function(e,i){e&&e[0]&&$.inArray(_g.data.items[e[0]].type,Formula.equipmentType.Aircrafts)>-1&&_g.data.items[e[0]].rankupgradable&&t.aircraftmax&&(e[1]=7)})}),i++)}),InfosFleet.clean(e.data)}_db.fleets.insert(this.new_data(e,t),function(e,t){console.log(e,t),e?_g.error(e):"fleets"==_frame.app_main.cur_page&&(_frame.infos.show("[[FLEET::"+t._id+"]]"),this.menu_new.hide())}.bind(this))}},{key:"parse_kancolle_calc_data",value:function(e){return this.new_data(e)}},{key:"contextmenu_show",value:function(e,i,n){t.contextmenu||(t.contextmenu=new _menu({className:"contextmenu-fleet",items:[$("<menuitem/>").html("详情").on({click:function(e){t.contextmenu.curel.trigger("click",[!0])}}),$("<menuitem/>").html("导出配置代码").on({click:function(e){InfosFleet.modalExport_show(t.contextmenu.curel.data("initdata"))}}),$("<menuitem/>").html("导出配置文本").on({click:function(e){InfosFleet.modalExportText_show(t.contextmenu.curel.data("initdata"))}}),$("<menuitem/>").html("移除").on({click:function(e){var i=t.contextmenu.curel.attr("data-fleetid");i&&InfosFleet.modalRemove_show(i,t.contextmenu.curobject)}})]})),t.contextmenu.curobject=this,t.contextmenu.curel=e,n?t.contextmenu.show(n.clientX,n.clientY):t.contextmenu.show(i||e)}},{key:"genlist",value:function(e){Q.fcall(function(){}).then(function(){return this.loaddata()}.bind(this)).then(function(e){return this.validdata(e)}.bind(this)).then(function(e){return this.datacheck(e)}.bind(this)).then(function(e){return this.append_all_items(e)}.bind(this)).then(function(){setTimeout(function(){_frame.app_main.loaded("tablelist_"+this._index,!0)}.bind(this),100)}.bind(this))["catch"](function(e){_g.log(e)}).done(function(){e&&e(),_g.log("Fleets list DONE")})}},{key:"refresh",value:function(){console.log("refresh"),this.dom.tbody.empty(),this.genlist(function(){this.dom.tbody.scrollTop(this.dom.tbody.attr("scrollbody")||0)}.bind(this))}},{key:"importBuilds",value:function(e,i){e=e||this.dbfile_selector,_frame.app_main.loading_start("tablelist_fleets_import",!1),e.prop("disabled",!0);var n=Q.defer(),a=Q.fcall(function(){var t=Q.defer();if(_g.isNWjs&&i){var n=e.val();n.indexOf(";")>-1&&(n=node.path.dirname(n.split(";")[0])),node.fs.readFile(node.path.join(n,i),"utf8",function(e,i){e?t.reject("文件载入失败",new Error(e)):t.resolve(i)})}else for(var a,s=0;a=e[0].files[s];s++){var o=new FileReader;o.onload=function(e){return function(e){return t.resolve(e.target.result)}}(a),o.readAsText(a)}return t.promise});return a=a.then(function(t){e.val("");var i=[],n=Q.defer();return t.split("\n").forEach(function(e){if(e){try{i.push(JSON.parse(e))}catch(t){n.reject("文件格式错误",t)}n.resolve(i)}else n.reject("文件无内容")}),n.promise}).then(function(e){var i=Q.defer(),n=Q();return e.forEach(function(e){n=n.then(function(){var i=Q.defer();return _db.fleets.insert(e,function(n){n?"uniqueViolated"==n.errorType?t.modalBuildConflictShow(e,i):i.reject(n):i.resolve()}),i.promise})}),n=n.then(function(){i.resolve()})["catch"](function(e){i.reject(e)}).done(function(){_frame.modal.hide()}),i.promise}),a=a.then(function(){this.refresh(),_g.badgeMsg("成功导入配置"),n.resolve()}.bind(this))["catch"](function(e,t){_g.log(e),_g.error(t,"[舰队] 导入配置文件"),_g.badgeError(e),n.reject(e,t)}).done(function(){_frame.app_main.loading_complete("tablelist_fleets_import"),e.prop("disabled",!1)}),n.promise}}]),t}(Tablelist);TablelistFleets.support={},TablelistFleets.support.buildfile=!!(_g.isNWjs||window.File&&window.FileReader&&window.FileList&&window.Blob&&window.URL),TablelistFleets.avatarImgSuffix=_huCss.csscheck_full("mask-image")?"."+_g.imgExt:"-mask-2.png",TablelistFleets.menuOptions_show=function(e,t){if(!TablelistFleets.menuOptions){var i=[$('<menuitem class="mod-checkbox donot_hide option-in-tablelist option-groupbytheme"/>').append($("<input/>",{type:"checkbox",id:"_input_g"+_g.inputIndex}).prop("checked",Lockr.get("fleetlist-option-groupbytheme")).on("change",function(e){Lockr.set("fleetlist-option-groupbytheme",e.target.checked),TablelistFleets.menuOptions.curTablelist&&(TablelistFleets.menuOptions.curTablelist.dom.tbody.empty(),TablelistFleets.menuOptions.curTablelist.genlist())})).append($("<label/>",{"for":"_input_g"+_g.inputIndex++,html:"按主题颜色进行分组"})),$('<menuitem class="mod-checkbox donot_hide option-in-tablelist option-aircraftdefaultmax option-aircraftimportmax"/>').append($("<input/>",{type:"checkbox",id:"_input_g"+_g.inputIndex}).prop("checked",Lockr.get("fleetlist-option-aircraftimportmax")).on("change",function(e){Lockr.set("fleetlist-option-aircraftimportmax",e.target.checked)})).append($("<label/>",{"for":"_input_g"+_g.inputIndex++,html:"导入配置时提升飞行器熟练度至"})),$('<menuitem class="mod-checkbox donot_hide option-aircraftdefaultmax"/>').append($("<input/>",{type:"checkbox",id:"_input_g"+_g.inputIndex}).prop("checked",Lockr.get("fleetlist-option-aircraftdefaultmax")).on("change",function(e){Lockr.set("fleetlist-option-aircraftdefaultmax",e.target.checked)})).append($("<label/>",{"for":"_input_g"+_g.inputIndex++,html:'<span class="inline option-in-tablelist">配装时</span>新增飞行器熟练度默认为'})),$('<hr class="option-in-infos"/>'),$("<menuitem/>",{"class":"option-in-infos",html:"移除配置"}).on("click",function(){console.log(InfosFleet.cur),InfosFleet.cur&&InfosFleet.cur.remove()})];_g.isNWjs&&(i=i.concat(TablelistFleets.menuOptionsItemsBuildsLocation())),TablelistFleets.menuOptions=new _menu({className:"menu-tablelistfleets-options",items:i})}TablelistFleets.menuOptions.curTablelist=t||null,t?TablelistFleets.menuOptions.dom.menu.addClass("is-tablelist"):TablelistFleets.menuOptions.dom.menu.removeClass("is-tablelist"),TablelistFleets.menuOptions.show(e)},TablelistFleets.modalBuildConflictShow=function(e,t){if(e){TablelistFleets.modalBuildConflict||(TablelistFleets.modalBuildConflict=$("<div/>").append($("<h4>原配置</h4>")).append(TablelistFleets.modalBuildConflictOld=$('<dl class="link_fleet"/>')).append($("<h4>新配置</h4>")).append(TablelistFleets.modalBuildConflictNew=$('<dl class="link_fleet"/>')).append($('<p class="actions"/>').append(TablelistFleets.modalBuildConflictButtonConfirm=$("<button/>",{"class":"button",html:"替换"})).append(TablelistFleets.modalBuildConflictButtonCancel=$("<button/>",{"class":"button",html:"跳过"}))));var i=void 0,n=function(e){for(var t="<i>",i=InfosFleet.decompress(e.data)[0]||[],n=0;n<6;)t+=i[n]&&i[n][0]?'<img class="img'+(_huCss.csscheck_full("mask-image")?"":" nomask")+'" src="'+_g.path.pics.ships+"/"+i[n][0]+"/0"+TablelistFleets.avatarImgSuffix+'" contextmenu="disabled"/>':'<s class="img'+(_huCss.csscheck_full("mask-image")?"":" nomask")+'"/>',n++;return t+="</i>",t="<dt>"+t+"<strong>"+e.name+"</strong></dt>"+("<span>最后更新: "+new Date(e.time_modify).format("%Y年%m月%d日 %G:%i:%s")+"</span>")};Q.fcall(function(){var n=Q.defer();return _db.fleets.find({_id:e._id},function(e,a){e?t?t.reject(e):_g.log(e):(i=a[0],n.resolve())}),n.promise}).then(function(){TablelistFleets.modalBuildConflictButtonConfirm.off("click").on("click",function(){_db.fleets.update({_id:e._id},e,{},function(i,n){if(i)t?t.reject(i):_g.log(i);else if(_g.log("build updated "+n),_frame.infos.contentCache.fleet&&_frame.infos.contentCache.fleet[e._id]){_frame.infos.contentCache.fleet[e._id].remove(),delete _frame.infos.contentCache.fleet[e._id];try{delete _frame.app_main.loading_state[_g.state2URI({infos:"fleet",id:e._id})]}catch(a){}}t&&t.resolve()})}),e.time_modify>i.time_modify?TablelistFleets.modalBuildConflictButtonConfirm.trigger("click"):e.time_modify<i.time_modify?(TablelistFleets.modalBuildConflictOld.attr({"data-theme":i.theme,"class":"link_fleet"}).html(n(i)),TablelistFleets.modalBuildConflictNew.attr({"data-theme":e.theme,"class":"link_fleet"}).html(n(e)),TablelistFleets.modalBuildConflictButtonCancel.off("click").on("click",function(){t&&t.resolve()}),_frame.modal.show(TablelistFleets.modalBuildConflict,"配置冲突",{classname:"infos_fleet infos_fleet_import_conflict",detach:!0,onClose:function(){t&&t.resolve()}})):t&&t.resolve()})}};